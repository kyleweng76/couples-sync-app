<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>æˆ‘å€‘çš„å°æ™‚å…‰</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ttgreen: '#2cc998', 
                        ttred: '#e95d5d',   
                        ttgray: '#f5f5f5',  
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #ffffff; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #main-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        .page-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding-top: 70px; 
            padding-bottom: 90px;
            background-color: #f9fafb;
            display: none; 
        }
        .page-content.active { display: block; }
        
        #page-calendar.active {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            padding-top: 60px; 
            padding-bottom: 70px;
        }
        
        .nav-item.active { color: #2cc998; } 
        .nav-item.active svg { stroke-width: 2.5px; }

        .tt-input-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tt-input-row:active { background-color: #f9fafb; }
        .tt-icon { color: #9ca3af; margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; }
        
        .modal { transition: opacity 0.2s ease, transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.visible { opacity: 1; pointer-events: auto; transform: scale(1); }

.custom-checkbox {
  appearance: none;          /* æ¨™æº– */
  -webkit-appearance: none;  /* iOS Safari */
}        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #2cc998; border-color: #2cc998; }
        .custom-checkbox:checked::before { transform: scale(1); }
        
        .cat-chip { padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; border: 1px solid #e5e7eb; background: white; color: #6b7280; white-space: nowrap; transition: all 0.2s; }
        .cat-chip.active { background: #2cc998; color: white; border-color: #2cc998; box-shadow: 0 2px 5px rgba(44, 201, 152, 0.2); }

        .todo-item { transition: all 0.3s ease; }
        .todo-item.done span { text-decoration: line-through; color: #9ca3af; }

        .dt-btn:active, .dt-btn:focus { background-color: #fff; border: 1px solid #2cc998; outline: none; }
        .dt-btn{
  width: 100%;
  justify-content: flex-start;
  text-align: left;       /* âœ… ä¸è¦å†ç½®ä¸­ */
}
/* iOS/Safariï¼šé¿å…è¡¨å–®å…ƒä»¶æ€ªç•°é è¨­æ¨£å¼ï¼ˆä¹Ÿè§£ appearance ç›¸å®¹æ€§è­¦å‘Šï¼‰ */
.custom-checkbox{
  -webkit-appearance: none;
  appearance: none;
}

.dt-wrapper-date { flex: 2; position: relative; }
        .dt-wrapper-time { flex: 1; position: relative; }

        .time-dropdown { position: absolute; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 60; width: 100px; }
        .time-option { padding: 8px 16px; font-size: 14px; color: #374151; cursor: pointer; }
        .time-option:hover { background-color: #f3f4f6; }

        .status-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #6b7280; transition: all 0.2s; }
        .status-btn.active { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; font-weight: bold; }
        .status-btn.active[data-status="confirmed"] { background: #ecfdf5; border-color: #2cc998; color: #2cc998; }
        .status-btn.active[data-status="tbc"] { background: #fffbeb; border-color: #f59e0b; color: #f59e0b; }
        .status-btn.active[data-status="tbd"] { background: #fef2f2; border-color: #ef4444; color: #ef4444; border-style: dashed; }

        .status-tag { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: 1px; line-height: 1.4; flex-shrink: 0; }
        .status-tag.tbc { border: 1px solid #f59e0b; color: #f59e0b; background: #fffbeb; }
        .status-tag.tbd { border: 1px dashed #ef4444; color: #ef4444; background: #fef2f2; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Big Calendar View Styles */
        .big-cal-header { font-size: 13px; color: #9ca3af; text-align: center; padding-bottom: 8px; font-weight: 500; }
        .big-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #f3f4f6; border: 1px solid #f3f4f6; }
        .big-cal-cell { 
            background-color: white; 
            min-height: 85px; 
            padding: 2px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative; 
            cursor: pointer; 
            overflow: hidden;
        }
        .big-cal-cell.today { background-color: #f8fafc; }
        .big-cal-cell.selected { background-color: #ecfdf5; box-shadow: inset 0 0 0 2px #2cc998; }
        .big-cal-day-num { 
            font-size: 12px; 
            font-weight: 500; 
            color: #374151; 
            margin-bottom: 2px; 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
        }
        .big-cal-cell.today .big-cal-day-num { background-color: #2cc998; color: white; }
        .event-bar { width: 100%; font-size: 9px; line-height: 1.2; padding: 2px 3px; border-radius: 2px; background-color: #2cc998; color: white; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .event-bar.done { text-decoration: line-through; opacity: 0.6; }
        .more-events { font-size: 9px; color: #9ca3af; margin-top: 1px; }

        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { font-size: 12px; color: #9ca3af; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 50%; cursor: pointer; color: #374151; }
        .cal-day:hover { background-color: #f3f4f6; }
        .cal-day.empty { cursor: default; background: none; }
        .cal-day.selected { background-color: #2cc998; color: white; font-weight: bold; }
        .cal-day.today { color: #2cc998; font-weight: bold; }
        .cal-day:nth-child(7n), .cal-day-header:nth-child(7) { color: #f87171; } 
        .cal-day:nth-child(7n+1), .cal-day-header:nth-child(1) { color: #f87171; } 

        .avatar-sm { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #toast-container { transition: opacity 0.3s ease; }
        #toast-container.visible { opacity: 1; }
        /* ===== Calendar Grid Fix (7 columns align) ===== */
        .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        /* ===== FIX: Calendar Picker Height ===== */
#calendar-picker-modal .calendar-grid {
  min-height: auto;
}

#calendar-picker-modal #calendar-days {
  min-height: unset;
}
/* ===== iOS-like Calendar Picker ===== */

/* æ•´å€‹æ—¥æœŸ grid æ›´ç·Šæ¹Š */
#calendar-picker-modal .calendar-grid {
  gap: 6px;
}

/* æ—¥æœŸæ ¼å­ï¼šåœ“å½¢ã€ç„¡å¤–æ¡† */
#calendar-picker-modal .cal-day {
  width: 36px;
  height: 36px;
  aspect-ratio: unset;
  border-radius: 9999px;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.15s ease, color 0.15s ease;
}

/* Hoverï¼ˆåƒ iOS è¼•è§¸ï¼‰ */
#calendar-picker-modal .cal-day:hover {
  background-color: #f2f2f7;
}

/* ä»Šå¤©ï¼ˆiOS å¸¸ç”¨ã€Œå­—è‰²æç¤ºã€ï¼‰ */
#calendar-picker-modal .cal-day.today {
  color: #2cc998;
  font-weight: 600;
}

/* é¸ä¸­æ—¥æœŸï¼ˆiOS æ ¸å¿ƒï¼‰ */
#calendar-picker-modal .cal-day.selected {
  background-color: #2cc998;
  color: white;
  font-weight: 600;
}

/* ç©ºç™½æ ¼å®Œå…¨ä¸å¯é» */
#calendar-picker-modal .cal-day.empty {
  pointer-events: none;
  background: transparent;
}

/* æ˜ŸæœŸæ¨™é¡Œæ›´åƒ iOS */
#calendar-picker-modal .cal-day-header {
  font-size: 11px;
  font-weight: 500;
  color: #8e8e93;
}

/* æ•´å€‹ modal é«˜åº¦ç¸®çŸ­ */
#calendar-picker-modal .relative {
  padding-bottom: 12px;
}
/* ===== iOS Bottom Nav Touch Fix ===== */
nav .nav-item {
  padding-bottom: 6px;
}
/* ===== iOS-like Bottom Tab Bounce ===== */

/* Tab æœ¬é«” */
nav .nav-item {
  transition:
    transform 0.12s ease-out,
    background-color 0.12s ease-out;
  border-radius: 12px;
}



/* iOS Safariï¼šé¿å…é•·æŒ‰å‡ºç¾è—è‰²é®ç½© */
nav .nav-item {
  -webkit-tap-highlight-color: transparent;
}
/* ===== iOS-like Bottom Tab (Icon Only Bounce) ===== */

/* icon æœ¬é«” */
nav .nav-item i {
  transition: transform 0.12s ease-out;
  will-change: transform;
}

/* æŒ‰ä¸‹æ™‚ï¼šåªæœ‰ icon ç¸® */
nav .nav-item:active i {
  transform: scale(0.85);
}

/* ç›®å‰é ï¼šicon å¾®æ”¾å¤§ */
nav .nav-item.active i {
  transform: scale(1.1);
}

/* æ–‡å­—å®Œå…¨ä¸å‹•ï¼ˆä¿éšªï¼‰ */
nav .nav-item span {
  transform: none !important;
}

/* iOS Safari é˜²è—è‰²é«˜äº® */
nav .nav-item {
  -webkit-tap-highlight-color: transparent;
}
/* ===== iOS-like Active Tab Indicator ===== */

/* nav-item è®Šæˆå®šä½å®¹å™¨ */
nav .nav-item {
  position: relative;
}

/* ä½¿ç”¨ CSS è®Šæ•¸æ§åˆ¶é¡è‰² */
nav .nav-item.active::after {
  content: "";
  position: absolute;
  bottom: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 3px;
  border-radius: 999px;
  background-color: var(--active-tab-color, #2cc998);
}
/* ===== Swipe to delete ===== */
.swipe-row{
  position: relative;
  overflow: hidden;
  border-radius: 16px;
  background: #fff;
  margin: 6px 12px;
}

.swipe-actions{
  position: absolute;
  top: 0; bottom: 0; right: 0;
  width: 84px;                  /* âœ… é€™å€‹è¦è·Ÿ JS translateX ä¸€è‡´ */
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ff3b30;          /* iOS delete red */
}

.swipe-delete-btn{
  width: 100%;
  height: 100%;
  color: #fff;
  font-weight: 700;
}

.swipe-content{
  position: relative;
  z-index: 1;
  width: 100%;
  background: #fff;
  transform: translateX(0px);
  transition: transform 0.18s ease;
  touch-action: pan-y;
}

.swipe-row.open .swipe-content {
  transform: translateX(-84px);
}
    
/* ===== iOS Swipe-to-Delete (Calendar List) ===== */
.swipe-row{position:relative;overflow:hidden;border-radius:12px;}
.swipe-actions{position:absolute;top:0;right:0;bottom:0;display:flex;align-items:stretch;}
.swipe-delete-btn{display:flex;align-items:center;justify-content:center;padding:0 18px;font-weight:700;font-size:14px;color:#fff;background:#ff3b30;user-select:none;-webkit-user-select:none;}
.swipe-content{position:relative;transform:translateX(0);transition:transform .18s ease;will-change:transform;background:#fff;}
.swipe-row.open .swipe-content{transform:translateX(calc(-1 * var(--swipe-open, 88px)));}
/* ===== iOS swipe polish: easing ===== */
.swipe-content {
  transition-timing-function: cubic-bezier(.25,.8,.25,1);
}
[data-swipe="content"]{
  touch-action: pan-y;
}
/* iOS-style setting row */
.ios-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
}

/* å·¦å´æ¨™ç±¤ */
.ios-label {
  font-size: 14px;
  color: #374151; /* gray-700 */
  flex-shrink: 0;
}

/* å³å´é¡¯ç¤ºå€¼ */
.ios-value {
  font-size: 14px;
  color: #111827; /* gray-900 */
  text-align: right;
}

/* å°šæœªè¨­å®šæ™‚çš„æ¨£å¼ */
.ios-placeholder {
  color: #9ca3af; /* gray-400 */
}

/* å³å´è¼¸å…¥æ¡†ï¼ˆåœ°é»ï¼‰ */
.ios-input {
  border: none;
  outline: none;
  text-align: right;
  font-size: 14px;
  color: #111827;
  background: transparent;
  width: 70%;
}

.ios-input::placeholder {
  color: #9ca3af;
}
.ios-row-input { cursor: default; }
.ios-row-input:active { background: transparent; }
/* iOS switch */
.ios-switch { position: relative; display: inline-block; width: 52px; height: 32px; }
.ios-switch input { opacity: 0; width: 0; height: 0; }
.ios-slider {
  position: absolute; cursor: pointer; inset: 0;
  background: #e5e7eb; border-radius: 999px; transition: .2s;
}
.ios-slider:before {
  position: absolute; content: "";
  height: 28px; width: 28px; left: 2px; top: 2px;
  background: white; border-radius: 999px; transition: .2s;
  box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.ios-switch input:checked + .ios-slider { background: #2cc998; }
.ios-switch input:checked + .ios-slider:before { transform: translateX(20px); }
</style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden bg-white">

    <!-- Header -->
    <header class="bg-white border-b border-gray-100 p-4 fixed top-0 w-full z-10 safe-top flex justify-between items-center shadow-sm">
        <h1 class="text-lg font-bold text-gray-800 tracking-wide">
            <span class="text-ttgreen">Time</span>Tree <span class="text-xs text-gray-400 font-normal">for us</span>
        </h1>
        <div class="flex items-center gap-2">
            <div id="connection-status" class="w-2 h-2 rounded-full bg-red-400"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container">
        <!-- Page 1: Dashboard -->
        <div id="page-dashboard" class="page-content active">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mx-4 mt-2">
                <div class="flex justify-between items-center px-4">
                    <div class="flex flex-col items-center cursor-pointer card-press" onclick="window.updateMyStatus('charging')">
                        <div id="status-icon-haohao" class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-2xl border border-gray-100">ğŸ˜¶</div>
                        <span class="text-xs mt-2 text-gray-400">çš“çš“</span>
                    </div>
                    <div class="h-px w-10 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="status-icon-maomao" class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-2xl border border-gray-100">ğŸ˜¶</div>
                        <span class="text-xs mt-2 text-gray-400">æ¯›æ¯›</span>
                    </div>
                </div>
            </div>

            <!-- Next Up Card -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4 mt-4">
                <div class="bg-ttgreen px-4 py-2 flex justify-between items-center">
                    <span class="text-white text-xs font-bold tracking-wider">NEXT 7 DAYS</span>
                    <span id="dashboard-countdown" class="text-white text-xs bg-white/20 px-2 py-0.5 rounded-full">...</span>
                </div>
                <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
                    <div class="text-center py-8 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- Dashboard Todo Summary -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-ttgreen"></i> å¾…è¾¦æ¸…å–®
                    </h3>
                    <button onclick="window.switchTab('todo')" class="text-xs text-ttgreen font-medium">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div id="dashboard-todo-list" class="space-y-2">
                    <p class="text-xs text-gray-400 text-center py-2">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <div class="px-4 mt-4">
                <button onclick="window.openAddModal()" class="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-400 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-ttgreen"></i>
                    <span>æ–°å¢è¡Œç¨‹</span>
                </button>
            </div>
        </div>

        <!-- Page 2: Calendar -->
        <div id="page-calendar" class="page-content">
            <div class="flex-none bg-white z-10 border-b border-gray-200 px-2 py-2 flex items-center justify-between">
                 <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="window.switchCalendarView('list')" id="btn-view-list" class="px-4 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all">åˆ—è¡¨</button>
                    <button onclick="window.switchCalendarView('month')" id="btn-view-month" class="px-4 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">æœˆæ›†</button>
                </div>
                <button onclick="window.openAddModal()" class="text-ttgreen font-medium text-sm flex items-center gap-1 bg-green-50 px-3 py-1.5 rounded-lg">
                    <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
                </button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 relative w-full">
                <div id="calendar-view-list" class="absolute inset-0 overflow-y-auto">
                    <div id="event-list" class="divide-y divide-gray-100 bg-white">
                        <div class="text-center py-10 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                <div id="calendar-view-month" class="absolute inset-0 overflow-y-auto hidden">
                    <div class="flex justify-between items-center p-4 bg-white">
                        <h2 id="big-cal-title" class="text-lg font-bold text-gray-800">...</h2>
                        <div class="flex gap-2">
                            <button onclick="window.changeBigCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button onclick="window.changeBigCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="bg-white pb-2">
                        <div class="grid grid-cols-7 text-center mb-1">
                            <div class="big-cal-header text-red-400">æ—¥</div><div class="big-cal-header">ä¸€</div><div class="big-cal-header">äºŒ</div><div class="big-cal-header">ä¸‰</div><div class="big-cal-header">å››</div><div class="big-cal-header">äº”</div><div class="big-cal-header text-red-400">å…­</div>
                        </div>
                        <div id="big-cal-grid" class="big-cal-grid border-t border-gray-100"></div>
                    </div>
                    <div class="mt-2 bg-white border-t border-gray-200 min-h-[300px]">
                        <div class="px-4 py-2 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                            <span id="selected-date-label" class="text-sm font-bold text-gray-600">é¸æ“‡æ—¥æœŸæŸ¥çœ‹</span>
                        </div>
                        <div id="month-event-list" class="divide-y divide-gray-100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Todo -->
        <div id="page-todo" class="page-content">
            <div class="sticky top-0 bg-white z-10 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">å¾…è¾¦æ¸…å–®</h2>
                 <button onclick="window.openAddTodoModal()" class="bg-ttgreen text-white p-2 rounded-lg shadow-sm active:scale-95 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="todo-list-container" class="p-4 space-y-6 pb-24">
                <!-- Joint Section -->
                <div>
                     <h3 class="text-sm font-bold text-orange-400 mb-2 flex items-center gap-1">
                        <i data-lucide="users" class="w-4 h-4"></i> å…±åŒå¾…è¾¦
                    </h3>
                    <div id="todo-list-joint" class="space-y-2"></div>
                </div>
                 <!-- Haohao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-ttgreen mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> çš“çš“
                    </h3>
                    <div id="todo-list-haohao" class="space-y-2"></div>
                </div>
                 <!-- Maomao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-pink-400 mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> æ¯›æ¯›
                    </h3>
                    <div id="todo-list-maomao" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Page 4: Settings -->
        <div id="page-settings" class="page-content p-4 space-y-6">
            <h2 class="text-lg font-bold text-gray-800 px-1">è¨­å®š</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-50">
                    <p class="text-sm text-gray-500 mb-3">æˆ‘æ˜¯èª°ï¼Ÿ (åˆ‡æ›èº«åˆ†)</p>
                    <div class="flex gap-2">
                        <button id="role-haohao" onclick="window.setRole('haohao')" class="flex-1 py-3 rounded-lg text-sm font-medium border transition">çš“çš“</button>
                        <button id="role-maomao" onclick="window.setRole('maomao')" class="flex-1 py-3 rounded-lg text-sm font-medium border transition">æ¯›æ¯›</button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 space-y-4">
                    <p class="text-sm text-gray-500 mb-2">ä»£è¡¨è‰²è¨­å®š</p>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('haohao')">
                        <span class="text-sm text-gray-700">çš“çš“</span>
                        <div id="setting-color-haohao" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('maomao')">
                        <span class="text-sm text-gray-700">æ¯›æ¯›</span>
                        <div id="setting-color-maomao" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('joint')">
                        <span class="text-sm text-gray-700">å…±åŒè¡Œç¨‹</span>
                        <div id="setting-color-joint" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400 mt-4">Firebase Connected Â· Version 102.0 (Stable Click)</div>
        </div>
    </main>

    <!-- Global Color Picker Modal -->
    <div id="global-color-picker" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.toggleGlobalColorPicker(false)"></div>
        <div class="relative bg-white w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">é¸æ“‡é¡è‰²</h3>
            <div id="global-color-grid" class="grid grid-cols-1 gap-1 max-h-[300px] overflow-y-auto"></div>
            <button onclick="window.toggleGlobalColorPicker(false)" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeConfirmModal()"></div>
        <div class="relative bg-white w-[280px] rounded-xl shadow-xl p-5 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-4">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œæ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
                <button onclick="window.executeDelete()" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200">åˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[90] pointer-events-none transition-opacity duration-300 opacity-0">
        <div id="toast-message" class="bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur-sm">
        </div>
    </div>

    <!-- Add Event Modal (Minimal Stable) -->
<div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
  <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddModal()"></div>

  <div class="relative bg-white w-full h-full md:h-auto md:w-[380px] md:rounded-2xl flex flex-col">

   <!-- Modal Top Bar (iOS-like) -->
<div class="px-6 py-4 border-b flex items-center justify-between">
   <!-- å·¦ï¼šå–æ¶ˆ -->
  <button
    onclick="window.closeAddModal()"
    class="text-gray-500 text-sm"
  >
    å–æ¶ˆ
  </button>

  <!-- ä¸­ï¼šæ¨™é¡Œ -->
  <h3 id="add-modal-title" class="text-base font-semibold text-gray-800">
    æ–°å¢è¡Œç¨‹
  </h3>

  <!-- å³ï¼šåˆªé™¤ + å„²å­˜ -->
  <div class="flex items-center gap-3">
    <!-- â­ åˆªé™¤ï¼ˆé è¨­éš±è—ï¼‰ -->
    <button
      id="btn-delete"
      onclick="window.deleteCurrentEvent()"
      class="text-red-500 text-sm hidden"
    >
      Delete
    </button>

    <!-- å„²å­˜ -->
    <button
      id="add-save-btn"
      onclick="window.saveEvent()"
      class="text-ttgreen text-sm font-semibold"
    >
      å„²å­˜
    </button>
  </div>
</div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">

      <!-- Title (iOS row) -->
<div class="ios-row ios-row-input">
  <span class="ios-label">æ¨™é¡Œ</span>
  <input
    type="text"
    id="input-title"
    class="ios-input"
    placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œ"
  />
</div>

      <!-- Date (iOS row) -->
<input type="hidden" id="input-date-start">

<div class="ios-row" onclick="window.openCalendar('start')">
  <span class="ios-label">æ—¥æœŸ</span>
  <span id="display-date-start" class="ios-value">é¸æ“‡æ—¥æœŸ</span>
</div>

     <!-- Time (Optional) -->
<div class="ios-row" onclick="window.openTimePicker('start')">
  <span class="ios-label">æ™‚é–“</span>
  <span id="display-time-start" class="ios-value ios-placeholder">æœªè¨­å®š</span>
</div>
<input type="hidden" id="input-time-start">

<!-- Location (Optional) -->
<div class="ios-row">
  <span class="ios-label">åœ°é»</span>
  <input
    type="text"
    id="input-location"
    class="ios-input"
    placeholder="å¯ä¸å¡«"
  />
</div>

      <!-- Partner toggle -->
<div class="ios-row">
  <span class="ios-label">èˆ‡å°æ–¹ä¸€èµ·</span>
  <label class="ios-switch">
    <input type="checkbox" id="check-partner" onchange="window.togglePartner()">
    <span class="ios-slider"></span>
  </label>
</div>

      <!-- Status -->
      <div class="bg-white rounded-xl p-4 border border-gray-200">
        <label class="text-xs font-bold text-gray-400 mb-2 block">ç‹€æ…‹</label>
        <div class="flex gap-2">
          <button
            type="button"
            class="status-btn active"
            data-status="confirmed"
            onclick="window.setStatus('confirmed')"
          >å·²ç¢ºèª</button>
          <button
            type="button"
            class="status-btn"
            data-status="tbc"
            onclick="window.setStatus('tbc')"
          >TBC</button>
          <button
            type="button"
            class="status-btn"
            data-status="tbd"
            onclick="window.setStatus('tbd')"
          >TBD</button>
        </div>
        <input type="hidden" id="input-status" value="confirmed">
      </div>

      <!-- Note -->
      <div class="bg-white border border-gray-200 rounded-xl p-4">
        <label class="text-xs font-bold text-gray-400 mb-1 block">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <textarea
  id="input-note"
  class="w-full bg-transparent text-[17px] text-gray-900 focus:outline-none resize-none"
  rows="3"
  placeholder="å…¶ä»–éœ€è¦è¨»æ˜çš„äº‹é …"
></textarea>
      </div>

    </div>

  </div>
</div>

    
    <!-- Add Todo Modal -->
    <div id="add-todo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddTodoModal()"></div>
        <div class="relative bg-white w-full h-full md:h-auto md:w-[350px] md:rounded-2xl flex flex-col md:max-h-[80vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 id="todo-modal-title" class="text-lg font-bold text-gray-800">æ–°å¢å¾…è¾¦äº‹é …</h3>
                <button onclick="window.closeAddTodoModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å…§å®¹</label>
                    <input type="text" id="todo-input-title" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-ttgreen">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸæ™‚é–“ (é¸å¡«)</label>
                    <div class="flex gap-2 items-center h-10">
                        <input type="hidden" id="input-date-todo">
                        <input type="hidden" id="input-time-todo">
                        <div class="dt-wrapper-date flex-1">
                            <div id="display-date-todo" class="dt-btn justify-start w-full" onclick="window.openCalendar('todo')">--/--/--</div>
                        </div>
                        <div class="dt-wrapper-time relative w-24">
                            <input type="text" id="display-time-todo" class="dt-btn justify-center w-full focus:bg-white outline-none" placeholder="--:--" maxlength="5" onfocus="window.openTimePicker('todo')" oninput="window.handleTimeInput('todo', this.value)" onblur="window.validateTimeInput('todo', this)">
                        </div>
                    </div>
                </div>

                <div class="space-y-3 pt-2">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-gray-700">å…±åŒå¾…è¾¦ (å…©äººå¯è¦‹)</span>
                        <input type="checkbox" id="todo-check-joint" class="custom-checkbox">
                    </label>
                    
                    <label id="todo-calendar-option" class="flex items-center justify-between cursor-pointer opacity-50 pointer-events-none transition-opacity">
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-700">åŒæ­¥è‡³è¡Œäº‹æ›†</span>
                            <span class="text-[10px] text-gray-400">éœ€å…ˆé¸æ“‡æ—¥æœŸ</span>
                        </div>
                        <input type="checkbox" id="todo-check-calendar" class="custom-checkbox" disabled>
                    </label>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100">
                <button id="todo-modal-btn" onclick="window.saveTodoItem()" class="w-full py-3 bg-ttgreen text-white rounded-xl font-bold shadow-md active:scale-95 transition">æ–°å¢å¾…è¾¦</button>
            </div>
        </div>
    </div>

    <!-- Dropdowns & Pickers -->
    <div id="time-picker-dropdown" class="time-dropdown hidden"></div>
    <div id="calendar-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCalendar()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl w-[320px] p-4 overflow-hidden max-h-[420px]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cal-month-title" class="text-lg font-bold text-gray-800 tracking-wide cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition">...</h3>
                <div class="flex gap-1"><button onclick="window.changeCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><button onclick="window.changeCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-red-400">æ—¥</div><div class="cal-day-header">ä¸€</div><div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div><div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div><div class="cal-day-header text-red-400">å…­</div>
            </div>

            <div id="calendar-days" class="calendar-grid"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-sm font-medium">
                <button onclick="window.selectToday()" class="text-ttgreen hover:bg-green-50 px-3 py-1.5 rounded-lg transition">ä»Šå¤©</button>
                <button onclick="window.closeCalendar()" class="text-gray-400 hover:bg-gray-50 px-3 py-1.5 rounded-lg transition">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
        <nav class="bg-white border-t border-gray-100 fixed bottom-0 w-full px-6 pt-3 pb-6 pb-safe z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <button class="nav-item active flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('dashboard')"><i data-lucide="layout-grid" class="w-6 h-6"></i><span class="text-[10px] font-medium">æ‘˜è¦</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('calendar')"><i data-lucide="calendar" class="w-6 h-6"></i><span class="text-[10px] font-medium">è¡Œäº‹æ›†</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('todo')"><i data-lucide="list-checks" class="w-6 h-6"></i><span class="text-[10px] font-medium">æ¸…å–®</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('settings')"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-[10px] font-medium">è¨­å®š</span></button>
        </div>
    </nav>

    <script>
       /* ===== STABLE PATCH: SafeRun Helper ===== */
window.safeRun = function (fn, label = 'unknown') {
  try {
    return fn();
  } catch (err) {
    console.error(`[SafeRun:${label}]`, err);
    if (window.showToast) {
      window.showToast('ç™¼ç”ŸéŒ¯èª¤ï¼Œä½† App ä»å¯ä½¿ç”¨');
    }
    return null;
  }
};
        // --- 1. VARIABLES ---
        /* ===== STABLE PATCH: Firestore Listener Guard ===== */
const snapshotRegistry = {};

function bindSnapshot(ref, cb, label = 'snapshot') {
  if (snapshotRegistry[label]) return; // å·²ç¶é

  const unsub = ref.onSnapshot(
    snap => window.safeRun(() => cb(snap), label),
    err => console.error(`[Firestore:${label}]`, err)
  );

  snapshotRegistry[label] = unsub;
}


        const firebaseConfig = { apiKey: "AIzaSyDLrPr4X6r3e2V_vqFaCICgKVwLmiykxpc", authDomain: "kyle-mao.firebaseapp.com", projectId: "kyle-mao", storageBucket: "kyle-mao.firebasestorage.app", messagingSenderId: "290564848532", appId: "1:290564848532:web:006c4e9df4b1330895ad81" };
        let db; try { if(typeof firebase!=='undefined'){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}

        let currentUserRole = localStorage.getItem('user_role') || 'haohao'; 
        let currentSelectedColor = '#2cc998'; 
        let currentCategory = 'default';
        let editingEventId = null;
        let editingTodoId = null;
        let allEventsCache = [];
        let isSavingEvent = false;
        let __lastSaveAt = 0;
        let allTodosCache = [];
        let roleColors = { haohao: '#2cc998', maomao: '#e6688d', joint: '#f7b546' };
        let colorPickerTarget = null;
        let calTargetInput = 'start'; 
        let calCurrentDate = new Date(); 
        let bigCalDate = new Date();
        let currentViewMode = 'list';

        const timeTreeColors = [ { name: "Emerald Green", hex: "#2cc998" }, { name: "Modern Cyan", hex: "#5cc2d1" }, { name: "Deep Sky Blue", hex: "#5ba3eb" }, { name: "Pastel Brown", hex: "#a68b75" }, { name: "Midnight Black", hex: "#333333" }, { name: "Apple Red", hex: "#e35651" }, { name: "French Rose", hex: "#e6688d" }, { name: "Coral Pink", hex: "#f29074" }, { name: "Bright Orange", hex: "#f7b546" }, { name: "Soft Violet", hex: "#9f82d1" } ];
        const moodMap = { 'charging': { icon: 'âš¡ï¸', bg: 'bg-yellow-100', border: 'border-yellow-300' }, 'sleepy': { icon: 'ğŸ’¤', bg: 'bg-blue-100', border: 'border-blue-300' }, 'love': { icon: 'â¤ï¸', bg: 'bg-rose-100', border: 'border-rose-300' }, 'busy': { icon: 'ğŸ”¥', bg: 'bg-orange-100', border: 'border-orange-300' }, 'normal': { icon: 'ğŸ˜¶', bg: 'bg-gray-50', border: 'border-gray-100' } };

        // --- 2. GLOBAL FUNCTION DEFINITIONS (Assigned to window immediately) ---
        
        window.updateDateDisplay = function(type, dateStr) {
            const displayEl = (type === 'recur') ? document.getElementById('display-recur-until') : (type === 'todo' ? document.getElementById('display-date-todo') : document.getElementById(`display-date-${type}`));
            if(!displayEl) return;
            if(!dateStr) { if (type === 'recur') displayEl.textContent = "è¨­å®šæ—¥æœŸ"; if (type === 'todo') displayEl.textContent = "--/--/--"; return; }
            const date = new Date(dateStr); const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            if (type === 'recur' || type === 'todo') displayEl.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} (${weekDays[date.getDay()]})`;
            else displayEl.textContent = `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥(${weekDays[date.getDay()]})`;
        };

        window.updateTimeDisplay = function(type, timeStr) {
  const el = document.getElementById(`display-time-${type}`);
  if (!el) return;

  if (!timeStr) {
    el.textContent = 'æœªè¨­å®š';
    el.classList.add('ios-placeholder');
  } else {
    el.textContent = timeStr;
    el.classList.remove('ios-placeholder');
  }
};
        window.checkRecurValidity = function() { 
            const eD_el = document.getElementById('input-date-end');
            const rD_el = document.getElementById('input-recur-until');
            if (!eD_el || !rD_el) return;
            const eD = eD_el.value; 
            const rD = rD_el.value; 
            if(rD && eD && new Date(rD) < new Date(eD)) { 
                rD_el.value = eD; 
                window.updateDateDisplay('recur', eD); 
            } 
        };
        
        window.autoUpdateEnd = function() { 
            const sD = document.getElementById('input-date-start')?.value; 
            const sT = document.getElementById('input-time-start')?.value; 
            
            // Check for end inputs existence
            const eD_el = document.getElementById('input-date-end');
            const eT_el = document.getElementById('input-time-end');
            const dT_el = document.getElementById('display-time-end');
            
            if(!sD || !sT || !eD_el || !eT_el) return; 
            
            const start = new Date(`${sD}T${sT}`); 
            const end = new Date(start.getTime() + 3600000); 
            const eD = end.toISOString().split('T')[0]; 
            const eT = end.toTimeString().substring(0,5); 
            
            eD_el.value = eD; 
            eT_el.value = eT; 
            if(dT_el) dT_el.value = eT; 
            window.updateDateDisplay('end', eD); 
            window.checkRecurValidity(); 
        };
        
        window.checkEndDateValidity = function() { 
            const sD = document.getElementById('input-date-start')?.value; 
            const sT = document.getElementById('input-time-start')?.value; 
            const eD = document.getElementById('input-date-end')?.value; 
            const eT = document.getElementById('input-time-end')?.value; 
            
            if (!sD || !sT || !eD || !eT) return;
            
            if(new Date(`${eD}T${eT}`) < new Date(`${sD}T${sT}`)) { 
                window.autoUpdateEnd(); 
            } else { 
                window.checkRecurValidity(); 
            } 
        };
        
        window.setNowToInputs = function() { 
            const now = new Date(); 
            const dStr = now.toISOString().split('T')[0]; 
            let h = now.getHours(), m = now.getMinutes(); 
            if(m < 30) { m = 30; } else { m = 0; h += 1; } 
            if(h > 23) h = 0; 
            const tStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; 
            
            const startEl = document.getElementById('input-date-start'); 
            if(startEl) { 
                startEl.value = dStr; 
                document.getElementById('input-time-start').value = tStr; 
                window.updateDateDisplay('start', dStr); 
                window.updateTimeDisplay('start', tStr); 
                
                // Only update end if elements exist
                const endEl = document.getElementById('input-date-end');
                if (endEl) {
                    endEl.value = dStr; 
                    document.getElementById('input-time-end').value = tStr; 
                    window.updateDateDisplay('end', dStr); 
                    window.updateTimeDisplay('end', tStr); 
                }
            } 
        };
        window.updateRoleUI = function() { const btnHaohao = document.getElementById('role-haohao'); const btnMaomao = document.getElementById('role-maomao'); if(!btnHaohao) return; const activeClass = "flex-1 py-3 rounded-lg text-sm font-bold border border-ttgreen bg-green-50 text-ttgreen transition shadow-sm"; const inactiveClass = "flex-1 py-3 rounded-lg text-sm font-medium border border-gray-200 text-gray-400 bg-white transition"; if(currentUserRole === 'haohao') { btnHaohao.className = activeClass; btnMaomao.className = inactiveClass; } else { btnHaohao.className = inactiveClass; btnMaomao.className = activeClass; } const ptText = document.getElementById('partner-toggle-text'); if(ptText) ptText.textContent = (currentUserRole === 'haohao' ? 'èˆ‡æ¯›æ¯›ä¸€èµ·' : 'èˆ‡çš“çš“ä¸€èµ·'); };
        window.updateSettingsColorUI = function() { const h = document.getElementById('setting-color-haohao'); if(h) { h.style.backgroundColor = roleColors.haohao; document.getElementById('setting-color-maomao').style.backgroundColor = roleColors.maomao; document.getElementById('setting-color-joint').style.backgroundColor = roleColors.joint; } };
        window.setStatus = function(s) { document.getElementById('input-status').value = s; document.querySelectorAll('.status-btn').forEach(b=>{ if(b.dataset.status===s) b.classList.add('active'); else b.classList.remove('active'); }); };
        window.showToast = function(msg) { const t = document.getElementById('toast-container'); const m = document.getElementById('toast-message'); m.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); };
        // --- Event Modal UX helpers (Apple-like) ---
        window.setEventModalMode = function(mode) {
            const titleEl = document.getElementById('add-modal-title');
            const saveBtn = document.getElementById('add-save-btn');
            if (titleEl) titleEl.textContent = (mode === 'edit') ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹';
            if (saveBtn) saveBtn.textContent = (mode === 'edit') ? 'æ›´æ–°' : 'å„²å­˜';
        };

        window.updateEventSaveState = function() {
            const saveBtn = document.getElementById('add-save-btn');
            if (!saveBtn) return;
            const title = document.getElementById('input-title')?.value?.trim();
            const startDate = document.getElementById('input-date-start')?.value;
            const ok = !!(title && startDate);

            // å„²å­˜ä¸­æ™‚ç¶­æŒ disabled
            saveBtn.disabled = !ok || window.__savingEvent === true;
            saveBtn.classList.toggle('opacity-60', saveBtn.disabled);
        };

        // éœ€è¦æ™‚è‡ªå‹•åˆ¤æ–·ï¼šæ²’å¸¶ id å°±æ˜¯æ–°å¢ï¼›æœ‰ id å°±æ˜¯ç·¨è¼¯
        window.openEventModal = function(id) {
            if (id) return window.openEditModal(id);
            return window.openAddModal();
        };


        // ===== Add Modal: Save Button UI =====
        window.updateAddSaveButtonUI = function() {
            const btn = document.getElementById('add-save-btn');
            if (!btn) return;
            const title = document.getElementById('input-title')?.value?.trim();
            const date = document.getElementById('input-date-start')?.value;
            const canSave = !!title && !!date;

            btn.disabled = !canSave;

            // è®“ disabled ç‹€æ…‹ä¹Ÿçœ‹å¾—å‡ºä¾†æ˜¯æŒ‰éˆ•
            if (!canSave) {
                btn.classList.remove('bg-ttgreen','text-white','shadow-sm');
                btn.classList.add('bg-gray-100','text-gray-400','border','border-gray-200');
            } else {
                btn.classList.remove('bg-gray-100','text-gray-400','border','border-gray-200');
                btn.classList.add('bg-ttgreen','text-white','shadow-sm');
            }
        };
window.updateParticipantsPreview = function() {
  const container = document.getElementById('participants-preview');
  if (!container) return; // âœ… æ²’æœ‰é€™å€‹å€å¡Šå°±ç›´æ¥è·³é

  const isP = document.getElementById('check-partner')?.checked;
  let html = '';
  html += `<div class="avatar-sm z-20" style="background-color:${roleColors[currentUserRole]}">${currentUserRole==='haohao'?'çš“':'æ¯›'}</div>`;
  if(isP) {
    const p = currentUserRole==='haohao'?'maomao':'haohao';
    html += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]}">${p==='haohao'?'çš“':'æ¯›'}</div>`;
  }
  container.innerHTML = html;
};
        window.setRole = function(role) {
  localStorage.setItem('user_role', role);
  currentUserRole = role;
  window.updateRoleUI();

  // â­ Active Tab æŒ‡ç¤ºç·šé¡è‰²è·Ÿè§’è‰²åŒæ­¥
  document.documentElement.style.setProperty(
    '--active-tab-color',
    roleColors[role]
  );
};
        window.updateMyStatus = function(specificMood) { 
            if(!db) return; 
            const moods = ['normal', 'charging', 'sleepy', 'love', 'busy']; 
            let nextMood;
            // Use specific mood if provided and valid, otherwise random
            if (specificMood && moods.includes(specificMood)) {
                nextMood = specificMood;
            } else {
                nextMood = moods[Math.floor(Math.random() * moods.length)]; 
            }
            const d = {}; 
            d[currentUserRole] = nextMood; 
            db.collection('status').doc('current').set(d, { merge: true }); 
        };

        // â­ NEW: Render function for Status UI
        window.renderStatus = function(data) {
            if (!data) return;
            ['haohao', 'maomao'].forEach(role => {
                const mood = data[role] || 'normal';
                const config = moodMap[mood] || moodMap.normal;
                const el = document.getElementById(`status-icon-${role}`);
                if (el) {
                    el.textContent = config.icon;
                    // Reset and apply new classes
                    el.className = `w-12 h-12 rounded-full flex items-center justify-center text-2xl border transition-all duration-300 ${config.bg} ${config.border}`;
                }
            });
        };

        window.toggleGlobalColorPicker = function(show) { const el = document.getElementById('global-color-picker'); const grid = document.getElementById('global-color-grid'); if(show) { grid.innerHTML = ''; timeTreeColors.forEach(color => { const row = document.createElement('div'); row.className = "flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition"; row.onclick = () => window.selectGlobalColor(color); row.innerHTML = `<div class="w-5 h-5 rounded-full mr-3 shadow-sm" style="background-color: ${color.hex}"></div><span class="text-sm text-gray-700">${color.name}</span>`; grid.appendChild(row); }); el.classList.remove('hidden'); setTimeout(() => el.classList.add('visible'), 10); } else { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); colorPickerTarget = null; } };

        window.selectGlobalColor = function(c) { if (colorPickerTarget === 'event') { currentSelectedColor = c.hex; document.getElementById('selected-color-name').textContent = c.name; document.getElementById('selected-color-dot').style.backgroundColor = c.hex; } else if (colorPickerTarget) { roleColors[colorPickerTarget] = c.hex; localStorage.setItem(`color_${colorPickerTarget}`, c.hex); window.updateSettingsColorUI(); } window.toggleGlobalColorPicker(false); };
        window.openColorConfig = function(target) { colorPickerTarget = target; window.toggleGlobalColorPicker(true); };
        window.syncSelectedColorUI = function() {
            const dot = document.getElementById('selected-color-dot');
            const name = document.getElementById('selected-color-name');

  if (!dot || !name) return;

  // å¾ç›®å‰é¸æ“‡çš„é¡è‰²æ‰¾å°æ‡‰åç¨±
  const found = timeTreeColors.find(c => c.hex === currentSelectedColor);

  dot.style.backgroundColor = currentSelectedColor;
  name.textContent = found ? found.name : 'è‡ªè¨‚é¡è‰²';
};

        // --- 3. RENDERERS ---
        window.renderEvents = function(ignored) { const items = window.getCalendarItems(); const now = new Date(); const future = items.filter(e => { const date = new Date(e.timestamp); if(e.isTodo && e.done) return false; return !isNaN(date) && date >= now; }); const titleEl = document.getElementById('next-event-title'); if(titleEl && future.length > 0) { const n = future[0], d = new Date(n.timestamp); titleEl.textContent = n.title; const timeStr = n.allDay ? "All Day" : d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('next-event-time').textContent = timeStr; document.getElementById('next-event-date').textContent = d.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); const diff = Math.ceil((d-now)/(1000*60*60*24)); document.getElementById('countdown').textContent = diff<=0?"TODAY":`D - ${diff}`; } else if(titleEl) { titleEl.textContent = "No Upcoming Events"; } const listEl = document.getElementById('event-list'); if(listEl) { if (items.length === 0) listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; else window.renderEventListItems(items, listEl); } };
        window.getCalendarItems = function() { const events = allEventsCache.map(e => ({...e, type: 'event'})); const todos = allTodosCache.filter(t => t.addToCalendar && t.timestamp).map(t => ({ id: t.id, title: t.title, timestamp: t.timestamp, color: null, allDay: !t.dueTime, isTodo: true, done: t.done, type: 'todo', creator: t.creator, isJoint: t.isJoint })); return [...events, ...todos].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); };
        
        window.renderDashboardNextUp = function(items) { const now = new Date(); const next7Days = new Date(); next7Days.setDate(now.getDate() + 7); const upcoming = items.filter(item => { const t = new Date(item.timestamp); if (item.isTodo && item.done) return false; return !isNaN(t) && t >= now && t <= next7Days; }); const countEl = document.getElementById('dashboard-countdown'); if (upcoming.length > 0) { const first = upcoming[0]; const d = new Date(first.timestamp); const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24)); countEl.textContent = diff <= 0 ? "TODAY" : `D - ${diff}`; } else { countEl.textContent = "FREE"; } const container = document.getElementById('dashboard-next-list'); if (!container) return; container.innerHTML = ''; if (upcoming.length === 0) { container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">æœªä¾† 7 å¤©æ²’æœ‰è¡Œç¨‹ ğŸ˜´</div>`; } else { let html = ''; upcoming.forEach(item => { const date = new Date(item.timestamp); const timeStr = item.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false}); const dateStr = date.toLocaleDateString('zh-TW', {month:'numeric', day:'numeric', weekday:'short'}); let color = '#2cc998'; if (item.isTodo) { color = item.isJoint ? roleColors.joint : (item.creator==='haohao' ? roleColors.haohao : roleColors.maomao); } else { color = item.color; } let tagHtml = item.isTodo ? `<span class="ml-2 text-[10px] border border-gray-200 text-gray-400 px-1 rounded">å¾…è¾¦</span>` : ''; let clickAction = item.isTodo ? `window.openEditTodoModal('${item.id}')` : `window.openEditModal('${item.id}')`; html += `<div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer" onclick="${clickAction}"><div class="w-1 self-stretch rounded-full mr-3" style="background-color: ${color}"></div><div class="flex-1 min-w-0"><div class="flex items-center"><span class="text-sm font-bold text-gray-800 truncate">${item.title}</span>${tagHtml}</div><div class="text-xs text-gray-500 mt-0.5">${dateStr} Â· ${timeStr} ${item.location ? `Â· ${item.location}` : ''}</div></div></div>`; }); container.innerHTML = html; } };
        window.renderCalendarListView = function() { const items = window.getCalendarItems(); const listEl = document.getElementById('event-list'); if(!listEl) return; if (items.length === 0) { listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; } else { window.renderEventListItems(items, listEl); } };

window.renderEventListItems = function(items, container) {
  let html = '';
  items.forEach(e => {
    const date = new Date(e.timestamp);
    if (isNaN(date)) return;

    const timeStr = e.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false});

    // ===== TODO item =====
    if (e.isTodo) {
      const statusClass = e.done ? "line-through text-gray-400" : "text-gray-800";
      const checkIcon = e.done
        ? '<i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>'
        : '<i data-lucide="square" class="w-5 h-5 text-gray-400"></i>';

      const dotColor = e.isJoint ? roleColors.joint : (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);

      const content = `
        <div class="flex p-4 items-center gap-4 hover:bg-gray-50 transition">
          <div class="flex flex-col items-center w-10">
            <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
            <span class="text-xl font-bold text-gray-800 leading-none">${date.getDate()}</span>
          </div>
          <div class="w-1 self-stretch rounded-full" style="background-color:${dotColor}"></div>
          <div class="flex-1 min-w-0 flex items-center justify-between">
            <div>
              <div class="flex items-center gap-2 ${statusClass}">
                <span class="font-bold truncate block">${e.title}</span>
                <span class="text-xs border border-gray-200 px-1 rounded text-gray-400 flex-shrink-0">å¾…è¾¦</span>
              </div>
              <div class="text-xs text-gray-500">${timeStr}</div>
            </div>
          </div>
          <div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${e.id}', ${!e.done}); event.stopPropagation();">${checkIcon}</div>
        </div>`;

      html += `
        <div class="swipe-row mx-3 my-2 border border-gray-100 shadow-sm" data-swipe="row">
          <div class="swipe-actions" data-swipe="actions">
            <button class="swipe-delete-btn" onclick="window.deleteTodoFromSwipe('${e.id}'); event.stopPropagation();">åˆªé™¤</button>
          </div>
          <div class="swipe-content card-press" data-swipe="content" onclick="window.openEditTodoModal('${e.id}')">
            ${content}
          </div>
        </div>`;
      return;
    }

    // ===== Event item =====
    let ic = '';
    if (e.category === 'travel') ic = 'plane';
    else if (e.category === 'appointment') ic = 'scissors';
    else if (e.category === 'gathering') ic = 'users';
    else if (e.category === 'vacation') ic = 'palmtree';

    const ico = ic ? `<i data-lucide="${ic}" class="w-3 h-3 text-gray-400"></i>` : '';

    let st = '';
    if (e.status === 'tbc') st = `<span class="status-tag tbc">TBC</span>`;
    else if (e.status === 'tbd') st = `<span class="status-tag tbd">TBD</span>`;

    let av = `<div class="avatar-sm z-20" style="background-color:${roleColors[e.creator]||'#2cc998'}">${e.creator==='haohao'?'çš“':'æ¯›'}</div>`;
    if (e.isJoint) {
      const p = e.creator === 'haohao' ? 'maomao' : 'haohao';
      av += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]||'#e6688d'}">${p==='haohao'?'çš“':'æ¯›'}</div>`;
    }

    const eventContent = `
      <div class="flex p-4 items-start gap-4 hover:bg-gray-50 transition">
        <div class="flex flex-col items-center w-10 pt-1">
          <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
          <span class="text-xl font-bold text-gray-800 leading-none" style="color:${e.color}">${date.getDate()}</span>
        </div>
        <div class="w-1 self-stretch rounded-full" style="background-color:${e.color}"></div>
        <div class="flex-1 min-w-0 pt-1">
          <div class="flex items-center gap-1">
            ${ico}
            <h4 class="font-bold text-gray-800 truncate">${e.title}</h4>
            ${st}
          </div>
          <div class="text-xs text-gray-500">${timeStr} ${e.location ? 'Â· ' + e.location : ''}</div>
        </div>
        <div class="flex items-center self-center -space-x-1 pl-2">${av}</div>
      </div>`;

    html += `
      <div class="swipe-row mx-3 my-2 border border-gray-100 shadow-sm" data-swipe="row">
        <div class="swipe-actions" data-swipe="actions">
          <button class="swipe-delete-btn" onclick="window.deleteEventFromSwipe('${e.id}'); event.stopPropagation();">åˆªé™¤</button>
        </div>
        <div class="swipe-content card-press" data-swipe="content" onclick="window.openEditModal('${e.id}')">
          ${eventContent}
        </div>
      </div>`;
  });

  container.innerHTML = html;

  if (typeof lucide !== 'undefined') {
    lucide.createIcons({ root: container });
  }

  if (window.bindSwipeToDelete) {
    window.bindSwipeToDelete(container);
  }
};

        window.toggleAllDay = function() { const isChecked = document.getElementById('check-allday').checked; document.querySelectorAll('.dt-wrapper-time').forEach(d => d.style.display = isChecked ? 'none' : 'block'); };
        window.toggleRecurring = function() { const isChecked = document.getElementById('check-recurring').checked; const opts = document.getElementById('recurring-options'); if(isChecked) { opts.classList.remove('hidden'); if(!document.getElementById('input-recur-until').value) document.getElementById('input-recur-until').value = document.getElementById('input-date-end').value; } else opts.classList.add('hidden'); };
        window.toggleTravelFields = function() { const type = document.getElementById('input-transport-type').value; const isPlane = type === 'plane'; document.getElementById('travel-region-intl').classList.toggle('hidden', !isPlane); document.getElementById('travel-region-tw').classList.toggle('hidden', isPlane); };
        window.toggleBooked = function() { const isChecked = document.getElementById('check-booked').checked; const txt = document.getElementById('appoint-status-text'); txt.textContent = isChecked ? "å·²é ç´„" : "æœªå®Œæˆ"; txt.className = isChecked ? "text-xs font-bold text-purple-600" : "text-xs text-gray-500"; };
window.togglePartner = function() {
  const isChecked = document.getElementById('check-partner').checked;
  updateParticipantsPreview();

  colorPickerTarget = 'event';

  window.updateAddSaveButtonUI();

  if (isChecked) {
    currentSelectedColor = roleColors.joint;
  } else {
    currentSelectedColor = roleColors[currentUserRole];
  }

};
window.saveEvent = function () {
  if (!db) {
    window.showToast('è³‡æ–™åº«å°šæœªé€£ç·š');
    return;
  }

  // é˜²é€£é»
  if (window.__savingEvent) return;
  window.__savingEvent = true;

    const saveBtn = document.getElementById('add-save-btn');

  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­â€¦';
    saveBtn.classList.add('opacity-60');
  }

  try {
    const title = document.getElementById('input-title')?.value?.trim();
    if (!title) {
      window.showToast('è«‹å¡«å¯«æ¨™é¡Œ');
      throw new Error('Missing title');
    }

    const startDate = document.getElementById('input-date-start')?.value;
const startTimeRaw = document.getElementById('input-time-start')?.value || '';
const startTime = startTimeRaw.trim(); // å¯èƒ½æ˜¯ '' æˆ– '14:00'

const allDay = !startTime;
const timeForTs = startTime || '00:00';
const timestamp = new Date(`${startDate}T${timeForTs}`).toISOString();

const data = {
  title,
  startDate,
  startTime: startTime || null,     // â­é¸å¡«
  timestamp,
  allDay,                           // â­è‡ªå‹•åˆ¤æ–·
  location: document.getElementById('input-location')?.value?.trim() || '', // â­é¸å¡«
  note: document.getElementById('input-note')?.value || '',
  isJoint: document.getElementById('check-partner')?.checked || false,
  status: document.getElementById('input-status')?.value || 'confirmed',
  creator: currentUserRole,
  color: currentSelectedColor,
  createdAt: new Date().toISOString()
};

    const req = editingEventId
      ? db.collection('events').doc(editingEventId).update(data)
      : db.collection('events').add(data);

    req
      .then(() => {
        window.showToast('è¡Œç¨‹å·²å„²å­˜');
        window.closeAddModal();
      })
      .catch(err => {
        console.error(err);
        window.showToast('å„²å­˜å¤±æ•—');
      })
      .finally(() => {
        window.__savingEvent = false;
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'ä¿å­˜';
          saveBtn.classList.remove('opacity-60');
        }
      });

  } catch (err) {
    window.__savingEvent = false;
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = 'ä¿å­˜';
      saveBtn.classList.remove('opacity-60');
    }
  }
};

        window.deleteCurrentEvent = function() { if(!editingEventId){ window.showToast("ç„¡æ³•è­˜åˆ¥ ID"); return; } window.confirmDelete(); };
        window.confirmDelete = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10); };
        window.closeConfirmModal = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('visible'); setTimeout(() => m.classList.add('hidden'), 200); };
        window.executeDelete = function() { if(editingEventId) { db.collection('events').doc(editingEventId).delete().then(() => { window.closeConfirmModal(); window.closeAddModal(); window.showToast('è¡Œç¨‹å·²åˆªé™¤'); }).catch(e => { console.error(e); window.showToast('åˆªé™¤å¤±æ•—'); }); } };
window.openAddModal = function () {
  try {
    // é€²å…¥ã€Œæ–°å¢ã€æ¨¡å¼
    editingEventId = null;
    if (typeof window.setEventModalMode === 'function') window.setEventModalMode('add');

    // æ¸…æ¬„ä½ï¼ˆå…¨éƒ¨ç”¨é˜²å‘†ï¼Œé¿å…æŠ“ä¸åˆ°å…ƒç´ ç›´æ¥å™´éŒ¯ï¼‰
    const titleEl = document.getElementById('input-title');
    if (titleEl) titleEl.value = '';

    const noteEl = document.getElementById('input-note');
    if (noteEl) noteEl.value = '';

    const dateStartEl = document.getElementById('input-date-start');
    if (dateStartEl) dateStartEl.value = '';

    document.getElementById('input-time-start').value = '';
    document.getElementById('input-location').value = '';

    // æ—¥æœŸé¡¯ç¤ºï¼ˆè‹¥ä½ æœ‰ updateDateDisplayï¼‰
    if (typeof window.updateDateDisplay === 'function') window.updateDateDisplay('start', '');

    const partnerEl = document.getElementById('check-partner');
    if (partnerEl) partnerEl.checked = false;

    // ç‹€æ…‹é è¨­ confirmed
    window.setStatus?.('confirmed');

    // é¡è‰²é è¨­
    if (typeof roleColors !== 'undefined' && typeof currentUserRole !== 'undefined') {
      currentSelectedColor = roleColors[currentUserRole];
    }
    colorPickerTarget = 'event';

    // è§£é™¤å„²å­˜é–
    window.__savingEvent = false;
    window.updateEventSaveState?.();
    if (typeof window.updateAddSaveButtonUI === 'function') window.updateAddSaveButtonUI();

    // æ‰“é–‹ modal
    const m = document.getElementById('add-modal');
    if (!m) {
      console.error('[openAddModal] æ‰¾ä¸åˆ° #add-modal');
      return;
    }
    m.classList.remove('hidden');
    requestAnimationFrame(() => m.classList.add('visible'));
  } catch (err) {
    console.error('[openAddModal] error:', err);
    alert('æ–°å¢è¦–çª—æ‰“ä¸é–‹ï¼šè«‹é–‹ Console çœ‹éŒ¯èª¤è¨Šæ¯ï¼ˆæˆ‘å·²æŠŠéŒ¯èª¤å°å‡ºï¼‰ã€‚');
  }
};
window.openEditModal = function (id) {
  const evt = allEventsCache.find(e => e.id === id);
  if (!evt) {
    window.showToast('æ‰¾ä¸åˆ°è¡Œç¨‹');
    return;
  }

  editingEventId = id;
  const delBtn = document.getElementById('btn-delete');
if (delBtn) delBtn.classList.remove('hidden');

  // === æ¨™é¡Œ ===
  document.getElementById('input-title').value = evt.title || '';

  // === æ—¥æœŸ ===
  if (evt.startDate) {
    document.getElementById('input-date-start').value = evt.startDate;
    window.updateDateDisplay('start', evt.startDate);
  } else if (evt.timestamp) {
    const d = new Date(evt.timestamp);
    const ds = d.toISOString().split('T')[0];
    document.getElementById('input-date-start').value = ds;
    window.updateDateDisplay('start', ds);
  }
    document.getElementById('input-time-start').value = evt.startTime || '';
    document.getElementById('input-location').value = evt.location || '';
  // === ä¸€èµ· / ä¸ä¸€èµ· ===
  const partner = document.getElementById('check-partner');
  partner.checked = !!evt.isJoint;

  // === ç‹€æ…‹ ===
  window.setStatus(evt.status || 'confirmed');

  // === å‚™è¨» ===
  document.getElementById('input-note').value = evt.note || '';

  // === é¡è‰²é‚è¼¯ï¼ˆåªä¿ç•™è³‡æ–™ï¼Œä¸ç¢° UIï¼‰===
  currentSelectedColor = evt.color || roleColors[evt.creator] || roleColors[currentUserRole];
  colorPickerTarget = 'event';

  // === é–‹ modal ===
  window.updateAddSaveButtonUI();

  const m = document.getElementById('add-modal');
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};
 window.openAddTodoModal = function() { editingTodoId = null; document.getElementById('todo-modal-title').textContent = 'æ–°å¢å¾…è¾¦äº‹é …'; document.getElementById('todo-modal-btn').textContent = 'æ–°å¢å¾…è¾¦'; document.getElementById('todo-input-title').value = ''; document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; document.getElementById('display-date-todo').textContent = '--/--/--'; document.getElementById('display-time-todo').value = ''; document.getElementById('todo-check-joint').checked = false; document.getElementById('todo-check-calendar').checked = false; window.checkTodoCalendarOption(); const m = document.getElementById('add-todo-modal'); window.updateEventSaveState?.();
  m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); };
 window.closeAddModal = function () {
  window.__savingEvent = false;
  const m = document.getElementById('add-modal');
  if (!m) return;
  m.classList.remove('visible');
  setTimeout(() => m.classList.add('hidden'), 200);
};
if (typeof window.updateEventSaveState === 'function') {
  window.updateEventSaveState();
}
        window.openEditTodoModal = function(id) { editingTodoId = id; const todo = allTodosCache.find(t => t.id === id); if(!todo) return; document.getElementById('todo-modal-title').textContent = 'ç·¨è¼¯å¾…è¾¦äº‹é …'; document.getElementById('todo-modal-btn').textContent = 'å„²å­˜ä¿®æ”¹'; document.getElementById('todo-input-title').value = todo.title; if(todo.dueDate) { document.getElementById('input-date-todo').value = todo.dueDate; window.updateDateDisplay('todo', todo.dueDate); } else { document.getElementById('input-date-todo').value = ''; window.updateDateDisplay('todo', ''); } if(todo.dueTime) { document.getElementById('input-time-todo').value = todo.dueTime; document.getElementById('display-time-todo').value = todo.dueTime; } else { document.getElementById('input-time-todo').value = ''; document.getElementById('display-time-todo').value = ''; } document.getElementById('todo-check-joint').checked = todo.isJoint; document.getElementById('todo-check-calendar').checked = todo.addToCalendar; window.checkTodoCalendarOption(); const m = document.getElementById('add-todo-modal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); };
        window.closeAddTodoModal = function() { const m = document.getElementById('add-todo-modal'); m.classList.remove('visible'); setTimeout(()=>m.classList.add('hidden'),200); };
        window.checkTodoCalendarOption = function() { const dateVal = document.getElementById('input-date-todo').value; const opt = document.getElementById('todo-calendar-option'); const check = document.getElementById('todo-check-calendar'); if (dateVal) { opt.classList.remove('opacity-50', 'pointer-events-none'); check.disabled = false; } else { opt.classList.add('opacity-50', 'pointer-events-none'); check.disabled = true; check.checked = false; } };
        window.saveTodoItem = function() { const title = document.getElementById('todo-input-title').value; if (!title) { window.showToast('è«‹è¼¸å…¥å…§å®¹'); return; } const date = document.getElementById('input-date-todo').value; const time = document.getElementById('input-time-todo').value; const isJoint = document.getElementById('todo-check-joint').checked; const addToCalendar = document.getElementById('todo-check-calendar').checked; const todoData = { title, done: false, creator: currentUserRole, isJoint: isJoint, addToCalendar: addToCalendar, createdAt: new Date().toISOString() }; if (date) { todoData.dueDate = date; todoData.dueTime = time || null; const tStr = time || "00:00"; todoData.timestamp = new Date(`${date}T${tStr}`).toISOString(); } if(editingTodoId) { db.collection('todos').doc(editingTodoId).update(todoData).then(() => { window.closeAddTodoModal(); window.showToast('å¾…è¾¦äº‹é …å·²æ›´æ–°'); }).catch(err => console.error(err)); } else { db.collection('todos').add(todoData).then(() => { window.closeAddTodoModal(); window.showToast('å¾…è¾¦äº‹é …å·²æ–°å¢'); }).catch(err => console.error(err)); } };
        window.toggleTodo = function(id,s) { db.collection('todos').doc(id).update({done:s}); };
        window.deleteTodo = function(id) { if(confirm('åˆªé™¤?')) db.collection('todos').doc(id).delete(); };
        // ===== Swipe Delete: Unified delete confirm =====
window.__pendingDelete = null;

window.requestDelete = function(type, id) {
  window.__pendingDelete = { type, id };

  // ä½ å·²ç¶“æœ‰ confirm modalï¼Œå°±æ²¿ç”¨
  const m = document.getElementById('confirm-modal');
  if (!m) {
    // æ²’ modal å°±ç›´æ¥åˆªï¼ˆä¿åº•ï¼‰
    return window.executePendingDelete();
  }
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};

window.executePendingDelete = function() {
  if (!db) return;

  const p = window.__pendingDelete;
  if (!p) return;

  const { type, id } = p;

  const ref =
    type === 'todo'
      ? db.collection('todos').doc(id).delete()
      : db.collection('events').doc(id).delete();

  ref.then(() => {
    window.showToast(type === 'todo' ? 'å¾…è¾¦å·²åˆªé™¤' : 'è¡Œç¨‹å·²åˆªé™¤');
  }).catch(err => {
    console.error(err);
    window.showToast('åˆªé™¤å¤±æ•—');
  }).finally(() => {
    window.__pendingDelete = null;
    window.closeConfirmModal?.();
  });
};

// è®“ä½ åŸæœ¬ confirm modal çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•æ²¿ç”¨
// ï¼ˆä½ åŸæœ¬çš„ executeDelete æ˜¯ç”¨ editingEventIdï¼Œæˆ‘å€‘è®“å®ƒå„ªå…ˆèµ° pendingï¼‰
window.executeDelete = function() {
  if (window.__pendingDelete) return window.executePendingDelete();

  // fallbackï¼šä¿ç•™ä½ åŸæœ¬é‚è¼¯ï¼ˆå¦‚æœä½ é‚„æœ‰ editingEventId çš„åˆªé™¤ï¼‰
  if (editingEventId) {
    db.collection('events').doc(editingEventId).delete()
      .then(() => {
        window.closeConfirmModal?.();
        window.closeAddModal?.();
        window.showToast('è¡Œç¨‹å·²åˆªé™¤');
      })
      .catch(e => {
        console.error(e);
        window.showToast('åˆªé™¤å¤±æ•—');
      });
  }
};

// ===== Swipe binder =====

window.deleteEventFromSwipe = function(id) {
  if (!db) return;
  editingEventId = id;
  window.confirmDelete();
};

window.deleteTodoFromSwipe = function(id) {
  if (!db) return;
  // reuse existing deleteTodo (has confirm)
  window.deleteTodo(id);
};

window.bindSwipeToDelete = function(container) {
  if (!container) return;

  const rows = container.querySelectorAll('[data-swipe="row"]');
  rows.forEach(row => {
    if (row.__swipeBound) return;
    row.__swipeBound = true;

    const content = row.querySelector('[data-swipe="content"]');
    const actions = row.querySelector('[data-swipe="actions"]');
    if (!content || !actions) return;

    // compute open width
    const openW = Math.max(72, actions.getBoundingClientRect().width || 88);
    row.style.setProperty('--swipe-open', `${openW}px`);

    let startX = 0;
    let currentX = 0;
    let dragging = false;

    const getX = (e) => (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;

    const start = (e) => {
      // ignore if tapping delete button
      if (e.target && e.target.closest && e.target.closest('.swipe-delete-btn')) return;

      dragging = true;
      startX = getX(e);
      currentX = 0;
      content.style.transition = 'none';
    };

    const move = (e) => {
      if (!dragging) return;

      // prevent page scroll while horizontal swiping

      const dx = getX(e) - startX;
      let tx = Math.min(0, dx); // only allow left swipe
      tx = Math.max(tx, -openW * 1.2); // clamp
      currentX = tx;
      content.style.transform = `translateX(${tx}px)`;
    };

    const end = () => {
      if (!dragging) return;
      dragging = false;
      content.style.transition = 'transform .18s ease';

      const shouldOpen = currentX < -openW * 0.45;
      if (shouldOpen) {
        row.classList.add('open');
        content.style.transform = `translateX(${-openW}px)`;
        if (navigator.vibrate) navigator.vibrate(10);
      } else {
        row.classList.remove('open');
        content.style.transform = 'translateX(0px)';
      }
    };

    // pointer events (recommended)
content.addEventListener('pointerdown', (e) => {
  // åªè™•ç† touch / penï¼Œæ»‘é¼ ç”¨ä½ åŸæœ¬ mousedown ä¹Ÿå¯ä»¥
  if (e.pointerType === 'mouse') return;
  start(e);
  try { content.setPointerCapture(e.pointerId); } catch {}
});

content.addEventListener('pointermove', (e) => {
  if (e.pointerType === 'mouse') return;
  move(e); // ä½ çš„ move() å…§éƒ¨å°±ä¸è¦å†å¼·åˆ¶ preventDefault äº†
});

content.addEventListener('pointerup', () => end());
content.addEventListener('pointercancel', () => end());

    // mouse (desktop testing)
    content.addEventListener('mousedown', (e) => {
      start(e);
      const mm = (ev) => move(ev);
      const mu = () => {
        document.removeEventListener('mousemove', mm);
        document.removeEventListener('mouseup', mu);
        end();
            };
      document.addEventListener('mousemove', mm);
      document.addEventListener('mouseup', mu);
    });

    // tap content while open => close (matches iOS feel)
    content.addEventListener('click', (e) => {
      if (row.classList.contains('open')) {
        e.stopPropagation();
        row.classList.remove('open');
        content.style.transition = 'transform .18s ease';
        content.style.transform = 'translateX(0px)';
      }
    });
  });

  // clicking anywhere else in container closes open rows
  container.addEventListener('click', (e) => {
    const row = e.target.closest?.('[data-swipe="row"]');
    container.querySelectorAll('[data-swipe="row"].open').forEach(r => {
      if (row && r === row) return;
      const c = r.querySelector('[data-swipe="content"]');
      r.classList.remove('open');
      if (c) c.style.transform = 'translateX(0px)';
    });
  }, { capture: true });
};

        window.renderTodos = function(todos) { const jointList=document.getElementById('todo-list-joint'), haohaoList=document.getElementById('todo-list-haohao'), maomaoList=document.getElementById('todo-list-maomao'), dashboardList=document.getElementById('dashboard-todo-list'); if(!jointList) return; jointList.innerHTML=''; haohaoList.innerHTML=''; maomaoList.innerHTML=''; dashboardList.innerHTML=''; let pendingCount=0; todos.forEach(t => { let colorHex = roleColors.haohao; let container = haohaoList; if (t.isJoint) { colorHex = roleColors.joint; container = jointList; } else if (t.creator === 'maomao') { colorHex = roleColors.maomao; container = maomaoList; } let checkStyle = t.done ? `background-color: #d1d5db; border-color: #d1d5db;` : `border-color: ${colorHex};`; let titleClass = t.done ? "text-gray-400 line-through" : "text-gray-800"; if (t.done) { } else { pendingCount++; } let calInfo = t.dueDate ? `<span class="text-[10px] ${t.done?'text-gray-300':'text-gray-400'} ml-2 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</span>` : ''; const html = `<div class="todo-item flex items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm"><div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${t.id}', ${!t.done}); event.stopPropagation();"><div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors text-white" style="${checkStyle}">${t.done?'<i data-lucide="check" class="w-3 h-3"></i>':''}</div></div><div class="flex-1 px-2 cursor-pointer overflow-hidden" onclick="window.openEditTodoModal('${t.id}')"><span class="${titleClass} font-medium truncate block">${t.title}</span>${calInfo}</div><button onclick="window.deleteTodo('${t.id}'); event.stopPropagation();" class="flex-none p-2 text-gray-300 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button></div>`; container.innerHTML += html; }); if (pendingCount === 0) dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">æ²’æœ‰æœªå®Œæˆçš„å¾…è¾¦äº‹é … ğŸ‰</p>`; else { const pendings = todos.filter(t => !t.done).slice(0, 3); pendings.forEach(t => { let dotColor = t.isJoint ? roleColors.joint : (t.creator==='haohao' ? roleColors.haohao : roleColors.maomao); dashboardList.innerHTML += `<div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-100"><div class="w-2 h-2 rounded-full" style="background-color: ${dotColor}"></div><span class="truncate text-gray-700">${t.title}</span></div>`; }); if (todos.filter(t => !t.done).length > 3) dashboardList.innerHTML += `<div class="text-center text-xs text-gray-400 mt-1">é‚„æœ‰ ${todos.filter(t => !t.done).length - 3} å€‹é …ç›®...</div>`; } if(typeof lucide !== 'undefined') lucide.createIcons(); };
        window.openCalendar = function(t) { calTargetInput=t; let v = ''; if (t === 'recur') v = document.getElementById('input-recur-until').value; else if (t === 'todo') v = document.getElementById('input-date-todo').value; else v = document.getElementById(`input-date-${t}`).value; // âœ… å¦‚æœå°šæœªé¸æ—¥æœŸï¼šä½¿ç”¨è€…ã€Œé»äº†æ—¥æœŸã€æ‰è‡ªå‹•å¸¶å…¥ä»Šå¤©
if (!v) {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  v = `${yyyy}-${mm}-${dd}`;

  document.getElementById(`input-date-${t}`).value = v;

  // æ›´æ–°é¡¯ç¤ºï¼ˆç”¨ä½ åŸæœ¬çš„æ ¼å¼ï¼‰
  const disp = document.getElementById(`display-date-${t}`);
  if (disp) disp.textContent = window.formatDisplayDate?.(v) || v;
}calCurrentDate=v?new Date(v):new Date(); if(isNaN(calCurrentDate.getTime())) calCurrentDate = new Date(); window.renderCalendarModal(); const m=document.getElementById('calendar-picker-modal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); };
        window.closeCalendar = function() { const m=document.getElementById('calendar-picker-modal'); m.classList.remove('visible'); setTimeout(()=>m.classList.add('hidden'),200); };
        window.selectCalDate = function(y,m,d) { const s=`${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`; if(calTargetInput==='recur') { document.getElementById('input-recur-until').value=s; window.updateDateDisplay('recur',s); } else if(calTargetInput==='todo') { document.getElementById('input-date-todo').value=s; window.updateDateDisplay('todo',s); window.checkTodoCalendarOption(); } else { document.getElementById(`input-date-${calTargetInput}`).value=s; window.updateDateDisplay(calTargetInput,s); }
  window.updateAddSaveButtonUI(); window.closeCalendar(); if(calTargetInput==='start') window.autoUpdateEnd(); else if(calTargetInput==='end') window.checkEndDateValidity(); };
        window.updateEventSaveState?.();
        window.changeCalMonth = function(offset) {
  calCurrentDate.setMonth(calCurrentDate.getMonth() + offset);
  window.renderCalendarModal();
};

        window.renderCalendarModal = function() {
  const y = calCurrentDate.getFullYear();
  const m = calCurrentDate.getMonth();
  const t = new Date();

  document.getElementById('cal-month-title').textContent =
    `${y}å¹´${m+1}æœˆ`;

  const dim = new Date(year, month+1, 0).getDate();
  const sd  = new Date(year, month, 1).getDay();

  let h = '';

  // æœˆåˆç©ºç™½
  for (let i = 0; i < sd; i++) {
    h += `<div class="cal-day empty"></div>`;
  }

  // æ—¥æœŸ
  for (let d = 1; d <= dim; d++) {
    const isT = (
      y === t.getFullYear() &&
      m === t.getMonth() &&
      d === t.getDate()
    );
    const selected =
  calTargetInput &&
  document.getElementById(`input-date-${calTargetInput}`)?.value ===
  `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;

h += `<div class="cal-day ${isT?'today':''} ${selected?'selected':''}"
          onclick="window.selectCalDate(${y},${m},${d})">${d}</div>`;
  }

  // â­ è£œé½Šå°¾å·´ï¼ˆé—œéµï¼‰
  const totalCells = sd + dim;
  const remainder = totalCells % 7;
  if (remainder !== 0) {
    for (let i = 0; i < 7 - remainder; i++) {
      h += `<div class="cal-day empty"></div>`;
    }
  }

  document.getElementById('calendar-days').innerHTML = h;
};
        window.selectToday = function() { window.selectCalDate(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()); };
        window.initInputListeners = function() { document.addEventListener('click',e=>{ const p=document.getElementById('time-picker-dropdown'); if(p && !p.classList.contains('hidden') && !e.target.closest('.dt-wrapper-time') && !e.target.closest('.time-dropdown')) { p.classList.add('hidden'); } }); };
        window.openTimePicker = function(t) { const p=document.getElementById('time-picker-dropdown'), w=document.getElementById(`display-time-${t}`).parentElement; let h=''; // âœ… å¦‚æœå°šæœªé¸æ™‚é–“ï¼šä½¿ç”¨è€…ã€Œé»äº†æ™‚é–“ã€æ‰è‡ªå‹•å¸¶å…¥ç¾åœ¨æ™‚é–“ï¼ˆé…åˆ 30 åˆ†é˜é¸é …ï¼‰
const timeInput = document.getElementById(`input-time-${t}`);
if (timeInput && !timeInput.value) {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');

  // ä½ çš„é¸é …æ˜¯æ¯ 30 åˆ†é˜ä¸€æ ¼ï¼Œæ‰€ä»¥æŠŠåˆ†é˜ã€Œå››æ¨äº”å…¥åˆ° 00/30ã€
  const mRaw = now.getMinutes();
  const m = (mRaw < 15) ? '00' : (mRaw < 45 ? '30' : '00');
  const hh = (mRaw >= 45) ? String((now.getHours() + 1) % 24).padStart(2, '0') : h;

  const v = `${hh}:${m}`;
  timeInput.value = v;
  window.updateTimeDisplay?.(t, v);

  // å¦‚æœä½ æœ‰ã€Œé–‹å§‹æ™‚é–“ -> è‡ªå‹•æ›´æ–°çµæŸæ™‚é–“ã€çš„é‚è¼¯ï¼Œé€™è£¡é †ä¾¿å¸¶ä¸€ä¸‹
  if (t === 'start') window.autoUpdateEnd?.();
}for(let i=0;i<24;i++) for(let j=0;j<60;j+=30) { let s=`${i.toString().padStart(2,'0')}:${j.toString().padStart(2,'0')}`; h+=`<div class="time-option" onmousedown="window.setTime('${t}','${s}')">${s}</div>`; } p.innerHTML=h; p.style.top=(w.offsetTop+w.offsetHeight+5)+'px'; p.style.left=w.offsetLeft+'px'; p.style.width=w.offsetWidth+'px'; p.dataset.target=t; p.classList.remove('hidden'); };
        window.setTime = function(t,v) { document.getElementById(`input-time-${t}`).value=v; window.updateTimeDisplay(t,v); document.getElementById('time-picker-dropdown').classList.add('hidden'); if(t==='start') window.autoUpdateEnd(); else if(t==='end') window.checkEndDateValidity(); };
        window.handleTimeInput = function(t,v) { if(v.length===2 && !v.includes(':') && /^\d+$/.test(v)) document.getElementById(`display-time-${t}`).value=v+':'; };
        window.validateTimeInput = function(t,el) { let v=el.value.trim(), m=v.match(/^(\d{1,2}):?(\d{1,2})?$/); if(m){ let h=parseInt(m[1]), min=m[2]?parseInt(m[2]):0; if(h>=0&&h<24&&min>=0&&min<60){ const f=`${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`; el.value=f; document.getElementById(`input-time-${t}`).value=f; if(t==='start') window.autoUpdateEnd(); else if(t==='end') window.checkEndDateValidity(); return; } } el.value=document.getElementById(`input-time-${t}`).value||'--:--'; }
        window.switchTab = function(tab) { document.querySelectorAll('.page-content').forEach(e=>e.classList.remove('active')); const t=document.getElementById(`page-${tab}`); if(t) t.classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); const map={'dashboard':0,'calendar':1,'todo':2,'settings':3}; const navs=document.querySelectorAll('.nav-item'); if(navs[map[tab]]) navs[map[tab]].classList.add('active'); if(typeof lucide !== 'undefined') lucide.createIcons(); }
        window.switchCalendarView = function(mode) { currentViewMode=mode; const l=document.getElementById('calendar-view-list'), m=document.getElementById('calendar-view-month'); const bl=document.getElementById('btn-view-list'), bm=document.getElementById('btn-view-month'); if(mode==='list') { l.classList.remove('hidden'); m.classList.add('hidden'); bl.className="px-4 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all"; bm.className="px-4 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all"; } else { l.classList.add('hidden'); m.classList.remove('hidden'); bm.className="px-4 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all"; bl.className="px-4 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all"; window.renderBigCalendar(); window.selectBigCalendarDate(new Date()); } }
        window.changeBigCalMonth = function(d) { bigCalDate.setMonth(bigCalDate.getMonth()+d); window.renderBigCalendar(); }
        window.renderBigCalendar = function() {
  if (currentViewMode !== 'month') return;

  const year = bigCalDate.getFullYear();
  const month = bigCalDate.getMonth();
  const today = new Date();

  document.getElementById('big-cal-title').textContent =
    `${year}å¹´${month+1}æœˆ`;

  const dim = new Date(year, month+1, 0).getDate();
  const sd  = new Date(year, month, 1).getDay();
  const g   = document.getElementById('big-cal-grid');
  if (!g) return;

  let html = '';
  for (let i = 0; i < sd; i++) {
    html += `<div class="bg-gray-50 border-b border-r border-gray-100 min-h-[85px]"></div>`;
  }

  const items = window.getCalendarItems();
  for (let d = 1; d <= dim; d++) {
    const ds = new Date(year, month, d);
    const de = new Date(year, month, d, 23,59,59);
    const dayItems = items.filter(e => {
      const t = new Date(e.timestamp);
      return t >= ds && t <= de;
    });

    let bars = '';
    dayItems.slice(0,3).forEach(e => {
      if (e.isTodo) {
        const s = e.done
          ? 'bg-gray-300 line-through text-gray-500'
          : 'bg-gray-400 text-white';
        bars += `<div class="event-bar ${s}">âœ“ ${e.title}</div>`;
      } else {
        bars += `<div class="event-bar" style="background-color:${e.color || '#2cc998'}">${e.title}</div>`;
      }
    });
    if (dayItems.length > 3) {
      bars += `<div class="more-events">+${dayItems.length-3}</div>`;
    }

    const isToday =
      year===today.getFullYear() &&
      month===today.getMonth() &&
      d===today.getDate();

    html += `
      <div class="big-cal-cell border-b border-r border-gray-100 ${isToday?'today':''}"
           id="big-cal-day-${d}"
           onclick="window.selectBigCalendarDate(${year},${month},${d})">
        <div class="big-cal-day-num">${d}</div>
        <div style="width:100%;margin-top:2px;">${bars}</div>
      </div>`;
  }

  g.innerHTML = html;
};
        
        window.selectBigCalendarDate = function(y,m,d) { document.querySelectorAll('.big-cal-cell.selected').forEach(e=>e.classList.remove('selected')); if(m===bigCalDate.getMonth()) { const el=document.getElementById(`big-cal-day-${d}`); if(el) el.classList.add('selected'); } document.getElementById('selected-date-label').textContent = `${y}å¹´${m+1}æœˆ${d}æ—¥`; const listEl = document.getElementById('month-event-list'); if(!listEl) return; const items = window.getCalendarItems(); const ds=new Date(y, m, d), de=new Date(y, m, d, 23,59,59); const dayEvents = items.filter(e => { const t = new Date(e.timestamp); return t>=ds && t<=de; }); if(dayEvents.length===0) listEl.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">é€™å¤©æ²’æœ‰å®‰æ’è¡Œç¨‹ ğŸ˜´</div>`; else window.renderEventListItems(dayEvents, listEl); };
function initApp(db) {
  if (!db) {
    console.error("Firebase not initialized");
    return;
  }

  // connection indicator
  const conn = document.getElementById('connection-status');
  if (conn) {
    conn.className = "w-2 h-2 rounded-full bg-ttgreen shadow-[0_0_8px_#2cc998]";
  }

  /* ===== STABLE PATCH: Events Snapshot ===== */
  bindSnapshot(
    db.collection('events').orderBy('timestamp', 'asc'),
    (snapshot) => {
      const events = [];
      snapshot.forEach(doc =>
        events.push({ id: doc.id, ...doc.data() })
      );
      allEventsCache = events;

      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-events'
      );
      safeRun(
        () => window.renderCalendarListView(),
        'calendar-list'
      );

      // Big Calendar åªåœ¨æœˆæ›†æ¨¡å¼æ‰æ¸²æŸ“
      if (currentViewMode === 'month') {
        safeRun(() => window.renderBigCalendar(), 'big-calendar');
      }
    },
    'events'
  );

  /* ===== STABLE PATCH: Todos Snapshot ===== */
  bindSnapshot(
    db.collection('todos').orderBy('createdAt', 'desc'),
    (snapshot) => {
      const todos = [];
      snapshot.forEach(doc =>
        todos.push({ id: doc.id, ...doc.data() })
      );
      allTodosCache = todos;

      safeRun(() => window.renderTodos(todos), 'todos');
      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-todos'
      );
    },
    'todos'
  );

  /* ===== STABLE PATCH: Status Snapshot ===== */
  bindSnapshot(
    db.collection('status').doc('current'),
    (doc) => {
      if (doc.exists) {
        // â­ Now window.renderStatus exists and is safe to call
        safeRun(() => window.renderStatus?.(doc.data()), 'status');
      }
    },
    'status'
  );
}



 
/* ===== STABLE PATCH: App Bootstrap ===== */
document.addEventListener('DOMContentLoaded', () => {
  safeRun(() => {
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();


    // Add modal save btn state
    const titleInput = document.getElementById('input-title');
    if (titleInput && !titleInput.dataset.boundSaveUi) {
      titleInput.addEventListener('input', () => window.updateAddSaveButtonUI());
      titleInput.dataset.boundSaveUi = '1';
    }
    }

    // â­ åˆå§‹åŒ– Active Tab æŒ‡ç¤ºç·šé¡è‰²
    document.documentElement.style.setProperty(
      '--active-tab-color',
      roleColors[currentUserRole]
    );

    if (db) {
      initApp(db);
    }
  }, 'bootstrap');
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const isHttp = location.protocol === 'https:' || location.protocol === 'http:';
    if (!isHttp) {
      // ä½ ç”¨ file:// é–‹å•Ÿæ™‚æœƒæ˜¯ null originï¼ŒSW ä¸èƒ½è¨»å†Šï¼Œé¿å… console é»ƒè‰²è­¦å‘Š
      return;
    }

    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.warn('SW skipped/failed', err));
  });
}

/* ===== PWA Resume Guard (iOS) ===== */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    safeRun(() => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      if (currentViewMode === 'month') {
        window.renderBigCalendar();
      }
    }, 'resume');
  }
});

</script>

</body>
</html>
