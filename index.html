<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>æˆ‘å€‘çš„å°æ™‚å…‰</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ttgreen: '#2cc998', 
                        ttred: '#e95d5d',   
                        ttgray: '#f5f5f5',  
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #ffffff; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #main-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        .page-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding-top: 70px; 
            padding-bottom: 90px;
            background-color: #f9fafb;
            display: none; 
        }
        .page-content.active { display: block; }
        
        #page-calendar.active {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            padding-top: 60px; 
            padding-bottom: 70px;
        }
        
        .nav-item.active { color: #2cc998; } 
        .nav-item.active svg { stroke-width: 2.5px; }

        .tt-input-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tt-input-row:active { background-color: #f9fafb; }
        .tt-icon { color: #9ca3af; margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; }
        
        .modal { transition: opacity 0.2s ease, transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.visible { opacity: 1; pointer-events: auto; transform: scale(1); }

        .custom-checkbox { appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor; width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #2cc998; border-color: #2cc998; }
        .custom-checkbox:checked::before { transform: scale(1); }
        
        .cat-chip { padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; border: 1px solid #e5e7eb; background: white; color: #6b7280; white-space: nowrap; transition: all 0.2s; }
        .cat-chip.active { background: #2cc998; color: white; border-color: #2cc998; box-shadow: 0 2px 5px rgba(44, 201, 152, 0.2); }

        .todo-item { transition: all 0.3s ease; }
        .todo-item.done span { text-decoration: line-through; color: #9ca3af; }

        .dt-btn { background-color: #f9fafb; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; color: #374151; text-align: center; transition: all 0.2s; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .dt-btn:active, .dt-btn:focus { background-color: #fff; border: 1px solid #2cc998; outline: none; }
        .dt-wrapper-date { flex: 2; position: relative; }
        .dt-wrapper-time { flex: 1; position: relative; }

        /* ===== UPDATED: Unified Input Row Styles ===== */
        .dt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            /* Border logic handled by HTML classes now for better control */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dt-row:active { background-color: #f9fafb; }
        
        .dt-label {
            font-size: 15px; /* Slightly larger */
            font-weight: 500;
            color: #1f2937; /* Darker gray */
            min-width: 60px;
        }
        
        .dt-value {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }
        
        /* Unified Input Style */
        .dt-input {
            width: 100%;
            text-align: right;
            font-size: 15px; 
            color: #1f2937;
            outline: none;
            border: none;
            background: transparent;
            padding: 0;
            font-weight: 400;
        }
        .dt-input::placeholder {
            color: #9ca3af; /* Matches the chevron color */
        }
        
        /* Text placeholder for Date/Time spans */
        .dt-text-placeholder {
            color: #9ca3af;
            font-size: 15px;
        }
        .dt-text-value {
            color: #1f2937; /* Dark */
            font-size: 15px;
            font-weight: 500;
        }

        /* Fixed Time Dropdown Modal Style */
        .time-picker-modal-content {
            background: white;
            border-radius: 16px;
            max-height: 300px;
            overflow-y: auto;
            width: 280px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        .time-option { 
            padding: 10px 16px; 
            font-size: 16px; 
            color: #374151; 
            cursor: pointer; 
            text-align: center;
        }
        .time-option:hover { background-color: #f3f4f6; }
        .time-option.selected { color: #2cc998; font-weight: bold; background-color: #ecfdf5; }

        .status-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #6b7280; transition: all 0.2s; }
        .status-btn.active { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; font-weight: bold; }
        .status-btn.active[data-status="confirmed"] { background: #ecfdf5; border-color: #2cc998; color: #2cc998; }
        .status-btn.active[data-status="tbc"] { background: #fffbeb; border-color: #f59e0b; color: #f59e0b; }
        .status-btn.active[data-status="tbd"] { background: #fef2f2; border-color: #ef4444; color: #ef4444; border-style: dashed; }

        .status-tag { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: 1px; line-height: 1.4; flex-shrink: 0; }
        .status-tag.tbc { border: 1px solid #f59e0b; color: #f59e0b; background: #fffbeb; }
        .status-tag.tbd { border: 1px dashed #ef4444; color: #ef4444; background: #fef2f2; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Big Calendar View Styles */
        .big-cal-header { font-size: 13px; color: #9ca3af; text-align: center; padding-bottom: 8px; font-weight: 500; }
        .big-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #f3f4f6; border: 1px solid #f3f4f6; }
        .big-cal-cell { 
            background-color: white; 
            min-height: 85px; 
            padding: 2px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative; 
            cursor: pointer; 
            overflow: hidden;
        }
        .big-cal-cell.today { background-color: #f8fafc; }
        .big-cal-cell.selected { background-color: #ecfdf5; box-shadow: inset 0 0 0 2px #2cc998; }
        .big-cal-day-num { 
            font-size: 12px; 
            font-weight: 500; 
            color: #374151; 
            margin-bottom: 2px; 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
        }
        .big-cal-cell.today .big-cal-day-num { background-color: #2cc998; color: white; }
        .event-bar { width: 100%; font-size: 9px; line-height: 1.2; padding: 2px 3px; border-radius: 2px; background-color: #2cc998; color: white; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .event-bar.done { text-decoration: line-through; opacity: 0.6; }
        .more-events { font-size: 9px; color: #9ca3af; margin-top: 1px; }

        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { font-size: 12px; color: #9ca3af; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 50%; cursor: pointer; color: #374151; }
        .cal-day:hover { background-color: #f3f4f6; }
        .cal-day.empty { cursor: default; background: none; }
        .cal-day.selected { background-color: #2cc998; color: white; font-weight: bold; }
        .cal-day.today { color: #2cc998; font-weight: bold; }
        .cal-day:nth-child(7n), .cal-day-header:nth-child(7) { color: #f87171; } 
        .cal-day:nth-child(7n+1), .cal-day-header:nth-child(1) { color: #f87171; } 

        .avatar-sm { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #toast-container { transition: opacity 0.3s ease; }
        #toast-container.visible { opacity: 1; }
        /* ===== Calendar Grid Fix (7 columns align) ===== */
        .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        /* ===== FIX: Calendar Picker Height ===== */
        #calendar-picker-modal .calendar-grid {
        min-height: auto;
        }

        #calendar-picker-modal #calendar-days {
        min-height: unset;
        }
        /* ===== iOS-like Calendar Picker ===== */

        /* æ•´å€‹æ—¥æœŸ grid æ›´ç·Šæ¹Š */
        #calendar-picker-modal .calendar-grid {
        gap: 6px;
        }

        /* æ—¥æœŸæ ¼å­ï¼šåœ“å½¢ã€ç„¡å¤–æ¡† */
        #calendar-picker-modal .cal-day {
        width: 36px;
        height: 36px;
        aspect-ratio: unset;
        border-radius: 9999px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.15s ease, color 0.15s ease;
        }

        /* Hoverï¼ˆåƒ iOS è¼•è§¸ï¼‰ */
        #calendar-picker-modal .cal-day:hover {
        background-color: #f2f2f7;
        }

        /* ä»Šå¤©ï¼ˆiOS å¸¸ç”¨ã€Œå­—è‰²æç¤ºã€ï¼‰ */
        #calendar-picker-modal .cal-day.today {
        color: #2cc998;
        font-weight: 600;
        }

        /* é¸ä¸­æ—¥æœŸï¼ˆiOS æ ¸å¿ƒï¼‰ */
        #calendar-picker-modal .cal-day.selected {
        background-color: #2cc998;
        color: white;
        font-weight: 600;
        }

        /* ç©ºç™½æ ¼å®Œå…¨ä¸å¯é» */
        #calendar-picker-modal .cal-day.empty {
        pointer-events: none;
        background: transparent;
        }

        /* æ˜ŸæœŸæ¨™é¡Œæ›´åƒ iOS */
        #calendar-picker-modal .cal-day-header {
        font-size: 11px;
        font-weight: 500;
        color: #8e8e93;
        }

        /* æ•´å€‹ modal é«˜åº¦ç¸®çŸ­ */
        #calendar-picker-modal .relative {
        padding-bottom: 12px;
        }
        /* ===== iOS Bottom Nav Touch Fix ===== */
        nav .nav-item {
        padding-bottom: 6px;
        }
        /* ===== iOS-like Bottom Tab Bounce ===== */

        /* Tab æœ¬é«” */
        nav .nav-item {
        transition:
            transform 0.12s ease-out,
            background-color 0.12s ease-out;
        border-radius: 12px;
        }

        /* iOS Safariï¼šé¿å…é•·æŒ‰å‡ºç¾è—è‰²é®ç½© */
        nav .nav-item {
        -webkit-tap-highlight-color: transparent;
        }
        /* ===== iOS-like Bottom Tab (Icon Only Bounce) ===== */

        /* icon æœ¬é«” */
        nav .nav-item i {
        transition: transform 0.12s ease-out;
        will-change: transform;
        }

        /* æŒ‰ä¸‹æ™‚ï¼šåªæœ‰ icon ç¸® */
        nav .nav-item:active i {
        transform: scale(0.85);
        }

        /* ç›®å‰é ï¼šicon å¾®æ”¾å¤§ */
        nav .nav-item.active i {
        transform: scale(1.1);
        }

        /* æ–‡å­—å®Œå…¨ä¸å‹•ï¼ˆä¿éšªï¼‰ */
        nav .nav-item span {
        transform: none !important;
        }

        /* iOS Safari é˜²è—è‰²é«˜äº® */
        nav .nav-item {
        -webkit-tap-highlight-color: transparent;
        }
        /* ===== iOS-like Active Tab Indicator ===== */

        /* nav-item è®Šæˆå®šä½å®¹å™¨ */
        nav .nav-item {
        position: relative;
        }

        /* ä½¿ç”¨ CSS è®Šæ•¸æ§åˆ¶é¡è‰² */
        nav .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 3px;
        border-radius: 999px;
        background-color: var(--active-tab-color, #2cc998);
        }
        
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden bg-white">

    <!-- Header -->
    <header class="bg-white border-b border-gray-100 p-4 fixed top-0 w-full z-10 safe-top flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <img src="icon.png" alt="Logo" class="w-8 h-8 rounded-lg shadow-sm">
            
            <h1 class="text-lg font-bold text-gray-800 tracking-wide">
                å°æ™‚å…‰ <span class="text-xs text-gray-400 font-normal">for us</span>
            </h1>
        </div>

        <div class="flex items-center gap-2">
            <div id="connection-status" class="w-2 h-2 rounded-full bg-red-400"></div>
        </div>
    </header>
    <!-- Main Content -->
    <main id="main-container">
        <!-- Page 1: Dashboard -->
 <div id="page-dashboard" class="page-content active">
    
    <div class="mt-6"></div>

    <div class="flex flex-col items-center mb-6 w-full">
        
        <div class="w-full max-w-[320px] px-6 flex justify-between items-start mb-24 relative z-10">
            
            <div class="relative flex flex-col items-center group cursor-pointer" onclick="window.setNoteInputFocus()">
                <div id="avatar-note-haohao" class="w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl font-bold ring-4 ring-white shadow-md z-20 transition-transform active:scale-95" style="background-color: #2cc998;">
                    çš“
                    <div id="status-dot-haohao" class="hidden absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                </div>

                <div id="note-bubble-haohao" class="hidden absolute top-20 opacity-0 transform -translate-y-2 transition-all duration-300 z-30 w-36 flex flex-col items-center pointer-events-none">
                    <div class="w-3 h-3 bg-white transform rotate-45 -mb-1.5 border-t border-l border-gray-100 relative z-20"></div>
                    <div class="relative bg-white border border-gray-100 px-3 py-2.5 rounded-2xl shadow-xl text-xs text-gray-600 w-full text-center leading-relaxed break-words z-10">
                        <span id="note-text-haohao">...</span>
                    </div>
                </div>
            </div>

            <div class="relative flex flex-col items-center group cursor-pointer" onclick="window.setNoteInputFocus()">
                <div id="avatar-note-maomao" class="w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl font-bold ring-4 ring-white shadow-md z-20 transition-transform active:scale-95" style="background-color: #e6688d;">
                    æ¯›
                    <div id="status-dot-maomao" class="hidden absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                </div>

                <div id="note-bubble-maomao" class="hidden absolute top-20 opacity-0 transform -translate-y-2 transition-all duration-300 z-30 w-36 flex flex-col items-center pointer-events-none">
                    <div class="w-3 h-3 bg-white transform rotate-45 -mb-1.5 border-t border-l border-gray-100 relative z-20"></div>
                    <div class="relative bg-white border border-gray-100 px-3 py-2.5 rounded-2xl shadow-xl text-xs text-gray-600 w-full text-center leading-relaxed break-words z-10">
                        <span id="note-text-maomao">...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative w-full max-w-[260px] z-20">
            <div class="flex items-center bg-white rounded-full px-1 py-0.5 shadow-sm border border-gray-200 focus-within:ring-2 focus-within:ring-green-100 focus-within:border-green-300 transition-all">
                <div class="w-8 h-8 flex items-center justify-center text-gray-300">
                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                </div>

<!-- Page 2: Next 7 Days -->
                <input type="text" id="note-input" maxlength="20

    <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4">
        <div class="bg-ttgreen px-4 py-2 flex justify-between items-center">
            <span class="text-white text-xs font-bold tracking-wider">NEXT 7 DAYS</span>
            <span id="dashboard-countdown" class="text-white text-xs bg-white/20 px-2 py-0.5 rounded-full">...</span>
        </div>
        <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
            <div class="text-center py-8 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="check-square" class="w-4 h-4 text-ttgreen"></i> å¾…è¾¦æ¸…å–®
            </h3>
            <button onclick="window.switchTab('todo')" class="text-xs text-ttgreen font-medium">æŸ¥çœ‹å…¨éƒ¨</button>
        </div>
        <div id="dashboard-todo-list" class="space-y-2">
            <p class="text-xs text-gray-400 text-center py-2">è¼‰å…¥ä¸­...</p>
        </div>
    </div>
    
    <div class="px-4 mt-4 flex gap-3 pb-6">
        <button onclick="window.openAddModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
            <i data-lucide="calendar-plus" class="w-5 h-5 text-ttgreen"></i>
            <span class="text-sm font-bold">æ–°å¢è¡Œç¨‹</span>
        </button>
        
        <button onclick="window.openAddTodoModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
            <i data-lucide="check-square" class="w-5 h-5 text-blue-400"></i>
            <span class="text-sm font-bold">æ–°å¢å¾…è¾¦</span>
        </button>
    </div>
</div>

            <!-- Next Up Card -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4 mt-4">
                <div class="bg-ttgreen px-4 py-2 flex justify-between items-center">
                    <span class="text-white text-xs font-bold tracking-wider">NEXT 7 DAYS</span>
                    <span id="dashboard-countdown" class="text-white text-xs bg-white/20 px-2 py-0.5 rounded-full">...</span>
                </div>
                <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
                    <div class="text-center py-8 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- Dashboard Todo Summary -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-ttgreen"></i> å¾…è¾¦æ¸…å–®
                    </h3>
                    <button onclick="window.switchTab('todo')" class="text-xs text-ttgreen font-medium">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div id="dashboard-todo-list" class="space-y-2">
                    <p class="text-xs text-gray-400 text-center py-2">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <div class="px-4 mt-4 flex gap-3 pb-6">
    <button onclick="window.openAddModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
        <i data-lucide="calendar-plus" class="w-5 h-5 text-ttgreen"></i>
        <span class="text-sm font-bold">æ–°å¢è¡Œç¨‹</span>
    </button>
    
    <button onclick="window.openAddTodoModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
        <i data-lucide="check-square" class="w-5 h-5 text-blue-400"></i>
        <span class="text-sm font-bold">æ–°å¢å¾…è¾¦</span>
    </button>
</div>
</div>
        <!-- Page 2: Calendar -->
        <div id="page-calendar" class="page-content">
            <div class="flex-none bg-white z-10 border-b border-gray-200 px-2 py-2 flex items-center justify-between">
                 <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="window.switchCalendarView('list')" id="btn-view-list" class="px-4 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all">åˆ—è¡¨</button>
                    <button onclick="window.switchCalendarView('month')" id="btn-view-month" class="px-4 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">æœˆæ›†</button>
                </div>
                <button onclick="window.openAddModal()" class="text-ttgreen font-medium text-sm flex items-center gap-1 bg-green-50 px-3 py-1.5 rounded-lg">
                    <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢
                </button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 relative w-full">
                <div id="calendar-view-list" class="absolute inset-0 overflow-y-auto">
                    <div id="event-list" class="divide-y divide-gray-100 bg-white">
                        <div class="text-center py-10 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                <div id="calendar-view-month" class="absolute inset-0 overflow-y-auto hidden">
                    <div class="flex justify-between items-center p-4 bg-white">
                        <h2 id="big-cal-title" class="text-lg font-bold text-gray-800">...</h2>
                        <div class="flex gap-2">
                            <button onclick="window.changeBigCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button onclick="window.changeBigCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="bg-white pb-2">
                        <div class="grid grid-cols-7 text-center mb-1">
                            <div class="big-cal-header text-red-400">æ—¥</div><div class="big-cal-header">ä¸€</div><div class="big-cal-header">äºŒ</div><div class="big-cal-header">ä¸‰</div><div class="big-cal-header">å››</div><div class="big-cal-header">äº”</div><div class="big-cal-header text-red-400">å…­</div>
                        </div>
                        <div id="big-cal-grid" class="big-cal-grid border-t border-gray-100"></div>
                    </div>
                    <div class="mt-2 bg-white border-t border-gray-200 min-h-[300px]">
                        <div class="px-4 py-2 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                            <span id="selected-date-label" class="text-sm font-bold text-gray-600">é¸æ“‡æ—¥æœŸæŸ¥çœ‹</span>
                        </div>
                        <div id="month-event-list" class="divide-y divide-gray-100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Todo -->
        <div id="page-todo" class="page-content">
            <div class="sticky top-0 bg-white z-10 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">å¾…è¾¦æ¸…å–®</h2>
                 <button onclick="window.openAddTodoModal()" class="bg-ttgreen text-white p-2 rounded-lg shadow-sm active:scale-95 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="todo-list-container" class="p-4 space-y-6 pb-24">
                <!-- Joint Section -->
                <div>
                     <h3 class="text-sm font-bold text-orange-400 mb-2 flex items-center gap-1">
                        <i data-lucide="users" class="w-4 h-4"></i> å…±åŒå¾…è¾¦
                    </h3>
                    <div id="todo-list-joint" class="space-y-2"></div>
                </div>
                 <!-- Haohao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-ttgreen mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> çš“çš“
                    </h3>
                    <div id="todo-list-haohao" class="space-y-2"></div>
                </div>
                 <!-- Maomao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-pink-400 mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> æ¯›æ¯›
                    </h3>
                    <div id="todo-list-maomao" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Page 4: Settings -->
        <div id="page-settings" class="page-content p-4 space-y-6">
            <h2 class="text-lg font-bold text-gray-800 px-1">è¨­å®š</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-50">
                    <p class="text-sm text-gray-500 mb-3">æˆ‘æ˜¯èª°ï¼Ÿ (åˆ‡æ›èº«åˆ†)</p>
                    <div class="flex gap-2">
                        <button id="role-haohao" onclick="window.setRole('haohao')" class="flex-1 py-3 rounded-lg text-sm font-medium border transition">çš“çš“</button>
                        <button id="role-maomao" onclick="window.setRole('maomao')" class="flex-1 py-3 rounded-lg text-sm font-medium border transition">æ¯›æ¯›</button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 space-y-4">
                    <p class="text-sm text-gray-500 mb-2">ä»£è¡¨è‰²è¨­å®š</p>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('haohao')">
                        <span class="text-sm text-gray-700">çš“çš“</span>
                        <div id="setting-color-haohao" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('maomao')">
                        <span class="text-sm text-gray-700">æ¯›æ¯›</span>
                        <div id="setting-color-maomao" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200" onclick="window.openColorConfig('joint')">
                        <span class="text-sm text-gray-700">å…±åŒè¡Œç¨‹</span>
                        <div id="setting-color-joint" class="w-6 h-6 rounded-full border border-gray-300 shadow-sm"></div>
                    </div>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400 mt-4">Firebase Connected Â· Version 102.8 (Sync Todo to Calendar List)</div>
        </div>
    </main>

    <!-- Global Color Picker Modal -->
    <div id="global-color-picker" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.toggleGlobalColorPicker(false)"></div>
        <div class="relative bg-white w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">é¸æ“‡é¡è‰²</h3>
            <div id="global-color-grid" class="grid grid-cols-1 gap-1 max-h-[300px] overflow-y-auto"></div>
            <button onclick="window.toggleGlobalColorPicker(false)" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeConfirmModal()"></div>
        <div class="relative bg-white w-[280px] rounded-xl shadow-xl p-5 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-4">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œæ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
                <button onclick="window.executeDelete()" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200">åˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[90] pointer-events-none transition-opacity duration-300 opacity-0">
        <div id="toast-message" class="bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur-sm">
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
      <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddModal()"></div>

      <div class="relative bg-white w-full h-full md:h-auto md:w-[380px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
        
        <!-- NEW HEADER: Standard App Style -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
            <button onclick="window.closeAddModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition">å–æ¶ˆ</button>
            <span class="text-sm font-bold text-gray-800">è¡Œç¨‹è©³æƒ…</span>
            <button onclick="window.saveEvent()" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">ä¿å­˜</button>
        </div>

        <!-- Title -->
        <div class="px-6 pt-4 pb-2">
          <label class="text-xs font-bold text-gray-400 mb-1 block">æ¨™é¡Œ</label>
          <input
            type="text"
            id="input-title"
            placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œ"
            class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent"
          />
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">

          <!-- Date / Time / Location Group -->
          <!-- æ¡ç”¨ç™½åº•ã€å…§éƒ¨æœ‰åˆ†éš”ç·šçš„åˆ—è¡¨é¢¨æ ¼ -->
          <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
             
             <!-- Date -->
             <div class="dt-row" onclick="window.openCalendar('start')">
               <div class="dt-label">æ—¥æœŸ</div>
               <div class="dt-value group">
                 <span id="display-date-start" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-start">
             </div>

             <!-- Time -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('start')">
              <div class="dt-label">æ™‚é–“</div>
              <div class="dt-value group">
                <span id="display-time-start" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-start" value="">
            </div>

            <!-- Location -->
            <div class="dt-row border-t border-gray-50">
              <div class="dt-label">åœ°é»</div>
              <div class="dt-value">
                <input id="input-location" type="text" placeholder="è¼¸å…¥åœ°é»" class="dt-input" />
              </div>
            </div>
          </div>

          <!-- Partner -->
          <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
            <span class="text-sm text-gray-700">èˆ‡å°æ–¹ä¸€èµ·</span>
            <input
              type="checkbox"
              id="check-partner"
              class="custom-checkbox"
              onchange="window.togglePartner()"
            />
          </div>

          <!-- Status -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <label class="text-xs font-bold text-gray-400 mb-2 block">ç‹€æ…‹</label>
            <div class="flex gap-2">
              <button
                type="button"
                class="status-btn active"
                data-status="confirmed"
                onclick="window.setStatus('confirmed')"
              >å·²ç¢ºèª</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbc"
                onclick="window.setStatus('tbc')"
              >TBC</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbd"
                onclick="window.setStatus('tbd')"
              >TBD</button>
            </div>
            <input type="hidden" id="input-status" value="confirmed">
          </div>

          <!-- Note -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
            <label class="text-xs font-bold text-gray-400 mb-1 block">å‚™è¨»</label>
            <textarea
              id="input-note"
              rows="3"
              placeholder="ç°¡å–®å‚™è¨»ä¸€ä¸‹å°±å¥½"
              class="w-full text-sm bg-transparent focus:outline-none resize-none"
            ></textarea>
          </div>

        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-100 flex justify-center pb-safe">
          <!-- åˆªé™¤æŒ‰éˆ• (åªåœ¨ç·¨è¼¯æ™‚é¡¯ç¤ºï¼Œå…¨å¯¬ç´…è‰²æŒ‰éˆ•) -->
          <button
            id="btn-delete-event"
            onclick="window.deleteCurrentEvent()"
            class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
          >
            åˆªé™¤æ­¤è¡Œç¨‹
          </button>
        </div>

      </div>
    </div>

    
    <!-- Add Todo Modal -->
    <div id="add-todo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddTodoModal()"></div>
        <div class="relative bg-white w-full h-full md:h-auto md:w-[350px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
            
            <!-- HEADER: Standard App Style (Unified with Add Event) -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
                <button onclick="window.closeAddTodoModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition">å–æ¶ˆ</button>
                <span id="todo-modal-title" class="text-sm font-bold text-gray-800">æ–°å¢å¾…è¾¦äº‹é …</span>
                <button onclick="window.saveTodoItem()" id="todo-modal-btn" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">æ–°å¢</button>
            </div>

            <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                <!-- Content Input (Unified Style) -->
                <div class="px-2 pt-2 pb-2">
                    <label class="text-xs font-bold text-gray-400 mb-1 block">å…§å®¹</label>
                    <input type="text" id="todo-input-title" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent">
                </div>
                
                <!-- Date/Time Group (Unified List Style) -->
                <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
                    <!-- Date -->
                    <div class="dt-row" onclick="window.openCalendar('todo')">
                        <div class="dt-label">æ—¥æœŸ</div>
                        <div class="dt-value group">
                            <span id="display-date-todo" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo">
                    </div>
                    
                    <!-- Time -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo')">
                        <div class="dt-label">æ™‚é–“</div>
                        <div class="dt-value group">
                            <span id="display-time-todo" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo">
                    </div>
                </div>

                <!-- Options -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-700">å…±åŒå¾…è¾¦ (å…©äººå¯è¦‹)</span>
                    <input type="checkbox" id="todo-check-joint" class="custom-checkbox">
                </div>
                
            </div>

            <!-- Footer (Delete Button - Unified Style) -->
            <div class="p-4 border-t border-gray-100 flex justify-center pb-safe">
                 <button
                    id="btn-delete-todo"
                    onclick="window.deleteCurrentTodo()"
                    class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
                  >
                    åˆªé™¤æ­¤å¾…è¾¦
                  </button>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div id="time-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
         <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeTimePicker()"></div>
         <div id="time-list-container" class="relative time-picker-modal-content flex flex-col">
             <!-- Time slots will be populated here -->
         </div>
    </div>

    <!-- Dropdowns & Pickers -->
    <div id="calendar-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCalendar()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl w-[320px] p-4 overflow-hidden max-h-[420px]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cal-month-title" class="text-lg font-bold text-gray-800 tracking-wide cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition">...</h3>
                <div class="flex gap-1"><button onclick="window.changeCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><button onclick="window.changeCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-red-400">æ—¥</div><div class="cal-day-header">ä¸€</div><div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div><div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div><div class="cal-day-header text-red-400">å…­</div>
            </div>

            <div id="calendar-days" class="calendar-grid"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-sm font-medium">
    <button onclick="window.selectToday()" class="text-ttgreen hover:bg-green-50 px-3 py-1.5 rounded-lg transition">ä»Šå¤©</button>
    <button onclick="window.clearDate()" class="text-red-400 hover:bg-red-50 px-3 py-1.5 rounded-lg transition">æ¸…é™¤</button>
    <button onclick="window.closeCalendar()" class="text-gray-400 hover:bg-gray-50 px-3 py-1.5 rounded-lg transition">å–æ¶ˆ</button>
</div>
        </div>
    </div>

    <!-- Bottom Nav -->
        <nav class="bg-white border-t border-gray-100 fixed bottom-0 w-full px-6 pt-3 pb-6 pb-safe z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <button class="nav-item active flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('dashboard')"><i data-lucide="layout-grid" class="w-6 h-6"></i><span class="text-[10px] font-medium">æ‘˜è¦</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('calendar')"><i data-lucide="calendar" class="w-6 h-6"></i><span class="text-[10px] font-medium">è¡Œäº‹æ›†</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('todo')"><i data-lucide="list-checks" class="w-6 h-6"></i><span class="text-[10px] font-medium">æ¸…å–®</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('settings')"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-[10px] font-medium">è¨­å®š</span></button>
        </div>
    </nav>

    <script>
       /* ===== STABLE PATCH: SafeRun Helper ===== */
        window.safeRun = function (fn, label = 'unknown') {
        try {
            return fn();
        } catch (err) {
            console.error(`[SafeRun:${label}]`, err);
            if (window.showToast) {
            window.showToast('ç™¼ç”ŸéŒ¯èª¤ï¼Œä½† App ä»å¯ä½¿ç”¨');
            }
            return null;
        }
        };
        // --- 1. VARIABLES ---
        /* ===== STABLE PATCH: Firestore Listener Guard ===== */
        const snapshotRegistry = {};

        function bindSnapshot(ref, cb, label = 'snapshot') {
        if (snapshotRegistry[label]) return; // å·²ç¶é

        const unsub = ref.onSnapshot(
            snap => window.safeRun(() => cb(snap), label),
            err => console.error(`[Firestore:${label}]`, err)
        );

        snapshotRegistry[label] = unsub;
        }


        const firebaseConfig = { apiKey: "AIzaSyDLrPr4X6r3e2V_vqFaCICgKVwLmiykxpc", authDomain: "kyle-mao.firebaseapp.com", projectId: "kyle-mao", storageBucket: "kyle-mao.firebasestorage.app", messagingSenderId: "290564848532", appId: "1:290564848532:web:006c4e9df4b1330895ad81" };
        let db; try { if(typeof firebase!=='undefined'){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}

        let currentUserRole = localStorage.getItem('user_role') || 'haohao'; 
        let currentSelectedColor = '#2cc998'; 
        let currentCategory = 'default';
        let editingEventId = null;
        let editingTodoId = null;
        let allEventsCache = [];
        let isSavingEvent = false;
        let __lastSaveAt = 0;
        let allTodosCache = [];
// ä¿®æ”¹è™•ï¼šå„ªå…ˆå¾ localStorage è®€å–é¡è‰²ï¼Œè‹¥æ²’æœ‰æ‰ä½¿ç”¨é è¨­å€¼
let roleColors = { 
    haohao: localStorage.getItem('color_haohao') || '#2cc998', 
    maomao: localStorage.getItem('color_maomao') || '#e6688d', 
    joint: localStorage.getItem('color_joint') || '#f7b546' 
};        let colorPickerTarget = null;
        let calTargetInput = 'start'; 
        let calCurrentDate = new Date(); 
        let bigCalDate = new Date();
        let currentViewMode = 'list';
        let timePickerTarget = ''; // FIX: variable for time picker
        let deleteTarget = 'event'; // 'event' or 'todo'

        const timeTreeColors = [ { name: "Emerald Green", hex: "#2cc998" }, { name: "Modern Cyan", hex: "#5cc2d1" }, { name: "Deep Sky Blue", hex: "#5ba3eb" }, { name: "Pastel Brown", hex: "#a68b75" }, { name: "Midnight Black", hex: "#333333" }, { name: "Apple Red", hex: "#e35651" }, { name: "French Rose", hex: "#e6688d" }, { name: "Coral Pink", hex: "#f29074" }, { name: "Bright Orange", hex: "#f7b546" }, { name: "Soft Violet", hex: "#9f82d1" } ];
        const moodMap = { 'charging': { icon: 'âš¡ï¸', bg: 'bg-yellow-100', border: 'border-yellow-300' }, 'sleepy': { icon: 'ğŸ’¤', bg: 'bg-blue-100', border: 'border-blue-300' }, 'love': { icon: 'â¤ï¸', bg: 'bg-rose-100', border: 'border-rose-300' }, 'busy': { icon: 'ğŸ”¥', bg: 'bg-orange-100', border: 'border-orange-300' }, 'normal': { icon: 'ğŸ˜¶', bg: 'bg-gray-50', border: 'border-gray-100' } };

        // --- 2. GLOBAL FUNCTION DEFINITIONS (Assigned to window immediately) ---
        
        window.updateDateDisplay = function(type, dateStr) {
            const displayEl = (type === 'recur') ? document.getElementById('display-recur-until') : (type === 'todo' ? document.getElementById('display-date-todo') : document.getElementById(`display-date-${type}`));
            if(!displayEl) return;
            if(!dateStr) { 
                // Empty state styling
                if (type === 'recur') displayEl.textContent = "è¨­å®šæ—¥æœŸ"; 
                else if (type === 'todo') {
                    displayEl.textContent = "è«‹é¸æ“‡"; 
                    displayEl.classList.add('dt-text-placeholder');
                    displayEl.classList.remove('dt-text-value');
                }
                else {
                    displayEl.textContent = "è«‹é¸æ“‡"; // Unified placeholder
                    displayEl.classList.add('dt-text-placeholder');
                    displayEl.classList.remove('dt-text-value');
                }
                return; 
            }
            
            // Value state styling
            displayEl.classList.remove('dt-text-placeholder');
            displayEl.classList.add('dt-text-value');

            const date = new Date(dateStr); 
            const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            if (type === 'recur' || type === 'todo') displayEl.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} (${weekDays[date.getDay()]})`;
            else displayEl.textContent = `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥(${weekDays[date.getDay()]})`;
        };

        window.updateTimeDisplay = function(type, timeStr) { 
            const el = document.getElementById(`display-time-${type}`); 
            if(el) { 
                if(!timeStr) {
                    el.textContent = 'è«‹é¸æ“‡';
                    el.classList.add('dt-text-placeholder');
                    el.classList.remove('dt-text-value');
                } else {
                    el.textContent = timeStr;
                    el.value = timeStr; 
                    el.classList.remove('dt-text-placeholder');
                    el.classList.add('dt-text-value');
                }
            } 
        }; 
        
        window.checkRecurValidity = function() { const eD = document.getElementById('input-date-end')?.value; const rD = document.getElementById('input-recur-until')?.value; if(rD && eD && new Date(rD) < new Date(eD)) { const el = document.getElementById('input-recur-until'); if(el) el.value = eD; window.updateDateDisplay('recur', eD); } };
        // FIX: Safer Auto Update
        window.autoUpdateEnd = function() { 
            try {
                const sD = document.getElementById('input-date-start')?.value; 
                const sT = document.getElementById('input-time-start')?.value; 
                if(!sD || !sT) return; 
                
                // Safe Check: If end input doesn't exist, don't crash
                const endInputD = document.getElementById('input-date-end');
                const endInputT = document.getElementById('input-time-end');
                
                if (!endInputD || !endInputT) return;

                const start = new Date(`${sD}T${sT}`); 
                const end = new Date(start.getTime() + 3600000); 
                const eD = end.toISOString().split('T')[0]; 
                const eT = end.toTimeString().substring(0,5); 
                
                endInputD.value = eD; 
                endInputT.value = eT; 
                
                const dispEndT = document.getElementById('display-time-end');
                if(dispEndT) dispEndT.value = eT; 
                
                window.updateDateDisplay('end', eD); 
                if(window.checkRecurValidity) window.checkRecurValidity(); 
            } catch (e) {
                console.warn("Auto update end failed silently", e);
            }
        };
        window.checkEndDateValidity = function() { const sD = document.getElementById('input-date-start').value; const sT = document.getElementById('input-time-start').value; const eD = document.getElementById('input-date-end').value; const eT = document.getElementById('input-time-end').value; if(new Date(`${eD}T${eT}`) < new Date(`${sD}T${sT}`)) { window.autoUpdateEnd(); } else { window.checkRecurValidity(); } };
        window.setNowToInputs = function() { const now = new Date(); const dStr = now.toISOString().split('T')[0]; let h = now.getHours(), m = now.getMinutes(); if(m < 30) { m = 30; } else { m = 0; h += 1; } if(h > 23) h = 0; const tStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; const startEl = document.getElementById('input-date-start'); if(startEl) { startEl.value = dStr; document.getElementById('input-time-start').value = tStr; window.updateDateDisplay('start', dStr); window.updateTimeDisplay('start', tStr); const endD = document.getElementById('input-date-end'); if(endD) endD.value = dStr; const endT = document.getElementById('input-time-end'); if(endT) endT.value = tStr; window.updateDateDisplay('end', dStr); window.updateTimeDisplay('end', tStr); } };
        window.updateRoleUI = function() { const btnHaohao = document.getElementById('role-haohao'); const btnMaomao = document.getElementById('role-maomao'); if(!btnHaohao) return; const activeClass = "flex-1 py-3 rounded-lg text-sm font-bold border border-ttgreen bg-green-50 text-ttgreen transition shadow-sm"; const inactiveClass = "flex-1 py-3 rounded-lg text-sm font-medium border border-gray-200 text-gray-400 bg-white transition"; if(currentUserRole === 'haohao') { btnHaohao.className = activeClass; btnMaomao.className = inactiveClass; } else { btnHaohao.className = inactiveClass; btnMaomao.className = activeClass; } const ptText = document.getElementById('partner-toggle-text'); if(ptText) ptText.textContent = (currentUserRole === 'haohao' ? 'èˆ‡æ¯›æ¯›ä¸€èµ·' : 'èˆ‡çš“çš“ä¸€èµ·'); };
        window.updateSettingsColorUI = function() { const h = document.getElementById('setting-color-haohao'); if(h) { h.style.backgroundColor = roleColors.haohao; document.getElementById('setting-color-maomao').style.backgroundColor = roleColors.maomao; document.getElementById('setting-color-joint').style.backgroundColor = roleColors.joint; } };
        window.setStatus = function(s) { document.getElementById('input-status').value = s; document.querySelectorAll('.status-btn').forEach(b=>{ if(b.dataset.status===s) b.classList.add('active'); else b.classList.remove('active'); }); };
        window.showToast = function(msg) { const t = document.getElementById('toast-container'); const m = document.getElementById('toast-message'); m.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); };
        window.updateParticipantsPreview = function() { const container = document.getElementById('participants-preview'); const isP = document.getElementById('check-partner').checked; let html = ''; html += `<div class="avatar-sm z-20" style="background-color:${roleColors[currentUserRole]}">${currentUserRole==='haohao'?'çš“':'æ¯›'}</div>`; if(isP) { const p = currentUserRole==='haohao'?'maomao':'haohao'; html += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]}">${p==='haohao'?'çš“':'æ¯›'}</div>`; } container.innerHTML = html; };
  window.setRole = function(role) {
  localStorage.setItem('user_role', role);
  currentUserRole = role;
  window.updateRoleUI();

  // â­ Active Tab æŒ‡ç¤ºç·šé¡è‰²è·Ÿè§’è‰²åŒæ­¥
  document.documentElement.style.setProperty(
    '--active-tab-color',
    roleColors[role]
  );
};
        window.updateMyStatus = function() { if(!db) return; const moods = ['normal', 'charging', 'sleepy', 'love', 'busy']; const randomMood = moods[Math.floor(Math.random() * moods.length)]; const d = {}; d[currentUserRole] = randomMood; db.collection('status').doc('current').set(d, { merge: true }); };
        window.toggleGlobalColorPicker = function(show) { const el = document.getElementById('global-color-picker'); const grid = document.getElementById('global-color-grid'); if(show) { grid.innerHTML = ''; timeTreeColors.forEach(color => { const row = document.createElement('div'); row.className = "flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition"; row.onclick = () => window.selectGlobalColor(color); row.innerHTML = `<div class="w-5 h-5 rounded-full mr-3 shadow-sm" style="background-color: ${color.hex}"></div><span class="text-sm text-gray-700">${color.name}</span>`; grid.appendChild(row); }); el.classList.remove('hidden'); setTimeout(() => el.classList.add('visible'), 10); } else { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); colorPickerTarget = null; } };
window.selectGlobalColor = function(c) {
    // 1. å¦‚æœæ˜¯åœ¨ã€Œæ–°å¢/ç·¨è¼¯è¡Œç¨‹ã€æ™‚é¸é¡è‰² (ç¶­æŒåŸæ¨£)
    if (colorPickerTarget === 'event') {
        currentSelectedColor = c.hex;
        document.getElementById('selected-color-name').textContent = c.name;
        document.getElementById('selected-color-dot').style.backgroundColor = c.hex;
    } 
    // 2. å¦‚æœæ˜¯åœ¨ã€Œè¨­å®šé é¢ã€é¸ä»£è¡¨è‰² (ä¿®æ”¹é‚è¼¯)
    else if (colorPickerTarget) {
        const newHex = c.hex;
        const targetRole = colorPickerTarget; // ç›®å‰æ­£åœ¨ä¿®æ”¹çš„è§’è‰² (haohao, maomao, joint)
        const oldHex = roleColors[targetRole]; // è©²è§’è‰²åŸæœ¬çš„é¡è‰² (ç”¨ä¾†äº¤æ›ç”¨)

        // === æ­¥é©Ÿ A: æª¢æŸ¥è¡çª ===
        let conflictRole = null;
        for (let key in roleColors) {
            // å¦‚æœä¸æ˜¯è‡ªå·±ï¼Œä¸”é¡è‰²è·Ÿæ–°é¸çš„ä¸€æ¨£ï¼Œå°±æ˜¯è¡çªè€…
            if (key !== targetRole && roleColors[key] === newHex) {
                conflictRole = key;
                break;
            }
        }

        // === æ­¥é©Ÿ B: æ›´æ–°ç›®æ¨™è§’è‰²çš„é¡è‰² ===
        roleColors[targetRole] = newHex;
        localStorage.setItem(`color_${targetRole}`, newHex);

        // === æ­¥é©Ÿ C: è™•ç†è¡çª (è‡ªå‹•äº¤æ›) ===
        if (conflictRole) {
            // æŠŠè¡çªè€…çš„é¡è‰²æ›æˆèˆŠé¡è‰²
            roleColors[conflictRole] = oldHex;
            localStorage.setItem(`color_${conflictRole}`, oldHex);
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            const roleNames = { haohao: 'çš“çš“', maomao: 'æ¯›æ¯›', joint: 'å…±åŒè¡Œç¨‹' };
            window.showToast(`é¡è‰²é‡è¤‡ï¼Œå·²èˆ‡ã€Œ${roleNames[conflictRole]}ã€äº¤æ›é¡è‰²ï¼`);
        }

        // === æ­¥é©Ÿ D: æ›´æ–°ä»‹é¢ ===
        // 1. æ›´æ–°è¨­å®šé é¢çš„ä¸‰å€‹åœ“åœˆ
        window.updateSettingsColorUI();

        // 2. æª¢æŸ¥æ˜¯å¦å½±éŸ¿åˆ°åº•éƒ¨å°èˆªåˆ— (Active Tab) çš„é¡è‰²
        // (ç„¡è«–æ˜¯ã€Œç›´æ¥ä¿®æ”¹è‡ªå·±ã€æˆ–æ˜¯ã€Œå› ç‚ºäº¤æ›è€Œæ”¹è®Šäº†è‡ªå·±ã€éƒ½è¦æ›´æ–°)
        if (targetRole === currentUserRole || conflictRole === currentUserRole) {
             document.documentElement.style.setProperty(
                '--active-tab-color',
                roleColors[currentUserRole]
            );
        }
    }
    
    // é—œé–‰é¸è‰²è¦–çª—
    window.toggleGlobalColorPicker(false);
};
        window.openColorConfig = function(target) { colorPickerTarget = target; window.toggleGlobalColorPicker(true); };
        window.syncSelectedColorUI = function() {
            const dot = document.getElementById('selected-color-dot');
            const name = document.getElementById('selected-color-name');

  if (!dot || !name) return;

  // å¾ç›®å‰é¸æ“‡çš„é¡è‰²æ‰¾å°æ‡‰åç¨±
  const found = timeTreeColors.find(c => c.hex === currentSelectedColor);

  dot.style.backgroundColor = currentSelectedColor;
  name.textContent = found ? found.name : 'è‡ªè¨‚é¡è‰²';
};

        // --- 3. RENDERERS ---
        window.renderEvents = function(ignored) { const items = window.getCalendarItems(); const now = new Date(); const future = items.filter(e => { const date = new Date(e.timestamp); if(e.isTodo && e.done) return false; return !isNaN(date) && date >= now; }); const titleEl = document.getElementById('next-event-title'); if(titleEl && future.length > 0) { const n = future[0], d = new Date(n.timestamp); titleEl.textContent = n.title; const timeStr = n.allDay ? "All Day" : d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('next-event-time').textContent = timeStr; document.getElementById('next-event-date').textContent = d.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); const diff = Math.ceil((d-now)/(1000*60*60*24)); document.getElementById('countdown').textContent = diff<=0?"TODAY":`D - ${diff}`; } else if(titleEl) { titleEl.textContent = "No Upcoming Events"; } const listEl = document.getElementById('event-list'); if(listEl) { if (items.length === 0) listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; else window.renderEventListItems(items, listEl); } };
window.getCalendarItems = function() {
    const events = allEventsCache.map(e => ({...e, type: 'event'}));
    
    // ä¿®æ”¹è™•ï¼šåªè¦æœ‰ timestamp (ä»£è¡¨æœ‰è¨­å®šæ—¥æœŸ)ï¼Œå°±è¦–ç‚ºè¦é¡¯ç¤ºåœ¨è¡Œäº‹æ›†ï¼Œä¸æª¢æŸ¥ addToCalendar æ¬„ä½
    const todos = allTodosCache.filter(t => t.timestamp).map(t => ({
        id: t.id,
        title: t.title,
        timestamp: t.timestamp,
        color: null,
        allDay: !t.dueTime,
        isTodo: true,
        done: t.done,
        type: 'todo',
        creator: t.creator,
        isJoint: t.isJoint
    }));

    return [...events, ...todos].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
};        
window.renderDashboardNextUp = function(items) {
    const now = new Date();
    const next7Days = new Date();
    next7Days.setDate(now.getDate() + 7);

    const upcoming = items.filter(item => {
        const t = new Date(item.timestamp);
        if (item.isTodo && item.done) return false;
        return !isNaN(t) && t >= now && t <= next7Days;
    });

    const countEl = document.getElementById('dashboard-countdown');
    if (upcoming.length > 0) {
        const first = upcoming[0];
        const d = new Date(first.timestamp);
        const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
        countEl.textContent = diff <= 0 ? "TODAY" : `D - ${diff}`;
    } else {
        countEl.textContent = "FREE";
    }

    const container = document.getElementById('dashboard-next-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (upcoming.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">æœªä¾† 7 å¤©æ²’æœ‰è¡Œç¨‹ ğŸ˜´</div>`;
    } else {
        let html = '';
        upcoming.forEach(item => {
            const date = new Date(item.timestamp);
            const timeStr = item.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            const dateStr = date.toLocaleDateString('zh-TW', {
                month: 'numeric',
                day: 'numeric',
                weekday: 'short'
            });

            let color = '#2cc998';
            if (item.isTodo) {
                color = item.isJoint ? roleColors.joint : (item.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
            } else {
                color = item.color;
            }

            // === ä¿®æ”¹è™•ï¼šå¢åŠ ç‹€æ…‹æ¨™ç±¤é‚è¼¯ ===
            let tagHtml = '';
            
            if (item.isTodo) {
                // å¾…è¾¦æ¨™ç±¤
                tagHtml = `<span class="ml-2 text-[10px] border border-gray-200 text-gray-400 px-1 rounded flex-shrink-0">å¾…è¾¦</span>`;
            } else {
                // è¡Œç¨‹ç‹€æ…‹æ¨™ç±¤ (TBC / TBD)
                if (item.status === 'tbc') {
                    tagHtml = `<span class="ml-2 status-tag tbc">TBC</span>`;
                } else if (item.status === 'tbd') {
                    tagHtml = `<span class="ml-2 status-tag tbd">TBD</span>`;
                }
            }
            // ==============================

            let clickAction = item.isTodo ? `window.openEditTodoModal('${item.id}')` : `window.openEditModal('${item.id}')`;
            
            html += `
            <div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer" onclick="${clickAction}">
                <div class="w-1 self-stretch rounded-full mr-3" style="background-color: ${color}"></div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center">
                        <span class="text-sm font-bold text-gray-800 truncate">${item.title}</span>
                        ${tagHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5">${dateStr} Â· ${timeStr} ${item.location ? `Â· ${item.location}` : ''}</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }
};
window.renderCalendarListView = function() { const items = window.getCalendarItems(); const listEl = document.getElementById('event-list'); if(!listEl) return; if (items.length === 0) { listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; } else { window.renderEventListItems(items, listEl); } };
window.renderEventListItems = function(items, container) {
    let html = '';
    items.forEach(e => {
        const date = new Date(e.timestamp);
        if (isNaN(date)) return;
        const timeStr = e.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });

        if (e.isTodo) {
            // === å¾…è¾¦äº‹é … (Todo) ===
            const statusClass = e.done ? "line-through text-gray-400" : "text-gray-800";
            const checkIcon = e.done ? '<i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="square" class="w-5 h-5 text-gray-400"></i>';
            let dotColor = e.isJoint ? roleColors.joint : (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);

            // ä¿®æ”¹è™•ï¼š
            // 1. ç§»é™¤äº† flex å®¹å™¨ä¸Šçš„ gap-2
            // 2. å¾…è¾¦æ¨™ç±¤åŠ ä¸Šäº† ml-2 (å·¦é‚Šè·) å’Œ text-[10px] (ç¸®å°å­—é«”)ï¼Œèˆ‡æ‘˜è¦é ä¸€è‡´
            html += `
            <div class="flex p-4 items-center gap-4 hover:bg-gray-50 transition cursor-pointer">
                <div class="flex flex-col items-center w-10">
                    <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
                    <span class="text-xl font-bold text-gray-800 leading-none">${date.getDate()}</span>
                </div>
                <div class="w-1 self-stretch rounded-full" style="background-color: ${dotColor}"></div>
                <div class="flex-1 min-w-0 flex items-center justify-between" onclick="window.openEditTodoModal('${e.id}')">
                    <div>
                        <div class="flex items-center ${statusClass}">
                            <span class="font-bold truncate block">${e.title}</span>
                            <span class="ml-2 text-[10px] border border-gray-200 px-1 rounded text-gray-400 flex-shrink-0">å¾…è¾¦</span>
                        </div>
                        <div class="text-xs text-gray-500">${timeStr}</div>
                    </div>
                </div>
                <div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${e.id}', ${!e.done}); event.stopPropagation();">
                    ${checkIcon}
                </div>
            </div>`;
        } else {
            // === ä¸€èˆ¬è¡Œç¨‹ (Event) ===
            let ic = '';
            if (e.category === 'travel') ic = 'plane';
            else if (e.category === 'appointment') ic = 'scissors';
            else if (e.category === 'gathering') ic = 'users';
            else if (e.category === 'vacation') ic = 'palmtree';

            // ä¿®æ”¹è™•ï¼šicon åŠ ä¸Š mr-1 (å³é‚Šè·) ä¾†èˆ‡æ¨™é¡Œéš”é–‹
            let ico = ic ? `<i data-lucide="${ic}" class="w-3 h-3 text-gray-400 mr-1"></i>` : '';

            // ä¿®æ”¹è™•ï¼šç‹€æ…‹æ¨™ç±¤åŠ ä¸Š ml-2 (å·¦é‚Šè·)
            let st = '';
            if (e.status === 'tbc') st = `<span class="ml-2 status-tag tbc">TBC</span>`;
            else if (e.status === 'tbd') st = `<span class="ml-2 status-tag tbd">TBD</span>`;

            let av = `<div class="avatar-sm z-20" style="background-color:${roleColors[e.creator]||'#2cc998'}">${e.creator==='haohao'?'çš“':'æ¯›'}</div>`;
            if (e.isJoint) av += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[e.creator==='haohao'?'maomao':'haohao']||'#e6688d'}">${e.creator==='haohao'?'çš“':'æ¯›'}</div>`;

            // ä¿®æ”¹è™•ï¼šç§»é™¤äº† flex å®¹å™¨ä¸Šçš„ gap-1ï¼Œæ”¹ç”¨å…ƒä»¶è‡ªå·±çš„ margin ä¾†æ§åˆ¶
            html += `
            <div class="flex p-4 items-start gap-4 hover:bg-gray-50 transition cursor-pointer card-press" onclick="window.openEditModal('${e.id}')">
                <div class="flex flex-col items-center w-10 pt-1">
                    <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
                    <span class="text-xl font-bold text-gray-800 leading-none" style="color:${e.color}">${date.getDate()}</span>
                </div>
                <div class="w-1 self-stretch rounded-full" style="background-color:${e.color}"></div>
                <div class="flex-1 min-w-0 pt-1">
                    <div class="flex items-center">
                        ${ico}
                        <h4 class="font-bold text-gray-800 truncate">${e.title}</h4>
                        ${st}
                    </div>
                    <div class="text-xs text-gray-500">${timeStr} ${e.location?'Â· '+e.location:''}</div>
                </div>
                <div class="flex items-center self-center -space-x-1 pl-2">${av}</div>
            </div>`;
        }
    });
    container.innerHTML = html;
    if (typeof lucide !== 'undefined') lucide.createIcons({
        root: container
    });
};
window.toggleAllDay = function() { const isChecked = document.getElementById('check-allday').checked; document.querySelectorAll('.dt-wrapper-time').forEach(d => d.style.display = isChecked ? 'none' : 'block'); };
        window.toggleRecurring = function() { const isChecked = document.getElementById('check-recurring').checked; const opts = document.getElementById('recurring-options'); if(isChecked) { opts.classList.remove('hidden'); if(!document.getElementById('input-recur-until').value) document.getElementById('input-recur-until').value = document.getElementById('input-date-end').value; } else opts.classList.add('hidden'); };
        window.toggleTravelFields = function() { const type = document.getElementById('input-transport-type').value; const isPlane = type === 'plane'; document.getElementById('travel-region-intl').classList.toggle('hidden', !isPlane); document.getElementById('travel-region-tw').classList.toggle('hidden', isPlane); };
        window.toggleBooked = function() { const isChecked = document.getElementById('check-booked').checked; const txt = document.getElementById('appoint-status-text'); txt.textContent = isChecked ? "å·²é ç´„" : "æœªå®Œæˆ"; txt.className = isChecked ? "text-xs font-bold text-purple-600" : "text-xs text-gray-500"; };
window.togglePartner = function() {
  const isChecked = document.getElementById('check-partner').checked;
  updateParticipantsPreview();

  colorPickerTarget = 'event';

  if (isChecked) {
    currentSelectedColor = roleColors.joint;
  } else {
    currentSelectedColor = roleColors[currentUserRole];
  }

};
window.saveEvent = function () {
  if (!db) {
    window.showToast('è³‡æ–™åº«å°šæœªé€£ç·š');
    return;
  }
  if (window.__savingEvent) return;
  window.__savingEvent = true;

  const saveBtn = document.querySelector(
    '#add-modal button[onclick="window.saveEvent()"]'
  );
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­â€¦';
    saveBtn.classList.add('opacity-60');
  }

  try {
    const title = document.getElementById('input-title')?.value?.trim();
    if (!title) {
      window.showToast('è«‹å¡«å¯«æ¨™é¡Œ');
      throw new Error('Missing title');
    }

    const startDate = document.getElementById('input-date-start')?.value;
    if (!startDate) {
      window.showToast('è«‹é¸æ“‡æ—¥æœŸ');
      throw new Error('Missing date');
    }

    // === ä¿®æ”¹è™•ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºå…¨å¤©è¡Œç¨‹ ===
    const timeInput = document.getElementById('input-time-start')?.value;
    // å¦‚æœæ™‚é–“æ¬„ä½æ˜¯ç©ºçš„ï¼Œå°±è¦–ç‚º All Day
    const isAllDay = !timeInput; 
    // è‹¥ç‚ºå…¨å¤©ï¼ŒTimestamp ä»éœ€ä¸€å€‹æ™‚é–“æ’åºï¼Œæš«å®š 00:00
    const time = timeInput || '00:00'; 
    const timestamp = new Date(`${startDate}T${time}:00`).toISOString();

    const data = {
      title,
      startDate,
      timestamp,
      allDay: isAllDay, // å¯«å…¥å…¨å¤©æ——æ¨™
      isJoint: document.getElementById('check-partner')?.checked || false,
      status: document.getElementById('input-status')?.value || 'confirmed',
      note: document.getElementById('input-note')?.value || '',
      creator: currentUserRole,
      color: currentSelectedColor,
      location: document.getElementById('input-location')?.value || '',
      createdAt: new Date().toISOString()
    };

    const req = editingEventId
      ? db.collection('events').doc(editingEventId).update(data)
      : db.collection('events').add(data);

    req
      .then(() => {
        window.showToast('è¡Œç¨‹å·²å„²å­˜');
        window.closeAddModal();
      })
      .catch(err => {
        console.error(err);
        window.showToast('å„²å­˜å¤±æ•—');
      })
      .finally(() => {
        window.__savingEvent = false;
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'ä¿å­˜';
          saveBtn.classList.remove('opacity-60');
        }
      });

  } catch (err) {
    window.__savingEvent = false;
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = 'ä¿å­˜';
      saveBtn.classList.remove('opacity-60');
    }
  }
};
        window.deleteCurrentEvent = function() { if(!editingEventId){ window.showToast("ç„¡æ³•è­˜åˆ¥ ID"); return; } deleteTarget='event'; window.confirmDelete(); };
        window.deleteCurrentTodo = function() { if(!editingTodoId){ window.showToast("ç„¡æ³•è­˜åˆ¥ ID"); return; } deleteTarget='todo'; window.confirmDelete(); };
        window.confirmDelete = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10); };
        window.closeConfirmModal = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('visible'); setTimeout(() => m.classList.add('hidden'), 200); };
        window.executeDelete = function() { 
            if(deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete().then(() => { window.closeConfirmModal(); window.closeAddModal(); window.showToast('è¡Œç¨‹å·²åˆªé™¤'); }).catch(e => { console.error(e); window.showToast('åˆªé™¤å¤±æ•—'); }); 
            } else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete().then(() => { window.closeConfirmModal(); window.closeAddTodoModal(); window.showToast('å¾…è¾¦å·²åˆªé™¤'); }).catch(e => { console.error(e); window.showToast('åˆªé™¤å¤±æ•—'); });
            }
        };
window.openAddModal = function () {
  editingEventId = null;

  // === åŸºæœ¬æ¬„ä½ï¼ˆéƒ½å­˜åœ¨ï¼‰===
  document.getElementById('input-title').value = '';
  document.getElementById('input-note').value = '';
  document.getElementById('input-date-start').value = '';
  
  // FIX: Reset displays style
  const dD = document.getElementById('display-date-start');
  dD.textContent = 'è«‹é¸æ“‡';
  dD.classList.add('dt-text-placeholder');
  dD.classList.remove('dt-text-value');

  const t = document.getElementById('input-time-start');
  if (t) t.value = '';
  const td = document.getElementById('display-time-start');
  if (td) { 
      td.textContent = 'è«‹é¸æ“‡';
      td.classList.add('dt-text-placeholder');
      td.classList.remove('dt-text-value');
  }

  const loc = document.getElementById('input-location');
  if (loc) loc.value = '';

  // ä¸€èµ· / ä¸ä¸€èµ·
  const partner = document.getElementById('check-partner');
  partner.checked = false;

  // ç‹€æ…‹é è¨­ confirmed
  window.setStatus('confirmed');

  // é¡è‰²é‚è¼¯ï¼ˆä¿ç•™ï¼Œä½†ä¸ç¢° UIï¼‰
  currentSelectedColor = roleColors[currentUserRole];
  colorPickerTarget = 'event';

  // åˆªé™¤æŒ‰éˆ•ï¼šæ–°å¢æ¨¡å¼ä¸‹éš±è—
  const delBtn = document.getElementById('btn-delete-event');
  if(delBtn) delBtn.classList.add('hidden');

  // ğŸ”“ é–‹ modal
  const m = document.getElementById('add-modal');
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};
window.openEditModal = function (id) {
  const evt = allEventsCache.find(e => e.id === id);
  if (!evt) {
    window.showToast('æ‰¾ä¸åˆ°è¡Œç¨‹');
    return;
  }

  editingEventId = id;

  // === æ¨™é¡Œ ===
  document.getElementById('input-title').value = evt.title || '';

  // === æ—¥æœŸ ===
  if (evt.startDate) {
    document.getElementById('input-date-start').value = evt.startDate;
    window.updateDateDisplay('start', evt.startDate);
  } else if (evt.timestamp) {
    const d = new Date(evt.timestamp);
    const ds = d.toISOString().split('T')[0];
    document.getElementById('input-date-start').value = ds;
    window.updateDateDisplay('start', ds);
  }

  // === ä¿®æ”¹è™•ï¼šæ™‚é–“ (è‹¥ç‚º All Day å‰‡æ¸…ç©ºï¼Œå¦å‰‡è§£æé¡¯ç¤º) ===
  const timeInput = document.getElementById('input-time-start');
  
  if (evt.allDay) {
      // 1. å¦‚æœæ˜¯å…¨å¤©è¡Œç¨‹ï¼Œæ¸…ç©ºæ™‚é–“æ¬„ä½
      timeInput.value = '';
      // 2. é¡¯ç¤ºæ–‡å­—è¨­ç‚ºé è¨­ (é€šå¸¸æ˜¯ 'è«‹é¸æ“‡'ï¼Œé€™ä»£è¡¨ç„¡æ™‚é–“=å…¨å¤©)
      window.updateTimeDisplay('start', ''); 
  } else if (evt.timestamp) {
      // 3. ä¸€èˆ¬è¡Œç¨‹ï¼Œè§£ææ™‚é–“ä¸¦é¡¯ç¤º
      const d = new Date(evt.timestamp);
      const hours = d.getHours().toString().padStart(2, '0');
      const minutes = d.getMinutes().toString().padStart(2, '0');
      const timeStr = `${hours}:${minutes}`;
      timeInput.value = timeStr;
      window.updateTimeDisplay('start', timeStr);
  }
  
  // === åœ°é» ===
  document.getElementById('input-location').value = evt.location || '';
  
  // === ä¸€èµ· / ä¸ä¸€èµ· ===
  const partner = document.getElementById('check-partner');
  partner.checked = !!evt.isJoint;

  // === ç‹€æ…‹ ===
  window.setStatus(evt.status || 'confirmed');

  // === å‚™è¨» ===
  document.getElementById('input-note').value = evt.note || '';

  // === é¡è‰²é‚è¼¯ ===
  currentSelectedColor = evt.color || roleColors[evt.creator] || roleColors[currentUserRole];
  colorPickerTarget = 'event';
  if(window.syncSelectedColorUI) window.syncSelectedColorUI();

  // åˆªé™¤æŒ‰éˆ•
  const delBtn = document.getElementById('btn-delete-event');
  if(delBtn) delBtn.classList.remove('hidden');

  // é–‹ modal
  const m = document.getElementById('add-modal');
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};
window.openAddTodoModal = function() {
    editingTodoId = null;
    document.getElementById('todo-modal-title').textContent = 'æ–°å¢å¾…è¾¦äº‹é …';
    document.getElementById('todo-modal-btn').textContent = 'æ–°å¢';
    document.getElementById('todo-input-title').value = '';
    document.getElementById('input-date-todo').value = '';
    document.getElementById('input-time-todo').value = '';
    
    // é‡ç½®é¡¯ç¤ºæ–‡å­—
    const dd = document.getElementById('display-date-todo');
    dd.textContent = 'è«‹é¸æ“‡';
    dd.classList.add('dt-text-placeholder');
    dd.classList.remove('dt-text-value');

    const dt = document.getElementById('display-time-todo');
    dt.textContent = 'è«‹é¸æ“‡';
    dt.classList.add('dt-text-placeholder');
    dt.classList.remove('dt-text-value');

    document.getElementById('todo-check-joint').checked = false;
    
    // === ä¿®æ”¹è™•ï¼šå·²ç§»é™¤èˆŠçš„ checkbox é‡ç½®ç¨‹å¼ç¢¼ ===

    const btn = document.getElementById('btn-delete-todo');
    if (btn) btn.classList.add('hidden');
    
    const m = document.getElementById('add-todo-modal');
    m.classList.remove('hidden');
    setTimeout(() => m.classList.add('visible'), 10);
};
window.closeAddModal = function() {
  window.__savingEvent = false; // ğŸ”’ ä¿éšªé‡ç½®
  const m=document.getElementById('add-modal');
  m.classList.remove('visible');
  setTimeout(()=>m.classList.add('hidden'),200);
};
/* =========================================
   å¾…è¾¦äº‹é …é‚è¼¯ä¿®å¾©åŒ… (è«‹æ›¿æ›ç›¸é—œå‡½å¼)
   ========================================= */

// 1. é–‹å•Ÿæ–°å¢è¦–çª—
window.openAddTodoModal = function() {
    editingTodoId = null;
    document.getElementById('todo-modal-title').textContent = 'æ–°å¢å¾…è¾¦äº‹é …';
    document.getElementById('todo-modal-btn').textContent = 'æ–°å¢';
    document.getElementById('todo-input-title').value = '';
    document.getElementById('input-date-todo').value = '';
    document.getElementById('input-time-todo').value = '';

    // é‡ç½®æ—¥æœŸé¡¯ç¤º
    const dd = document.getElementById('display-date-todo');
    if(dd) {
        dd.textContent = 'è«‹é¸æ“‡';
        dd.classList.add('dt-text-placeholder');
        dd.classList.remove('dt-text-value');
    }

    const dt = document.getElementById('display-time-todo');
    if(dt) {
        dt.textContent = 'è«‹é¸æ“‡';
        dt.classList.add('dt-text-placeholder');
        dt.classList.remove('dt-text-value');
    }

    // é‡ç½®å‹¾é¸æ¡†
    const jointCheck = document.getElementById('todo-check-joint');
    if(jointCheck) jointCheck.checked = false;

    // éš±è—åˆªé™¤æŒ‰éˆ•
    const btnDel = document.getElementById('btn-delete-todo');
    if (btnDel) btnDel.classList.add('hidden');

    // é¡¯ç¤ºè¦–çª—
    const m = document.getElementById('add-todo-modal');
    m.classList.remove('hidden');
    setTimeout(() => m.classList.add('visible'), 10);
};

// 2. é–‹å•Ÿç·¨è¼¯è¦–çª—
window.openEditTodoModal = function(id) {
    editingTodoId = id;
    const todo = allTodosCache.find(t => t.id === id);
    if (!todo) return;

    document.getElementById('todo-modal-title').textContent = 'ç·¨è¼¯å¾…è¾¦äº‹é …';
    document.getElementById('todo-modal-btn').textContent = 'å„²å­˜';
    document.getElementById('todo-input-title').value = todo.title;

    // è¨­å®šæ—¥æœŸ
    if (todo.dueDate) {
        document.getElementById('input-date-todo').value = todo.dueDate;
        window.updateDateDisplay('todo', todo.dueDate);
    } else {
        document.getElementById('input-date-todo').value = '';
        window.updateDateDisplay('todo', '');
    }

    // è¨­å®šæ™‚é–“
    if (todo.dueTime) {
        document.getElementById('input-time-todo').value = todo.dueTime;
        window.updateTimeDisplay('todo', todo.dueTime);
    } else {
        document.getElementById('input-time-todo').value = '';
        window.updateTimeDisplay('todo', '');
    }

    // è¨­å®šå…±åŒå‹¾é¸
    const jointCheck = document.getElementById('todo-check-joint');
    if(jointCheck) jointCheck.checked = todo.isJoint;

    // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
    const btnDel = document.getElementById('btn-delete-todo');
    if (btnDel) btnDel.classList.remove('hidden');

    // é¡¯ç¤ºè¦–çª—
    const m = document.getElementById('add-todo-modal');
    m.classList.remove('hidden');
    setTimeout(() => m.classList.add('visible'), 10);
};

// 3. é—œé–‰è¦–çª— (é€™å°±æ˜¯ä¹‹å‰å¯èƒ½éºå¤±çš„é—œéµå‡½å¼)
window.closeAddTodoModal = function() {
    const m = document.getElementById('add-todo-modal');
    if (!m) return;
    
    m.classList.remove('visible');
    setTimeout(() => m.classList.add('hidden'), 200);

    // å¼·åˆ¶é‡ç½®å„²å­˜ç‹€æ…‹ (è§£é–æŒ‰éˆ•)
    window.isSavingTodo = false;
    const btn = document.getElementById('todo-modal-btn');
    if (btn) {
        btn.textContent = editingTodoId ? 'å„²å­˜' : 'æ–°å¢';
        btn.style.opacity = '1';
    }
};

// 4. å„²å­˜å¾…è¾¦äº‹é … (ä¿®å¾©ï¼šæ¸…é™¤æ—¥æœŸå¾Œç„¡æ³•å­˜æª”çš„å•é¡Œ)
window.isSavingTodo = false;

window.saveTodoItem = function() {
    if (window.isSavingTodo) return;

    const title = document.getElementById('todo-input-title').value;
    if (!title) {
        window.showToast('è«‹è¼¸å…¥å…§å®¹');
        return;
    }

    // é–å®šæŒ‰éˆ•
    window.isSavingTodo = true;
    const btn = document.getElementById('todo-modal-btn');
    const originalText = btn ? btn.textContent : 'å„²å­˜';
    if (btn) {
        btn.textContent = 'å„²å­˜ä¸­...';
        btn.style.opacity = '0.5';
    }

    const date = document.getElementById('input-date-todo').value;
    const time = document.getElementById('input-time-todo').value;
    const isJoint = document.getElementById('todo-check-joint').checked;
    
    // è‹¥æœ‰æ—¥æœŸå‰‡è‡ªå‹•æ¨™è¨˜éœ€åŒæ­¥
    const addToCalendar = !!date; 

    // === ä¿®æ”¹é‡é» ===
    // æˆ‘å€‘å¿…é ˆã€Œæ˜ç¢ºã€è¨­å®šæ—¥æœŸæ¬„ä½ï¼Œå³ä½¿æ˜¯ç©ºçš„ä¹Ÿè¦è¨­ç‚º null
    // é€™æ¨£è³‡æ–™åº«æ‰æœƒçŸ¥é“è¦æŠŠèˆŠçš„æ—¥æœŸåˆªæ‰
    const todoData = {
        title,
        done: false,
        creator: currentUserRole,
        isJoint: isJoint,
        addToCalendar: addToCalendar,
        // å¦‚æœ date æ˜¯ç©ºçš„ï¼Œå°±è¨­ç‚º nullï¼›å¦å‰‡è¨­ç‚º date
        dueDate: date || null,
        // å¦‚æœ date æˆ– time æ˜¯ç©ºçš„ï¼Œå°±è¨­ç‚º null
        dueTime: (date && time) ? time : null,
        // timestamp ä¹Ÿæ˜¯ä¸€æ¨£
        timestamp: null,
        // æ³¨æ„ï¼šç·¨è¼¯æ™‚é€šå¸¸ä¸æ›´æ–° createdAtï¼Œä»¥å…é †åºäº‚æ‰ï¼Œé€™è£¡æˆ‘å€‘ç¶­æŒåŸæ¨£æˆ–å¯é¸æ“‡ä¸å‚³
        createdAt: new Date().toISOString() 
    };

    // è¨ˆç®— Timestamp (åªæœ‰åœ¨æœ‰æ—¥æœŸæ™‚æ‰è¨ˆç®—)
    if (date) {
        const tStr = time || "00:00";
        todoData.timestamp = new Date(`${date}T${tStr}`).toISOString();
    }

    const onSuccess = (msg) => {
        if (typeof window.closeAddTodoModal === 'function') {
            window.closeAddTodoModal();
        } else {
            const m = document.getElementById('add-todo-modal');
            if(m) {
                 m.classList.remove('visible');
                 setTimeout(() => m.classList.add('hidden'), 200);
            }
            window.isSavingTodo = false;
        }
        window.showToast(msg);
    };

    const onError = (err) => {
        console.error("Save Error:", err);
        window.showToast('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
        window.isSavingTodo = false;
        if (btn) {
            btn.textContent = originalText;
            btn.style.opacity = '1';
        }
    };

    // åŸ·è¡Œå¯«å…¥
    if (editingTodoId) {
        // ç·¨è¼¯æ¨¡å¼ï¼šé€™è£¡å‚³é€ null æœƒæŠŠè³‡æ–™åº«è£¡çš„èˆŠæ—¥æœŸæ´—æ‰
        db.collection('todos').doc(editingTodoId).update(todoData)
            .then(() => onSuccess('å¾…è¾¦äº‹é …å·²æ›´æ–°'))
            .catch(onError);
    } else {
        db.collection('todos').add(todoData)
            .then(() => onSuccess('å¾…è¾¦äº‹é …å·²æ–°å¢'))
            .catch(onError);
    }
};
window.toggleTodo = function(id,s) { db.collection('todos').doc(id).update({done:s}); };
        window.deleteTodo = function(id) { if(confirm('åˆªé™¤?')) db.collection('todos').doc(id).delete(); };
        window.renderTodos = function(todos) { const jointList=document.getElementById('todo-list-joint'), haohaoList=document.getElementById('todo-list-haohao'), maomaoList=document.getElementById('todo-list-maomao'), dashboardList=document.getElementById('dashboard-todo-list'); if(!jointList) return; jointList.innerHTML=''; haohaoList.innerHTML=''; maomaoList.innerHTML=''; dashboardList.innerHTML=''; let pendingCount=0; todos.forEach(t => { let colorHex = roleColors.haohao; let container = haohaoList; if (t.isJoint) { colorHex = roleColors.joint; container = jointList; } else if (t.creator === 'maomao') { colorHex = roleColors.maomao; container = maomaoList; } let checkStyle = t.done ? `background-color: #d1d5db; border-color: #d1d5db;` : `border-color: ${colorHex};`; let titleClass = t.done ? "text-gray-400 line-through" : "text-gray-800"; if (t.done) { } else { pendingCount++; } let calInfo = t.dueDate ? `<span class="text-[10px] ${t.done?'text-gray-300':'text-gray-400'} ml-2 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</span>` : ''; const html = `<div class="todo-item flex items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm"><div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${t.id}', ${!t.done}); event.stopPropagation();"><div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors text-white" style="${checkStyle}">${t.done?'<i data-lucide="check" class="w-3 h-3"></i>':''}</div></div><div class="flex-1 px-2 cursor-pointer overflow-hidden" onclick="window.openEditTodoModal('${t.id}')"><span class="${titleClass} font-medium truncate block">${t.title}</span>${calInfo}</div><button onclick="window.deleteTodo('${t.id}'); event.stopPropagation();" class="flex-none p-2 text-gray-300 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button></div>`; container.innerHTML += html; }); if (pendingCount === 0) dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">æ²’æœ‰æœªå®Œæˆçš„å¾…è¾¦äº‹é … ğŸ‰</p>`; else { const pendings = todos.filter(t => !t.done).slice(0, 3); pendings.forEach(t => { let dotColor = t.isJoint ? roleColors.joint : (t.creator==='haohao' ? roleColors.haohao : roleColors.maomao); dashboardList.innerHTML += `<div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-100"><div class="w-2 h-2 rounded-full" style="background-color: ${dotColor}"></div><span class="truncate text-gray-700">${t.title}</span></div>`; }); if (todos.filter(t => !t.done).length > 3) dashboardList.innerHTML += `<div class="text-center text-xs text-gray-400 mt-1">é‚„æœ‰ ${todos.filter(t => !t.done).length - 3} å€‹é …ç›®...</div>`; } if(typeof lucide !== 'undefined') lucide.createIcons(); };
        

        
        
        
        window.selectBigCalendarDate = function(y,m,d) { document.querySelectorAll('.big-cal-cell.selected').forEach(e=>e.classList.remove('selected')); if(m===bigCalDate.getMonth()) { const el=document.getElementById(`big-cal-day-${d}`); if(el) el.classList.add('selected'); } document.getElementById('selected-date-label').textContent = `${y}å¹´${m+1}æœˆ${d}æ—¥`; const listEl = document.getElementById('month-event-list'); if(!listEl) return; const items = window.getCalendarItems(); const ds=new Date(y, m, d), de=new Date(y, m, d, 23,59,59); const dayEvents = items.filter(e => { const t = new Date(e.timestamp); return t>=ds && t<=de; }); if(dayEvents.length===0) listEl.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">é€™å¤©æ²’æœ‰å®‰æ’è¡Œç¨‹ ğŸ˜´</div>`; else window.renderEventListItems(dayEvents, listEl); };
function initApp(db) {
  if (!db) {
    console.error("Firebase not initialized");
    return;
  }

  // connection indicator
  const conn = document.getElementById('connection-status');
  if (conn) {
    conn.className = "w-2 h-2 rounded-full bg-ttgreen shadow-[0_0_8px_#2cc998]";
  }

/* ===== STABLE PATCH: Notes Listener (ä¾¿åˆ©è²¼) ===== */
  db.collection('notes').onSnapshot(snapshot => {
      snapshot.forEach(doc => {
          // doc.id æœƒæ˜¯ 'haohao' æˆ– 'maomao'
          window.renderNoteBubble(doc.id, doc.data());
      });
      // é †ä¾¿åŒæ­¥ä¸€ä¸‹é ­åƒé¡è‰²
      window.syncNoteAvatarColors();
  });

  /* ===== STABLE PATCH: Events Snapshot ===== */
  bindSnapshot(
    db.collection('events').orderBy('timestamp', 'asc'),
    (snapshot) => {
      const events = [];
      snapshot.forEach(doc =>
        events.push({ id: doc.id, ...doc.data() })
      );
      allEventsCache = events;

      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-events'
      );
      safeRun(
        () => window.renderCalendarListView(),
        'calendar-list'
      );

      // Big Calendar åªåœ¨æœˆæ›†æ¨¡å¼æ‰æ¸²æŸ“
      if (currentViewMode === 'month') {
        safeRun(() => window.renderBigCalendar(), 'big-calendar');
      }
    },
    'events'
  );

  /* ===== STABLE PATCH: Todos Snapshot ===== */
  bindSnapshot(
    db.collection('todos').orderBy('createdAt', 'desc'),
    (snapshot) => {
      const todos = [];
      snapshot.forEach(doc =>
        todos.push({ id: doc.id, ...doc.data() })
      );
      allTodosCache = todos;

      // 1. æ›´æ–°å¾…è¾¦æ¸…å–®é é¢ (åŸæœ¬å°±æœ‰)
      safeRun(() => window.renderTodos(todos), 'todos');

      // 2. æ›´æ–° Dashboard æ‘˜è¦ (åŸæœ¬å°±æœ‰)
      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-todos'
      );

      // 3. === æ–°å¢ï¼šå¼·åˆ¶æ›´æ–°è¡Œäº‹æ›†åˆ—è¡¨ ===
      // é€™è¡Œæœƒè®“åˆ—è¡¨è¦–åœ–æŠ“å–æœ€æ–°çš„å¾…è¾¦äº‹é …
      safeRun(
        () => window.renderCalendarListView(),
        'calendar-list-from-todos'
      );

      // 4. === æ–°å¢ï¼šå¦‚æœç•¶å‰åœ¨çœ‹æœˆæ›†ï¼Œä¹Ÿè¦æ›´æ–°æœˆæ›†ä¸Šçš„å°æ©«æ¢ ===
      if (currentViewMode === 'month') {
        safeRun(() => window.renderBigCalendar(), 'big-calendar-from-todos');
      }
    },
    'todos'
  );

  /* ===== STABLE PATCH: Status Snapshot ===== */
  bindSnapshot(
    db.collection('status').doc('current'),
    (doc) => {
      if (doc.exists) {
        safeRun(() => window.renderStatus?.(doc.data()), 'status');
      }
    },
    'status'
  );
}



 
/* ===== STABLE PATCH: App Bootstrap ===== */


// ===== Calendar Picker (fixed) =====
window.openCalendar = function(t) {
  calTargetInput = t;

  // read currently selected date (do NOT auto-fill)
  let v = '';
  if (t === 'recur') v = document.getElementById('input-recur-until')?.value || '';
  else if (t === 'todo') v = document.getElementById('input-date-todo')?.value || '';
  else v = document.getElementById(`input-date-${t}`)?.value || '';

  calCurrentDate = v ? new Date(v) : new Date();
  if (isNaN(calCurrentDate.getTime())) calCurrentDate = new Date();

  window.renderCalendarModal();

  const m = document.getElementById('calendar-picker-modal');
  if (!m) return;
  m.classList.remove('hidden');
  setTimeout(()=>m.classList.add('visible'),10);

  if (window.lockBodyScroll) window.lockBodyScroll(true);
};

window.closeCalendar = function() {
  const m = document.getElementById('calendar-picker-modal');
  if (!m) return;
  m.classList.remove('visible');
  setTimeout(()=>m.classList.add('hidden'),200);

  if (window.lockBodyScroll) window.lockBodyScroll(false);
};

window.selectCalDate = function(y,m,d) {
  const s = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;

  if (calTargetInput === 'recur') {
    const el = document.getElementById('input-recur-until');
    if (el) el.value = s;
    window.updateDateDisplay?.('recur', s);
  } else if (calTargetInput === 'todo') {
    const el = document.getElementById('input-date-todo');
    if (el) el.value = s;
    window.updateDateDisplay?.('todo', s);
    // === ä¿®æ”¹è™•ï¼šç§»é™¤äº† checkTodoCalendarOption å‘¼å« ===
  } else {
    const el = document.getElementById(`input-date-${calTargetInput}`);
    if (el) el.value = s;
    window.updateDateDisplay?.(calTargetInput, s);
  }

  window.closeCalendar();

  if (calTargetInput === 'start') window.autoUpdateEnd?.();
  else if (calTargetInput === 'end') window.checkEndDateValidity?.();
};

window.changeCalMonth = function(offset) {
  calCurrentDate.setMonth(calCurrentDate.getMonth() + offset);
  window.renderCalendarModal();
};

window.renderCalendarModal = function() {
  const y = calCurrentDate.getFullYear();
  const m = calCurrentDate.getMonth();
  const today = new Date();

  const title = document.getElementById('cal-month-title');
  if (title) title.textContent = `${y}å¹´${m+1}æœˆ`;

  const dim = new Date(y, m+1, 0).getDate();
  const sd  = new Date(y, m, 1).getDay();

  // get selected date string for highlighting
  let selectedStr = '';
  if (calTargetInput === 'recur') selectedStr = document.getElementById('input-recur-until')?.value || '';
  else if (calTargetInput === 'todo') selectedStr = document.getElementById('input-date-todo')?.value || '';
  else selectedStr = document.getElementById(`input-date-${calTargetInput}`)?.value || '';

  let h = '';

  for (let i = 0; i < sd; i++) h += `<div class="cal-day empty"></div>`;

  for (let d = 1; d <= dim; d++) {
    const isToday = (y===today.getFullYear() && m===today.getMonth() && d===today.getDate());
    const str = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    const isSelected = selectedStr === str;

    h += `<div class="cal-day ${isToday?'today':''} ${isSelected?'selected':''}"
              onclick="window.selectCalDate(${y},${m},${d})">${d}</div>`;
  }

  const totalCells = sd + dim;
  const remainder = totalCells % 7;
  if (remainder !== 0) {
    for (let i = 0; i < 7 - remainder; i++) h += `<div class="cal-day empty"></div>`;
  }

  const days = document.getElementById('calendar-days');
  if (days) days.innerHTML = h;
};

window.selectToday = function() {
  const t = new Date();
  window.selectCalDate(t.getFullYear(), t.getMonth(), t.getDate());
};

// ===== NEW: Time Picker Logic (Fix for Missing Function) =====
window.openTimePicker = function(target) {
    timePickerTarget = target;
    const container = document.getElementById('time-list-container');
    container.innerHTML = ''; // clear

    // Generate time slots every 15 mins
    const times = [];
    for (let h=0; h<24; h++) {
        for (let m=0; m<60; m+=15) { // 15 min intervals
            const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
            times.push(timeStr);
        }
    }

    // Current value
    let currentVal = '';
    if (target === 'todo') currentVal = document.getElementById('input-time-todo').value;
    else currentVal = document.getElementById(`input-time-${target}`).value;

    let html = '';
    times.forEach(t => {
        const isSelected = t === currentVal;
        html += `<div class="time-option ${isSelected?'selected':''}" onclick="window.selectTime('${t}')">${t}</div>`;
    });
    
    // Add "None" option only for Todo or if needed, but for now strict times
    if (target === 'todo') {
        html = `<div class="time-option text-gray-400" onclick="window.selectTime('')">æ¸…é™¤æ™‚é–“</div>` + html;
    }

    container.innerHTML = html;

    const modal = document.getElementById('time-picker-modal');
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.add('visible'), 10);
    
    // Scroll to selected
    if (currentVal) {
        setTimeout(() => {
            const selectedEl = container.querySelector('.selected');
            if (selectedEl) selectedEl.scrollIntoView({block: 'center'});
        }, 100);
    }
};

window.closeTimePicker = function() {
    const modal = document.getElementById('time-picker-modal');
    modal.classList.remove('visible');
    setTimeout(() => modal.classList.add('hidden'), 200);
};

// FIX: Safe select time
window.selectTime = function(timeStr) {
    try {
        if (timePickerTarget === 'todo') {
            const el = document.getElementById('input-time-todo');
            if(el) el.value = timeStr;
            // Use unified update helper for display logic
            window.updateTimeDisplay('todo', timeStr);
        } else {
            const el = document.getElementById(`input-time-${timePickerTarget}`);
            if(el) el.value = timeStr;
            window.updateTimeDisplay(timePickerTarget, timeStr);
            if (timePickerTarget === 'start') {
                if(window.autoUpdateEnd) window.autoUpdateEnd(); 
            }
        }
    } catch(e) {
        console.error("selectTime error", e);
    } finally {
        window.closeTimePicker();
    }
};

// ===== MISSING NAVIGATION & CALENDAR RENDER FUNCTIONS =====
window.switchTab = function(tabId) {
    // 1. Pages åˆ‡æ›é¡¯ç¤º
    document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
    const target = document.getElementById('page-' + tabId);
    if(target) target.classList.add('active');
    
    // 2. Nav åœ–æ¨™ç‹€æ…‹åˆ‡æ›
    const tabs = ['dashboard', 'calendar', 'todo', 'settings'];
    document.querySelectorAll('.nav-item').forEach((el, idx) => {
        if(tabs[idx] === tabId) el.classList.add('active');
        else el.classList.remove('active');
    });

    // 3. ç‰¹æ®Šé‚è¼¯è™•ç†
    // å¦‚æœåˆ‡æ›åˆ°è¡Œäº‹æ›†ä¸”æ˜¯æœˆæ›†æ¨¡å¼ï¼Œéœ€è¦é‡ç¹ª
    if(tabId === 'calendar' && currentViewMode === 'month') {
        window.renderBigCalendar();
    }
    
    // === ä¿®æ”¹è™•ï¼šå¦‚æœåˆ‡æ›åˆ°è¨­å®šé ï¼Œå¼·åˆ¶æ›´æ–°é¡è‰²åœ“åœˆ UI ===
    if(tabId === 'settings') {
        window.updateSettingsColorUI();
    }
    // åœ¨ window.switchTab å‡½å¼å…§åŠ å…¥ï¼š
if(tabId === 'dashboard') {
    window.syncNoteAvatarColors?.();
}
};

window.switchCalendarView = function(mode) {
    currentViewMode = mode;
    const vList = document.getElementById('calendar-view-list');
    const vMonth = document.getElementById('calendar-view-month');
    const bList = document.getElementById('btn-view-list');
    const bMonth = document.getElementById('btn-view-month');
    
    if(mode === 'list') {
        vList.classList.remove('hidden');
        vMonth.classList.add('hidden');
        bList.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold');
        bList.classList.remove('text-gray-500','font-medium');
        bMonth.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold');
        bMonth.classList.add('text-gray-500','font-medium');
    } else {
        vList.classList.add('hidden');
        vMonth.classList.remove('hidden');
        bMonth.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold');
        bMonth.classList.remove('text-gray-500','font-medium');
        bList.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold');
        bList.classList.add('text-gray-500','font-medium');
        window.renderBigCalendar();
    }
};

window.changeBigCalMonth = function(delta) {
    bigCalDate.setMonth(bigCalDate.getMonth() + delta);
    window.renderBigCalendar();
};

window.renderBigCalendar = function() {
    const y = bigCalDate.getFullYear();
    const m = bigCalDate.getMonth();
    const title = document.getElementById('big-cal-title');
    if(title) title.textContent = `${y}å¹´${m+1}æœˆ`;
    
    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m+1, 0).getDate();
    
    let html = '';
    for(let i=0; i<firstDay; i++) {
        html += `<div class="big-cal-cell bg-gray-50/50"></div>`;
    }
    
    const nowStr = new Date().toDateString();
    const items = window.getCalendarItems ? window.getCalendarItems() : [];

    for(let d=1; d<=daysInMonth; d++) {
        const dateObj = new Date(y, m, d);
        const isToday = dateObj.toDateString() === nowStr;
        
        // Filter events for this day
        const dayEvents = items.filter(e => {
            const t = new Date(e.timestamp);
            return t.getDate() === d && t.getMonth() === m && t.getFullYear() === y;
        });

        // Bars HTML
        let bars = '';
        dayEvents.slice(0, 3).forEach(e => {
            let bg = e.color || '#2cc998';
            if(e.isTodo) bg = e.isJoint ? roleColors.joint : (e.creator==='haohao'?roleColors.haohao:roleColors.maomao);
            bars += `<div class="event-bar ${e.isTodo&&e.done?'done':''}" style="background-color:${bg}">${e.title}</div>`;
        });
        if(dayEvents.length > 3) {
            bars += `<div class="more-events">+${dayEvents.length-3}</div>`;
        }

        html += `<div class="big-cal-cell ${isToday?'today':''}" id="big-cal-day-${d}" onclick="window.selectBigCalendarDate(${y},${m},${d})">
            <div class="big-cal-day-num">${d}</div>
            <div class="w-full px-1 space-y-px">${bars}</div>
        </div>`;
    }
    
    const grid = document.getElementById('big-cal-grid');
    if(grid) grid.innerHTML = html;
};

document.addEventListener('DOMContentLoaded', () => {
  safeRun(() => {
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // â­ åˆå§‹åŒ– Active Tab æŒ‡ç¤ºç·šé¡è‰²
    document.documentElement.style.setProperty(
      '--active-tab-color',
      roleColors[currentUserRole]
    );

    if (db) {
      initApp(db);
    }
  }, 'bootstrap');
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.error('SW failed', err));
  });
}

/* ===== PWA Resume Guard (iOS) ===== */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    safeRun(() => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      if (currentViewMode === 'month') {
        window.renderBigCalendar();
      }
    }, 'resume');
  }
});
window.clearDate = function() {
    // 1. å¦‚æœæ˜¯å¾…è¾¦äº‹é … (todo)
    if (calTargetInput === 'todo') {
        // æ¸…ç©ºæ—¥æœŸèˆ‡æ™‚é–“çš„éš±è—å€¼
        document.getElementById('input-date-todo').value = '';
        document.getElementById('input-time-todo').value = '';
        
        // ä½¿ç”¨ç¾æœ‰çš„ helper å‡½å¼ä¾†é‡ç½®é¡¯ç¤ºæ–‡å­— (è®Šå›ã€Œè«‹é¸æ“‡ã€)
        if (window.updateDateDisplay) window.updateDateDisplay('todo', '');
        if (window.updateTimeDisplay) window.updateTimeDisplay('todo', '');
    } 
    // 2. å¦‚æœæ˜¯å…¶ä»– (ä¾‹å¦‚ä¸€èˆ¬è¡Œç¨‹ï¼Œé›–ç„¶é€šå¸¸å¿…å¡«ï¼Œä½†ä¹Ÿæä¾›æ¸…é™¤åŠŸèƒ½)
    else {
        const el = document.getElementById(`input-date-${calTargetInput}`);
        if (el) el.value = '';
        if (window.updateDateDisplay) window.updateDateDisplay(calTargetInput, '');
        
        // å¦‚æœæ˜¯é–‹å§‹æ—¥æœŸè¢«æ¸…é™¤ï¼Œå¯èƒ½éœ€è¦é€£å‹•çµæŸæ—¥æœŸæª¢æŸ¥ï¼Œä½†å› ç‚ºæ˜¯æ¸…ç©ºï¼Œæš«ä¸è™•ç†è‡ªå‹•è¨ˆç®—
    }

    // 3. é—œé–‰è¦–çª—
    window.closeCalendar();
};
/* =========================================
   ä¾¿åˆ©è²¼ (Status Note) åŠŸèƒ½é‚è¼¯
   ========================================= */

// 1. ç™¼é€ä¾¿åˆ©è²¼
window.sendNote = function() {
    const input = document.getElementById('note-input');
    const text = input.value.trim();

    if (!text) return;

    // å¯«å…¥è³‡æ–™åº« (collection: 'notes', docId: role)
    // é€™æ¨£åŒä¸€å€‹äººæ°¸é åªæœ‰ä¸€å‰‡æœ€æ–°çš„ note
    db.collection('notes').doc(currentUserRole).set({
        text: text,
        timestamp: new Date().toISOString(),
        creator: currentUserRole
    }).then(() => {
        window.showToast('å¿ƒæƒ…å·²ç™¼é€ ğŸ’¬');
        input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        input.blur(); // æ”¶èµ·éµç›¤
    }).catch(err => {
        console.error(err);
        window.showToast('ç™¼é€å¤±æ•—');
    });
};

// 2. èšç„¦è¼¸å…¥æ¡† (é»æ“Šé ­åƒæ™‚è§¸ç™¼)
window.setNoteInputFocus = function() {
    const input = document.getElementById('note-input');
    input.focus();
};

// 3. æ¸²æŸ“ä¾¿åˆ©è²¼ (æ ¸å¿ƒé‚è¼¯ï¼šæª¢æŸ¥ 24å°æ™‚)
// 3. æ¸²æŸ“ä¾¿åˆ©è²¼ (ä¿®æ­£ï¼šæ°£æ³¡å¾€ä¸‹é¡¯ç¤º)
window.renderNoteBubble = function(role, data) {
    const bubbleId = `note-bubble-${role}`;
    const textId = `note-text-${role}`;
    const dotId = `status-dot-${role}`;
    
    const bubbleEl = document.getElementById(bubbleId);
    const textEl = document.getElementById(textId);
    const dotEl = document.getElementById(dotId);

    if (!bubbleEl || !textEl) return;

    if (!data || !data.text || !data.timestamp) {
        hideBubble(bubbleEl, dotEl);
        return;
    }

    const now = new Date();
    const noteTime = new Date(data.timestamp);
    const diffHours = (now - noteTime) / (1000 * 60 * 60);

    if (diffHours < 24) {
        textEl.textContent = data.text;
        
        // é¡¯ç¤º
        bubbleEl.classList.remove('hidden');
        if(dotEl) dotEl.classList.remove('hidden');
        
        // å‹•ç•«ï¼šå¾ä¸Šæ–¹æ»‘ä¸‹ä¾† (-translate-y-2 -> 0)
        requestAnimationFrame(() => {
            bubbleEl.classList.remove('opacity-0', '-translate-y-2');
        });
    } else {
        hideBubble(bubbleEl, dotEl);
    }
};

function hideBubble(bubbleEl, dotEl) {
    // éš±è—å‹•ç•«
    bubbleEl.classList.add('opacity-0', '-translate-y-2');
    if(dotEl) dotEl.classList.add('hidden');
    
    setTimeout(() => {
        bubbleEl.classList.add('hidden');
    }, 300);
}

// 4. æ›´æ–°é ­åƒé¡è‰² (é…åˆè¨­å®šé é¢çš„é¡è‰²)
window.syncNoteAvatarColors = function() {
    const h = document.getElementById('avatar-note-haohao');
    const m = document.getElementById('avatar-note-maomao');
    if(h) h.style.backgroundColor = roleColors.haohao;
    if(m) m.style.backgroundColor = roleColors.maomao;
};
</script>

</body>
</html>
