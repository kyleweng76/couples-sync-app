<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <link rel="manifest" href="manifest.json">
    <title>æˆ‘å€‘çš„å°æ™‚å…‰</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ttgreen: '#2cc998', 
                        ttred: '#e95d5d',   
                        ttgray: '#f5f5f5',  
                    }
                }
            }
        }

        // === æ‰¹æ¬¡é¸å–åŠŸèƒ½æ ¸å¿ƒ ===

// ç‹€æ…‹è®Šæ•¸
window.batchState = {
    active: false,
    target: null, // 'event' æˆ– 'todo'
    selectedIds: new Set()
};

// 1. åˆ‡æ›æ¨¡å¼ (é€²å…¥/é€€å‡º)
window.toggleBatchMode = function(target) {
    const isActive = window.batchState.active;
    
    // å¦‚æœå·²ç¶“åœ¨æ¨¡å¼ä¸­ä¸”æŒ‰çš„æ˜¯åŒä¸€å€‹ target -> é€€å‡º
    if (isActive && window.batchState.target === target) {
        window.exitBatchMode();
        return;
    }

    // é€²å…¥é¸å–æ¨¡å¼
    window.batchState.active = true;
    window.batchState.target = target;
    window.batchState.selectedIds.clear();
    
    // æ›´æ–° UI æ–‡å­—èˆ‡æŒ‰éˆ•
    const btn = document.getElementById(`btn-batch-${target}`);
    if(btn) {
        btn.textContent = 'å®Œæˆ';
        btn.classList.add('text-theme', 'font-bold');
        btn.classList.remove('text-gray-500');
    }
    
    // éš±è—å³ä¸Šè§’çš„æ–°å¢æŒ‰éˆ• (é¿å…èª¤è§¸)
    const addBtn = document.getElementById(`btn-add-${target}-main`);
    if(addBtn) addBtn.classList.add('opacity-0', 'pointer-events-none');

    // é¡¯ç¤ºåº•éƒ¨æ“ä½œåˆ—
    const bar = document.getElementById('batch-action-bar');
    bar.classList.add('visible');
    window.updateBatchUI(); // é‡ç½®è¨ˆæ•¸

    // è§¸ç™¼é‡æ–°æ¸²æŸ“ (è®“å‹¾é¸æ¡†è·‘å‡ºä¾†)
    if (target === 'event') {
        window.renderCalendarListView();
    } else {
        window.renderTodos(window.allTodosCache);
    }
};

// 2. é€€å‡ºæ¨¡å¼
window.exitBatchMode = function() {
    const target = window.batchState.target;
    window.batchState.active = false;
    window.batchState.selectedIds.clear();
    window.batchState.target = null;

    // é‚„åŸæŒ‰éˆ•æ–‡å­—
    if(target) {
        const btn = document.getElementById(`btn-batch-${target}`);
        if(btn) {
            btn.textContent = 'é¸æ“‡';
            btn.classList.remove('text-theme', 'font-bold');
            btn.classList.add('text-gray-500');
        }
        const addBtn = document.getElementById(`btn-add-${target}-main`);
        if(addBtn) addBtn.classList.remove('opacity-0', 'pointer-events-none');
    }

    // éš±è—åº•éƒ¨åˆ—
    document.getElementById('batch-action-bar').classList.remove('visible');

    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ (é‚„åŸæˆæ»‘å‹•åˆªé™¤æ¨¡å¼)
    if (target === 'event') {
        window.renderCalendarListView();
    } else if (target === 'todo') {
        window.renderTodos(window.allTodosCache);
    }
};

// 3. é»é¸å–®ä¸€é …ç›®
window.toggleBatchItem = function(id) {
    if (window.batchState.selectedIds.has(id)) {
        window.batchState.selectedIds.delete(id);
    } else {
        window.batchState.selectedIds.add(id);
    }
    window.updateBatchUI();
    
    // æ›´æ–°è©²é …ç›®çš„å‹¾é¸åœˆåœˆæ¨£å¼ (ä¸ç”¨é‡ç¹ªæ•´å€‹åˆ—è¡¨)
    const checkCircle = document.getElementById(`batch-check-${id}`);
    if (checkCircle) {
        if (window.batchState.selectedIds.has(id)) checkCircle.classList.add('checked');
        else checkCircle.classList.remove('checked');
    }
};

// 4. æ›´æ–°åº•éƒ¨ UI (è¨ˆæ•¸èˆ‡æŒ‰éˆ•ç‹€æ…‹)
window.updateBatchUI = function() {
    const count = window.batchState.selectedIds.size;
    document.getElementById('batch-count').textContent = count;
    
    const delBtn = document.getElementById('btn-batch-delete');
    if (count > 0) {
        delBtn.disabled = false;
        delBtn.textContent = `åˆªé™¤ (${count})`;
    } else {
        delBtn.disabled = true;
        delBtn.textContent = 'åˆªé™¤';
    }
};

// 5. åŸ·è¡Œæ‰¹æ¬¡åˆªé™¤
window.executeBatchDelete = function() {
    const count = window.batchState.selectedIds.size;
    if (count === 0) return;

    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${count} å€‹é …ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;

    const targetCollection = window.batchState.target === 'event' ? 'events' : 'todos';
    const batch = db.batch();
    
    window.batchState.selectedIds.forEach(id => {
        const ref = db.collection(targetCollection).doc(id);
        batch.delete(ref);
    });

    batch.commit()
        .then(() => {
            window.showToast(`å·²åˆªé™¤ ${count} å€‹é …ç›®`);
            window.exitBatchMode(); // åˆªé™¤å®Œè‡ªå‹•é€€å‡º
        })
        .catch(err => {
            console.error("Batch delete failed", err);
            window.showToast('åˆªé™¤å¤±æ•—');
        });
};

    </script>

    <style>
        /* === æ–°å¢ï¼šå‹•æ…‹ä¸»é¡Œè‰²è®Šæ•¸ === */
        :root {
            --app-color: #2cc998; /* é è¨­ç‚ºçš“çš“ç¶  */
        }
        /* === å„ªåŒ–3ï¼šå¼·åˆ¶é–‹å•Ÿ iOS æ…£æ€§æ²å‹• (é‡å°æ‰€æœ‰æ²å‹•å€åŸŸ) === */
        .scroller-smooth,
        .page-content,        /* å„€è¡¨æ¿é é¢ */
        #todo-scroll-area,    /* å¾…è¾¦æ¸…å–®æ²å‹•å€ */
        #calendar-scroll-area,/* æœˆæ›†æ²å‹•å€ */
        #calendar-view-list,  /* è¡Œäº‹æ›†åˆ—è¡¨æ¨¡å¼ */
        #chat-container,      /* èŠå¤©å®¤ */
        .overflow-y-auto      /* æ‰€æœ‰ Tailwind çš„æ²å‹•å®¹å™¨ */
        {
            -webkit-overflow-scrolling: touch !important;
            overscroll-behavior-y: contain; /* é˜²æ­¢æ»‘åˆ°åº•éƒ¨æ™‚æ‹‰å‹•æ•´å€‹ç¶²é  */
        }
        * {
    -webkit-tap-highlight-color: transparent !important;
        }
        .bg-theme { background-color: var(--app-color) !important; }
        .text-theme { color: var(--app-color) !important; }
        .border-theme { border-color: var(--app-color) !important; }

        /* åº•éƒ¨å°èˆªåˆ—å‹•æ…‹è®Šè‰² (è¦†å¯«åŸæœ¬ Tailwind çš„ group è¨­å®š) */
        .nav-btn.active .nav-icon-pill {
            background-color: var(--app-color) !important;
            color: white !important;
        }
        .nav-btn.active span {
            color: var(--app-color) !important;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; /* å»ºè­°æ”¹æˆé€™å€‹æ›´æ·ºçš„ç°è‰²ï¼ŒåŸæœ¬çš„ #e5e5e5 æœ‰é»å¤ªæ·± */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none; /* ç¦æ­¢é•·æŒ‰è·³å‡ºé¸å–® */
            /* ... */
        }
        /* ä½†è¦è¨˜å¾—æŠŠè¼¸å…¥æ¡†ã€Œé‚„åŸã€ï¼Œä¸ç„¶æœƒç„¡æ³•æ‰“å­—ï¼ */
        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* === è«‹æŠŠé€™æ®µè£œé€²å» === */
        .safe-top {
        padding-top: env(safe-area-inset-top) !important;
        height: auto !important; /* è®“é«˜åº¦è‡ªå‹•é•·é«˜ï¼Œå®¹ç´å‹•æ…‹å³¶ */
        }
        #main-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        /* 1. ä¿®æ­£é é¢é ‚éƒ¨è·é›¢ï¼Œé¿å…è¢«æ¨™é¡Œåˆ—æ“‹ä½ (è£åˆ‡å•é¡Œ) */
        .page-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding-top: calc(70px + env(safe-area-inset-top));
            padding-bottom: 90px;
            background-color: #f9fafb;
            display: none; 
        }

        /* === ä¿®æ­£ï¼šçµ‚æ¥µç‰ˆ (æ¢å¾©å½ˆæ€§ + å®Œç¾ç™½åº•) === */
        
        /* 1. è¨­å®šåº•è‰²ç‚ºç™½è‰²ï¼šé€™æ¨£å½ˆèµ·ä¾†æ™‚ï¼Œéœ²å‡ºçš„åº•å±¤å°±æ˜¯ç™½çš„ï¼Œä¸æœƒæ˜¯é»‘çš„ */
        html {
            background-color: #ffffff;
            height: 100%;
        }

        body {
            background-color: #ffffff;
            height: 100%;       /* ğŸ‘ˆ æ”¹å› 100% ä»¥æ¶ˆé™¤éµç›¤å»¶é² */
            width: 100%;
            position: fixed;    /* ç¶­æŒ fixed é–å®šè¦–çª— */
            overflow: hidden;
        }

        /* 2. èŠå¤©å®¤ï¼šå®Œå…¨æ¢å¾© iOS åŸç”Ÿæ»¾å‹•æ‰‹æ„Ÿ */
        #chat-container {
            /* åŸºç¤è¨­å®š */
            flex: 1;
            min-height: 0;
            position: relative;
            z-index: 0;
            
            /* æ»¾å‹•è¨­å®šï¼šæ¢å¾©åŸå» è¨­å®š */
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            
            /* èƒŒæ™¯è¨­å®š */
            background-color: #ffffff; 
            background-image: radial-gradient(#e5e7eb 2px, transparent 2px);
            background-size: 24px 24px; 
            background-attachment: scroll; 
            
            /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ é—œéµï¼è£œä¸Šé€™ä¸€è¡Œä¾†è¦†å¯«ä¸Šé¢çš„è¨­å®š ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
            overscroll-behavior-y: auto !important; 
        }

        /* === é‡è¦ï¼šå¼·åˆ¶éš±è—ä¹‹å‰å¯«çš„ ::before (é‚£å¼µåœ–ç‰‡å±¤)ï¼Œé¿å…å¹²æ“¾ === */
        #chat-container::before {
            display: none !important;
        }

        #page-chat.active {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            padding-top: calc(70px + env(safe-area-inset-top)); 
            padding-bottom: 90px;
            
            /* ğŸ‘‡ åŠ å…¥é€™ä¸€è¡Œï¼šå¼·åˆ¶èƒŒæ™¯å…¨ç™½ï¼Œç•¶ä½œç¬¬äºŒå±¤é˜²è­· */
            background-color: #ffffff !important; 
        }
        
        /* 3. èŠå¤©æ°£æ³¡æ¨£å¼å„ªåŒ– (æ”¯æ´é¡¯ç¤ºåå­—) */
        .chat-row { display: flex; width: 100%; margin-bottom: 6px; }
        
        /* å·¦å´ (å°æ–¹) */
        .chat-row.left { justify-content: flex-start; align-items: flex-start; }
        /* å·¦å´æ°£æ³¡ (åŸæœ¬æ˜¯ç™½åº•) -> ç§»é™¤ background-color */
        .chat-row.left .chat-bubble {
            /* background-color: #ffffff; <--- åˆªé™¤æˆ–è¨»è§£æ‰é€™è¡Œ */
            /* color: #1f2937; <--- åˆªé™¤é€™è¡Œï¼Œæˆ‘å€‘æœƒçµ±ä¸€ç”¨ç™½è‰²å­— */
            border-radius: 0 16px 16px 16px;
            margin-left: 6px;
        }
        
        /* å³å´ (è‡ªå·±) */
        .chat-row.right { justify-content: flex-end; align-items: flex-end; }
        /* å³å´æ°£æ³¡ (åŸæœ¬æ˜¯ç¶ åº•) -> ç§»é™¤ background-color */
        .chat-row.right .chat-bubble {
            /* background-color: #9de69f; <--- åˆªé™¤æˆ–è¨»è§£æ‰é€™è¡Œ */
            /* color: #0f172a; <--- åˆªé™¤é€™è¡Œ */
            border-radius: 16px 0 16px 16px;
            margin-right: 2px;
        }

        /* ä¿®æ”¹ï¼šæ°£æ³¡å¯¬åº¦ (æ”¾å¯¬é™åˆ¶ï¼Œè§£æ±ºå¤ªå¿«æ›è¡Œçš„å•é¡Œ) */
        .chat-bubble {
            padding: 8px 12px;
            font-size: 15px; /* å­—é«”å¾®èª¿å¤§ä¸€é»ï¼Œé–±è®€æ›´èˆ’æœ */
            line-height: 1.5;
            max-width: 88%; /* <--- é—œéµï¼åŸæœ¬æ˜¯ 75%ï¼Œæ”¹å¤§åˆ° 88% */
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            word-break: break-all;
        }
        
        /* é ­åƒæ¨£å¼ */
        .chat-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: white; font-weight: bold;
            flex-shrink: 0;
            margin-top: 2px; /* ç¨å¾®å°é½Š */
        }
        
        /* ä¿®æ”¹ï¼šæ™‚é–“æ–‡å­—é¡è‰² (åŠ æ·±ç°è‰²ï¼Œå–æ¶ˆé™°å½±ï¼Œç¢ºä¿æ¸…æ¥š) */
        .chat-time {
            font-size: 10px; /* ç¨å¾®åŠ å¤§ä¸€é»é»ï¼ŒåŸæœ¬ 9px */
            color: #6b7280 !important; /* <--- é—œéµï¼æ”¹æˆæ·±ç°è‰² */
            text-shadow: none !important; /* ç§»é™¤é™°å½± */
            margin: 0 4px;
            align-self: flex-end;
            margin-bottom: 2px;
            min-width: 25px;
            line-height: 1;
        }
        .page-content.active { display: block; }
        
        #page-calendar.active, #page-todo.active {
        display: flex;
        flex-direction: column;
        padding: 0;
        overflow: hidden; 
        /* ä¿®æ”¹é€™ä¸€è¡Œï¼šåŠ ä¸Š env(safe-area-inset-top) */
        padding-top: calc(70px + env(safe-area-inset-top)); 
        padding-bottom: 90px; 
        }
        
        .nav-item.active { color: #2cc998; } 
        .nav-item.active svg { stroke-width: 2.5px; }

        .tt-input-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tt-input-row:active { background-color: #f9fafb; }
        .tt-icon { color: #9ca3af; margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; }
        
        /* === å„ªåŒ–ï¼šå½ˆè·³è¦–çª—å‹•ç•« (Spring Pop) === */
        /* 1. å¤–å±¤å®¹å™¨ (è² è²¬èƒŒæ™¯è®Šé»‘) - åªåšæ·¡å…¥æ·¡å‡º */
        .modal {
            transition: opacity 0.25s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        .modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* 2. å…§å±¤å¡ç‰‡ (è² è²¬è·³å‡ºä¾†) - åŠ å…¥è²èŒ²æ›²ç·šè®“å®ƒæœ‰ Q åº¦ */
        .modal .relative {
            /* cubic-bezier æ•¸å€¼ï¼šè®“å‹•ç•«æœ‰ä¸€é»é»ã€Œè¡éé ­å†æ‹‰å›ä¾†ã€çš„å½ˆæ€§æ„Ÿ */
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease;
            
            /* åˆå§‹ç‹€æ…‹ï¼šç¨å¾®ç¸®å° (0.9) ä¸”å¾€ä¸‹æ²‰ä¸€é»é» (10px) */
            transform: scale(0.9) translateY(10px);
            opacity: 0;
        }

        /* é¡¯ç¤ºç‹€æ…‹ï¼šé‚„åŸå¤§å°èˆ‡ä½ç½® */
        .modal.visible .relative {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .bg-theme-light { background-color: var(--app-color-light) !important; }
        .custom-checkbox { appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor; width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { 
            background-color: var(--app-color) !important; 
            border-color: var(--app-color) !important; 
        }        .custom-checkbox:checked::before { transform: scale(1); }
        
        .cat-chip { padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; border: 1px solid #e5e7eb; background: white; color: #6b7280; white-space: nowrap; transition: all 0.2s; }
        .cat-chip.active { background: #2cc998; color: white; border-color: #2cc998; box-shadow: 0 2px 5px rgba(44, 201, 152, 0.2); }

        .todo-item { transition: all 0.3s ease; }
        .todo-item.done span { text-decoration: line-through; color: #9ca3af; }

        .dt-btn { background-color: #f9fafb; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; color: #374151; text-align: center; transition: all 0.2s; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .dt-btn:active, .dt-btn:focus { background-color: #fff; border: 1px solid #2cc998; outline: none; }
        .dt-wrapper-date { flex: 2; position: relative; }
        .dt-wrapper-time { flex: 1; position: relative; }

        /* Unified Input Row Styles */
        .dt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dt-row:active { background-color: #f9fafb; }
        
        .dt-label {
            font-size: 15px; 
            font-weight: 500;
            color: #1f2937; 
            min-width: 60px;
        }
        
        .dt-value {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }
        
        .dt-input {
            width: 100%;
            text-align: right;
            font-size: 15px; 
            color: #1f2937;
            outline: none;
            border: none;
            background: transparent;
            padding: 0;
            font-weight: 400;
        }
        .dt-input::placeholder { color: #9ca3af; }
        
        .dt-text-placeholder { color: #9ca3af; font-size: 15px; }
        .dt-text-value { color: #1f2937; font-size: 15px; font-weight: 500; }

        /* Fixed Time Dropdown Modal Style */
        .time-picker-modal-content {
            background: white;
            border-radius: 16px;
            max-height: 300px;
            overflow-y: auto;
            width: 280px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        .time-option { 
            padding: 10px 16px; 
            font-size: 16px; 
            color: #374151; 
            cursor: pointer; 
            text-align: center;
        }
        .time-option:hover { background-color: #f3f4f6; }
        .time-option.selected { color: #2cc998; font-weight: bold; background-color: #ecfdf5; }

        .status-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #6b7280; transition: all 0.2s; }
        .status-btn.active { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; font-weight: bold; }
        .status-btn.active[data-status="confirmed"] { background: #ecfdf5; border-color: #2cc998; color: #2cc998; }
        .status-btn.active[data-status="tbc"] { background: #fffbeb; border-color: #f59e0b; color: #f59e0b; }
        .status-btn.active[data-status="tbd"] { background: #fef2f2; border-color: #ef4444; color: #ef4444; border-style: dashed; }

        .status-tag { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: 1px; line-height: 1.4; flex-shrink: 0; }
        .status-tag.tbc { border: 1px solid #f59e0b; color: #f59e0b; background: #fffbeb; }
        .status-tag.tbd { border: 1px dashed #ef4444; color: #ef4444; background: #fef2f2; }
        
        .recur-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            background: white;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .recur-btn.active {
            background-color: var(--app-color-light) !important;
            border-color: var(--app-color) !important;
            color: var(--app-color) !important;
            font-weight: bold;
        }
        .day-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .day-circle.active {
            background-color: var(--app-color) !important;
            border-color: var(--app-color) !important;
            color: white;
        }
        
        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { font-size: 12px; color: #9ca3af; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 50%; cursor: pointer; color: #374151; }
        .cal-day:hover { background-color: #f3f4f6; }
        .cal-day.empty { cursor: default; background: none; }
        .cal-day.selected { background-color: #2cc998; color: white; font-weight: bold; }
        .cal-day.today { color: #2cc998; font-weight: bold; }
        .cal-day:nth-child(7n), .cal-day-header:nth-child(7) { color: #f87171; } 
        .cal-day:nth-child(7n+1), .cal-day-header:nth-child(1) { color: #f87171; } 

        /* === TimeTree é¢¨æ ¼æœˆæ›†æ¨£å¼ (å›ºå®šç¶²æ ¼ç‰ˆ) === */
        .big-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #f0f0f0; /* é ‚éƒ¨é‚Šç•Œ */
        }
        
        .big-cal-cell {
            /* é—œéµï¼šå›ºå®šé«˜åº¦ï¼Œè®“æ¯å€‹æ ¼å­ä¸€æ¨£å¤§ */
            height: 110px; 
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0; /* å‚ç›´åˆ†éš”ç·š */
            padding: 2px 0 0 0; /* æ¸›å°‘å…§è·ï¼Œçˆ­å–ç©ºé–“ */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* è¶…å‡ºç¯„åœéš±è—ï¼Œé¿å…æ’é–‹ */
        }

        /* ç§»é™¤æœ€å³é‚Šçš„ç·šï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨ */
        .big-cal-cell:nth-child(7n) {
            border-right: none;
        }

        /* ä¿®æ”¹ï¼šæ—¥æœŸé ­éƒ¨å®¹å™¨ (é‚„åŸ margin) */
        .big-cal-day-header {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 3px;
            padding-top: 2px;
            padding-bottom: 2px;
            margin-bottom: 0px; /* <--- æ”¹å› 0ï¼Œæˆ‘å€‘æ”¹ç”¨ä¸‹æ–¹çš„ padding ä¾†æ¨ */
            height: 24px;
            line-height: 24px;
            position: relative;
        }

        .big-cal-day-num {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            z-index: 5;
        }

        /* ä»Šå¤©æ¨£å¼ (åŸæœ¬æ˜¯åœ“åœˆï¼Œç¾åœ¨æ”¹ç°¡å–®é»ï¼Œæˆ–è€…ç¶­æŒåœ“åœˆä½†è¦åŒ…ä½æ•¸å­—) */
        .big-cal-cell.today .big-cal-day-num {
            background-color: var(--app-color) !important; /* æ”¹ç”¨è®Šæ•¸ */
            color: white !important;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            display: inline-block;
        }

        /* è¾²æ›†æ¨£å¼ */
        .big-cal-lunar {
            font-size: 9px;
            color: #9ca3af; /* ç°è‰² */
            font-weight: 400;
        }

        /* å‡æ—¥æ¨£å¼ */
        .big-cal-holiday {
            font-size: 9px;
            color: #ef4444; /* ç´…è‰² */
            font-weight: bold;
            margin-left: 2px;
        }
        
        /* é€±æœ«å­—é«”è®Šç´… (é¸æ“‡æ€§) */
        .big-cal-cell:nth-child(7n) .big-cal-day-num, 
        .big-cal-cell:nth-child(7n+1) .big-cal-day-num {
            color: #f87171; 
        }
        .big-cal-cell.today .big-cal-day-num { color: white !important; } /* ä»Šå¤©å¼·åˆ¶ç™½å­— */
        
        /* ä¿®æ”¹ï¼šå…§å®¹å€å¡Šå®¹å™¨ (å¾®èª¿é–“è·) */
        .big-cal-content-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1px;
            padding-top: 6px; /* <--- æ”¹æˆ 6pxï¼Œå‰›å‰›å¥½çš„è·é›¢ */
        }

        /* è¡Œç¨‹æ¢æ¨£å¼ï¼šæ›´æ‰ã€æ–‡å­—æ›´å° */
        .event-bar { 
            height: 18px; /* å›ºå®šé«˜åº¦ */
            line-height: 18px;
            font-size: 10px; 
            padding: 0 4px; 
            color: white; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            text-align: left; 
            position: relative;
            box-sizing: border-box;
            z-index: 10;
        }

        /* ä¼‘å‡æ¨£å¼å„ªåŒ– */
        .event-bar.leave {
            background-color: white !important;
            border: 1px solid currentColor;
            font-weight: 800; /* å­—åŠ ç²— */
            line-height: 16px; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05); /* åŠ ä¸€é»é»ç«‹é«”æ„Ÿ */
        }

        /* "+N" çš„æç¤ºæ”¹ç‚ºæ”¾åœ¨æ ¼å­åº•éƒ¨ä¸­å¤® */
        .more-events { 
            font-size: 9px; 
            color: #9ca3af; 
            text-align: center;
            margin-top: 1px;
        }

        .avatar-sm { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #toast-container { transition: opacity 0.3s ease; }
        #toast-container.visible { opacity: 1; }
        
        /* iOS-like Calendar Picker */
        #calendar-picker-modal .calendar-grid { gap: 6px; min-height: auto; }
        #calendar-picker-modal #calendar-days { min-height: unset; }
        #calendar-picker-modal .cal-day { width: 36px; height: 36px; aspect-ratio: unset; border-radius: 9999px; font-size: 14px; font-weight: 500; transition: background-color 0.15s ease, color 0.15s ease; }
        #calendar-picker-modal .cal-day:hover { background-color: #f2f2f7; }
        #calendar-picker-modal .cal-day.today { color: #2cc998; font-weight: 600; }
        #calendar-picker-modal .cal-day.selected { background-color: #2cc998; color: white; font-weight: 600; }
        #calendar-picker-modal .cal-day.empty { pointer-events: none; background: transparent; }
        #calendar-picker-modal .cal-day-header { font-size: 11px; font-weight: 500; color: #8e8e93; }
        #calendar-picker-modal .relative { padding-bottom: 12px; }
        
        /* iOS Bottom Nav */
        nav .nav-item { padding-bottom: 6px; transition: transform 0.12s ease-out, background-color 0.12s ease-out; border-radius: 12px; -webkit-tap-highlight-color: transparent; position: relative; }
        nav .nav-item i { transition: transform 0.12s ease-out; will-change: transform; }
        nav .nav-item:active i { transform: scale(0.85); }
        nav .nav-item.active i { transform: scale(1.1); }
        nav .nav-item span { transform: none !important; }
        nav .nav-item.active::after { content: ""; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; border-radius: 999px; background-color: var(--active-tab-color, #2cc998); }
    
        /* === åˆ†é¡æ¨™ç±¤æ¨£å¼ === */
        .category-chip {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .category-chip.active {
            background-color: #ecfdf5;
            color: #2cc998;
            border-color: #2cc998;
            font-weight: bold;
        }
        
        /* å³å´è¨Šæ¯ (è‡ªå·±)ï¼šè³‡è¨Šæ¬„åœ¨æ°£æ³¡å·¦é‚Š -> å…§å®¹é å³å°é½Š (é å‘æ°£æ³¡) */
        .chat-row.right .chat-info-col { 
            align-items: flex-end; 
            margin-right: 6px; 
        }
        
        /* å·¦å´è¨Šæ¯ (å°æ–¹)ï¼šè³‡è¨Šæ¬„åœ¨æ°£æ³¡å³é‚Š -> å…§å®¹é å·¦å°é½Š (é å‘æ°£æ³¡) */
        .chat-row.left .chat-info-col { 
            align-items: flex-start; 
            margin-left: 6px;
        }

        /* ä¿®æ”¹ï¼šå·²è®€æ¨™ç±¤ (çµ±ä¸€æ·±ç°è‰²) */
        .chat-read {
            font-size: 10px;
            color: #6b7280 !important; /* <--- é—œéµï¼æ”¹æˆæ·±ç°è‰² */
            font-weight: normal; 
            line-height: 1;
            margin-bottom: 3px;
            text-shadow: none;
        }
        
        /* å¼·åˆ¶è¦†å¯«æ™‚é–“æ¨£å¼ï¼Œç¢ºä¿å°é½Š */
        .chat-info-col .chat-time {
            margin: 0 !important; /* ç§»é™¤åŸæœ¬çš„å·¦å³ marginï¼Œè®“å®ƒèƒ½å¤ ç²¾æº–å°é½Š */
            font-size: 10px;      /* ç¢ºä¿è·Ÿå·²è®€ä¸€æ¨£å¤§ï¼Œè¦–è¦ºè¼ƒå¹³è¡¡ */
            line-height: 1;
        }

        /* === ä¿®æ­£ï¼šæ¢å¾©è¨Šæ¯è³‡è¨Šæ¬„çš„å‚ç›´æ’ç‰ˆ === */
        .chat-info-col {
            display: flex;
            flex-direction: column; /* é—œéµï¼è®“å®ƒå€‘å‚ç›´æ’åˆ— (å·²è®€åœ¨ä¸Šï¼Œæ™‚é–“åœ¨ä¸‹) */
            justify-content: flex-end; /* é ä¸‹å°é½Šï¼Œå°é½Šæ°£æ³¡åº•éƒ¨ */
            margin-bottom: 0px; /* å¾®èª¿åº•éƒ¨è·é›¢ */
            min-width: 30px; /* ç¢ºä¿æœ‰è¶³å¤ å¯¬åº¦ */
        }

        .leave-row {
            display: flex;
            justify-content: center; /* <--- åŠ å…¥é€™è¡Œï¼Œè®“æ¨™ç±¤æ°´å¹³ç½®ä¸­ */
            gap: 2px;
            margin-bottom: 2px;
            min-height: 0;
        }

        .leave-chip {
            font-size: 10px;
            color: white;
            font-weight: bold;
            padding: 0 4px; /* ç¨å¾®å¯¬ä¸€é»ï¼Œè®“å­—èˆ’æœ */
            border-radius: 4px;
            height: 16px;   /* å›ºå®šé«˜åº¦ï¼Œè·Ÿä¸€èˆ¬çš„è¡Œç¨‹æ¢å·®ä¸å¤šæˆ–ç•¥å° */
            line-height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* æ—¥æœŸ Header å¾®èª¿ (æ”¹å›é å·¦æˆ–ç½®ä¸­ï¼Œé€™è£¡ç¶­æŒç½®ä¸­æ¯”è¼ƒå¥½çœ‹) */
        .big-cal-day-header {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 3px;
            padding-top: 2px;
            margin-bottom: 2px;
            height: 20px;
            line-height: 20px;
            position: relative;
        }

        /* === æ–°å¢ï¼šç²¾ç¢ºæ™‚é–“é¸æ“‡å™¨æ¨£å¼ === */
        .time-picker-body {
            display: flex;
            height: 220px; /* æ§åˆ¶é¸æ“‡å€åŸŸé«˜åº¦ */
            overflow: hidden;
            position: relative;
            background: #fff;
        }
        
        .time-column {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            text-align: center;
            /* scroll-behavior: smooth; <--- åˆªé™¤é€™è¡Œ */
            scroll-snap-type: y mandatory; /* åŠ å…¥ï¼šå¼·åˆ¶å‚ç›´å¸é™„ */
            position: relative;            /* åŠ å…¥ï¼šç¢ºä¿å®šä½è¨ˆç®—æº–ç¢º */
        }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™æ²å‹•åŠŸèƒ½ */
        .time-column::-webkit-scrollbar { display: none; }
        .time-column { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ä¿®æ”¹ï¼šæ™‚é–“æ ¼ (å›ºå®šé«˜åº¦ 50pxï¼Œé€™æ˜¯è¨ˆç®—çš„åŸºæº–) */
        .time-cell {
            height: 50px;  /* <--- é—œéµï¼å›ºå®šé«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #9ca3af; /* æ²’é¸ä¸­æ™‚ç”±æ·±ç°æ”¹æ·ºç°ï¼Œæ›´åƒæ»¾è¼ª */
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin: 0 10px;
            scroll-snap-align: center; /* ä¿æŒå¸é™„æ•ˆæœ */
            user-select: none; /* é˜²æ­¢æ»‘å‹•æ™‚é¸å–åˆ°æ–‡å­— */
        }
        
        .time-cell:hover { background-color: #f9fafb; }
        
        /* é¸ä¸­æ¨£å¼ (ç¶ è‰²æ”¾å¤§) */
        .time-cell.selected {
            color: var(--app-color) !important; /* æ”¹ç”¨è®Šæ•¸ */
            font-weight: 800;
            font-size: 26px;
            transform: scale(1);
            opacity: 1;
        }

        /* æ–°å¢ï¼šæ’é–‹é ­å°¾çš„ç©ºç™½å€å¡Š */
        .picker-spacer {
            height: 85px; /* (å®¹å™¨é«˜åº¦ 220 / 2) - (å–®æ ¼é«˜åº¦ 50 / 2) = 110 - 25 = 85 */
            width: 100%;
            flex-shrink: 0;
        }
        
        .time-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #d1d5db;
            width: 20px;
            padding-bottom: 20px; /* å¾®èª¿å°é½Š */
        }

        /* === ä¿®æ­£ï¼šè‡ªè¨‚å¾…è¾¦åˆ†é¡è¼¸å…¥æ¡† (èšç„¦æ™‚è®Šä¸»é¡Œè‰²) === */
        .focus-border-theme:focus {
            border-color: var(--app-color) !important;
            --tw-ring-color: var(--app-color) !important; /* âœ… æ”¹æˆé€™æ¨£æ‰å° */
            outline: none; /* ç¢ºä¿ç§»é™¤é è¨­é»‘æ¡† */
        }

        /* === ä¿®æ­£ï¼šåˆ†é¡æ¨™ç±¤é¸å–ç‹€æ…‹ (æ”¹ç”¨è®Šæ•¸) === */
        .category-chip.active {
            background-color: var(--app-color-light) !important; /* æ·ºè‰²åº• */
            color: var(--app-color) !important;      /* ä¸»è‰²å­— */
            border-color: var(--app-color) !important; /* ä¸»è‰²æ¡† */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        /* === ä¿®æ­£ï¼šè¨­å®šé é¢çš„ Toggle é–‹é—œ (é¸å–æ™‚è®Šä¸»é¡Œè‰²) === */
        /* ç•¶ input è¢« checked æ™‚ï¼Œå¾Œé¢çš„ div è®Šè‰² */
        .toggle-checkbox:checked + .toggle-bg {
            background-color: var(--app-color) !important;
        }

        /* === æ–°å¢ï¼šåˆ†é¡æ’åºæŒ‰éˆ•æ¨£å¼ === */
        .sort-btn {
            padding: 4px;
            border-radius: 6px;
            color: #9ca3af;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sort-btn:hover { background-color: #f3f4f6; color: #4b5563; }
        .sort-btn:active { transform: scale(0.9); background-color: #e5e7eb; }
        .sort-btn.disabled { opacity: 0.3; cursor: default; pointer-events: none; }

        /* === æ–°å¢ï¼šåˆ†é¡ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•æ¨£å¼ === */
        .cat-action-btn {
            padding: 4px;
            margin-left: 2px;
            color: #9ca3af;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .cat-action-btn:hover { background-color: #f3f4f6; color: #4b5563; }
        .cat-action-btn.delete:hover { background-color: #fee2e2; color: #ef4444; }

        /* === è²¼åœ–é¸æ“‡å™¨æ¨£å¼ === */
        #sticker-picker-container {
            height: 0;
            overflow: hidden;
            transition: height 0.2s ease-out;
            background-color: #f9fafb;
            border-top: 1px solid #f0f0f0;
        }
        #sticker-picker-container.open {
            height: 200px; /* è²¼åœ–å€é«˜åº¦ */
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
            height: 100%;
            overflow-y: auto;
        }
        .sticker-item {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            cursor: pointer;
            border-radius: 8px;
            padding: 5px;
            transition: transform 0.1s;
        }
        .sticker-item:active {
            transform: scale(0.9);
            background-color: #e5e7eb;
        }
        
        /* èŠå¤©å®¤å…§çš„è²¼åœ–é¡¯ç¤ºæ¨£å¼ */
        .chat-sticker {
            max-width: 120px; /* è²¼åœ–æœ€å¤§å¯¬åº¦ */
            border-radius: 12px;
            display: block;
            /* èƒŒæ™¯è¨­å®šå·²ç§»é™¤ï¼ŒPNG é€æ˜éƒ¨åˆ†å°±æœƒæ­£å¸¸é¡¯ç¤ºäº† */
        }

        /* === æ»‘å‹•åˆªé™¤å°ˆç”¨æ¨£å¼ === */
        .swipe-item {
            position: relative;
            overflow: hidden; /* éš±è—è¶…å‡ºç¯„åœçš„ç´…è‰²æŒ‰éˆ• */
        }

        /* ç´…è‰²åˆªé™¤åº•å±¤ */
        .swipe-action-bg {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 80px; /* åˆªé™¤æŒ‰éˆ•å¯¬åº¦ */
            background-color: #ef4444; /* ç´…è‰² */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 0;
        }

        /* å‰æ™¯å…§å®¹å±¤ (æˆ‘å€‘è¦æ»‘å‹•é€™å±¤) */
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: white;
            transition: transform 0.2s ease-out;
            width: 100%;
            
            /* ğŸ‘‡ åŠ å…¥é€™ä¸€è¡Œ ğŸ‘‡ */
            /* æ„æ€ï¼šç€è¦½å™¨åªè² è²¬è™•ç† Y è»¸(ä¸Šä¸‹)æ²å‹•ï¼ŒX è»¸(å·¦å³)å‹•ä½œç•™çµ¦æˆ‘çš„ç¨‹å¼ç¢¼è™•ç† */
            touch-action: pan-y; 
        }

        #calendar-scroll-area {
    /* ...åŸæœ¬çš„è¨­å®š... */
    
    /* ğŸ‘‡ åŠ å…¥é€™ä¸€è¡Œï¼Œæ„æ€æ˜¯ï¼šé€™å€‹å€åŸŸä¸»è¦è² è²¬ä¸Šä¸‹æ²å‹•ï¼Œå·¦å³æ»‘å‹•äº¤çµ¦ JS è™•ç† */
    touch-action: pan-y; 
}

    /* === éµç›¤å„ªåŒ–ï¼šç•¶éµç›¤é–‹å•Ÿæ™‚ === */
    body.keyboard-open nav {
        display: none !important; /* éš±è—åº•éƒ¨å°èˆªåˆ— */
    }

    /* ç¢ºä¿è¼¸å…¥æ¡†è²¼åœ¨éµç›¤ä¸Šæ–¹ */
    body.keyboard-open #page-chat {
        padding-bottom: 0 !important;
    }

    /* === å„ªåŒ–ï¼šæ‹–æ›³æ™‚éš±è—ç´…è‰²åˆªé™¤åº•å±¤ (é˜²æ­¢ç©¿å¹«) === */
    .sortable-ghost .swipe-action-bg,
    .sortable-drag .swipe-action-bg,
    .sortable-chosen .swipe-action-bg {
        display: none !important;
        visibility: hidden !important;
    }

    /* === æ‹–æ›³æ’åºæ¨£å¼ === */
    .sortable-ghost {
        opacity: 0.4;
        background-color: #f3f4f6;
        border: 2px dashed #d1d5db;
    }
    .sortable-drag {
        cursor: grabbing;
        opacity: 1;
        background: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: scale(1.02); /* ç¨å¾®æ”¾å¤§ä¸€é»é» */
    }

    /* === æ‰¹æ¬¡é¸å–æ¨¡å¼æ¨£å¼ (å¼·åˆ¶ä¿®æ­£ç‰ˆ) === */
    .batch-checkbox-col {
        width: 0;
        min-width: 0; /* é è¨­æœ€å°å¯¬åº¦ç‚º 0 */
        overflow: hidden;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0 !important; /* ğŸš« ç¦æ­¢è¢«å£“ç¸® */
    }

    /* ç•¶ .swipe-item æœ‰ selection-mode æ™‚ï¼Œå¼·åˆ¶å±•é–‹ */
    .swipe-item.selection-mode .batch-checkbox-col {
        width: 40px !important;      /* å¼·åˆ¶å¯¬åº¦ */
        min-width: 40px !important;  /* å¼·åˆ¶æœ€å°å¯¬åº¦ (é—œéµ!) */
        opacity: 1 !important;       /* å¼·åˆ¶é¡¯ç¤º */
        margin-right: 8px !important;
    }

    /* æ¨¡æ“¬ iOS çš„åœ“å½¢å‹¾é¸æ¡† */
    .batch-check-circle {
        width: 22px;
        height: 22px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        transition: all 0.2s;
        position: relative;
    }

    /* é¸ä¸­ç‹€æ…‹ */
    .batch-check-circle.checked {
        background-color: #2cc998; /* ä¸»é¡Œè‰² */
        border-color: #2cc998;
    }

    /* æ‰“å‹¾ç¬¦è™Ÿ (ç”¨ CSS ç•«) */
    .batch-check-circle.checked::after {
        content: '';
        position: absolute;
        left: 7px;
        top: 3px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* åº•éƒ¨æ‰¹æ¬¡æ“ä½œåˆ— */
    #batch-action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        padding: 16px; /* åŠ å¤§ä¸€é»æ–¹ä¾¿é»æ“Š */
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        display: flex;
        justify-content: space-between;
        align-items: center;
        transform: translateY(100%); /* é è¨­è—åœ¨ä¸‹é¢ */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100; /* è¦è“‹éåŸæœ¬çš„å°èˆªåˆ— */
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    #batch-action-bar.visible {
        transform: translateY(0);
    }

    /* === å…¨è‰²ç³»ä¸»é¡Œæ¨£å¼ === */

    /* 1. ç•¶åº•éƒ¨å°èˆªåˆ—è®Šè‰²æ™‚ï¼Œèª¿æ•´æŒ‰éˆ•æ¨£å¼ */
    nav.colored-nav .nav-item {
        color: rgba(255, 255, 255, 0.6) !important; /* æœªé¸ä¸­ï¼šåŠé€æ˜ç™½è‰² */
    }

    nav.colored-nav .nav-btn.active .nav-icon-pill {
        background-color: white !important; /* é¸ä¸­ï¼šèƒŒæ™¯è®Šç™½ */
        color: var(--app-color) !important; /* é¸ä¸­ï¼šåœ–ç¤ºè®Šå›ä¸»é¡Œè‰² */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav.colored-nav .nav-btn.active span {
        color: white !important; /* é¸ä¸­ï¼šæ–‡å­—è®Šç™½ */
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* 2. èª¿æ•´ Header å…§çš„æ–‡å­—é¡è‰² */
    header.colored-header h1, 
    header.colored-header span,
    header.colored-header i {
        color: white !important;
    }

    /* èª¿æ•´ Header å…§çš„ User Badge (åŸæœ¬æœ‰èƒŒæ™¯è‰²ï¼Œç¾åœ¨æ”¹æˆç™½è‰²åŠé€æ˜) */
    header.colored-header #header-role-badge {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* === çµ‚æ¥µè§£æ³•ï¼šå¼·åˆ¶é–‹å•Ÿ iOS å½ˆæ€§æ•ˆæœ (å³ä½¿å…§å®¹å¾ˆå°‘ä¹Ÿæœƒå½ˆ) === */
        #chat-container::after {
            content: "";
            display: block;
            position: absolute; /* çµ•å°å®šä½ï¼Œä¸ä½”æ“šå¯¦éš›ç‰ˆé¢ */
            top: 0;
            left: 0;
            width: 1px;
            height: calc(100% + 1px); /* é—œéµï¼æ°¸é æ¯”å®¹å™¨é«˜ 1px */
            pointer-events: none;     /* è®“é»æ“Šç©¿é€ï¼Œä¸å½±éŸ¿æ“ä½œ */
            z-index: -1;              /* è—åœ¨æœ€åº•ä¸‹ */
            opacity: 0;               /* å®Œå…¨é€æ˜ */
        }

    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden bg-white">

    <!-- Header -->
    <header id="app-header" class="bg-white border-b border-gray-100 p-4 fixed top-0 w-full z-40 safe-top flex justify-between items-center shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-3">
            <img src="icon.png" alt="Logo" class="w-9 h-9 rounded-xl shadow-sm">
            <h1 class="text-lg font-bold text-gray-800 tracking-wide">
                å°æ™‚å…‰ <span class="text-xs text-gray-400 font-normal ml-0.5">for us</span>
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="header-role-badge" class="px-2.5 py-1 rounded-full text-xs text-white font-bold shadow-sm transition-colors duration-300 flex items-center gap-1.5 opacity-0 cursor-pointer hover:opacity-90 active:scale-95 transition-transform" onclick="window.openSettingsModal()">
                <span id="header-role-name">è¼‰å…¥ä¸­</span>
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>
            <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-red-400 ring-2 ring-white shadow-sm"></div>
        </div>
    </header>

    <!-- Main Content -->
 <main id="main-container">

<div id="page-dashboard" class="page-content active">
            
            <div class="px-4 mb-3">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-green-100/50 to-transparent rounded-full -mr-8 -mt-8 pointer-events-none"></div>
                    
                    <div class="z-10">
                        <div class="flex items-baseline gap-1.5">
                            <span id="brief-day-num" class="text-3xl font-bold text-gray-800 tracking-tight">--</span>
                            <span id="brief-day-word" class="text-sm font-bold text-gray-500">é€±--</span>
                        </div>
                        
                        <div id="brief-special" class="hidden text-sm font-bold text-rose-500 mt-1 mb-0.5 animate-pulse">
                            </div>

                        <div class="flex items-center gap-2 mt-0.5">
                            <span id="brief-month-year" class="text-xs text-gray-400 font-medium">--æœˆ / 20--</span>
                            <span class="w-0.5 h-3 bg-gray-200 rounded-full"></span>
                            <span id="brief-lunar" class="text-xs text-theme font-medium">è¾²æ›† --</span>
                        </div>
                    </div>

                    <div class="text-right z-10 flex flex-col items-end">
                        <div class="flex items-center gap-2">
                            <i id="brief-weather-icon" data-lucide="cloud" class="w-6 h-6 text-gray-400"></i>
                            <span id="brief-temp-current" class="text-2xl font-bold text-gray-800">--Â°</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-0.5 font-medium flex items-center gap-1">
                            <span id="brief-weather-desc">è¼‰å…¥ä¸­</span>
                            <span>â€¢</span>
                            <span id="brief-temp-range">H:--Â° L:--Â°</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 flex gap-3 mb-6">
                <button onclick="window.openAddModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="calendar-plus" class="w-5 h-5 text-theme"></i>
                    <span class="text-sm font-bold">æ–°å¢è¡Œç¨‹</span>
                </button>
                <button onclick="window.openAddTodoModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="check-square" class="w-5 h-5 text-blue-400"></i>
                    <span class="text-sm font-bold">æ–°å¢å¾…è¾¦</span>
                </button>
            </div>

            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4">
                <div class="bg-theme px-4 py-2 flex justify-between items-center">
                    <span class="text-white text-xs font-bold tracking-wider">NEXT 3 DAYS</span>
                    <button onclick="window.switchTab('calendar')" class="text-white text-xs font-bold hover:bg-white/20 px-2 py-1 rounded transition">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
                    <div class="text-center py-8 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-theme"></i> å¾…è¾¦æ¸…å–®
                    </h3>
                    <button onclick="window.switchTab('todo')" class="text-xs text-theme font-medium">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div id="dashboard-todo-list" class="space-y-2">
                    <p class="text-xs text-gray-400 text-center py-2">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
        </div>

        <!-- Page 2: Calendar -->
        <div id="page-calendar" class="page-content">
            <div class="flex-none bg-white z-10 border-b border-gray-200 px-4 flex items-center justify-between h-[60px] relative">
    
    <button id="btn-batch-event" onclick="window.toggleBatchMode('event')" class="text-sm font-medium text-gray-500 hidden">
        é¸æ“‡
    </button>
    <div id="calendar-header-spacer" class="w-8 hidden"></div> <div class="flex bg-gray-100 p-1 rounded-lg absolute left-1/2 transform -translate-x-1/2">
        <button onclick="window.switchCalendarView('list')" id="btn-view-list" class="w-16 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-theme transition-all">åˆ—è¡¨</button>
        <button onclick="window.switchCalendarView('month')" id="btn-view-month" class="w-16 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">æœˆæ›†</button>
    </div>
    
    <button id="btn-add-event-main" onclick="window.openAddModal()" class="bg-theme text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-sm active:scale-95 transition hover:bg-green-500">
        <i data-lucide="plus" class="w-5 h-5"></i>
    </button>
</div>
            <div class="flex-1 overflow-y-auto bg-gray-50 relative w-full" id="calendar-view-month">
                <div id="calendar-view-list" class="absolute inset-0 overflow-y-auto">
                    <div id="event-list" class="divide-y divide-gray-100 bg-white">
                        <div class="text-center py-10 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                <div id="calendar-view-month-container" class="absolute inset-0 flex flex-col bg-gray-50 hidden">
                    
            <div class="flex-none bg-white z-20 shadow-sm relative">
                        <div class="flex justify-between items-center p-3 border-b border-gray-100">
                            <h2 id="big-cal-title" class="text-lg font-bold text-gray-800 pl-2">...</h2>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="window.jumpToToday()" class="text-xs font-bold text-theme bg-theme-light px-3 py-1.5 rounded-full hover:bg-green-100 transition active:scale-95 mr-1">
                                    ä»Šå¤©
                                </button>
                                <button onclick="window.changeBigCalMonth(-1)" class="p-1.5 rounded-full hover:bg-gray-100 active:bg-gray-200 transition">
                                    <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
                                </button>
                                <button onclick="window.changeBigCalMonth(1)" class="p-1.5 rounded-full hover:bg-gray-100 active:bg-gray-200 transition">
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-7 text-center py-2 bg-white">
                            <div class="big-cal-header text-xs font-bold text-red-400">æ—¥</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">ä¸€</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">äºŒ</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">ä¸‰</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">å››</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">äº”</div>
                            <div class="big-cal-header text-xs font-bold text-red-400">å…­</div>
                        </div>
                    </div>

                    <div id="calendar-scroll-area" class="flex-1 overflow-y-auto relative bg-white w-full">
                        <div id="big-cal-grid" class="big-cal-grid border-t border-gray-100 pb-4"></div>
                        
                        <div class="bg-gray-50 border-t border-gray-200 min-h-[300px] pb-24">
                            <div class="sticky top-0 z-10 px-4 py-2 bg-gray-50/95 backdrop-blur border-b border-gray-200 flex justify-between items-center shadow-sm">
                                <span id="selected-date-label" class="text-sm font-bold text-gray-600">é¸æ“‡æ—¥æœŸæŸ¥çœ‹</span>
                            </div>
            <div id="month-event-list" class="divide-y divide-gray-100 bg-white">
                                </div>
                        </div>
                    </div>
                </div> </div>     </div>         <div id="page-todo" class="page-content">
            
            <div class="flex-none bg-white z-20 border-b border-gray-200 px-4 flex items-center justify-between h-[60px] relative shadow-[0_1px_2px_rgba(0,0,0,0.05)]">
    
    <button id="btn-batch-todo" onclick="window.toggleBatchMode('todo')" class="text-sm font-medium text-gray-500">
        é¸æ“‡
    </button>

    <h2 class="text-xl font-bold text-gray-800 absolute left-1/2 transform -translate-x-1/2">å¾…è¾¦æ¸…å–®</h2>
    
    <button id="btn-add-todo-main" onclick="window.openAddTodoModal()" class="bg-theme text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-sm active:scale-95 transition hover:bg-green-500">
        <i data-lucide="plus" class="w-5 h-5"></i>
    </button>
</div>
            
            <div id="todo-scroll-area" class="flex-1 overflow-y-auto bg-white w-full relative">
                <div id="todo-category-container" class="p-4 space-y-4 pb-24">
                    <div class="text-center py-10 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

        </div>

        <div id="page-chat" class="page-content h-full">
            
            <div id="chat-container" onclick="window.dismissKeyboard()" class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 bg-[#9bbbd4] shadow-inner no-scrollbar">
                <div class="text-center text-xs text-gray-500 mt-4 bg-white/50 py-1 rounded-full mx-auto px-4 w-fit">
                    è¼‰å…¥å°è©±ä¸­...
                </div>
            </div>

            <div class="flex-none bg-white border-t border-gray-200 z-20">
                <div class="p-3 bg-gray-50 flex items-center gap-2">
                    
                    <button onclick="window.toggleStickerPicker()" class="p-2 text-gray-400 hover:text-gray-600 active:scale-95 transition rounded-full hover:bg-gray-200 flex-shrink-0">
                        <i data-lucide="smile" class="w-6 h-6"></i>
                    </button>

                    <div class="flex-1 flex flex-nowrap items-center bg-white rounded-full px-2 py-2 shadow-sm border border-gray-200 focus-within:ring-2 focus-within:ring-ttgreen focus-within:ring-opacity-50">
                        
                        <div class="w-8 h-8 flex items-center justify-center text-gray-400 flex-shrink-0 cursor-pointer hover:text-gray-600 active:scale-95 transition" onclick="window.scrollToBottom()">
                            <i data-lucide="arrow-down-circle" class="w-6 h-6"></i>
                        </div>

                        <input type="text" id="note-input" placeholder="å‚³é€è¨Šæ¯..." class="flex-1 min-w-0 bg-transparent border-none text-base text-gray-700 placeholder-gray-400 focus:ring-0 px-2 outline-none text-left h-full py-1" onfocus="window.closeStickerPicker()">
                    
                    </div> <button id="note-send-btn" onclick="window.sendNote()" class="w-9 h-9 flex items-center justify-center rounded-full bg-ttgreen text-white shadow-md active:scale-90 transition ml-1 flex-shrink-0 hover:bg-green-500">
                        <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                    </button>
                </div>

                <div id="sticker-picker-container">
                    <div id="sticker-grid" class="sticker-grid">
                        </div>
                </div>
            </div>
    </main>

    <!-- Modals (All preserved) -->
    
    <!-- Global Color Picker Modal -->
    <div id="global-color-picker" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.toggleGlobalColorPicker(false)"></div>
        <div class="relative bg-white w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">é¸æ“‡é¡è‰²</h3>
            <div id="global-color-grid" class="grid grid-cols-1 gap-1 max-h-[300px] overflow-y-auto"></div>
            <button onclick="window.toggleGlobalColorPicker(false)" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeSettingsModal()"></div>
        <div class="relative bg-white w-[320px] rounded-2xl shadow-xl overflow-hidden transform scale-100 transition-transform">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">è¨­å®š</h3>
                <button onclick="window.closeSettingsModal()" class="p-1 rounded-full hover:bg-gray-200 text-gray-400 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-5 space-y-6">
                <div id="role-selection-section" class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">æˆ‘æ˜¯èª°ï¼Ÿ (åˆ‡æ›èº«åˆ†)</p>
                    <div class="flex gap-3">
                        <button id="role-haohao" onclick="window.setRole('haohao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">çš“çš“</button>
                        <button id="role-maomao" onclick="window.setRole('maomao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">æ¯›æ¯›</button>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">ä»£è¡¨è‰²è¨­å®š</p>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('haohao')">
                            <span class="text-sm font-medium text-gray-700">çš“çš“</span>
                            <div id="setting-color-haohao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('maomao')">
                            <span class="text-sm font-medium text-gray-700">æ¯›æ¯›</span>
                            <div id="setting-color-maomao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('joint')">
                            <span class="text-sm font-medium text-gray-700">å…±åŒè¡Œç¨‹</span>
                            <div id="setting-color-joint" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">é€šçŸ¥è¨­å®š</p>
                    <button onclick="window.manualSetupPush()" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 flex items-center justify-center gap-2 active:bg-gray-200 transition text-gray-700 font-bold">
                        <i data-lucide="bell" class="w-4 h-4"></i>
                        é‡æ–°è¨»å†Šæ¨æ’­ (Debug)
                    </button>
                </div>
                    </div>
                </div>

                <div class="space-y-3">
                    
                    <div class="space-y-3">
                    
                    <button onclick="window.openCategorySettingsModal()" class="w-full bg-gray-50 p-4 rounded-xl border border-gray-100 flex items-center justify-between group active:scale-98 transition cursor-pointer">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg text-theme shadow-sm border border-gray-100">
                                <i data-lucide="list-filter" class="w-5 h-5"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-sm font-bold text-gray-700 block">ç®¡ç†åˆ†é¡æ’åº & é¡¯ç¤º</span>
                                <span class="text-[10px] text-gray-400 block mt-0.5">é»æ“Šé€²å…¥èª¿æ•´</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 group-hover:text-gray-500 transition"></i>
                    </button>
                </div>
                </div>

            </div>
            <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                <span class="text-[10px] text-gray-400">Firebase Connected Â· v105.0</span>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeConfirmModal()"></div>
        <div class="relative bg-white w-[280px] rounded-xl shadow-xl p-5 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-4">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œæ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" onclick="window.executeDelete()" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200">åˆªé™¤</button>            
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[90] pointer-events-none transition-opacity duration-300 opacity-0">
        <div id="toast-message" class="bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur-sm">
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
      <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddModal()"></div>

      <div class="relative bg-white w-full h-full md:h-auto md:w-[380px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
        
        <!-- NEW HEADER: Standard App Style -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100" 
     style="padding-top: calc(12px + env(safe-area-inset-top));">
            <button onclick="window.closeAddModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition cursor-pointer">å–æ¶ˆ</button>
            <span class="text-sm font-bold text-gray-800">è¡Œç¨‹è©³æƒ…</span>
            <button onclick="window.saveEvent()" class="text-theme text-sm font-bold px-2 py-1 hover:hover:bg-gray-50 rounded-lg transition">ä¿å­˜</button>
        </div>

        <!-- Title -->
        <div class="px-6 pt-4 pb-2">
          <label class="text-xs font-bold text-gray-400 mb-1 block">æ¨™é¡Œ</label>
          <input
            type="text"
            id="input-title"
            placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œ"
            class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent"
          />
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">

          <!-- Date / Time / Location Group -->
          <!-- æ¡ç”¨ç™½åº•ã€å…§éƒ¨æœ‰åˆ†éš”ç·šçš„åˆ—è¡¨é¢¨æ ¼ -->
          <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
             
             <!-- Date -->
             <div class="dt-row" onclick="window.openCalendar('start')">
               <div class="dt-label">é–‹å§‹æ—¥æœŸ</div>
               <div class="dt-value group">
                 <span id="display-date-start" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-start">
             </div>

             <!-- Time (Start) -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('start')">
              <div class="dt-label">é–‹å§‹æ™‚é–“</div>
              <div class="dt-value group">
                <span id="display-time-start" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-start" value="">
            </div>
            
            <!-- Time (End) - New! -->
            <div class="dt-row border-t border-gray-50" onclick="window.openCalendar('end')">
               <div class="dt-label">çµæŸæ—¥æœŸ</div>
               <div class="dt-value group">
                 <span id="display-date-end" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-end">
             </div>

            <!-- End Time -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('end')">
              <div class="dt-label">çµæŸæ™‚é–“</div>
              <div class="dt-value group">
                <span id="display-time-end" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-end" value="">
            </div>

            <!-- Location -->
            <div class="dt-row border-t border-gray-50">
              <div class="dt-label">åœ°é»</div>
              <div class="dt-value">
                <input id="input-location" type="text" placeholder="è¼¸å…¥åœ°é»" class="dt-input" />
              </div>
            </div>
          </div>

          <div class="dt-row border-t border-gray-50" onclick="window.openReminderPicker()">
              <div class="dt-label">æé†’</div>
              <div class="dt-value group">
                  <span id="display-remind" class="dt-text-value">ä¸é€šçŸ¥</span>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-remind" value="0">
          </div>

          <!-- Partner -->
          <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
            <span class="text-sm text-gray-700">èˆ‡å°æ–¹ä¸€èµ·</span>
            <input
              type="checkbox"
              id="check-partner"
              class="custom-checkbox"
              onchange="window.togglePartner()"
            />
          </div>

          <!-- Recurrence (New!) -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
             <div class="flex justify-between items-center mb-3">
                 <span class="text-sm text-gray-700 font-bold">é‡è¤‡è¨­å®š</span>
                 <input type="checkbox" id="check-recur-event" class="custom-checkbox" onchange="window.toggleRecurOptions('event')">
             </div>
             <div id="recur-options-event" class="hidden space-y-3 pt-2 border-t border-gray-100">
                 <!-- Frequency -->
                 <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                     <button type="button" class="recur-btn active flex-shrink-0" data-val="daily" onclick="window.selectRecurFreq('event', 'daily')">æ¯å¤©</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="weekly" onclick="window.selectRecurFreq('event', 'weekly')">æ¯é€±</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="biweekly" onclick="window.selectRecurFreq('event', 'biweekly')">æ¯å…©é€±</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="monthly" onclick="window.selectRecurFreq('event', 'monthly')">æ¯æœˆ</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="yearly" onclick="window.selectRecurFreq('event', 'yearly')">æ¯å¹´</button>
                 </div>
                 
                 <!-- Weekly Days Selector -->
                 <div id="recur-days-row-event" class="flex justify-between hidden">
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="0">æ—¥</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="1">ä¸€</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="2">äºŒ</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="3">ä¸‰</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="4">å››</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="5">äº”</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="6">å…­</button>
                 </div>

                 <!-- End Date (Fixed: Custom Picker) -->
                 <div class="dt-row p-0 border-none" onclick="window.openCalendar('recur-event')">
                     <div class="dt-label text-xs text-gray-400">çµæŸé‡è¤‡</div>
                     <div class="dt-value">
                         <span id="display-date-recur-event" class="text-sm text-gray-600 bg-gray-50 rounded px-2 py-1">è¨­å®šæ—¥æœŸ</span>
                         <input type="hidden" id="input-date-recur-event">
                     </div>
                 </div>
                 <p class="text-[10px] text-gray-400 text-center">å°‡è‡ªå‹•ç”¢ç”Ÿè‡³çµæŸæ—¥æœŸçš„è¡Œç¨‹</p>
             </div>
          </div>

          <!-- Status -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <label class="text-xs font-bold text-gray-400 mb-2 block">ç‹€æ…‹</label>
            <div class="flex gap-2">
              <button
                type="button"
                class="status-btn active"
                data-status="confirmed"
                onclick="window.setStatus('confirmed')"
              >å·²ç¢ºèª</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbc"
                onclick="window.setStatus('tbc')"
              >TBC</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbd"
                onclick="window.setStatus('tbd')"
              >TBD</button>
            </div>
            <input type="hidden" id="input-status" value="confirmed">
          </div>

          <!-- Note -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
            <label class="text-xs font-bold text-gray-400 mb-1 block">å‚™è¨»</label>
            <textarea
              id="input-note"
              rows="3"
              placeholder="ç°¡å–®å‚™è¨»ä¸€ä¸‹å°±å¥½"
              class="w-full text-sm bg-transparent focus:outline-none resize-none"
            ></textarea>
          </div>

        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-100 flex justify-center pb-20 md:pb-4">
          <!-- åˆªé™¤æŒ‰éˆ• (åªåœ¨ç·¨è¼¯æ™‚é¡¯ç¤ºï¼Œå…¨å¯¬ç´…è‰²æŒ‰éˆ•) -->
          <button
            id="btn-delete-event"
            onclick="window.deleteCurrentEvent()"
            class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
          >
            åˆªé™¤æ­¤è¡Œç¨‹
          </button>
        </div>

      </div>
    </div>

    
    <!-- Add Todo Modal -->
    <div id="add-todo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddTodoModal()"></div>
        <div class="relative bg-white w-full h-full md:h-auto md:w-[350px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
            
            <!-- HEADER: Standard App Style (Unified with Add Event) -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100" 
     style="padding-top: calc(12px + env(safe-area-inset-top));">
                <button onclick="window.closeAddTodoModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition cursor-pointer">å–æ¶ˆ</button>
                <span id="todo-modal-title" class="text-sm font-bold text-gray-800">æ–°å¢å¾…è¾¦äº‹é …</span>
                <button onclick="window.saveTodoItem()" id="todo-modal-btn" class="text-theme text-sm font-bold px-2 py-1 hover:hover:bg-gray-50 rounded-lg transition">æ–°å¢</button>
            </div>

            <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                <!-- Content Input (Unified Style) -->
                <div class="px-2 pt-2 pb-2">
                    <label class="text-xs font-bold text-gray-400 mb-1 block">å…§å®¹</label>
                    <input type="text" id="todo-input-title" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent">
                </div>
                <div class="px-2 pt-2 pb-2">
                    <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-400 block">åˆ†é¡æ¨™ç±¤</label>
                    <button onclick="window.toggleCustomCategoryInput()" class="text-[10px] text-theme font-bold bg-theme-light px-2 py-0.5 rounded">è‡ªè¨‚</button>
                    </div>
                    
                    <div id="todo-category-chips" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        </div>
                    
                    <div id="todo-custom-category-container" class="hidden mt-2 flex gap-2">
                    <input type="text" id="todo-input-category-custom" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus-border-theme">
                    </div>
                    
                    <input type="hidden" id="todo-input-category" value="">
                </div>
                <!-- Date/Time Group (Unified List Style) -->
                <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
                    <!-- Date -->
                    <div class="dt-row" onclick="window.openCalendar('todo')">
                        <div class="dt-label">é–‹å§‹æ—¥æœŸ</div>
                        <div class="dt-value group">
                            <span id="display-date-todo" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo">
                    </div>
                    
                    <!-- Time (Start) -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo')">
                        <div class="dt-label">é–‹å§‹æ™‚é–“</div>
                        <div class="dt-value group">
                            <span id="display-time-todo" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo">
                    </div>
                    
                    <!-- End Date (New!) -->
                    <div class="dt-row border-t border-gray-50" onclick="window.openCalendar('todo-end')">
                        <div class="dt-label">çµæŸæ—¥æœŸ</div>
                        <div class="dt-value group">
                            <span id="display-date-todo-end" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo-end">
                    </div>

                    <!-- Time (End) - New! -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo-end')">
                        <div class="dt-label">çµæŸæ™‚é–“</div>
                        <div class="dt-value group">
                            <span id="display-time-todo-end" class="dt-text-placeholder transition-colors">è«‹é¸æ“‡</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo-end">
                    </div>
                </div>

                <!-- Options -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-700">å…±åŒå¾…è¾¦ (å…©äººå¯è¦‹)</span>
                    <input type="checkbox" id="todo-check-joint" class="custom-checkbox">
                </div>

                <!-- Recurrence (New! for Todo) -->
                <div class="bg-white border border-gray-200 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-700 font-bold">é‡è¤‡è¨­å®š</span>
                        <input type="checkbox" id="check-recur-todo" class="custom-checkbox" onchange="window.toggleRecurOptions('todo')">
                    </div>
                    <div id="recur-options-todo" class="hidden space-y-3 pt-2 border-t border-gray-100">
                        <!-- Frequency -->
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            <button type="button" class="recur-btn active flex-shrink-0" data-val="daily" onclick="window.selectRecurFreq('todo', 'daily')">æ¯å¤©</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="weekly" onclick="window.selectRecurFreq('todo', 'weekly')">æ¯é€±</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="biweekly" onclick="window.selectRecurFreq('todo', 'biweekly')">æ¯å…©é€±</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="monthly" onclick="window.selectRecurFreq('todo', 'monthly')">æ¯æœˆ</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="yearly" onclick="window.selectRecurFreq('todo', 'yearly')">æ¯å¹´</button>
                        </div>
                        
                        <!-- Weekly Days Selector -->
                        <div id="recur-days-row-todo" class="flex justify-between hidden">
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="0">æ—¥</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="1">ä¸€</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="2">äºŒ</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="3">ä¸‰</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="4">å››</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="5">äº”</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="6">å…­</button>
                        </div>

                        <!-- End Date (Fixed: Custom Picker) -->
                        <div class="dt-row p-0 border-none" onclick="window.openCalendar('recur-todo')">
                            <div class="dt-label text-xs text-gray-400">çµæŸé‡è¤‡</div>
                            <div class="dt-value">
                                <span id="display-date-recur-todo" class="text-sm text-gray-600 bg-gray-50 rounded px-2 py-1">è¨­å®šæ—¥æœŸ</span>
                                <input type="hidden" id="input-date-recur-todo">
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 text-center">å°‡è‡ªå‹•ç”¢ç”Ÿè‡³çµæŸæ—¥æœŸçš„å¾…è¾¦</p>
                    </div>
                </div>
            </div>

            <!-- Footer (Delete Button - Unified Style) -->
            <div class="p-4 border-t border-gray-100 flex justify-center pb-20 md:pb-4">
                 <button
                    id="btn-delete-todo"
                    onclick="window.deleteCurrentTodo()"
                    class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
                  >
                    åˆªé™¤æ­¤å¾…è¾¦
                  </button>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div id="time-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
         <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeTimePicker()"></div>
         <div id="time-list-container" class="relative time-picker-modal-content flex flex-col">
             <!-- Time slots will be populated here -->
         </div>
    </div>

    <div id="reminder-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeReminderPicker()"></div>
        <div class="relative bg-white w-[260px] rounded-2xl shadow-xl overflow-hidden py-2">
            <h3 class="text-center text-sm font-bold text-gray-400 py-2 border-b border-gray-50">é¸æ“‡æé†’æ™‚é–“</h3>
            
            <div class="max-h-[320px] overflow-y-auto">
                <div onclick="window.selectReminder('0', 'ä¸é€šçŸ¥')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">ä¸é€šçŸ¥</div>
                <div onclick="window.selectReminder('on_time', 'æº–æ™‚')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">æº–æ™‚</div>
                <div onclick="window.selectReminder('5', '5 åˆ†é˜å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">5 åˆ†é˜å‰</div>
                <div onclick="window.selectReminder('10', '10 åˆ†é˜å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">10 åˆ†é˜å‰</div>
                <div onclick="window.selectReminder('30', '30 åˆ†é˜å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">30 åˆ†é˜å‰</div>
                <div onclick="window.selectReminder('60', '1 å°æ™‚å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">1 å°æ™‚å‰</div>
                <div onclick="window.selectReminder('120', '2 å°æ™‚å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">2 å°æ™‚å‰</div>
                <div onclick="window.selectReminder('1440', '1 å¤©å‰')" class="p-3 text-center text-gray-700 font-medium hover:bg-gray-50 cursor-pointer border-b border-gray-50 active:bg-green-50 active:text-theme">1 å¤©å‰</div>
            </div>
            
            <div class="p-2 pt-0 text-center">
                <button onclick="window.closeReminderPicker()" class="text-xs text-gray-400 font-medium py-3 w-full hover:text-gray-600 transition">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Dropdowns & Pickers -->
    <div id="calendar-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCalendar()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl w-[320px] p-4 overflow-hidden max-h-[420px]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cal-month-title" class="text-lg font-bold text-gray-800 tracking-wide cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition">...</h3>
                <div class="flex gap-1"><button onclick="window.changeCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><button onclick="window.changeCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-red-400">æ—¥</div><div class="cal-day-header">ä¸€</div><div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div><div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div><div class="cal-day-header text-red-400">å…­</div>
            </div>

            <div id="calendar-days" class="calendar-grid"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-sm font-medium">
                <button onclick="window.selectToday()" class="text-theme hover:bg-green-50 px-3 py-1.5 rounded-lg transition">ä»Šå¤©</button>
                <div class="flex gap-2">
                    <button onclick="window.clearDate()" class="text-red-400 hover:bg-red-50 px-3 py-1.5 rounded-lg transition">æ¸…é™¤</button>
                    <button onclick="window.closeCalendar()" class="text-gray-400 hover:bg-gray-50 px-3 py-1.5 rounded-lg transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav (4 Items only) -->
            <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 px-2 pt-2 pb-6 flex justify-around items-center z-50 pb-safe">
            
            <button onclick="window.switchTab('dashboard')" class="nav-btn active group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="dashboard">
                <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:text-white text-gray-400">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:font-bold text-gray-400">æ‘˜è¦</span>
            </button>

            <button onclick="window.switchTab('calendar')" class="nav-btn group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="calendar">
                <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:text-white text-gray-400">
                    <i data-lucide="calendar" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:font-bold text-gray-400">è¡Œäº‹æ›†</span>
            </button>
            
            <button onclick="window.switchTab('todo')" class="nav-btn group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="todo">
                 <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:text-white text-gray-400">
                    <i data-lucide="check-square" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:font-bold text-gray-400">å¾…è¾¦</span>
            </button>

            <button onclick="window.switchTab('chat')" class="nav-btn group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="chat">
                 <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:text-white text-gray-400 relative">
                    <i data-lucide="message-circle" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                    
                    <div id="chat-badge" class="hidden absolute -top-1 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 h-[18px] min-w-[18px] flex items-center justify-center rounded-full shadow-sm border border-white z-10 scale-90">
                        0
                    </div>
                    </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:font-bold text-gray-400">èŠå¤©</span>
            </button>

            </nav>

    <script>

        // === æ–°å¢ï¼šå¾…è¾¦åˆ†é¡é¡¯ç¤ºè¨­å®š (é è¨­å…¨éƒ¨é¡¯ç¤ºï¼Œfalse ä»£è¡¨éš±è—) ===
        window.todoCategoryVisibility = JSON.parse(localStorage.getItem('todo_category_visibility') || '{}');

        // === è²¼åœ–è¨­å®š ===
        // è«‹å°‡ä½ çš„è²¼åœ–æª”æ¡ˆæ”¾åœ¨è·Ÿ index.html åŒä¸€å€‹è³‡æ–™å¤¾ï¼Œä¸¦åœ¨é€™è£¡åŠ å…¥æª”å
        window.stickerList = [
            'pic1.png',
            'pic2.png',
            'pic3.png',
            'pic4.png',
            'pic5.png',
            'pic6.png',
            'pic7.png',
            'pic8.png',
            'pic9.png',
            'pic10.png',
            'pic11.png',
            'pic12.png',
            'pic13.png',
            'pic14.png'
        ];

        // === æ–°å¢ï¼šè²¼åœ–ç›¸é—œåŠŸèƒ½ ===
        
        // 1. åˆ‡æ›è²¼åœ–é¸å–®é¡¯ç¤º/éš±è—
        window.toggleStickerPicker = function() {
            const container = document.getElementById('sticker-picker-container');
            const isOpen = container.classList.contains('open');
            
            if (isOpen) {
                container.classList.remove('open');
            } else {
                // å¦‚æœé‚„æ²’æ¸²æŸ“éï¼Œå…ˆæ¸²æŸ“
                if (document.getElementById('sticker-grid').innerHTML.trim() === '') {
                    window.renderStickerPicker();
                }
                container.classList.add('open');
                // è²¼åœ–é–‹å•Ÿæ™‚ï¼Œæ²å‹•åˆ°åº•éƒ¨ä»¥å…è¢«é®æ“‹
                setTimeout(() => window.scrollToBottom(), 250);
            }
        };

        // 2. é—œé–‰è²¼åœ–é¸å–® (é»æ“Šè¼¸å…¥æ¡†æ™‚å‘¼å«)
        window.closeStickerPicker = function() {
            document.getElementById('sticker-picker-container').classList.remove('open');
        };

        // 3. æ¸²æŸ“è²¼åœ–åˆ—è¡¨
        window.renderStickerPicker = function() {
            const grid = document.getElementById('sticker-grid');
            let html = '';
            window.stickerList.forEach(src => {
                html += `<img src="${src}" class="sticker-item" onclick="window.sendSticker('${src}')">`;
            });
            grid.innerHTML = html;
        };

        // 4. ç™¼é€è²¼åœ– (æ ¼å¼ï¼štype='sticker')
        window.sendSticker = function(url) {
            if (!window.checkRoleEnforcement()) return;
            
            // ç™¼é€å¾Œé—œé–‰é¸å–®
            window.closeStickerPicker();

            const data = {
                text: url, // è²¼åœ–æ¨¡å¼ä¸‹ï¼Œtext æ¬„ä½å­˜åœ–ç‰‡è·¯å¾‘
                type: 'sticker', // æ¨™è¨˜ç‚ºè²¼åœ–
                timestamp: new Date().toISOString(),
                creator: currentUserRole
            };

            db.collection('messages').add(data)
                .then(() => {
                    triggerHaptic('MEDIUM'); // <--- ğŸŒŸ åŠ å…¥é€™è¡Œ (ä¸­ç­‰éœ‡å‹•ï¼Œç¢ºèªæ„Ÿå¼·ä¸€é»)
                    window.showToast('å·²å‚³é€è²¼åœ–');
                    window.scrollToBottom();
                })
                .catch((error) => {
                    console.error("Error: ", error);
                    window.showToast('å‚³é€å¤±æ•—');
                });
        };

        // === éœ‡å‹•å›é¥‹å°å·¥å…· ===
    const triggerHaptic = async (style = 'LIGHT') => {
    try {
        // å˜—è©¦å‘¼å« Capacitor çš„ Haptics
        const { Haptics, ImpactStyle } = Capacitor.Plugins; 
        
        if (style === 'LIGHT') await Haptics.impact({ style: ImpactStyle.Light });
        else if (style === 'MEDIUM') await Haptics.impact({ style: ImpactStyle.Medium });
        else if (style === 'HEAVY') await Haptics.impact({ style: ImpactStyle.Heavy });
        else if (style === 'SUCCESS') await Haptics.notification({ type: 'SUCCESS' });
        else if (style === 'ERROR') await Haptics.notification({ type: 'ERROR' });
    } catch (e) {
        // é›»è…¦ç‰ˆä¸æ”¯æ´éœ‡å‹•ï¼Œå¿½ç•¥éŒ¯èª¤
        // console.log('Haptics not available');
    }
};

       /* ===== STABLE PATCH: SafeRun Helper ===== */
        window.safeRun = function (fn, label = 'unknown') {
        try {
            return fn();
        } catch (err) {
            console.error(`[SafeRun:${label}]`, err);
            if (window.showToast) {
            window.showToast('ç™¼ç”ŸéŒ¯èª¤ï¼Œä½† App ä»å¯ä½¿ç”¨');
            }
            return null;
        }
        };
        // --- 1. VARIABLES ---
        /* ===== STABLE PATCH: Firestore Listener Guard ===== */
        const snapshotRegistry = {};

        function bindSnapshot(ref, cb, label = 'snapshot') {
        if (snapshotRegistry[label]) return; // å·²ç¶é

        const unsub = ref.onSnapshot(
            snap => window.safeRun(() => cb(snap), label),
            err => console.error(`[Firestore:${label}]`, err)
        );

        snapshotRegistry[label] = unsub;
        }


        const firebaseConfig = { apiKey: "AIzaSyDLrPr4X6r3e2V_vqFaCICgKVwLmiykxpc", authDomain: "kyle-mao.firebaseapp.com", projectId: "kyle-mao", storageBucket: "kyle-mao.firebasestorage.app", messagingSenderId: "290564848532", appId: "1:290564848532:web:006c4e9df4b1330895ad81" };
        let db; try { if(typeof firebase!=='undefined'){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}

        // === è®Šæ•¸å®£å‘Šå€ (ä¿®æ­£ç‰ˆ) ===
        let currentUserRole = localStorage.getItem('user_role'); 
        let currentSelectedColor = '#2cc998'; 
        let currentCategory = 'default';
        let editingEventId = null;
        let editingTodoId = null;
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹é€™è£¡ï¼šæ”¹æˆ window. é–‹é ­ï¼Œç¢ºä¿å…¨åŸŸè®€å–å¾—åˆ° ğŸ‘‡ğŸ‘‡ğŸ‘‡
        window.allEventsCache = [];
        let isSavingEvent = false;
        let __lastSaveAt = 0;
        window.allTodosCache = [];
        // ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ”¹çµæŸ ğŸ‘†ğŸ‘†ğŸ‘†

        // å„ªå…ˆå¾ localStorage è®€å–é¡è‰²
        let roleColors = { 
            haohao: localStorage.getItem('color_haohao') || '#2cc998', 
            maomao: localStorage.getItem('color_maomao') || '#e6688d', 
            joint: localStorage.getItem('color_joint') || '#f7b546' 
        };
        let colorPickerTarget = null;
        let calTargetInput = 'start'; 
        let calCurrentDate = new Date(); 
        let bigCalDate = new Date();
        let currentViewMode = 'list';
        let timePickerTarget = ''; // FIX: variable for time picker
        let deleteTarget = 'event'; // 'event' or 'todo'
        let currentSelectedDate = null; // ç”¨ä¾†è¨˜ä½ç›®å‰æœˆæ›†é¸ä¸­çš„æ—¥æœŸ
        let noteToDelete = null;
        
        // Recurrence Variables
        let currentRecurFreq = { event: 'daily', todo: 'daily' };

        const timeTreeColors = [ { name: "Emerald Green", hex: "#2cc998" }, { name: "Modern Cyan", hex: "#5cc2d1" }, { name: "Deep Sky Blue", hex: "#5ba3eb" }, { name: "Pastel Brown", hex: "#a68b75" }, { name: "Midnight Black", hex: "#333333" }, { name: "Apple Red", hex: "#e35651" }, { name: "French Rose", hex: "#e6688d" }, { name: "Coral Pink", hex: "#f29074" }, { name: "Bright Orange", hex: "#f7b546" }, { name: "Soft Violet", hex: "#9f82d1" } ];
        const moodMap = { 'charging': { icon: 'âš¡ï¸', bg: 'bg-yellow-100', border: 'border-yellow-300' }, 'sleepy': { icon: 'ğŸ’¤', bg: 'bg-blue-100', border: 'border-blue-300' }, 'love': { icon: 'â¤ï¸', bg: 'bg-rose-100', border: 'border-rose-300' }, 'busy': { icon: 'ğŸ”¥', bg: 'bg-orange-100', border: 'border-orange-300' }, 'normal': { icon: 'ğŸ˜¶', bg: 'bg-gray-50', border: 'border-gray-100' } };

        // --- 2. GLOBAL FUNCTION DEFINITIONS (Assigned to window immediately) ---

        function isLeaveEvent(title) {
            if (!title) return false;
            // åªè¦æ¨™é¡ŒåŒ…å«é€™äº›é—œéµå­—ï¼Œéƒ½æœƒè¢«è¦–ç‚ºä¼‘å‡é¡å‹çš„è¡Œç¨‹
            return title.includes('ä¼‘å‡') || 
                   title.includes('è«‹å‡') || 
                   title.includes('é—œç·š') || 
                   title.includes('å…¬ä¼‘') || 
                   title.includes('ç—…å‡');
        }
        
        function hideBubble(bubbleEl, dotEl, timeEl, role) {
            bubbleEl.classList.add('opacity-0');
            if (role === 'haohao') bubbleEl.classList.add('-translate-x-2'); else bubbleEl.classList.add('translate-x-2');
            if(dotEl) dotEl.classList.add('hidden');
            if(timeEl) timeEl.classList.add('opacity-0', 'hidden'); 
            setTimeout(() => { bubbleEl.classList.add('hidden'); }, 300);
        }

        window.renderNoteBubble = function(role, data) {
            const bubbleId = `note-bubble-${role}`; const textId = `note-text-${role}`; const dotId = `status-dot-${role}`; const timeId = `note-time-${role}`; 
            const bubbleEl = document.getElementById(bubbleId); const textEl = document.getElementById(textId); const dotEl = document.getElementById(dotId); const timeEl = document.getElementById(timeId);
            if (!bubbleEl || !textEl) return;
            if (!data || !data.text || !data.timestamp) { hideBubble(bubbleEl, dotEl, timeEl, role); return; }
            const now = new Date(); const noteTime = new Date(data.timestamp); const diffHours = (now - noteTime) / (1000 * 60 * 60);
            if (diffHours < 24) {
                textEl.textContent = data.text;
                if(timeEl) { timeEl.textContent = window.getRelativeTimeStr(data.timestamp); timeEl.classList.remove('hidden'); timeEl.classList.remove('opacity-0'); }
                bubbleEl.classList.remove('hidden'); if(dotEl) dotEl.classList.remove('hidden');
                requestAnimationFrame(() => { bubbleEl.classList.remove('opacity-0'); if (role === 'haohao') { bubbleEl.classList.remove('-translate-x-2'); } else { bubbleEl.classList.remove('translate-x-2'); } });
            } else { hideBubble(bubbleEl, dotEl, timeEl, role); }
        };
        
        window.getRelativeTimeStr = function(timestamp) {
            const now = new Date(); const date = new Date(timestamp); const diffMs = now - date; const diffMins = Math.floor(diffMs / (1000 * 60)); const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffMins < 1) return 'å‰›å‰›'; if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`; if (diffHours < 24) return `${diffHours}å°æ™‚å‰`; return '1å¤©å‰';
        };

        window.toggleRecurOptions = function(type) {
            const check = document.getElementById(`check-recur-${type}`);
            const options = document.getElementById(`recur-options-${type}`);
            if(check.checked) {
                options.classList.remove('hidden');
                // Set default end date to 3 months from now
                const end = new Date();
                end.setMonth(end.getMonth() + 3);
                const dateStr = end.toISOString().split('T')[0];
                document.getElementById(`input-date-recur-${type}`).value = dateStr;
                window.updateDateDisplay(`recur-${type}`, dateStr);
            } else {
                options.classList.add('hidden');
            }
        };

        window.selectRecurFreq = function(type, freq) {
            currentRecurFreq[type] = freq;
            const container = document.getElementById(`recur-options-${type}`);
            const buttons = container.querySelectorAll('.recur-btn');
            buttons.forEach(b => {
                if(b.dataset.val === freq) b.classList.add('active');
                else b.classList.remove('active');
            });
            
            // Show/Hide Days Selector for Weekly/Biweekly
            const daysRow = document.getElementById(`recur-days-row-${type}`);
            if(freq === 'weekly' || freq === 'biweekly') {
                daysRow.classList.remove('hidden');
            } else {
                daysRow.classList.add('hidden');
            }
        };

        window.toggleRecurDay = function(el) {
            el.classList.toggle('active');
        };

        // Utility: Generate recurring dates
        window.generateRecurringDates = function(startDateStr, endDateStr, freq, selectedDays) {
            const dates = [];
            let current = new Date(startDateStr);
            const end = new Date(endDateStr);
            const startDay = current.getDate();
            const startMonth = current.getMonth();
            
            // Safety: max 100 events to prevent browser hang
            let limit = 100; 
            
            // Bi-weekly logic: Calculate week difference from start
            const getWeekDiff = (d1, d2) => {
                const oneJan = new Date(d1.getFullYear(), 0, 1);
                // Simple approximation is enough for parity check if consistent
                return Math.floor((d2 - d1) / (7 * 24 * 60 * 60 * 1000));
            };

            while(current <= end && limit > 0) {
                let addIt = false;
                
                if (freq === 'daily') {
                    addIt = true;
                } else if (freq === 'weekly') {
                    // Check if current day is in selectedDays
                    if (selectedDays.includes(current.getDay())) addIt = true;
                } else if (freq === 'biweekly') {
                    // Check week parity relative to start
                    const weekDiff = getWeekDiff(new Date(startDateStr), current);
                    if (weekDiff % 2 === 0 && selectedDays.includes(current.getDay())) {
                        addIt = true;
                    }
                } else if (freq === 'monthly') {
                    if (current.getDate() === startDay) addIt = true;
                } else if (freq === 'yearly') {
                    if (current.getMonth() === startMonth && current.getDate() === startDay) addIt = true;
                }

                if (addIt) {
                    dates.push(new Date(current));
                    limit--;
                }

                // Increment
                if(freq === 'monthly') {
                    current.setMonth(current.getMonth() + 1);
                } else if (freq === 'yearly') {
                    current.setFullYear(current.getFullYear() + 1);
                } else {
                    // Daily, Weekly, Biweekly -> Increment by day to catch multiple days/week
                    current.setDate(current.getDate() + 1);
                }
            }
            return dates;
        };

        // --- IMPORTANT: Modal Closing Functions Defined Globally Here ---
        
        window.closeAddModal = function() {
          window.__savingEvent = false;
          const m = document.getElementById('add-modal');
          if(m) {
              m.classList.remove('visible');
              setTimeout(() => m.classList.add('hidden'), 200);
          }
        };

        window.closeAddTodoModal = function() { 
            const m = document.getElementById('add-todo-modal'); 
            if(m) {
                m.classList.remove('visible'); 
                setTimeout(()=>m.classList.add('hidden'),200); 
            }
        };

        // --- Core Action Functions Moved Up ---
        
        window.openAddModal = function () {
            triggerHaptic('LIGHT');
            if (!window.checkRoleEnforcement()) return;
            
            editingEventId = null;
            document.getElementById('input-title').value = '';
            document.getElementById('input-note').value = '';
            
            // === âœ¨ å„ªåŒ–ï¼šè‡ªå‹•å¸¶å…¥æœˆæ›†é¸å–çš„æ—¥æœŸ ===
            let defaultDate = '';
            // å¦‚æœç¾åœ¨æ˜¯åœ¨æœˆæ›†è¦–åœ– (month)ï¼Œä¸”æœ‰é¸ä¸­æŸä¸€å¤©
            if (currentViewMode === 'month' && currentSelectedDate) {
                 const { y, m, d } = currentSelectedDate;
                 // æ ¼å¼åŒ–ç‚º YYYY-MM-DD
                 defaultDate = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            }
            
            document.getElementById('input-date-start').value = defaultDate;
            
            // æ›´æ–°é¡¯ç¤ºæ–‡å­—
            const dD = document.getElementById('display-date-start'); 
            if (defaultDate) {
                window.updateDateDisplay('start', defaultDate);
            } else {
                dD.textContent = 'è«‹é¸æ“‡'; 
                dD.classList.add('dt-text-placeholder'); 
                dD.classList.remove('dt-text-value');
            }
            // ======================================

            const t = document.getElementById('input-time-start'); if (t) t.value = '';
            const td = document.getElementById('display-time-start'); if (td) { td.textContent = 'è«‹é¸æ“‡'; td.classList.add('dt-text-placeholder'); td.classList.remove('dt-text-value'); }
            
            // çµæŸæ—¥æœŸé è¨­è·Ÿé–‹å§‹æ—¥æœŸä¸€æ¨£
            const de = document.getElementById('input-date-end'); 
            if (de) de.value = defaultDate;
            const dde = document.getElementById('display-date-end'); 
            if (dde) { 
                if(defaultDate) window.updateDateDisplay('end', defaultDate);
                else { dde.textContent = 'è«‹é¸æ“‡'; dde.classList.add('dt-text-placeholder'); dde.classList.remove('dt-text-value'); }
            }

            const te = document.getElementById('input-time-end'); if (te) te.value = '';
            const tde = document.getElementById('display-time-end'); if (tde) { tde.textContent = 'è«‹é¸æ“‡'; tde.classList.add('dt-text-placeholder'); tde.classList.remove('dt-text-value'); }
            const loc = document.getElementById('input-location'); if (loc) loc.value = '';
            
            document.getElementById('input-remind').value = '0';
            document.getElementById('display-remind').textContent = 'ä¸é€šçŸ¥'; 
            const partner = document.getElementById('check-partner'); partner.checked = false;
          
            document.getElementById('check-recur-event').checked = false; window.toggleRecurOptions('event');
            window.selectRecurFreq('event', 'daily'); document.querySelectorAll('.day-circle.active').forEach(b => b.classList.remove('active'));
            window.setStatus('confirmed');
            currentSelectedColor = roleColors[currentUserRole]; colorPickerTarget = 'event';
            const delBtn = document.getElementById('btn-delete-event'); if(delBtn) delBtn.classList.add('hidden');
            
            // æ›´æ–°åƒèˆ‡è€…é è¦½
            window.updateParticipantsPreview();

            const m = document.getElementById('add-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10);
        };

        window.openEditModal = function (id) {
          const evt = allEventsCache.find(e => e.id === id);
          if (!evt) { window.showToast('æ‰¾ä¸åˆ°è¡Œç¨‹'); return; }
          editingEventId = id;
          document.getElementById('input-title').value = evt.title || '';
          if (evt.startDate) { document.getElementById('input-date-start').value = evt.startDate; window.updateDateDisplay('start', evt.startDate); } 
          else if (evt.timestamp) { const d = new Date(evt.timestamp); const ds = d.toISOString().split('T')[0]; document.getElementById('input-date-start').value = ds; window.updateDateDisplay('start', ds); }
          const timeInput = document.getElementById('input-time-start');
          if (evt.allDay) { timeInput.value = ''; window.updateTimeDisplay('start', ''); window.updateTimeDisplay('end', ''); } 
          else if (evt.timestamp) { const d = new Date(evt.timestamp); const hours = d.getHours().toString().padStart(2, '0'); const minutes = d.getMinutes().toString().padStart(2, '0'); const timeStr = `${hours}:${minutes}`; timeInput.value = timeStr; window.updateTimeDisplay('start', timeStr); }
          if (evt.endDate) { document.getElementById('input-date-end').value = evt.endDate; window.updateDateDisplay('end', evt.endDate); } 
          else { const sD = document.getElementById('input-date-start').value; document.getElementById('input-date-end').value = sD; window.updateDateDisplay('end', sD); }
          if (evt.endTime) { document.getElementById('input-time-end').value = evt.endTime; window.updateTimeDisplay('end', evt.endTime); } 
          else { document.getElementById('input-time-end').value = ''; window.updateTimeDisplay('end', ''); }
          document.getElementById('input-location').value = evt.location || '';
          // è®€å–æé†’è¨­å®š
          const rVal = evt.remind || '0';
          document.getElementById('input-remind').value = rVal;
          document.getElementById('display-remind').textContent = window.getRemindLabel(rVal); // æ–°å¢é€™è¡Œï¼šæŠŠ '30' è½‰æˆ '30 åˆ†é˜å‰'
          const partner = document.getElementById('check-partner'); partner.checked = !!evt.isJoint;
          window.setStatus(evt.status || 'confirmed');
          document.getElementById('input-note').value = evt.note || '';
          document.getElementById('check-recur-event').checked = false; window.toggleRecurOptions('event');
          currentSelectedColor = evt.color || roleColors[evt.creator] || roleColors[currentUserRole]; colorPickerTarget = 'event';
          const delBtn = document.getElementById('btn-delete-event'); if(delBtn) delBtn.classList.remove('hidden');
          const m = document.getElementById('add-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10);
          
          window.updateParticipantsPreview();
        };

        window.openAddTodoModal = function() { 
            // === åŠ å…¥é€™è¡Œ ===
            if (!window.checkRoleEnforcement()) return;
            // ===============
            editingTodoId = null; document.getElementById('todo-modal-title').textContent = 'æ–°å¢å¾…è¾¦äº‹é …'; document.getElementById('todo-modal-btn').textContent = 'æ–°å¢'; document.getElementById('todo-input-title').value = ''; document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; 
            const dd = document.getElementById('display-date-todo'); dd.textContent = 'è«‹é¸æ“‡'; dd.classList.add('dt-text-placeholder'); dd.classList.remove('dt-text-value');
            const dt = document.getElementById('display-time-todo'); dt.textContent = 'è«‹é¸æ“‡'; dt.classList.add('dt-text-placeholder'); dt.classList.remove('dt-text-value');
            
            // Reset End Date
            document.getElementById('input-date-todo-end').value = '';
            const dde = document.getElementById('display-date-todo-end');
            dde.textContent = 'è«‹é¸æ“‡'; dde.classList.add('dt-text-placeholder'); dde.classList.remove('dt-text-value');

            // Reset End Time
            document.getElementById('input-time-todo-end').value = '';
            const dte = document.getElementById('display-time-todo-end');
            dte.textContent = 'è«‹é¸æ“‡'; dte.classList.add('dt-text-placeholder'); dte.classList.remove('dt-text-value');

            // FIX: ç§»é™¤äº†å°ä¸å­˜åœ¨å…ƒç´  'todo-check-calendar' çš„å¼•ç”¨
            document.getElementById('todo-check-joint').checked = false; 
            
            // Reset recurrence
            document.getElementById('check-recur-todo').checked = false;
            window.toggleRecurOptions('todo');
            window.selectRecurFreq('todo', 'daily');
            document.querySelectorAll('.day-circle').forEach(b => b.classList.remove('active'));
            
            const btn=document.getElementById('btn-delete-todo'); if(btn) btn.classList.add('hidden'); const m = document.getElementById('add-todo-modal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); 
        };

        window.openEditTodoModal = function(id) { 
            editingTodoId = id; 
            const todo = allTodosCache.find(t => t.id === id); 
            if(!todo) return; 
            document.getElementById('todo-modal-title').textContent = 'ç·¨è¼¯å¾…è¾¦äº‹é …'; 
            document.getElementById('todo-modal-btn').textContent = 'å„²å­˜'; 
            document.getElementById('todo-input-title').value = todo.title; 
            if(todo.dueDate) { 
                document.getElementById('input-date-todo').value = todo.dueDate; 
                window.updateDateDisplay('todo', todo.dueDate); 
            } else { 
                document.getElementById('input-date-todo').value = ''; 
                window.updateDateDisplay('todo', ''); 
            } 
            if(todo.dueTime) { 
                document.getElementById('input-time-todo').value = todo.dueTime; 
                window.updateTimeDisplay('todo', todo.dueTime); 
            } else { 
                document.getElementById('input-time-todo').value = ''; 
                window.updateTimeDisplay('todo', ''); 
            }

            // End Date
            if (todo.dueDateEnd) {
                document.getElementById('input-date-todo-end').value = todo.dueDateEnd;
                window.updateDateDisplay('todo-end', todo.dueDateEnd);
            } else {
                // Default to start date if existing
                const sD = document.getElementById('input-date-todo').value;
                document.getElementById('input-date-todo-end').value = sD;
                window.updateDateDisplay('todo-end', sD);
            }

            // End Time
            if (todo.dueTimeEnd) {
                document.getElementById('input-time-todo-end').value = todo.dueTimeEnd;
                window.updateTimeDisplay('todo-end', todo.dueTimeEnd);
            } else {
                document.getElementById('input-time-todo-end').value = '';
                window.updateTimeDisplay('todo-end', '');
            }

            document.getElementById('todo-check-joint').checked = todo.isJoint; 
            
            // Edit mode: Hide recurrence options
            document.getElementById('check-recur-todo').checked = false;
            window.toggleRecurOptions('todo');
            
            const btn=document.getElementById('btn-delete-todo'); 
            if(btn) btn.classList.remove('hidden'); 
            const m = document.getElementById('add-todo-modal'); 
            m.classList.remove('hidden'); 
            setTimeout(()=>m.classList.add('visible'),10); 
        };

        window.saveEvent = function () {
          if (!db) { window.showToast('è³‡æ–™åº«å°šæœªé€£ç·š'); return; }
          if (window.__savingEvent) return;
          window.__savingEvent = true;

          const saveBtn = document.querySelector('#add-modal button[onclick="window.saveEvent()"]');
          if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'å„²å­˜ä¸­â€¦'; saveBtn.classList.add('opacity-60'); }

          try {
            const title = document.getElementById('input-title').value.trim();
            if (!title) { window.showToast('è«‹å¡«å¯«æ¨™é¡Œ'); throw new Error('Missing title'); }

            const startDate = document.getElementById('input-date-start').value;
            if (!startDate) { window.showToast('è«‹é¸æ“‡æ—¥æœŸ'); throw new Error('Missing date'); }

            let endDate = document.getElementById('input-date-end').value;
            if (!endDate) endDate = startDate;

            // === æ–°å¢é©—è­‰é‚è¼¯ ===
            // 1. æª¢æŸ¥æ—¥æœŸï¼šçµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ
            if (endDate < startDate) {
                window.showToast('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ ğŸ™…â€â™‚ï¸');
                throw new Error('Invalid date range');
            }

            const time = document.getElementById('input-time-start').value; 
            const endTime = document.getElementById('input-time-end').value;

            // 2. æª¢æŸ¥æ™‚é–“ï¼šå¦‚æœæ˜¯åŒä¸€å¤©ï¼Œä¸”éƒ½æœ‰å¡«å¯«æ™‚é–“ï¼ŒçµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹æ™‚é–“
            if (startDate === endDate && time && endTime) {
                if (endTime < time) {
                    window.showToast('çµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹æ™‚é–“ ğŸ™…â€â™‚ï¸');
                    throw new Error('Invalid time range');
                }
            }
            // ===================

            const timestamp = new Date(`${startDate}T${time || '00:00'}:00`).toISOString();
            const isAllDay = !time; // å¦‚æœæ²’æœ‰é–‹å§‹æ™‚é–“ï¼Œè¦–ç‚ºå…¨å¤©

            const baseData = {
              title, allDay: isAllDay, isJoint: document.getElementById('check-partner').checked || false,
              status: document.getElementById('input-status').value || 'confirmed',
              note: document.getElementById('input-note').value || '',
              creator: currentUserRole, color: currentSelectedColor,
              location: document.getElementById('input-location').value || '',
              remind: document.getElementById('input-remind').value || '0',
              endDate: endDate, endTime: endTime || '', createdAt: new Date().toISOString()
            };

            const isRecur = document.getElementById('check-recur-event').checked;
            
            if (editingEventId && !isRecur) {
                db.collection('events').doc(editingEventId).update({ ...baseData, startDate, timestamp })
                .then(() => { window.showToast('è¡Œç¨‹å·²å„²å­˜'); window.closeAddModal(); })
                .catch(err => { console.error(err); window.showToast('å„²å­˜å¤±æ•—'); })
                .finally(() => { window.__savingEvent = false; if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ä¿å­˜'; saveBtn.classList.remove('opacity-60'); } });
            } else {
                let batchEvents = [];
                if (isRecur) {
                    const recurEndDateStr = document.getElementById('input-date-recur-event').value;
                    if (!recurEndDateStr) { window.showToast('è«‹é¸æ“‡é‡è¤‡çµæŸæ—¥æœŸ'); throw new Error('Missing end date'); }
                    const dayBtns = document.querySelectorAll('#recur-days-row-event .day-circle.active');
                    const selectedDays = Array.from(dayBtns).map(b => parseInt(b.dataset.d));
                    const dateList = window.generateRecurringDates(startDate, recurEndDateStr, currentRecurFreq.event, selectedDays);
                    if (dateList.length === 0) { window.showToast('å€é–“å…§æ²’æœ‰ç¬¦åˆçš„æ—¥æœŸ'); throw new Error('No dates generated'); }
                    const groupId = crypto.randomUUID(); 
                    const startObj = new Date(startDate);
                    const endObj = new Date(endDate);
                    const durationMs = endObj - startObj;
                    const durationDays = Math.round(durationMs / (1000 * 60 * 60 * 24));

                    batchEvents = dateList.map(d => {
                        const dStr = d.toISOString().split('T')[0];
                        const ts = new Date(`${dStr}T${time || '00:00'}:00`).toISOString();
                        const newEndObj = new Date(d);
                        newEndObj.setDate(newEndObj.getDate() + durationDays);
                        const newEndDateStr = newEndObj.toISOString().split('T')[0];
                        return { ...baseData, startDate: dStr, endDate: newEndDateStr, timestamp: ts, groupId: groupId };
                    });
                } else {
                    batchEvents.push({ ...baseData, startDate, timestamp });
                }
                Promise.all(batchEvents.map(evt => db.collection('events').add(evt)))
                .then(() => { const msg = isRecur ? `å·²å»ºç«‹ ${batchEvents.length} å€‹é‡è¤‡è¡Œç¨‹` : 'è¡Œç¨‹å·²å„²å­˜'; window.showToast(msg); window.closeAddModal(); })
                .catch(err => { console.error(err); window.showToast('å„²å­˜å¤±æ•—'); })
                .finally(() => { window.__savingEvent = false; if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ä¿å­˜'; saveBtn.classList.remove('opacity-60'); } });
            }
          } catch (err) {
            window.__savingEvent = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ä¿å­˜'; saveBtn.classList.remove('opacity-60'); }
          }
        };

        window.saveTodoItem = function() {
            if (window.isSavingTodo) return;
            const title = document.getElementById('todo-input-title').value.trim();
            if (!title) { window.showToast('è«‹è¼¸å…¥å…§å®¹'); return; }
            
            // === ä¿®æ”¹é‡é»ï¼šå–å¾—åˆ†é¡ ===
            let category = document.getElementById('todo-input-category').value;
            const customCat = document.getElementById('todo-input-category-custom').value.trim();
            
            // å¦‚æœæœ‰è¼¸å…¥è‡ªè¨‚åˆ†é¡ï¼Œå„ªå…ˆä½¿ç”¨ï¼Œä¸¦å­˜å…¥ localStorage
            if (customCat) {
                category = customCat;
                if (!customCategories.includes(customCat)) {
                    customCategories.push(customCat);
                    localStorage.setItem('my_custom_categories', JSON.stringify(customCategories));
                }
            }
            // ========================

            window.isSavingTodo = true;
            const btn = document.getElementById('todo-modal-btn');
            const originalText = btn ? btn.textContent : 'å„²å­˜';
            if (btn) { btn.textContent = 'å„²å­˜ä¸­...'; btn.style.opacity = '0.5'; }

            const date = document.getElementById('input-date-todo').value || null;
            const time = document.getElementById('input-time-todo').value || null;
            const isJoint = document.getElementById('todo-check-joint').checked;
            const isRecur = document.getElementById('check-recur-todo').checked;
            let dateEnd = document.getElementById('input-date-todo-end').value || null;
            if (date && !dateEnd) dateEnd = date;
            const timeEnd = document.getElementById('input-time-todo-end').value || null;
            const addToCalendar = !!date; 

            // === ä¿®æ”¹é‡é»ï¼šåŠ å…¥ category æ¬„ä½ ===
            const baseData = {
                title, done: false, creator: currentUserRole, isJoint: isJoint, addToCalendar: addToCalendar,
                category: category, // <--- å­˜å…¥è³‡æ–™åº«
                dueDate: date, dueTime: (date && time) ? time : null,
                dueDateEnd: dateEnd, dueTimeEnd: (date && timeEnd) ? timeEnd : null, 
                timestamp: null, createdAt: new Date().toISOString() 
            };
            
            if (date) {
                const tStr = time || "00:00";
                try { baseData.timestamp = new Date(`${date}T${tStr}`).toISOString(); } catch(e){}
            }

            const finish = (msg) => {
                if (typeof window.closeAddTodoModal === 'function') window.closeAddTodoModal();
                window.showToast(msg); window.isSavingTodo = false;
                if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; }
            };
            const onError = (err) => {
                console.error("Save Error:", err); window.showToast('å„²å­˜å¤±æ•—'); window.isSavingTodo = false;
                if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; }
            };

            if (editingTodoId && !isRecur) {
                db.collection('todos').doc(editingTodoId).update(baseData).then(() => finish('å¾…è¾¦äº‹é …å·²æ›´æ–°')).catch(onError);
            } else if (!isRecur) {
                db.collection('todos').add(baseData).then(() => finish('å¾…è¾¦äº‹é …å·²æ–°å¢')).catch(onError);
            } else {
                if (!date) { window.showToast('é‡è¤‡å¾…è¾¦éœ€è¦è¨­å®šé–‹å§‹æ—¥æœŸ'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const endDateStr = document.getElementById('input-date-recur-todo').value;
                if (!endDateStr) { window.showToast('è«‹é¸æ“‡é‡è¤‡çµæŸæ—¥æœŸ'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const dayBtns = document.querySelectorAll('#recur-days-row-todo .day-circle.active');
                const selectedDays = Array.from(dayBtns).map(b => parseInt(b.dataset.d));
                const dateList = window.generateRecurringDates(date, endDateStr, currentRecurFreq.todo, selectedDays);
                if (dateList.length === 0) { window.showToast('å€é–“å…§æ²’æœ‰ç¬¦åˆçš„æ—¥æœŸ'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const groupId = crypto.randomUUID();
                const startObj = new Date(date);
                const endObj = new Date(dateEnd);
                const durationMs = endObj - startObj;
                const durationDays = Math.round(durationMs / (1000 * 60 * 60 * 24));
                const batchEvents = dateList.map(d => {
                    const dStr = d.toISOString().split('T')[0];
                    let ts = null;
                    if(time) ts = new Date(`${dStr}T${time}`).toISOString(); else ts = new Date(`${dStr}T00:00`).toISOString();
                    const newEndObj = new Date(d);
                    newEndObj.setDate(newEndObj.getDate() + durationDays);
                    const newEndDateStr = newEndObj.toISOString().split('T')[0];
                    return { ...baseData, dueDate: dStr, dueDateEnd: newEndDateStr, timestamp: ts, groupId: groupId };
                });
                Promise.all(batchEvents.map(evt => db.collection('todos').add(evt))).then(() => finish(`å·²å»ºç«‹ ${batchEvents.length} å€‹é‡è¤‡å¾…è¾¦`)).catch(onError);
            }
        };

        window.confirmDeleteNote = function(role) {
            if (!window.checkRoleEnforcement()) return;
            deleteTarget = 'note';
            noteToDelete = role;
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = 'åˆªé™¤å¿ƒæƒ…ï¼Ÿ';
            if(desc) desc.textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ';
            window.confirmDelete();
        };

        // === è£œä¸Šï¼šå¾åˆ—è¡¨ç›´æ¥åˆªé™¤å¾…è¾¦ ===
        window.deleteTodo = function(id) {
            // è¨­å®šè¦åˆªé™¤çš„ ID (è®“ executeDelete çŸ¥é“è¦åˆªèª°)
            editingTodoId = id;
            deleteTarget = 'todo';

            // è¨­å®šç¢ºèªè¦–çª—çš„æ–‡å­—
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = 'åˆªé™¤å¾…è¾¦ï¼Ÿ';
            if(desc) desc.textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ';

            // æ‰“é–‹ç¢ºèªè¦–çª—
            window.confirmDelete();
        };

        window.deleteNote = function(role) {
            if (!window.checkRoleEnforcement()) return;
            const bubbleEl = document.getElementById(`note-bubble-${role}`); if(bubbleEl) bubbleEl.classList.add('hidden');
            const dotEl = document.getElementById(`status-dot-${role}`); if(dotEl) dotEl.classList.add('hidden');
            const timeEl = document.getElementById(`note-time-${role}`); if(timeEl) timeEl.classList.add('hidden');
            db.collection('notes').doc(role).delete().then(() => { window.showToast('å¿ƒæƒ…å·²åˆªé™¤ ğŸ’¨'); }).catch(err => { console.error(err); window.showToast('åˆªé™¤å¤±æ•—'); });
        };
        
        // === å„ªåŒ–ç‰ˆï¼šç™¼é€å¿ƒæƒ…ç•™è¨€ ===
        window.sendNote = function() {
            if (!window.checkRoleEnforcement()) return;
            
            const input = document.getElementById('note-input');
            const btn = document.getElementById('note-send-btn');
            const text = input.value.trim();
            
            if (!text) {
                window.showToast('è«‹è¼¸å…¥å…§å®¹ ğŸ’¬');
                input.focus();
                return;
            }

            // é–å®š UI
            input.disabled = true;
            btn.classList.add('opacity-50');

            const data = {
                text: text,
                timestamp: new Date().toISOString(),
                creator: currentUserRole
            };

            // æ”¹ç”¨ .add() æ–°å¢åˆ° messages é›†åˆ
            db.collection('messages').add(data)
                .then(() => {
                    triggerHaptic('MEDIUM'); // <--- ğŸŒŸ åŠ å…¥é€™è¡Œ (ä¸­ç­‰éœ‡å‹•ï¼Œç¢ºèªæ„Ÿå¼·ä¸€é»)
                    input.value = '';
                    window.showToast('å·²å‚³é€');
                    window.scrollToBottom();
                })
                .catch((error) => {
                    console.error("Error: ", error);
                    window.showToast('å‚³é€å¤±æ•—');
                })
                .finally(() => {
                    input.disabled = false;
                    btn.classList.remove('opacity-50');
                    input.focus();
                });
        };

        // === è£œä¸Šï¼šé»æ“Šé ­åƒèšç„¦è¼¸å…¥æ¡† ===
        window.setNoteInputFocus = function() {
            if (!window.checkRoleEnforcement()) return;
            const el = document.getElementById('note-input');
            if (el) {
                el.focus();
                // ç¨å¾®éœ‡å‹•ä¸€ä¸‹æ‰‹æ©Ÿ (å¦‚æœæœ‰æ”¯æ´)
                if (navigator.vibrate) navigator.vibrate(5);
            }
        };

        window.syncNoteAvatarColors = function() { 
            const h = document.getElementById('avatar-note-haohao'); 
            const m = document.getElementById('avatar-note-maomao'); 
            if(h) h.style.backgroundColor = roleColors.haohao; 
            if(m) m.style.backgroundColor = roleColors.maomao; 
        };

        window.openCalendar = function(type) {
            calTargetInput = type;
            const val = document.getElementById(`input-date-${type}`).value;
            if (val) calCurrentDate = new Date(val);
            else calCurrentDate = new Date();
            window.renderCalendarPicker();
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeCalendar = function() {
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.changeCalMonth = function(delta) {
            calCurrentDate.setMonth(calCurrentDate.getMonth() + delta);
            window.renderCalendarPicker();
        };

        window.renderCalendarPicker = function() {
            const y = calCurrentDate.getFullYear();
            const m = calCurrentDate.getMonth();
            document.getElementById('cal-month-title').textContent = `${y}å¹´${m + 1}æœˆ`;
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;
            const todayStr = new Date().toDateString();
            const inputVal = document.getElementById(`input-date-${calTargetInput}`).value;
            const selectedDateStr = inputVal ? new Date(inputVal).toDateString() : '';
            for (let d = 1; d <= daysInMonth; d++) {
                const thisDate = new Date(y, m, d);
                const thisDateStr = thisDate.toDateString();
                let classes = "cal-day";
                if (thisDateStr === todayStr) classes += " today";
                if (thisDateStr === selectedDateStr) classes += " selected";
                const el = document.createElement('div');
                el.className = classes;
                el.textContent = d;
                el.onclick = () => window.selectDate(y, m, d);
                grid.appendChild(el);
            }
        };

        window.selectDate = function(y, m, d) {
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            document.getElementById(`input-date-${calTargetInput}`).value = dateStr;
            window.updateDateDisplay(calTargetInput, dateStr);
            if (calTargetInput === 'start') {
                const endInput = document.getElementById('input-date-end');
                if (endInput && !endInput.value) { endInput.value = dateStr; window.updateDateDisplay('end', dateStr); }
                if(window.autoUpdateEnd) window.autoUpdateEnd(); 
            } else if (calTargetInput === 'todo') {
                 const endInput = document.getElementById('input-date-todo-end');
                 if (endInput && !endInput.value) { endInput.value = dateStr; window.updateDateDisplay('todo-end', dateStr); }
            }
            window.closeCalendar();
        };

        window.selectToday = function() {
            const now = new Date();
            window.selectDate(now.getFullYear(), now.getMonth(), now.getDate());
        };

        // === æ–°å¢ï¼šæ™‚é–“é¸æ“‡å™¨æš«å­˜è®Šæ•¸ ===
        let tempHour = 0;
        let tempMinute = 0;

        // === æ™‚é–“é¸æ“‡å™¨ (Scroll-Driven æœ€çµ‚å®Œç¾ç‰ˆ) ===
        // æ ¸å¿ƒæ¦‚å¿µï¼šä¸ç®¡æ˜¯æ‰‹æ»‘é‚„æ˜¯é»æ“Šï¼Œçµ±ä¸€ç”± "scroll" äº‹ä»¶ä¾†æ±ºå®šèª°è¢«é¸ä¸­
        
        window.openTimePicker = function(type) {
            window._timePickerTarget = type;
            const container = document.getElementById('time-list-container');
            container.innerHTML = '';
            
            // 1. è¨­å®šå®¹å™¨ï¼šé«˜åº¦å›ºå®š 220px
            container.className = "relative bg-white rounded-2xl shadow-2xl flex flex-col w-[300px] h-[340px] overflow-hidden"; 
            container.style.maxHeight = "none"; 

            // å–å¾—ç›®å‰æ™‚é–“
            const currentVal = document.getElementById(`input-time-${type}`).value;
            const now = new Date();
            let initH = now.getHours();
            let initM = now.getMinutes();

            if (currentVal) {
                const [h, m] = currentVal.split(':').map(Number);
                initH = h; initM = m;
            }
            // åˆå§‹åŒ–å…¨åŸŸè®Šæ•¸
            window._tempHour = initH;
            window._tempMinute = initM;

            // A. æ¨™é¡Œåˆ—
            const header = document.createElement('div');
            header.className = "bg-white border-b border-gray-100 flex justify-between items-center px-4 py-3 flex-none z-10";
            header.innerHTML = `
                <button onclick="window.closeTimePicker()" class="text-sm text-gray-500 min-w-[40px]">å–æ¶ˆ</button>
                <span class="text-sm font-bold text-gray-800">é¸æ“‡æ™‚é–“</span>
                <button onclick="window.confirmTimeSelection()" class="text-sm font-bold text-theme min-w-[40px]">ç¢ºå®š</button>
            `;
            container.appendChild(header);

            // B. å…§å®¹å€ (æ»¾è¼ªå€)
            const body = document.createElement('div');
            body.className = "flex bg-white relative flex-1 min-h-0"; 
            
            // --- å»ºç«‹æ»¾è¼ªæ¬„ä½çš„è¼”åŠ©å‡½å¼ ---
            const createColumn = (id, count, initialVal) => {
                const col = document.createElement('div');
                col.id = id;
                col.className = "flex-1 h-full overflow-y-auto text-center no-scrollbar py-0 relative";
                col.style.scrollSnapType = "y mandatory"; // é–‹å•Ÿ CSS å¸é™„
                
                // 1. ä¸Šæ–¹ç•™ç™½ (Spacer)
                const topSpacer = document.createElement('div');
                topSpacer.className = "picker-spacer";
                col.appendChild(topSpacer);

                // 2. æ•¸å­—æ ¼
                for(let i=0; i<count; i++) {
                    const cell = document.createElement('div');
                    cell.className = `time-cell ${i === initialVal ? 'selected' : ''}`;
                    cell.textContent = String(i).padStart(2, '0');
                    cell.dataset.val = i;
                    
                    // é»æ“Šæ™‚ï¼šå¹³æ»‘æ²å‹•åˆ°è©²ä½ç½®
                    cell.onclick = () => {
                        const targetPos = i * 50; // 50æ˜¯å›ºå®šé«˜åº¦
                        col.scrollTo({ top: targetPos, behavior: 'smooth' });
                    };
                    col.appendChild(cell);
                }

                // 3. ä¸‹æ–¹ç•™ç™½
                const bottomSpacer = document.createElement('div');
                bottomSpacer.className = "picker-spacer";
                col.appendChild(bottomSpacer);

                // 4. æ ¸å¿ƒï¼šç›£è½æ²å‹•äº‹ä»¶ (Scroll Listener)
                // ç•¶ä½¿ç”¨è€…æ»‘å‹•æ™‚ï¼Œè‡ªå‹•è¨ˆç®—ä¸­é–“æ˜¯èª°
                let scrollTimeout;
                col.addEventListener('scroll', () => {
                    // ä½¿ç”¨ debounce é¿å…éåº¦è§¸ç™¼ï¼Œä½†è¦–è¦ºæ›´æ–°è¦å³æ™‚
                    const scrollTop = col.scrollTop;
                    const index = Math.round(scrollTop / 50); // ç®—å‡ºç›®å‰æœ€æ¥è¿‘çš„ç´¢å¼• (50pxä¸€æ ¼)
                    
                    // å³æ™‚æ›´æ–°è¦–è¦ºæ¨£å¼
                    const cells = col.querySelectorAll('.time-cell');
                    cells.forEach((c, idx) => {
                        if (idx === index) c.classList.add('selected');
                        else c.classList.remove('selected');
                    });

                    // æ›´æ–°è³‡æ–™è®Šæ•¸ (é˜²æŠ–å‹•ï¼Œåœæ­¢æ²å‹•å¾Œæ‰ç¢ºèªæ•¸å€¼)
                    if (scrollTimeout) clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        if (id === 'time-col-hour') window._tempHour = index;
                        else window._tempMinute = index;
                    }, 50);
                });

                return col;
            };

            const hourCol = createColumn('time-col-hour', 24, initH);
            const minCol = createColumn('time-col-minute', 60, initM);

            // åˆ†éš”ç·š
            const divider = document.createElement('div');
            divider.className = "flex items-center justify-center font-bold text-gray-300 z-10 bg-transparent pointer-events-none mb-4";
            divider.textContent = ":";

            // è¦–è¦ºé®ç½© (Fade Mask)
            const mask = document.createElement('div');
            mask.className = "absolute inset-0 pointer-events-none z-10 flex flex-col justify-between";
            mask.innerHTML = `
                <div class="h-[85px] w-full bg-gradient-to-b from-white via-white/80 to-transparent"></div>
                <div class="h-[85px] w-full bg-gradient-to-t from-white via-white/80 to-transparent"></div>
            `;
            
            // é¸å–æ¡†ç·š (å…©æ¢ç¶ ç·š)
            const selectionBar = document.createElement('div');
            selectionBar.className = "absolute top-[50%] left-0 w-full h-[50px] -mt-[25px] pointer-events-none border-t border-b border-ttgreen/30 z-0";

            body.appendChild(mask);
            body.appendChild(selectionBar);
            body.appendChild(hourCol);
            body.appendChild(divider);
            body.appendChild(minCol);
            container.appendChild(body);

            // C. åº•éƒ¨æŒ‰éˆ•
            const footer = document.createElement('div');
            footer.className = "p-3 border-t border-gray-100 flex justify-center bg-gray-50 flex-none z-10";
            footer.innerHTML = '<button onclick="window.clearTime()" class="text-xs text-red-400 font-medium px-4 py-1.5 rounded-lg hover:bg-red-50 transition border border-transparent hover:border-red-100">æ¸…é™¤æ™‚é–“</button>';
            container.appendChild(footer);

            // D. é¡¯ç¤º & åˆå§‹å®šä½
            const m = document.getElementById('time-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);

            // åˆå§‹æ²å‹•åˆ°ä½ (ç„¡å‹•ç•«ï¼Œç›´æ¥è·³è½‰)
            setTimeout(() => {
                hourCol.scrollTop = initH * 50;
                minCol.scrollTop = initM * 50;
            }, 0);
        };

        // 3. ç¢ºå®šå„²å­˜ (ä¸è®Š)
        window.confirmTimeSelection = function() {
            // é˜²å‘†ï¼šç¢ºä¿æ•¸å€¼åœ¨ç¯„åœå…§
            const h = Math.max(0, Math.min(23, window._tempHour || 0));
            const m = Math.max(0, Math.min(59, window._tempMinute || 0));
            
            const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            const targetType = window._timePickerTarget;
            const inputEl = document.getElementById(`input-time-${targetType}`);
            
            if (inputEl) {
                inputEl.value = timeStr;
                window.updateTimeDisplay(targetType, timeStr);
                // è‡ªå‹•æ›´æ–°çµæŸæ™‚é–“é‚è¼¯
                if (targetType === 'start' || targetType === 'todo') { 
                    if (window.autoUpdateEnd) window.autoUpdateEnd(); 
                }
            }
            window.closeTimePicker();
        };

        // 4. æ¸…é™¤ & 5. é—œé–‰ (ä¸è®Š)
        window.clearTime = function() {
            const targetType = window._timePickerTarget;
            const inputEl = document.getElementById(`input-time-${targetType}`);
            if(inputEl) inputEl.value = '';
            window.updateTimeDisplay(targetType, ''); 
            window.closeTimePicker();
        };
        window.closeTimePicker = function() {
            const m = document.getElementById('time-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.checkRoleEnforcement = function() {
            if (!currentUserRole) {
                window.openSettingsModal();
                window.showToast('ğŸ‘‹ è«‹å…ˆå‘Šè¨´æˆ‘æ‚¨æ˜¯èª°ï¼Ÿ');
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) { roleSection.classList.add('ring-2', 'ring-ttgreen', 'bg-green-50'); setTimeout(() => roleSection.classList.remove('ring-2', 'ring-ttgreen', 'bg-green-50'), 600); }
                return false; 
            }
            return true;
        };
        
        // ä¿®æ”¹åŸæœ¬çš„ openSettingsModal
        window.openSettingsModal = function() {
            const m = document.getElementById('settings-modal');
            
            window.updateNotifyBtnState(); // <--- åŠ å…¥é€™è¡Œï¼šæ‰“é–‹è¨­å®šæ™‚æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
            
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeSettingsModal = function() {
            if (!currentUserRole) {
                window.showToast('è«‹å…ˆé¸æ“‡ä¸€å€‹èº«åˆ† ğŸ™');
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) { roleSection.classList.add('animate-pulse'); setTimeout(() => roleSection.classList.remove('animate-pulse'), 500); }
                return;
            }
            const m = document.getElementById('settings-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };
        
                // === æ–°å¢ï¼šé–‹å•Ÿåˆ†é¡ç®¡ç†è¦–çª— ===
        window.openCategorySettingsModal = function() {
            const m = document.getElementById('category-settings-modal');

            // ğŸŒŸ é€™è£¡æ‰é–‹å§‹æ¸²æŸ“åˆ—è¡¨ï¼Œç¢ºä¿æœ‰æ•ˆèƒ½ä¸” ID å­˜åœ¨
            window.renderCategorySettings();

            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        // === æ–°å¢ï¼šé—œé–‰åˆ†é¡ç®¡ç†è¦–çª— ===
        window.closeCategorySettingsModal = function() {
            const m = document.getElementById('category-settings-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.updateDateDisplay = function(type, dateStr) {
            let targetEl = (type === 'recur') ? document.getElementById('display-recur-until') : (type === 'todo' ? document.getElementById('display-date-todo') : document.getElementById(`display-date-${type}`));
            if (!targetEl) {
                 if (type === 'end') targetEl = document.getElementById('display-date-end');
                 else if (type === 'todo-end') targetEl = document.getElementById('display-date-todo-end');
                 else if (type.startsWith('recur-')) targetEl = document.getElementById(`display-date-${type}`);
            }
            if(!targetEl) return;
            if(!dateStr) { 
                if (type === 'recur' || type.startsWith('recur-')) targetEl.textContent = "è¨­å®šæ—¥æœŸ"; 
                else { targetEl.textContent = "è«‹é¸æ“‡"; targetEl.classList.add('dt-text-placeholder'); targetEl.classList.remove('dt-text-value'); }
                return; 
            }
            targetEl.classList.remove('dt-text-placeholder'); targetEl.classList.add('dt-text-value');
            const date = new Date(dateStr); 
            const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            if (type === 'recur' || type.startsWith('recur-')) targetEl.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} (${weekDays[date.getDay()]})`;
            else targetEl.textContent = `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥(${weekDays[date.getDay()]})`;
        };

        window.updateTimeDisplay = function(type, timeStr) { 
            const el = document.getElementById(`display-time-${type}`); 
            if(el) { 
                if(!timeStr) { el.textContent = 'è«‹é¸æ“‡'; el.classList.add('dt-text-placeholder'); el.classList.remove('dt-text-value'); } 
                else { el.textContent = timeStr; el.value = timeStr; el.classList.remove('dt-text-placeholder'); el.classList.add('dt-text-value'); }
            } 
        }; 
        
        window.checkRecurValidity = function() { const eD = document.getElementById('input-date-end')?.value; const rD = document.getElementById('input-recur-until')?.value; if(rD && eD && new Date(rD) < new Date(eD)) { const el = document.getElementById('input-recur-until'); if(el) el.value = eD; window.updateDateDisplay('recur', eD); } };
        
        window.autoUpdateEnd = function() { 
            try {
                let sT, endInputT, endDisplayType;
                if (document.getElementById('input-time-start') && document.getElementById('input-time-start').offsetParent !== null) {
                    sT = document.getElementById('input-time-start').value;
                    endInputT = document.getElementById('input-time-end');
                    endDisplayType = 'end';
                } 
                else if (document.getElementById('input-time-todo') && document.getElementById('input-time-todo').offsetParent !== null) {
                    sT = document.getElementById('input-time-todo').value;
                    endInputT = document.getElementById('input-time-todo-end');
                    endDisplayType = 'todo-end';
                }
                if (!sT || !endInputT) return;
                const [h, m] = sT.split(':').map(Number);
                const endH = (h + 1) % 24;
                const endTStr = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                if (!endInputT.value) { endInputT.value = endTStr; window.updateTimeDisplay(endDisplayType, endTStr); }
            } catch (e) { console.warn("Auto update end failed silently", e); }
        };
        window.checkEndDateValidity = function() { const sD = document.getElementById('input-date-start').value; const sT = document.getElementById('input-time-start').value; const eD = document.getElementById('input-date-end').value; const eT = document.getElementById('input-time-end').value; if(new Date(`${eD}T${eT}`) < new Date(`${sD}T${sT}`)) { window.autoUpdateEnd(); } else { window.checkRecurValidity(); } };
        window.setNowToInputs = function() { const now = new Date(); const dStr = now.toISOString().split('T')[0]; let h = now.getHours(), m = now.getMinutes(); if(m < 30) { m = 30; } else { m = 0; h += 1; } if(h > 23) h = 0; const tStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; const startEl = document.getElementById('input-date-start'); if(startEl) { startEl.value = dStr; document.getElementById('input-time-start').value = tStr; window.updateDateDisplay('start', dStr); window.updateTimeDisplay('start', tStr); const endD = document.getElementById('input-date-end'); if(endD) endD.value = dStr; const endT = document.getElementById('input-time-end'); if(endT) endT.value = tStr; window.updateDateDisplay('end', dStr); window.updateTimeDisplay('end', tStr); } };
        // === æ–°å¢ï¼šè«‹æ±‚é€šçŸ¥æ¬Šé™ ===
        window.requestNotifyPermission = function() {
            if (!("Notification" in window)) {
                window.showToast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥ ğŸ˜¢");
                return;
            }

            // iOS PWA æª¢æŸ¥
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone || (window.matchMedia('(display-mode: standalone)').matches);
            
            if (isIOS && !isStandalone) {
                alert("è«‹å…ˆå°‡æ­¤ç¶²é ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\næ‰èƒ½å•Ÿç”¨é€šçŸ¥åŠŸèƒ½å–”ï¼");
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    window.showToast("é€šçŸ¥å·²å•Ÿç”¨ï¼ğŸ‰");
                    window.updateNotifyBtnState();
                } else {
                    window.showToast("é€šçŸ¥æ¬Šé™è¢«æ‹’çµ• ğŸ˜­");
                }
            });
        };

        window.updateNotifyBtnState = function() {
            const btn = document.getElementById('btn-notify-perm');
            if (!btn) return;
            
            if (!("Notification" in window)) {
                btn.textContent = "ä¸æ”¯æ´";
                return;
            }

            if (Notification.permission === "granted") {
                btn.textContent = "å·²é–‹å•Ÿ";
                btn.className = "text-xs bg-green-100 border border-green-200 px-3 py-1.5 rounded-lg font-bold text-green-600 cursor-default";
                btn.onclick = null;
            } else if (Notification.permission === "denied") {
                btn.textContent = "å·²å°é–";
                btn.className = "text-xs bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg font-bold text-red-500";
            }
        };
        
        window.updateRoleUI = function() {
            // === 1. è¨­å®šé¡è‰²è®Šæ•¸ ===
            if (currentUserRole) {
                const color = roleColors[currentUserRole] || '#2cc998';
                document.documentElement.style.setProperty('--app-color', color);
                
                // è¨ˆç®—æ·ºè‰²ç‰ˆ
                let r = 0, g = 0, b = 0;
                if (color.length === 4) {
                    r = parseInt(color[1] + color[1], 16);
                    g = parseInt(color[2] + color[2], 16);
                    b = parseInt(color[3] + color[3], 16);
                } else if (color.length === 7) {
                    r = parseInt(color.slice(1, 3), 16);
                    g = parseInt(color.slice(3, 5), 16);
                    b = parseInt(color.slice(5, 7), 16);
                }
                const lightColor = `rgba(${r}, ${g}, ${b}, 0.1)`;
                document.documentElement.style.setProperty('--app-color-light', lightColor);

                // === âœ¨ æ–°å¢ï¼šä¸Šä¸‹æ¬„ä½è®Šè‰²é‚è¼¯ âœ¨ ===
                const header = document.getElementById('app-header');
                const nav = document.querySelector('nav');
                const logoText = header.querySelector('h1');
                
                // è¨­å®š Header èƒŒæ™¯
                header.style.backgroundColor = color;
                header.classList.remove('bg-white', 'border-b', 'border-gray-100'); // ç§»é™¤åŸæœ¬çš„ç™½åº•èˆ‡ç·šæ¢
                header.classList.add('colored-header', 'shadow-md'); // åŠ å…¥è‡ªè¨‚æ¨£å¼èˆ‡é™°å½±
                
                // è¨­å®š Nav èƒŒæ™¯
                nav.style.backgroundColor = color;
                nav.classList.remove('bg-white/95', 'border-t', 'border-gray-200');
                nav.classList.add('colored-nav', 'shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]');

                // è¨­å®š Meta Theme Color (è®“ç€è¦½å™¨ç¶²å€åˆ—ä¹Ÿè®Šè‰²ï¼)
                let metaThemeColor = document.querySelector("meta[name=theme-color]");
                if (!metaThemeColor) {
                    metaThemeColor = document.createElement("meta");
                    metaThemeColor.name = "theme-color";
                    document.head.appendChild(metaThemeColor);
                }
                metaThemeColor.content = color;
            }

            // === 2. èº«åˆ†åˆ‡æ›æŒ‰éˆ•æ¨£å¼ (ç¶­æŒä¸è®Š) ===
            const btnHaohao = document.getElementById('role-haohao');
            const btnMaomao = document.getElementById('role-maomao');
            if (btnHaohao) {
                const activeClass = "flex-1 py-3 rounded-xl text-sm font-bold border-2 border-transparent bg-theme text-white shadow-md transition transform scale-105";
                const inactiveClass = "flex-1 py-3 rounded-xl text-sm font-medium border border-gray-200 text-gray-400 bg-white transition hover:bg-gray-50";

                if (currentUserRole === 'haohao') { 
                    btnHaohao.className = activeClass; 
                    btnHaohao.style.backgroundColor = roleColors.haohao;
                    btnHaohao.style.borderColor = roleColors.haohao;
                    btnMaomao.className = inactiveClass; 
                    btnMaomao.style.backgroundColor = '';
                    btnMaomao.style.borderColor = '';
                } 
                else if (currentUserRole === 'maomao') { 
                    btnHaohao.className = inactiveClass;
                    btnHaohao.style.backgroundColor = '';
                    btnHaohao.style.borderColor = '';
                    btnMaomao.className = activeClass; 
                    btnMaomao.style.backgroundColor = roleColors.maomao;
                    btnMaomao.style.borderColor = roleColors.maomao;
                } 
                else { 
                    btnHaohao.className = inactiveClass; 
                    btnMaomao.className = inactiveClass; 
                }
            }

            // === 3. Header Badge æ›´æ–° (ç¶­æŒä¸è®Š) ===
            const badge = document.getElementById('header-role-badge');
            const badgeName = document.getElementById('header-role-name');
            if (badge && badgeName) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? 'çš“çš“' : 'æ¯›æ¯›';
                    badgeName.textContent = name;
                    badge.classList.remove('opacity-0');
                } else {
                    badgeName.textContent = 'è«‹é¸æ“‡';
                    badge.classList.remove('opacity-0');
                    badge.classList.add('animate-pulse');
                }
            }

            // === 4. èŠå¤©å®¤è¼¸å…¥æ¡†æ›´æ–° (ç¶­æŒä¸è®Š) ===
            const noteInput = document.getElementById('note-input');
            const noteSendBtn = document.getElementById('note-send-btn');
            if (noteInput) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? 'çš“çš“' : 'æ¯›æ¯›';
                    const color = roleColors[currentUserRole];
                    noteInput.placeholder = `${name}ï¼Œèªªé»ä»€éº¼...`;
                    noteInput.disabled = false;
                    if(noteInput.parentElement) noteInput.parentElement.style.borderColor = color;
                    if(noteSendBtn) { noteSendBtn.style.backgroundColor = color; noteSendBtn.classList.remove('bg-gray-300', 'cursor-not-allowed'); noteSendBtn.disabled = false; }
                } else {
                    noteInput.placeholder = 'è«‹å…ˆé¸æ“‡èº«åˆ†...';
                    noteInput.disabled = true;
                    if(noteInput.parentElement) noteInput.parentElement.style.borderColor = '#e5e7eb';
                    if(noteSendBtn) { noteSendBtn.style.backgroundColor = '#d1d5db'; noteSendBtn.classList.add('cursor-not-allowed'); noteSendBtn.disabled = true; }
                }
            }
            if (currentUserRole) {
                document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]);
                if(badge) badge.classList.remove('animate-pulse');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.updateSettingsColorUI = function() { const h = document.getElementById('setting-color-haohao'); if(h) { h.style.backgroundColor = roleColors.haohao; document.getElementById('setting-color-maomao').style.backgroundColor = roleColors.maomao; document.getElementById('setting-color-joint').style.backgroundColor = roleColors.joint; } };
        window.setStatus = function(s) { document.getElementById('input-status').value = s; document.querySelectorAll('.status-btn').forEach(b=>{ if(b.dataset.status===s) b.classList.add('active'); else b.classList.remove('active'); }); };
        window.showToast = function(msg) { const t = document.getElementById('toast-container'); const m = document.getElementById('toast-message'); m.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); };
        
        window.updateParticipantsPreview = function() { 
            const container = document.getElementById('participants-preview'); 
            if(!container) return; 
            const isP = document.getElementById('check-partner').checked; 
            let html = ''; 
            html += `<div class="avatar-sm z-20" style="background-color:${roleColors[currentUserRole]}">${currentUserRole==='haohao'?'çš“':'æ¯›'}</div>`; 
            if(isP) { 
                const p = currentUserRole==='haohao'?'maomao':'haohao'; 
                html += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]}">${p==='haohao'?'çš“':'æ¯›'}</div>`; 
            } 
            container.innerHTML = html; 
        };

        window.togglePartner = function() {
          const isChecked = document.getElementById('check-partner').checked;
          window.updateParticipantsPreview();
          colorPickerTarget = 'event';
          if (isChecked) currentSelectedColor = roleColors.joint;
          else currentSelectedColor = roleColors[currentUserRole];
        };

        window.setRole = function(role) { localStorage.setItem('user_role', role); currentUserRole = role; window.updateRoleUI(); document.documentElement.style.setProperty('--active-tab-color', roleColors[role]); };
        window.updateMyStatus = function(status) {
            if (!window.checkRoleEnforcement()) return;
             if(!db) return; const moods = ['normal', 'charging', 'sleepy', 'love', 'busy']; 
             let moodToSet = status;
             if (!moodToSet || !moodMap[moodToSet]) { moodToSet = moods[Math.floor(Math.random() * moods.length)]; }
             const d = {}; d[currentUserRole] = moodToSet; db.collection('status').doc('current').set(d, { merge: true }); 
        };
        window.toggleGlobalColorPicker = function(show) { const el = document.getElementById('global-color-picker'); const grid = document.getElementById('global-color-grid'); if(show) { grid.innerHTML = ''; timeTreeColors.forEach(color => { const row = document.createElement('div'); row.className = "flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition"; row.onclick = () => window.selectGlobalColor(color); row.innerHTML = `<div class="w-5 h-5 rounded-full mr-3 shadow-sm" style="background-color: ${color.hex}"></div><span class="text-sm text-gray-700">${color.name}</span>`; grid.appendChild(row); }); el.classList.remove('hidden'); setTimeout(() => el.classList.add('visible'), 10); } else { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); colorPickerTarget = null; } };

        window.selectGlobalColor = function(c) {
            if (colorPickerTarget === 'event') {
                currentSelectedColor = c.hex;
                document.getElementById('selected-color-name').textContent = c.name;
                document.getElementById('selected-color-dot').style.backgroundColor = c.hex;
            } 
            else if (colorPickerTarget) {
                const newHex = c.hex;
                const targetRole = colorPickerTarget; 
                const oldHex = roleColors[targetRole]; 
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é¡è‰²è¡çª (ä¾‹å¦‚æŠŠçš“çš“æ”¹æˆè·Ÿæ¯›æ¯›ä¸€æ¨£çš„é¡è‰²)
                let conflictRole = null;
                for (let key in roleColors) { 
                    if (key !== targetRole && roleColors[key] === newHex) { 
                        conflictRole = key; 
                        break; 
                    } 
                }
                
                // æ›´æ–°é¡è‰²ä¸¦å­˜æª”
                roleColors[targetRole] = newHex;
                localStorage.setItem(`color_${targetRole}`, newHex);
                
                // å¦‚æœæœ‰è¡çªï¼Œäº¤æ›é¡è‰²
                if (conflictRole) {
                    roleColors[conflictRole] = oldHex;
                    localStorage.setItem(`color_${conflictRole}`, oldHex);
                    window.showToast(`é¡è‰²é‡è¤‡ï¼Œå·²èˆ‡ã€Œ${conflictRole==='haohao'?'çš“çš“':(conflictRole==='maomao'?'æ¯›æ¯›':'å…±åŒè¡Œç¨‹')}ã€äº¤æ›é¡è‰²ï¼`);
                }
                
                // æ›´æ–°è¨­å®šé é¢è£¡é¢çš„å°åœ“é»
                window.updateSettingsColorUI();
                
                // === ğŸ‘‡ğŸ‘‡ğŸ‘‡ é—œéµä¿®æ­£ï¼šå¦‚æœæœ‰å‹•åˆ°ç•¶å‰ä½¿ç”¨è€…çš„é¡è‰²ï¼Œç«‹å³åˆ·æ–°å…¨Appä¸»é¡Œ ğŸ‘‡ğŸ‘‡ğŸ‘‡ ===
                if (targetRole === currentUserRole || conflictRole === currentUserRole) { 
                    window.updateRoleUI(); 
                }
                // =====================================================================
            }
            window.toggleGlobalColorPicker(false);
        };
        window.openColorConfig = function(target) { colorPickerTarget = target; window.toggleGlobalColorPicker(true); };
        window.syncSelectedColorUI = function() {
            const dot = document.getElementById('selected-color-dot');
            const name = document.getElementById('selected-color-name');
            if (!dot || !name) return;
            const found = timeTreeColors.find(c => c.hex === currentSelectedColor);
            dot.style.backgroundColor = currentSelectedColor;
            name.textContent = found ? found.name : 'è‡ªè¨‚é¡è‰²';
        };

        window.renderEvents = function(ignored) { const items = window.getCalendarItems(); const now = new Date(); const future = items.filter(e => { const date = new Date(e.timestamp); if(e.isTodo && e.done) return false; return !isNaN(date) && date >= now; }); const titleEl = document.getElementById('next-event-title'); if(titleEl && future.length > 0) { const n = future[0], d = new Date(n.timestamp); titleEl.textContent = n.title; const timeStr = n.allDay ? "All Day" : d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('next-event-time').textContent = timeStr; document.getElementById('next-event-date').textContent = d.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); const diff = Math.ceil((d-now)/(1000*60*60*24)); document.getElementById('countdown').textContent = diff<=0?"TODAY":`D - ${diff}`; } else if(titleEl) { titleEl.textContent = "No Upcoming Events"; } const listEl = document.getElementById('event-list'); if(listEl) { if (items.length === 0) listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; else window.renderEventListItems(items, listEl); } };
        window.getCalendarItems = function() {
            // 1. ç¢ºä¿ events æ˜¯é™£åˆ—
            const eventsRaw = Array.isArray(window.allEventsCache) ? window.allEventsCache : [];
            const events = eventsRaw.map(e => ({...e, type: 'event'}));
            
            // 2. ç¢ºä¿ todos æ˜¯é™£åˆ—
            const todosRaw = Array.isArray(window.allTodosCache) ? window.allTodosCache : [];
            const todos = todosRaw
                .filter(t => t.timestamp) 
                .map(t => ({
                    ...t, 
                    id: t.id,
                    title: t.title,
                    timestamp: t.timestamp,
                    allDay: !t.dueTime,
                    isTodo: true,
                    done: t.done,
                    type: 'todo',
                    color: null 
                }));

            // 3. ä½¿ç”¨ concat å–ä»£ ... (Spread Syntax) ä»¥é¿å…éŒ¯èª¤
            return events.concat(todos).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        };       

        window.renderDashboardNextUp = function(items) {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // <--- é—œéµä¿®æ”¹ï¼šå°‡æ¯”è¼ƒåŸºæº–è¨­ç‚ºä»Šå¤©çš„èµ·å§‹é»
            
            const nextLimit = new Date();
            nextLimit.setDate(now.getDate() + 3); 
            
            const upcoming = items.filter(item => {
                const t = new Date(item.timestamp);
                if (item.isTodo && item.done) return false;
                // é‚è¼¯ï¼šæ™‚é–“ >= ä»Šå¤©å‡Œæ™¨ ä¸” <= æœªä¾†3å¤©
                return !isNaN(t) && t >= now && t <= nextLimit;
            });

            // (å·²ç§»é™¤èˆŠçš„ countdown é‚è¼¯)

            const container = document.getElementById('dashboard-next-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (upcoming.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">æœªä¾† 3 å¤©æ²’æœ‰è¡Œç¨‹ ğŸ˜´</div>`;
            } else {
                let html = '';
                upcoming.forEach(item => {
                    const date = new Date(item.timestamp);
                    const startDateStr = item.startDate || item.dueDate;
                    const endDateStr = item.endDate || item.dueDateEnd;
                    const effectiveEndDateStr = endDateStr || startDateStr;

                    // åˆ¤æ–·æ˜¯å¦è·¨æ—¥
                    const isCrossDay = startDateStr !== effectiveEndDateStr;

                    // === 1. å»ºæ§‹é¡¯ç¤ºå­—ä¸² (Meta HTML) ===
                    let metaHtml = '';

                    if (isCrossDay) {
                        // === è·¨æ—¥è¡Œç¨‹ ===
                        const startD = new Date(startDateStr);
                        const endD = new Date(effectiveEndDateStr);
                        
                        if (item.allDay) {
                            const sStr = `${startD.getMonth()+1}/${startD.getDate()}`;
                            const eStr = `${endD.getMonth()+1}/${endD.getDate()}`;
                            metaHtml = `<span class="font-bold text-gray-600">${sStr}</span> <span class="text-gray-300 mx-1">â†’</span> <span class="font-bold text-gray-600">${eStr}</span> <span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-1">All Day</span>`;
                        } else {
                            const sTime = date.toLocaleTimeString('zh-TW', {
                                hour: '2-digit', minute: '2-digit', hour12: false
                            });
                            const eTime = item.endTime || '??:??';
                            const sStr = `${startD.getMonth()+1}/${startD.getDate()} ${sTime}`;
                            const eStr = `${endD.getMonth()+1}/${endD.getDate()} ${eTime}`;
                            metaHtml = `<span class="font-medium text-gray-600 tracking-tight">${sStr}</span> <i data-lucide="arrow-right" class="w-3 h-3 inline-block mx-0.5 align-middle text-gray-300"></i> <span class="font-medium text-gray-600 tracking-tight">${eStr}</span>`;
                        }
                    } else {
                        // === å–®æ—¥è¡Œç¨‹ ===
                        const dateDisplay = new Date(startDateStr).toLocaleDateString('zh-TW', {
                            month: 'numeric', day: 'numeric', weekday: 'short'
                        });
                        
                        let timeStr = item.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
                            hour: '2-digit', minute: '2-digit', hour12: false
                        });
                        
                        const endTime = item.endTime || item.dueTimeEnd;
                        if (endTime && !item.allDay) {
                            timeStr += ` - ${endTime}`;
                        }
                        
                        metaHtml = `${dateDisplay} <span class="text-gray-300 mx-1">|</span> ${timeStr}`;
                    }

                    if (item.location) {
                        metaHtml += ` <span class="text-gray-300 mx-1">|</span> ${item.location}`;
                    }

                    let color;
                    if (item.isJoint) {
                        color = roleColors.joint;
                    } else {
                        color = (item.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                    }

                    let displayIcon = '';
                    let isVac = false;
                    
                    // 1. å¦‚æœæ˜¯ä¼‘å‡ï¼Œç›´æ¥åœ¨æ¨™é¡Œå‰åŠ ä¸Š Emoji
                    if (typeof window.isLeaveEvent === 'function' && window.isLeaveEvent(item.title)) {
                        isVac = true;
                        displayIcon = 'ğŸ– '; 
                    }

                    let tagHtml = '';
                    if (item.isTodo) {
                        tagHtml = `<span class="ml-2 text-[10px] border border-gray-200 text-gray-400 px-1 rounded flex-shrink-0">å¾…è¾¦</span>`;
                    } 
                    // 2. å¦‚æœæ˜¯ä¼‘å‡ï¼ŒtagHtml ç•™ç©º (å› ç‚ºå·²ç¶“åŠ åœ¨æ¨™é¡Œäº†)
                    else if (isVac) {
                        tagHtml = ''; 
                    }
                    else if (item.status === 'tbc') tagHtml = `<span class="ml-2 status-tag tbc">TBC</span>`;
                    else if (item.status === 'tbd') tagHtml = `<span class="ml-2 status-tag tbd">TBD</span>`;

                    let noteDisplay = '';
                    if (item.note && item.note.trim()) {
                        noteDisplay = `<div class="text-xs text-gray-400 mt-1 flex items-start gap-1"><i data-lucide="sticky-note" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><span class="truncate">${item.note}</span></div>`;
                    }

                    let clickAction = item.isTodo ? `window.openEditTodoModal('${item.id}')` : `window.openEditModal('${item.id}')`;
                    const bgClass = isVac ? 'bg-blue-50/30' : 'hover:bg-gray-50';

                    html += `
                    <div class="flex items-center p-3 ${bgClass} cursor-pointer transition border-b border-gray-50 last:border-0" onclick="${clickAction}">
                        <div class="w-1 self-stretch rounded-full mr-3" style="background-color: ${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-gray-800 truncate">${displayIcon}${item.title}</span>
                                ${tagHtml}
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5 flex items-center flex-wrap">
                                ${metaHtml}
                            </div>
                            ${noteDisplay}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({ root: container });
                }
            }
        };
    
        window.renderCalendarListView = function() { const items = window.getCalendarItems(); const listEl = document.getElementById('event-list'); if(!listEl) return; if (items.length === 0) { listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">ç„¡è¡Œç¨‹</div>`; } else { window.renderEventListItems(items, listEl); } };

        // === å„ªåŒ–ç‰ˆï¼šåˆ—è¡¨æ¸²æŸ“ (æ”¯æ´æ‰¹æ¬¡é¸å–) ===
        window.renderEventListItems = function(items, container, forceExpand = false, hideMonthHeader = false) {
            const now = new Date(); 
            const isBatch = window.batchState.active && window.batchState.target === 'event';

            // é¡¯ç¤º/éš±è—æ¨™é¡Œåˆ—çš„ã€Œé¸æ“‡ã€æŒ‰éˆ•
            const batchBtn = document.getElementById('btn-batch-event');
            const spacer = document.getElementById('calendar-header-spacer');
            const viewListBtn = document.getElementById('btn-view-list');
            
            // åªæœ‰åœ¨ã€Œåˆ—è¡¨æ¨¡å¼ã€ä¸”ã€Œä¸åœ¨æœˆæ›†å®¹å™¨å…§ã€æ™‚æ‰é¡¯ç¤ºæŒ‰éˆ•
            // (æˆ‘å€‘åˆ¤æ–· container id æ˜¯å¦ç‚º month-event-list ä¾†æ±ºå®šæ˜¯ä¸æ˜¯æœˆæ›†ä¸‹æ–¹çš„æ¸…å–®)
            if (batchBtn && spacer) {
                if (container.id === 'month-event-list' || currentViewMode === 'month') {
                    batchBtn.classList.add('hidden');
                    spacer.classList.add('hidden');
                } else {
                    batchBtn.classList.remove('hidden');
                    spacer.classList.remove('hidden');
                }
            }

            // 2. å®šç¾© HTML ç”Ÿæˆå™¨ (ä¿®æ­£ç‰ˆï¼šåŠ å…¥å‹¾é¸æ¡† + ç§»é™¤é ­åƒ)
            const generateItemHtml = (listItems) => {
                let htmlBuffer = '';
                let lastMonthLabel = '';

                listItems.forEach(e => {
                    const date = new Date(e.timestamp);
                    const currentMonthLabel = `${date.getFullYear()}å¹´ ${date.getMonth() + 1}æœˆ`;
                    
                    if (!hideMonthHeader && currentMonthLabel !== lastMonthLabel) {
                        htmlBuffer += `
                        <div class="sticky top-0 z-30 bg-gray-100/95 backdrop-blur-sm px-4 py-2 text-xs font-bold text-gray-500 border-b border-gray-200 shadow-sm flex items-center justify-between">
                            <span>${currentMonthLabel}</span>
                            ${currentMonthLabel === `${now.getFullYear()}å¹´ ${now.getMonth() + 1}æœˆ` ? '<span class="text-[10px] bg-theme text-white px-1.5 py-0.5 rounded-full">æœ¬æœˆ</span>' : ''}
                        </div>`;
                        lastMonthLabel = currentMonthLabel;
                    }

                    // === åˆ¤æ–·æ˜¯å¦åç° ===
                    let opacityClass = '';
                    if (e.isTodo) {
                        if (e.done) opacityClass = 'opacity-40 grayscale';
                    } else {
                        let cutoffDate;
                        const sDateStr = e.endDate || e.dueDateEnd || e.startDate || e.dueDate;
                        if (sDateStr) {
                            if (e.allDay) {
                                const localDateStr = sDateStr.replace(/-/g, '/'); 
                                cutoffDate = new Date(localDateStr);
                                cutoffDate.setHours(23, 59, 59, 999);
                            } else {
                                const eTime = e.endTime || e.dueTimeEnd;
                                if (eTime) cutoffDate = new Date(`${sDateStr}T${eTime}`);
                                else cutoffDate = new Date(e.timestamp);
                            }
                        }
                        if (cutoffDate && now > cutoffDate) opacityClass = 'opacity-50 grayscale';
                    }

                    // === æ™‚é–“å­—ä¸²è™•ç† ===
                    let timeStr = "";
                    const startDateStr = e.startDate || e.dueDate;
                    const endDateStr = e.endDate || e.dueDateEnd;
                    const effectiveEndDateStr = endDateStr || startDateStr;
                    
                    let dateObjStart = startDateStr ? new Date(startDateStr) : date;
                    if (isNaN(dateObjStart)) dateObjStart = date;
                    
                    let dayNum = dateObjStart.getDate();
                    let dayName = dateObjStart.toLocaleDateString('en-US', { weekday: 'short' });

                    if (startDateStr && effectiveEndDateStr && startDateStr !== effectiveEndDateStr) {
                        const dateObjEnd = new Date(effectiveEndDateStr);
                        const sDateDisplay = `${dateObjStart.getMonth()+1}/${dateObjStart.getDate()}`;
                        const eDateDisplay = `${dateObjEnd.getMonth()+1}/${dateObjEnd.getDate()}`;
                        if (e.allDay) {
                             timeStr = `${sDateDisplay} - ${eDateDisplay} (All Day)`;
                        } else {
                             const sTime = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                             const eTime = (e.endTime || e.dueTimeEnd) || "??:??";
                             timeStr = `${sTime} <span class="text-gray-400">â†’</span> ${eDateDisplay} ${eTime}`;
                        }
                    } else {
                        timeStr = e.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                        const endTime = e.endTime || e.dueTimeEnd;
                        if (endTime && !e.allDay) timeStr += ` - ${endTime}`;
                    }

                    let displayIcon = '';
                    if (typeof window.isLeaveEvent === 'function' && window.isLeaveEvent(e.title)) displayIcon = 'ğŸ–ï¸ ';

                    let displayColor;
                    if (e.isJoint) displayColor = roleColors.joint; 
                    else displayColor = (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);

                    // === å‹•ä½œèˆ‡ç‹€æ…‹è¨­å®š ===
                    const deleteAction = e.isTodo ? `window.deleteTodo('${e.id}');` : `window.quickDeleteEvent('${e.id}');`;
                    const clickAction = isBatch ? `window.toggleBatchItem('${e.id}')` : (e.isTodo ? `window.openEditTodoModal('${e.id}')` : `window.openEditModal('${e.id}')`);
                    const isSelected = isBatch && window.batchState.selectedIds.has(e.id);
                    const checkClass = isSelected ? 'checked' : '';
                    
                    // å‹¾é¸æ¡† HTML
                    const checkboxHtml = `
                    <div class="batch-checkbox-col">
                        <div id="batch-check-${e.id}" class="batch-check-circle ${checkClass}"></div>
                    </div>`;

                    if (e.isTodo) {
                        // === å¾…è¾¦äº‹é …æ¨£å¼ ===
                        const statusClass = e.done ? "line-through text-gray-400" : "text-gray-800";
                        const checkIcon = e.done ? '<i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="square" class="w-5 h-5 text-gray-400"></i>';
                        
                        htmlBuffer += `
                        <div class="swipe-item border-b border-gray-50 last:border-0 ${opacityClass} ${isBatch ? 'selection-mode' : ''}" data-swipe-id="${e.id}">
                            ${!isBatch ? `<div class="swipe-action-bg" onclick="${deleteAction}"><i data-lucide="trash-2" class="w-5 h-5"></i></div>` : ''}
                            
                            <div class="swipe-content flex p-4 items-center bg-white" onclick="${clickAction}">
                                ${checkboxHtml} <div class="flex-1 flex items-center gap-4 min-w-0">
                                    <div class="flex flex-col items-center w-10">
                                        <span class="text-xs text-gray-400 font-medium uppercase">${dayName}</span>
                                        <span class="text-xl font-bold text-gray-800 leading-none">${dayNum}</span>
                                    </div>
                                    <div class="w-1 self-stretch rounded-full" style="background-color: ${displayColor}"></div>
                                    <div class="flex-1 min-w-0 flex items-center justify-between">
                                        <div>
                                            <div class="flex items-center ${statusClass}">
                                                <span class="font-bold truncate block">${displayIcon||''}${e.title}</span>
                                                <span class="ml-2 text-[10px] border border-gray-200 px-1 rounded text-gray-400 flex-shrink-0">å¾…è¾¦</span>
                                            </div>
                                            <div class="text-xs text-gray-500">${timeStr}</div>
                                        </div>
                                    </div>
                                    ${!isBatch ? `<div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${e.id}', ${!e.done}); event.stopPropagation();">${checkIcon}</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                    } else {
                        // === ä¸€èˆ¬è¡Œç¨‹æ¨£å¼ (ä¸‰è¡Œé«˜åº¦ + æ—¥æœŸè®Šè‰²ç‰ˆ) ===
                        let ic = ''; if (e.category === 'travel') ic = 'plane'; else if (e.category === 'appointment') ic = 'scissors'; else if (e.category === 'gathering') ic = 'users'; else if (e.category === 'vacation') ic = 'palmtree';
                        let ico = ic ? `<i data-lucide="${ic}" class="w-3 h-3 text-gray-400 mr-1 flex-shrink-0"></i>` : '';
                        let st = ''; if (e.status === 'tbc') st = `<span class="ml-2 status-tag tbc">TBC</span>`; else if (e.status === 'tbd') st = `<span class="ml-2 status-tag tbd">TBD</span>`;
                        
                        // å‚™è¨»è™•ç†ï¼šç¨ç«‹æˆç¬¬ä¸‰è¡Œé¡¯ç¤º
                        let noteDisplay = ''; 
                        if (e.note && e.note.trim()) {
                            noteDisplay = `<div class="text-xs text-gray-400 truncate flex items-center gap-1 min-h-[16px]"><i data-lucide="sticky-note" class="w-3 h-3"></i>${e.note}</div>`;
                        } else {
                            // å³ä½¿æ²’æœ‰å‚™è¨»ï¼Œä¹Ÿä¿ç•™ä¸€å€‹ç©ºçš„ä½”ä½ï¼Œç¢ºä¿è¦–è¦ºé«˜åº¦ä¸€è‡´ (å¯é¸ï¼Œé€™è£¡æˆ‘è®“å®ƒè‡ªå‹•å‚ç›´ç½®ä¸­)
                            // å¦‚æœä½ å¸Œæœ›æ²’å‚™è¨»æ™‚æ˜¯ä¸€ç‰‡ç©ºç™½ä½†é«˜åº¦ä¸è®Šï¼Œé€™è£¡ç•™ç©ºå³å¯
                        }

                        // æ™‚é–“èˆ‡åœ°é»åˆä½µåœ¨ç¬¬äºŒè¡Œ
                        let locationDisplay = e.location ? `<span class="mx-1">Â·</span><span>${e.location}</span>` : '';

                        htmlBuffer += `
                        <div class="swipe-item border-b border-gray-50 last:border-0 ${opacityClass} ${isBatch ? 'selection-mode' : ''}" data-swipe-id="${e.id}">
                            ${!isBatch ? `<div class="swipe-action-bg" onclick="${deleteAction}"><i data-lucide="trash-2" class="w-5 h-5"></i></div>` : ''}

                            <div class="swipe-content h-[88px] flex items-center bg-white card-press" onclick="${clickAction}">
                                
                                ${checkboxHtml} 
                                
                                <div class="flex-1 flex items-center h-full min-w-0 pr-4"> 
                                    
                                    <div class="w-[60px] flex flex-col items-center justify-center flex-shrink-0 h-full">
                                        <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">${dayName}</span>
                                        <span class="text-xl font-bold leading-none mt-0.5" style="color:${displayColor}">${dayNum}</span>
                                    </div>
                                    
                                    <div class="w-[4px] h-[48px] rounded-full mx-1 flex-shrink-0" style="background-color:${displayColor}"></div>
                                    
                                    <div class="flex-1 min-w-0 flex flex-col justify-center ml-3 gap-0.5">
                                        
                                        <div class="flex items-center">
                                            ${ico}
                                            <h4 class="font-bold text-gray-800 text-sm truncate leading-tight">${displayIcon||''}${e.title}</h4>
                                            ${st}
                                        </div>

                                        <div class="flex items-center text-xs text-gray-500 truncate leading-tight font-medium h-[16px]">
                                            <span>${timeStr}</span>
                                            ${locationDisplay}
                                        </div>

                                        ${noteDisplay}
                                    </div>
                                    
                                </div>
                            </div>
                        </div>`;
                    }
                });
                return htmlBuffer;
            };

            if (forceExpand) {
                container.innerHTML = generateItemHtml(items);
                if (typeof lucide !== 'undefined') lucide.createIcons({ root: container });
                return;
            }

            // ... (æ­·å²è¡Œç¨‹åˆ†æµ) ...
            const pastItems = []; const futureItems = [];
            items.forEach(e => { /* ...åŸæ¨£ä¿ç•™... */ });
            // ...
            
            // æœ€å¾Œåˆ¥å¿˜äº†å•Ÿå‹•æ»‘å‹•ç›£è½ (åªæœ‰åœ¨éæ‰¹æ¬¡æ¨¡å¼æ™‚æ‰æœ‰æ•ˆ)
            if (!isBatch) {
                setTimeout(() => window.initSwipeListeners(container), 100);
            }
    

            // é€™è£¡ä¹Ÿéœ€è¦ç”¨ç›¸åŒçš„ cutoff é‚è¼¯ä¾†åˆ†é¡ã€Œæ­·å²ã€èˆ‡ã€Œæœªä¾†ã€
            items.forEach(e => {
                const date = new Date(e.timestamp);
                if (isNaN(date)) return;
                
                let isPast = false;
                if (e.isTodo) { isPast = e.done; } 
                else {
                    // å¥—ç”¨ç›¸åŒçš„é‚è¼¯
                    const sDateStr = e.endDate || e.dueDateEnd || e.startDate || e.dueDate;
                    let cutoffDate;
                    if (sDateStr) {
                         if (e.allDay) {
                            const localDateStr = sDateStr.replace(/-/g, '/'); 
                            cutoffDate = new Date(localDateStr);
                            cutoffDate.setHours(23, 59, 59, 999);
                        } else {
                            const eTime = e.endTime || e.dueTimeEnd;
                            if (eTime) cutoffDate = new Date(`${sDateStr}T${eTime}`);
                            else cutoffDate = new Date(e.timestamp);
                        }
                        isPast = cutoffDate < now;
                    } else {
                        isPast = date < now;
                    }
                }
                if (isPast) pastItems.push(e); else futureItems.push(e);
            });

            let finalHtml = '';
            if (pastItems.length > 0) {
                finalHtml += `
                <div onclick="window.toggleHistory()" class="cursor-pointer bg-gray-50 border-b border-gray-200 py-3 flex items-center justify-center text-xs text-gray-500 hover:bg-gray-100 transition">
                    <i data-lucide="clock" class="w-3.5 h-3.5 mr-1.5"></i>
                    <span id="history-btn-text">æŸ¥çœ‹ä¹‹å‰çš„ ${pastItems.length} ç­†è¡Œç¨‹</span>
                    <i id="history-chevron" data-lucide="chevron-down" class="w-3.5 h-3.5 ml-1 transition-transform duration-300"></i>
                </div>
                <div id="history-list-container" class="hidden bg-gray-50/50 border-b border-gray-200 shadow-inner">`;
                finalHtml += generateItemHtml(pastItems);
                finalHtml += `</div>`;
            }
            if (futureItems.length > 0) {
                finalHtml += generateItemHtml(futureItems);
            } else {
                finalHtml += `<div class="text-center py-12 text-gray-400 text-sm">æ¥ä¸‹ä¾†æ²’æœ‰å®‰æ’è¡Œç¨‹ ğŸ‰</div>`;
            }

            container.innerHTML = finalHtml;
            setTimeout(() => window.initSwipeListeners(container), 100);
            if (typeof lucide !== 'undefined') lucide.createIcons({ root: container });
        };

        // === æ–°å¢ï¼šåˆ‡æ›æ­·å²é¡¯ç¤ºçš„å‡½å¼ ===
        window.toggleHistory = function() {
            const container = document.getElementById('history-list-container');
            const chevron = document.getElementById('history-chevron');
            const btnText = document.getElementById('history-btn-text');
            
            if (!container) return;

            if (container.classList.contains('hidden')) {
                // å±•é–‹
                container.classList.remove('hidden');
                chevron.classList.add('rotate-180');
                btnText.textContent = "æ”¶èµ·æ­·å²è¡Œç¨‹";
            } else {
                // æ”¶èµ·
                container.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                // é‡æ–°è¨ˆç®—æ•¸é‡ (é€™è£¡å·æ‡¶ç›´æ¥è®€å–åŸæœ¬çš„å­—ä¸²å¯èƒ½æœƒè·‘æ‰ï¼Œç°¡å–®å¯«æ­»æˆ–æ˜¯é‡ç®—)
                // æ¯”è¼ƒå¥½çš„åšæ³•æ˜¯ä¿æŒåŸæ¨£ï¼Œæˆ–æ˜¯ç°¡å–®å¯« "æŸ¥çœ‹æ­·å²è¡Œç¨‹"
                btnText.textContent = "æŸ¥çœ‹æ­·å²è¡Œç¨‹";
            }
        };
       
        window.toggleAllDay = function() { const isChecked = document.getElementById('check-allday').checked; document.querySelectorAll('.dt-wrapper-time').forEach(d => d.style.display = isChecked ? 'none' : 'block'); };
        window.toggleRecurring = function() { const isChecked = document.getElementById('check-recurring').checked; const opts = document.getElementById('recurring-options'); if(isChecked) { opts.classList.remove('hidden'); if(!document.getElementById('input-recur-until').value) document.getElementById('input-recur-until').value = document.getElementById('input-date-end').value; } else opts.classList.add('hidden'); };
        window.toggleTravelFields = function() { const type = document.getElementById('input-transport-type').value; const isPlane = type === 'plane'; document.getElementById('travel-region-intl').classList.toggle('hidden', !isPlane); document.getElementById('travel-region-tw').classList.toggle('hidden', isPlane); };
        window.toggleBooked = function() { const isChecked = document.getElementById('check-booked').checked; const txt = document.getElementById('appoint-status-text'); txt.textContent = isChecked ? "å·²é ç´„" : "æœªå®Œæˆ"; txt.className = isChecked ? "text-xs font-bold text-purple-600" : "text-xs text-gray-500"; };

        window.toggleTodo = function(id,s) {
            if(s) triggerHaptic('SUCCESS'); // <--- ğŸŒŸ åŠ å…¥é€™è¡Œ (å¦‚æœæ˜¯æ‰“å‹¾ï¼Œçµ¦ä¸€å€‹æˆåŠŸçš„éœ‡å‹•)
            else triggerHaptic('LIGHT');    // <--- ğŸŒŸ (å¦‚æœæ˜¯å–æ¶ˆï¼Œçµ¦ä¸€å€‹è¼•éœ‡å‹•)
            db.collection('todos').doc(id).update({done:s}); };

        // === è£œä¸Šç¼ºå¤±çš„åˆªé™¤è§¸ç™¼å‡½å¼ ===

        window.deleteCurrentEvent = function() {
            // ç¢ºä¿æœ‰æ­£åœ¨ç·¨è¼¯çš„ ID
            if (!editingEventId) return;
            
            deleteTarget = 'event';
            
            // è¨­å®šç¢ºèªè¦–çª—çš„æ–‡å­—
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = 'åˆªé™¤è¡Œç¨‹ï¼Ÿ';
            if(desc) desc.textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼';
            
            // æ‰“é–‹ç¢ºèªè¦–çª—
            window.confirmDelete();
        };

        window.deleteCurrentTodo = function() {
            // ç¢ºä¿æœ‰æ­£åœ¨ç·¨è¼¯çš„ ID
            if (!editingTodoId) return;
            
            deleteTarget = 'todo';
            
            // è¨­å®šç¢ºèªè¦–çª—çš„æ–‡å­—
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = 'åˆªé™¤å¾…è¾¦ï¼Ÿ';
            if(desc) desc.textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ';
            
            // æ‰“é–‹ç¢ºèªè¦–çª—
            window.confirmDelete();
        };

        // === å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†è¨˜éŒ„å“ªäº›åˆ†é¡æ˜¯è¢«ã€Œæ”¶èµ·ä¾†ã€çš„ ===
        window.collapsedCategories = JSON.parse(localStorage.getItem('collapsed_categories') || '{}');

        // === å„ªåŒ–ç‰ˆï¼šå¾…è¾¦æ¸…å–®æ¸²æŸ“ (å­—ä¸²çµ„è£æ¨¡å¼) ===
        window.renderTodos = function(todos) {
            const container = document.getElementById('todo-category-container');
            const dashboardList = document.getElementById('dashboard-todo-list');
            
            if(!container) return;
            
            // 1. è³‡æ–™å®‰å…¨æª¢æŸ¥
            let dataToRender = [];
            if (Array.isArray(todos)) {
                dataToRender = todos;
            } else if (Array.isArray(window.allTodosCache)) {
                dataToRender = window.allTodosCache;
            }

            try {
                // 2. è³‡æ–™åˆ†çµ„èˆ‡æ’åº
                const groups = {};
                const noCategoryKey = 'æœªåˆ†é¡';
                const categoryOrder = window.getCategoryOrder ? window.getCategoryOrder() : []; 
                let pendingCount = 0;

                // ä½¿ç”¨ slice() å–ä»£ spread èªæ³•ï¼Œç›¸å®¹æ€§æ›´é«˜
                const safeTodos = dataToRender.slice().sort((a, b) => {
                    const oA = a.order !== undefined ? a.order : 999999;
                    const oB = b.order !== undefined ? b.order : 999999;
                    return oA - oB;
                });

                safeTodos.forEach(t => {
                    if(!t.done) pendingCount++;
                    const cat = t.category || noCategoryKey;
                    if (!groups[cat]) { groups[cat] = []; }
                    groups[cat].push(t);
                });

                const sortedKeys = Object.keys(groups).sort((a, b) => {
                    const idxA = categoryOrder.indexOf(a);
                    const idxB = categoryOrder.indexOf(b);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    return a.localeCompare(b);
                });

                const isBatch = window.batchState && window.batchState.active && window.batchState.target === 'todo';
                let finalHtml = ''; // æº–å‚™ä¸€å€‹å¤§å­—ä¸²

                // 3. ç”¢ç”Ÿ HTML å­—ä¸²
                if (sortedKeys.length === 0) {
                     finalHtml = `<div class="text-center py-20 text-gray-300 text-sm">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é … ğŸ‰</div>`;
                } else {
                    sortedKeys.forEach(cat => {
                        const items = groups[cat];
                        const isCollapsed = !!window.collapsedCategories[cat];
                        const count = items.filter(i => !i.done).length; 
                        
                        const listId = `cat-list-${cat}`;
                        const chevronClass = isCollapsed ? '' : 'rotate-180';
                        const listClass = isCollapsed ? 'hidden' : 'block';
                        
                        // åˆ†é¡æ¨™é¡Œ
                        finalHtml += `
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50/50 cursor-pointer select-none active:bg-gray-100 transition" onclick="window.toggleTodoCategory('${cat}')">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="chevron-down" id="chevron-${cat}" class="w-4 h-4 text-gray-400 transition-transform duration-300 ${chevronClass}"></i>
                                    <h3 class="font-bold text-gray-700">${cat}</h3>
                                    ${count > 0 ? `<span class="bg-theme text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">${count}</span>` : ''}
                                </div>
                            </div>
                            <div id="${listId}" class="${listClass} divide-y divide-gray-100 bg-white sortable-list" data-category="${cat}">`;
                        
                        // å¾…è¾¦é …ç›®
                        items.forEach(t => {
                            let barColor = roleColors.haohao;
                            if (t.isJoint) barColor = roleColors.joint;
                            else if (t.creator === 'maomao') barColor = roleColors.maomao;
                            
                            const titleClass = t.done ? "text-gray-400 line-through" : "text-gray-800";
                            const checkStyle = t.done ? `background-color: #d1d5db; border-color: #d1d5db;` : `border-color: ${barColor};`;
                            
                            let calInfo = '';
                            if (t.dueDate) {
                                calInfo = `<span class="text-[10px] ${t.done?'text-gray-300':'text-gray-400'} ml-auto flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</span>`;
                            }

                            const isSelected = isBatch && window.batchState.selectedIds.has(t.id);
                            const checkClass = isSelected ? 'checked' : '';
                            
                            let clickAction = `window.openEditTodoModal('${t.id}')`;
                            if (isBatch) clickAction = `window.toggleBatchItem('${t.id}')`;

                            const batchCheckboxHtml = `
                                <div class="batch-checkbox-col">
                                    <div id="batch-check-${t.id}" class="batch-check-circle ${checkClass}"></div>
                                </div>`;

                            const deleteBtnHtml = !isBatch ? 
                                `<div class="swipe-action-bg" onclick="window.deleteTodo('${t.id}')"><i data-lucide="trash-2" class="w-5 h-5"></i></div>` : '';

                            const toggleBtnHtml = !isBatch ? `
                                <div class="flex-none mr-3" onclick="window.toggleTodo('${t.id}', ${!t.done}); event.stopPropagation();">
                                    <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors text-white" style="${checkStyle}">
                                        ${t.done ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                                    </div>
                                </div>` : '';

                            finalHtml += `
                            <div class="swipe-item border-b border-gray-50 last:border-0 ${isBatch ? 'selection-mode' : ''}" data-swipe-id="${t.id}" data-id="${t.id}">
                                ${deleteBtnHtml}
                                <div class="swipe-content flex items-center p-3 bg-white hover:bg-gray-50 transition cursor-pointer group" onclick="${clickAction}">
                                    ${batchCheckboxHtml}
                                    <div class="flex-1 flex items-center min-w-0">
                                        ${toggleBtnHtml}
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <span class="${titleClass} font-medium truncate">${t.title}</span>
                                                ${calInfo}
                                            </div>
                                            <div class="flex items-center mt-1">
                                                <div class="w-1.5 h-1.5 rounded-full mr-1.5" style="background-color: ${barColor}"></div>
                                                <span class="text-[10px] text-gray-400">
                                                    ${t.isJoint ? 'å…±åŒ' : (t.creator === 'haohao' ? 'çš“çš“' : 'æ¯›æ¯›')}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        });
                        
                        if(items.length === 0) { finalHtml += `<div class="p-4 text-center text-xs text-gray-300">æ­¤åˆ†é¡ç„¡é …ç›®</div>`; }
                        finalHtml += `</div></div>`;
                    });
                }

                // 4. ä¸€æ¬¡æ€§å¯«å…¥ DOM (é—œéµï¼)
                container.innerHTML = finalHtml;

                // 5. ç¶å®š SortableJS (å¯«å…¥å¾Œå†ç¶å®š)
                if (typeof Sortable !== 'undefined' && !isBatch) {
                    const sortableLists = container.querySelectorAll('.sortable-list');
                    sortableLists.forEach(listEl => {
                        const cat = listEl.getAttribute('data-category');
                        new Sortable(listEl, {
                            group: `cat-${cat}`, 
                            animation: 150, 
                            delay: 300, 
                            delayOnTouchOnly: true, 
                            touchStartThreshold: 5, 
                            ghostClass: 'sortable-ghost', 
                            chosenClass: 'sortable-drag',
                            onChoose: function() { triggerHaptic('MEDIUM'); },
                            onEnd: function (evt) { window.updateTodoOrder(cat, listEl); }
                        });
                    });
                }

                // 6. æ›´æ–° Dashboard (ä¿æŒä¸è®Š)
                if(dashboardList) {
                    if (pendingCount === 0) {
                        dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">æ²’æœ‰æœªå®Œæˆçš„å¾…è¾¦äº‹é … ğŸ‰</p>`;
                    } else {
                        dashboardList.innerHTML = '';
                        const pendings = dataToRender.filter(t => !t.done && (!t.category || window.todoCategoryVisibility[t.category] !== false)).slice(0, 3);
                        
                        if (pendings.length === 0 && pendingCount > 0) {
                            dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">å¾…è¾¦äº‹é …å·²éš±è—</p>`;
                        } else {
                            pendings.forEach(t => {
                                let dotColor = t.isJoint ? roleColors.joint : (t.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                                dashboardList.innerHTML += `
                                <div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-100 mb-1">
                                    <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${dotColor}"></div>
                                    <span class="truncate text-gray-700 flex-1">${t.title}</span>
                                    ${t.category ? `<span class="text-[9px] px-1 rounded bg-gray-200 text-gray-500">${t.category}</span>` : ''}
                                </div>`;
                            });
                            const remaining = dataToRender.filter(t => !t.done).length - pendings.length;
                            if (remaining > 0) dashboardList.innerHTML += `<div class="text-center text-xs text-gray-400 mt-1">é‚„æœ‰ ${remaining} å€‹é …ç›®...</div>`;
                        }
                    }
                }
                
                if (!isBatch) {
                    setTimeout(() => window.initSwipeListeners(container), 100);
                }
                if (typeof lucide !== 'undefined') lucide.createIcons();

            } catch (err) {
                console.error("Critical render error:", err);
                container.innerHTML = `<div class="p-4 text-center text-red-400 text-sm">åˆ—è¡¨è¼‰å…¥éŒ¯èª¤</div>`;
            }
        };

        // === æ–°å¢ï¼šåˆ†é¡æ”¶åˆåˆ‡æ›åŠŸèƒ½ ===
        window.toggleTodoCategory = function(cat) {
            // åˆ‡æ›ç‹€æ…‹
            const isCollapsed = window.collapsedCategories[cat];
            window.collapsedCategories[cat] = !isCollapsed;
            
            // å­˜å…¥ localStorage è¨˜ä½ä½¿ç”¨è€…çš„åå¥½
            localStorage.setItem('collapsed_categories', JSON.stringify(window.collapsedCategories));
            
            // ç›´æ¥æ“ä½œ DOM é¡¯ç¤º/éš±è—ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨ (æ•ˆèƒ½è¼ƒå¥½)
            const listEl = document.getElementById(`cat-list-${cat}`);
            const chevronEl = document.getElementById(`chevron-${cat}`);
            
            if (listEl && chevronEl) {
                if (!isCollapsed) { // è®Šç‚ºæ”¶åˆ
                    listEl.classList.add('hidden');
                    chevronEl.classList.remove('rotate-180');
                } else { // è®Šç‚ºå±•é–‹
                    listEl.classList.remove('hidden');
                    chevronEl.classList.add('rotate-180');
                }
            }
        };

        window.confirmDelete = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10); };
        window.closeConfirmModal = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('visible'); setTimeout(() => m.classList.add('hidden'), 200); };
        window.executeDelete = function() { 
            if(deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete().then(() => { window.closeConfirmModal(); window.closeAddModal(); window.showToast('è¡Œç¨‹å·²åˆªé™¤'); }).catch(e => { console.error(e); window.showToast('åˆªé™¤å¤±æ•—'); }); 
            } else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete().then(() => { window.closeConfirmModal(); window.closeAddTodoModal(); window.showToast('å¾…è¾¦å·²åˆªé™¤'); }).catch(e => { console.error(e); window.showToast('åˆªé™¤å¤±æ•—'); });
            } else if (deleteTarget === 'note' && noteToDelete) { // <--- ç¢ºèªé€™è£¡æ˜¯ noteToDelete
                window.deleteNote(noteToDelete); // å‘¼å«åˆªé™¤å‡½å¼
                window.closeConfirmModal();
            }
        };

        window.clearDate = function() {
            if (calTargetInput === 'todo') { document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; if (window.updateDateDisplay) window.updateDateDisplay('todo', ''); if (window.updateTimeDisplay) window.updateTimeDisplay('todo', ''); } 
            else { const el = document.getElementById(`input-date-${calTargetInput}`); if (el) el.value = ''; if (window.updateDateDisplay) window.updateDateDisplay(calTargetInput, ''); }
            window.closeCalendar();
        };

        // === ä¿®æ”¹å¾Œçš„ switchTabï¼šåŠ å…¥å°ç´…é»æ¶ˆé™¤é‚è¼¯ ===
        window.currentTab = 'dashboard'; // é è¨­åˆå§‹é é¢

        window.switchTab = function(tabId) {
            triggerHaptic('LIGHT');
            
            // æ›´æ–°ç›®å‰æ‰€åœ¨çš„é é¢è®Šæ•¸
            window.currentTab = tabId;

            // 1. éš±è—æ‰€æœ‰é é¢ & æ²å‹•æ­¸é›¶
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
                page.scrollTop = 0;
            });
            
            // 2. é¡¯ç¤ºç›®æ¨™é é¢
            const targetPage = document.getElementById(`page-${tabId}`);
            if(targetPage) {
                targetPage.classList.add('active');
                if(tabId === 'calendar' && typeof window.renderBigCalendar === 'function') window.renderBigCalendar();
                if (tabId === 'chat' && typeof window.scrollToBottom === 'function') window.scrollToBottom();
            }
            
            // 3. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.tab === tabId) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // === ğŸ”´ æ–°å¢ï¼šå¦‚æœåˆ‡æ›åˆ°èŠå¤©å®¤ï¼ŒæŠŠç´¯ç©çš„æœªè®€è¨Šæ¯ä¸€æ¬¡æ¨™è¨˜ç‚ºå·²è®€ ===
            if (tabId === 'chat' && window.unreadMsgIds && window.unreadMsgIds.length > 0) {
                const batch = db.batch();
                window.unreadMsgIds.forEach(id => {
                    const ref = db.collection('messages').doc(id);
                    batch.update(ref, { read: true });
                });
                batch.commit().then(() => {
                    console.log('Batch marked read');
                    // æ¸…é™¤ç´…é» UI
                    const badge = document.getElementById('chat-badge');
                    if(badge) badge.classList.add('hidden');
                    window.unreadMsgIds = [];
                });
            }
            // ========================================================

            if (navigator.vibrate) navigator.vibrate(5);
        };

        window.switchCalendarView = function(mode) {
            currentViewMode = mode;
            const vList = document.getElementById('calendar-view-list');
            const bList = document.getElementById('btn-view-list');
            const bMonth = document.getElementById('btn-view-month');
            const calendarViewMonthContainer = document.getElementById('calendar-view-month-container');
            
            if(mode === 'list') {
                vList.classList.remove('hidden');
                if(calendarViewMonthContainer) calendarViewMonthContainer.classList.add('hidden');
                bList.classList.add('bg-white','shadow-sm','text-theme','font-bold'); bList.classList.remove('text-gray-500','font-medium');
                bMonth.classList.remove('bg-white','shadow-sm','text-theme','font-bold'); bMonth.classList.add('text-gray-500','font-medium');
            } else {
                vList.classList.add('hidden');
                if(calendarViewMonthContainer) calendarViewMonthContainer.classList.remove('hidden');
                bMonth.classList.add('bg-white','shadow-sm','text-theme','font-bold'); bMonth.classList.remove('text-gray-500','font-medium');
                bList.classList.remove('bg-white','shadow-sm','text-theme','font-bold'); bList.classList.add('text-gray-500','font-medium');
                window.renderBigCalendar();
            }
        };

            window.changeBigCalMonth = function(delta) {
            // === é—œéµä¿®æ­£ï¼šå…ˆæŠŠæ—¥æœŸè¨­ç‚º 1 è™Ÿï¼Œé¿å…å¾ 31 è™Ÿåˆ‡æ›åˆ°çŸ­æœˆä»½æ™‚ç™¼ç”Ÿæº¢ä½è·³è™Ÿ ===
            bigCalDate.setDate(1); 
            
            bigCalDate.setMonth(bigCalDate.getMonth() + delta);
            window.renderBigCalendar();
        };
        
            window.selectBigCalendarDate = function(y, m, d, targetId = null, preventScroll = false) {
            // 0. è¨˜ä½ç•¶å‰é¸æ“‡ï¼Œæ–¹ä¾¿è³‡æ–™æ›´æ–°æ™‚åˆ·æ–°
            currentSelectedDate = { y, m, d };

            // 1. è¦–è¦ºé¸å–æ¨£å¼
            document.querySelectorAll('.big-cal-cell.selected').forEach(e => e.classList.remove('selected'));
            if (m === bigCalDate.getMonth()) {
                const el = document.getElementById(`big-cal-day-${d}`);
                if (el) el.classList.add('selected');
            }
            
            // 2. æ›´æ–°æ¨™é¡Œ
            const label = document.getElementById('selected-date-label');
            if (label) label.textContent = `${y}å¹´${m + 1}æœˆ${d}æ—¥`;
            
            // 3. æ¸²æŸ“ä¸‹æ–¹æ¸…å–® (å¼·åˆ¶å±•é–‹)
            const listEl = document.getElementById('month-event-list');
            if (listEl) {
                const items = window.getCalendarItems();
                const ds = new Date(y, m, d);
                const de = new Date(y, m, d, 23, 59, 59);
                
                const dayEvents = items.filter(e => {
                    const t = new Date(e.startDate || e.timestamp);
                    const startDay = new Date(t); startDay.setHours(0,0,0,0);
                    if (e.endDate || e.dueDateEnd) {
                        const endT = new Date(e.endDate || e.dueDateEnd); endT.setHours(23,59,59,999);
                        return ds <= endT && de >= startDay;
                    }
                    return t >= ds && t <= de;
                });

                if (dayEvents.length === 0) {
                    listEl.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">é€™å¤©æ²’æœ‰å®‰æ’è¡Œç¨‹ ğŸ˜´</div>`;
                } else {
                    // ç¬¬å››å€‹åƒæ•¸ true = éš±è—æœˆä»½æ¨™é¡Œ
                    window.renderEventListItems(dayEvents, listEl, true, true);
                }
            }

            // === 4. è§¸ç™¼æ²å‹•èˆ‡é«˜äº® ===
            // åªæœ‰åœ¨ preventScroll ç‚º false æ™‚æ‰åŸ·è¡Œæ²å‹• (é¿å…åˆªé™¤æ›´æ–°æ™‚ç•«é¢äº‚è·³)
            if (!preventScroll) {
                setTimeout(() => {
                    const scrollArea = document.getElementById('calendar-scroll-area');
                    const listHeader = document.getElementById('selected-date-label');
                    let didScrollHeader = false;

                    // --- å‹•ä½œ Aï¼šå„ªå…ˆç¢ºä¿æ¸…å–®æ¨™é¡Œæ»‘ä¸Šä¾† ---
                    if (scrollArea && listHeader) {
                        const headerRect = listHeader.getBoundingClientRect();
                        const containerRect = scrollArea.getBoundingClientRect();
                        
                        if (headerRect.top > containerRect.bottom - 250) { 
                             listHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                             didScrollHeader = true; 
                        }
                    }

                    // --- å‹•ä½œ Bï¼šå¦‚æœæœ‰æŒ‡å®šè¡Œç¨‹ï¼Œé€²è¡Œé«˜äº® ---
                    if (targetId) {
                        const targetEl = document.getElementById(`list-item-${targetId}`);
                        if (targetEl) {
                            if (!didScrollHeader) {
                                 targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            targetEl.classList.remove('bg-yellow-100', 'transition-colors', 'duration-1000');
                            void targetEl.offsetWidth; 
                            targetEl.classList.add('bg-yellow-100', 'transition-colors', 'duration-1000');
                            setTimeout(() => targetEl.classList.remove('bg-yellow-100'), 1500);
                        }
                    }
                }, 150); 
            }
        };
        
        // === ç¢ºä¿æ­¤å‡½å¼å­˜åœ¨ ===
        window.handleBigCalDbClick = function(y, m, d) {
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            
            // å…ˆé¸ä¸­è©²æ—¥æœŸ (è¦–è¦ºå›é¥‹)
            window.selectBigCalendarDate(y, m, d);
            
            // æ‰“é–‹æ–°å¢è¦–çª— (å› ç‚ºæˆ‘å€‘æ”¹éäº† openAddModalï¼Œå®ƒæœƒè‡ªå‹•è®€å–æˆ‘å€‘å‰›å‰›é¸ä¸­çš„æ—¥æœŸ)
            window.openAddModal();
        };

        let touchStartX = 0; let touchStartY = 0;
        // === å„ªåŒ–ç‰ˆï¼šæœˆæ›†æ»‘å‹•åˆ‡æ› (é˜²æ‰‹éœ‡é–å®š) ===
window.initSwipe = function() {
    const el = document.getElementById('calendar-scroll-area');
    if(!el) return;
    
    let startX = 0;
    let startY = 0;

    // 1. æ‰‹æŒ‡æŒ‰ä¸‹
    el.addEventListener('touchstart', e => { 
        startX = e.touches[0].clientX; 
        startY = e.touches[0].clientY; 
    }, {passive: true});

    // 2. æ‰‹æŒ‡ç§»å‹• (é—œéµæ–°å¢ï¼)
    el.addEventListener('touchmove', e => {
        if (currentViewMode !== 'month') return;
        
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;

        // åˆ¤æ–·ï¼šå¦‚æœæ˜¯æ˜é¡¯çš„æ°´å¹³æ»‘å‹• (Xè»¸ä½ç§» > Yè»¸ä½ç§»)
        if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
            // ğŸ›‘ é–å®šå‚ç›´æ²å‹•ï¼è®“ç•«é¢ä¸æœƒä¸Šä¸‹äº‚è·‘
            if (e.cancelable) e.preventDefault();
        }
    }, {passive: false}); // <--- æ³¨æ„ï¼šé€™è£¡å¿…é ˆæ˜¯ false

    // 3. æ‰‹æŒ‡æ”¾é–‹ (è§¸ç™¼åˆ‡æ›)
    el.addEventListener('touchend', e => {
        if (currentViewMode !== 'month') return;
        
        const endX = e.changedTouches[0].clientX; 
        const endY = e.changedTouches[0].clientY;
        
        // è¨ˆç®—ä½ç§»ï¼šèµ·é» - çµ‚é»
        const diffX = startX - endX; 
        const diffY = startY - endY;
        
        // è§¸ç™¼æ¢ä»¶ï¼šæ°´å¹³æ»‘å‹•å¤§æ–¼ 50px ä¸” æ°´å¹³ > å‚ç›´
        if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if(diffX > 0) window.changeBigCalMonth(1); // å¾€å·¦æ»‘ -> ä¸‹å€‹æœˆ
            else window.changeBigCalMonth(-1);         // å¾€å³æ»‘ -> ä¸Šå€‹æœˆ
        }
    }, {passive: true});
};

            // === æ–°å¢ï¼šä¸€éµå›åˆ°ä»Šå¤© ===
        window.jumpToToday = function() {
            const now = new Date();
            
            // 1. æ›´æ–°å…¨åŸŸè®Šæ•¸ bigCalDate ç‚ºä»Šå¤©
            bigCalDate = new Date(now);
            
            // 2. é‡ç•«æœˆæ›†æ ¼å­ (æœƒè‡ªå‹•åˆ‡æ›åˆ°æœ¬æœˆ)
            window.renderBigCalendar();
            
            // 3. é¸å–ä»Šå¤©çš„æ—¥æœŸ (é€™æœƒè§¸ç™¼ä¸‹æ–¹æ¸…å–®æ›´æ–° + è‡ªå‹•æ²å‹•)
            window.selectBigCalendarDate(
                now.getFullYear(), 
                now.getMonth(), 
                now.getDate()
            );
            
            // 4. çµ¦ä¸€é»éœ‡å‹•å›é¥‹ (å¦‚æœè£ç½®æ”¯æ´)
            if (navigator.vibrate) navigator.vibrate(5);
        };

            window.renderBigCalendar = function() {
            const y = bigCalDate.getFullYear();
            const m = bigCalDate.getMonth();
            const title = document.getElementById('big-cal-title');
            if(title) title.textContent = `${y}å¹´${m+1}æœˆ`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            
            // 0. æº–å‚™è³‡æ–™
            const items = window.getCalendarItems ? window.getCalendarItems() : [];
            const monthStart = new Date(y, m, 1);
            const monthEnd = new Date(y, m, daysInMonth, 23, 59, 59);

            // 1. ç¯©é¸å‡ºæœ¬æœˆç›¸é—œè¡Œç¨‹
            const allVisibleEvents = items.filter(e => {
                const s = new Date(e.startDate || e.timestamp);
                const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                const end = new Date(endStr); end.setHours(23,59,59);
                return end >= monthStart && s <= monthEnd;
            });

            // === é‡é»ï¼šå°‡è¡Œç¨‹æ‹†åˆ† ===
            // ä¼‘å‡è¡Œç¨‹ (å¦å¤–è™•ç†ï¼Œä¸åƒèˆ‡ä¸€èˆ¬æ’ç‰ˆ)
            const leaveEvents = allVisibleEvents.filter(e => window.isLeaveEvent(e.title));
            // ä¸€èˆ¬è¡Œç¨‹ (è¦ç•«æˆæ¢ç‹€çš„)
            const barEvents = allVisibleEvents.filter(e => !window.isLeaveEvent(e.title));

            // 2. å°ä¸€èˆ¬è¡Œç¨‹é€²è¡Œæ’åºèˆ‡è»Œé“åˆ†é… (Tetris æ¼”ç®—æ³•)
            barEvents.sort((a, b) => {
                const getDuration = (evt) => {
                    const s = new Date(evt.startDate || evt.timestamp);
                    const eStr = evt.endDate || evt.dueDateEnd || (evt.startDate || evt.dueDate);
                    const e = new Date(eStr);
                    return (e - s);
                };
                const durA = getDuration(a);
                const durB = getDuration(b);
                if (Math.abs(durA - durB) > 86400000) return durB - durA; 
                return new Date(a.timestamp) - new Date(b.timestamp);
            });

            const slots = {}; 
            const eventTrack = {}; 

            barEvents.forEach(e => {
                const s = new Date(e.startDate || e.timestamp); s.setHours(0,0,0,0);
                const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                const end = new Date(endStr); end.setHours(0,0,0,0);

                const coveredKeys = [];
                let loopDate = new Date(s);
                while(loopDate <= end) {
                    if (loopDate.getMonth() === m) {
                        coveredKeys.push(`${loopDate.getDate()}`);
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }
                if (coveredKeys.length === 0) return;

                let track = 0;
                while (true) {
                    let isTrackFree = true;
                    for (const key of coveredKeys) {
                        if (!slots[key]) slots[key] = [];
                        if (slots[key][track]) {
                            isTrackFree = false;
                            break;
                        }
                    }
                    if (isTrackFree) {
                        for (const key of coveredKeys) {
                            slots[key][track] = true;
                        }
                        eventTrack[e.id] = track;
                        break;
                    }
                    track++;
                }
            });

            // 3. é–‹å§‹æ¸²æŸ“æ ¼å­
            let html = '';
            for(let i=0; i<firstDay; i++) {
                html += `<div class="big-cal-cell bg-gray-50/30"></div>`;
            }

            for(let d=1; d<=daysInMonth; d++) {
                const current = new Date(y, m, d);
                const nowStr = new Date().toDateString();
                const isToday = current.toDateString() === nowStr;
                
                // --- A. è™•ç†ä¼‘å‡æ¨™ç±¤ (æ”¾åœ¨æœ€ä¸Šé¢) ---
                const todaysLeaves = leaveEvents.filter(e => {
                    const s = new Date(e.startDate || e.timestamp); s.setHours(0,0,0,0);
                    const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                    const end = new Date(endStr); end.setHours(0,0,0,0);
                    return current >= s && current <= end;
                });

                // æª¢æŸ¥ç•¶å¤©æœ‰èª°ä¼‘å‡
                let hasHaohaoLeave = false;
                let hasMaomaoLeave = false;
                // ç‚ºäº†ç¶å®šé»æ“Šäº‹ä»¶ï¼Œæˆ‘å€‘éœ€è¦ç´€éŒ„ ID
                let haohaoLeaveId = '';
                let maomaoLeaveId = '';

                todaysLeaves.forEach(e => {
                    if (e.creator === 'haohao' || e.isJoint) { hasHaohaoLeave = true; haohaoLeaveId = e.id; }
                    if (e.creator === 'maomao' || e.isJoint) { hasMaomaoLeave = true; maomaoLeaveId = e.id; }
                });

                let leaveHtml = '';
                if (hasHaohaoLeave || hasMaomaoLeave) {
                    leaveHtml += `<div class="leave-row">`;
                    if (hasHaohaoLeave) {
                        leaveHtml += `<span class="leave-chip" style="background-color:${roleColors.haohao}" onclick="event.stopPropagation(); window.selectBigCalendarDate(${y},${m},${d}, '${haohaoLeaveId}')">ä¼‘</span>`;
                    }
                    if (hasMaomaoLeave) {
                        leaveHtml += `<span class="leave-chip" style="background-color:${roleColors.maomao}" onclick="event.stopPropagation(); window.selectBigCalendarDate(${y},${m},${d}, '${maomaoLeaveId}')">ä¼‘</span>`;
                    }
                    leaveHtml += `</div>`;
                }

                // --- B. è™•ç†ä¸€èˆ¬è¡Œç¨‹æ¢ ---
                const dayBarEvents = barEvents.filter(e => {
                    const s = new Date(e.startDate || e.timestamp); s.setHours(0,0,0,0);
                    const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                    const end = new Date(endStr); end.setHours(0,0,0,0);
                    return current >= s && current <= end;
                });

                const MAX_VISIBLE_TRACKS = 4; // æœ€å¤šé¡¯ç¤ºå¹¾è¡Œä¸€èˆ¬è¡Œç¨‹
                let bars = '';
                let maxTrackUsed = -1;
                dayBarEvents.forEach(e => { if (eventTrack[e.id] > maxTrackUsed) maxTrackUsed = eventTrack[e.id]; });
                
                // å¦‚æœæœ‰ä¼‘å‡ï¼Œé¡¯ç¤ºç©ºé–“æœƒè¢«å£“ç¸®ä¸€é»ï¼Œä½†æˆ‘å€‘è®“å®ƒè‡ªç„¶å¾€ä¸‹æ“ 
                const renderLimit = Math.min(maxTrackUsed, MAX_VISIBLE_TRACKS - 1);
                
                for (let t = 0; t <= renderLimit; t++) {
                    const evt = dayBarEvents.find(e => eventTrack[e.id] === t);
                    if (evt) {
                        let bg;
                        if (evt.isJoint) bg = roleColors.joint;
                        else bg = (evt.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                        
                        const s = new Date(evt.startDate || evt.timestamp); s.setHours(0,0,0,0);
                        const endStr = evt.endDate || evt.dueDateEnd || (evt.startDate || evt.dueDate);
                        const end = new Date(endStr); end.setHours(0,0,0,0);
                        
                        const isStart = current.getTime() === s.getTime();
                        const isEnd = current.getTime() === end.getTime();
                        const isSingle = isStart && isEnd;
                        const showLabel = isStart || isSingle || (d === 1);

                        let styleAttr = `background-color:${bg};`;
                        let content = evt.title;
                        let shapeClass = 'rounded-[3px] mx-[2px] relative z-0'; 

                        if (!isSingle) {
                            if (isStart) {
                                shapeClass = 'rounded-l-[3px] rounded-r-none mr-[-3px] pr-2 relative z-10 ml-[2px]'; 
                            } else if (isEnd) {
                                shapeClass = 'rounded-l-none rounded-r-[3px] ml-[-3px] pl-2 relative z-10 mr-[2px]';
                                if (!showLabel) content = '&nbsp;'; 
                            } else {
                                shapeClass = 'rounded-none mx-[-3px] relative z-10';
                                if (!showLabel) content = '&nbsp;'; 
                            }
                        }
                        bars += `<div class="event-bar ${evt.isTodo&&evt.done?'done':''} ${shapeClass}" style="${styleAttr}" onclick="event.stopPropagation(); window.selectBigCalendarDate(${y},${m},${d}, '${evt.id}')">${content}</div>`;
                    } else {
                        bars += `<div class="event-bar invisible"></div>`;
                    }
                }

                let moreHtml = '';
                const hiddenEvents = dayBarEvents.filter(e => eventTrack[e.id] >= MAX_VISIBLE_TRACKS);
                if(hiddenEvents.length > 0) {
                    moreHtml = `<div class="more-events">${hiddenEvents.length} more</div>`;
                }

                // è¾²æ›†èˆ‡å‡æ—¥
                const { lunar, holiday } = window.getLunarAndHoliday(current);
                let extraInfoHtml = '';
                let dayNumStyle = '';
                if (holiday) {
                    extraInfoHtml = `<span class="big-cal-holiday">${holiday}</span>`;
                    dayNumStyle = 'style="color: #ef4444;"';
                } else {
                    extraInfoHtml = `<span class="big-cal-lunar">${lunar}</span>`;
                }

                // çµ„åˆ HTML
                // ä½ çš„ç¨‹å¼ç¢¼æ‡‰è©²é•·é€™æ¨£ (æª¢æŸ¥ ondblclick æœ‰æ²’æœ‰åœ¨è£¡é¢)
                html += `<div class="big-cal-cell ${isToday?'today':''}" id="big-cal-day-${d}" onclick="window.selectBigCalendarDate(${y},${m},${d})" ondblclick="window.handleBigCalDbClick(${y},${m},${d})">
                    <div class="big-cal-day-header">
                        <span class="big-cal-day-num" ${dayNumStyle}>${d}</span>
                        ${extraInfoHtml}
                    </div>
                    
                    <div class="big-cal-content-wrapper">
                        ${leaveHtml}
                        
                        ${bars}
                        ${moreHtml}
                    </div>
                </div>`;
            }
            
            const grid = document.getElementById('big-cal-grid');
            if(grid) grid.innerHTML = html;
        };

// === è¡Œç¨‹æé†’æª¢æŸ¥æ ¸å¿ƒ ===
        window.checkEventReminders = function() {
            // å¦‚æœæ²’æœ‰é–‹é€šçŸ¥æ¬Šé™ï¼Œå°±ä¸æª¢æŸ¥äº†
            if (Notification.permission !== "granted") return;

            const now = new Date();
            // ç‚ºäº†é¿å…ç§’æ•¸å·®ç•°å°è‡´éŒ¯éï¼Œæˆ‘å€‘åªæ¯”å°ã€Œå¹´-æœˆ-æ—¥ æ™‚:åˆ†ã€
            const currentMinuteStr = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
            
            // é¿å…åŒä¸€åˆ†é˜é‡è¤‡è·³é€šçŸ¥
            if (window._lastRemindTime === currentMinuteStr) return;
            window._lastRemindTime = currentMinuteStr;

            // æª¢æŸ¥æ‰€æœ‰å¿«å–ä¸­çš„è¡Œç¨‹
            if (!window.allEventsCache) return;

            window.allEventsCache.forEach(evt => {
                // 1. å¦‚æœè¨­å®šç‚ºã€Œä¸é€šçŸ¥ã€æˆ–ã€Œå·²å®Œæˆ(å¾…è¾¦)ã€ï¼Œè·³é
                if (!evt.remind || evt.remind === '0' || evt.remind === 0) return;
                
                // 2. è¨ˆç®—è¡Œç¨‹é–‹å§‹æ™‚é–“
                const startStr = `${evt.startDate}T${evt.endTime ? evt.endTime.split('T')[0] : (evt.timestamp ? evt.timestamp.split('T')[1].substring(0,5) : '00:00')}`;
                
                // é€™è£¡è¦å¾ˆå°å¿ƒè™•ç†æ™‚é–“æ ¼å¼ï¼Œæˆ‘å€‘çµ±ä¸€ç”¨ timestamp ä¾†ç®—
                let eventTime = new Date(evt.timestamp);
                
                // å¦‚æœæ˜¯å…¨å¤©è¡Œç¨‹ï¼Œé€šå¸¸é è¨­æ˜¯ 00:00ï¼Œæˆ‘å€‘å‡è¨­å…¨å¤©è¡Œç¨‹çš„æé†’åŸºæº–æ˜¯ç•¶å¤©æ—©ä¸Š 09:00
                if (evt.allDay) {
                    eventTime = new Date(evt.startDate);
                    eventTime.setHours(9, 0, 0, 0);
                }

                // 3. è¨ˆç®—ã€Œæ‡‰è©²è·³é€šçŸ¥çš„æ™‚é–“ã€
                let notifyTime = new Date(eventTime);
                if (evt.remind === 'on_time') {
                    // æº–æ™‚
                } else {
                    // æ‰£æ‰åˆ†é˜æ•¸
                    notifyTime.setMinutes(notifyTime.getMinutes() - parseInt(evt.remind));
                }

                // 4. æ¯”å°æ™‚é–“ï¼šå¦‚æœã€Œç¾åœ¨æ™‚é–“ã€ç­‰æ–¼ã€Œæ‡‰è©²é€šçŸ¥çš„æ™‚é–“ã€(èª¤å·®åœ¨1åˆ†é˜å…§)
                const notifyStr = `${notifyTime.getFullYear()}-${notifyTime.getMonth()}-${notifyTime.getDate()} ${notifyTime.getHours()}:${notifyTime.getMinutes()}`;

                if (currentMinuteStr === notifyStr) {
                    // è§¸ç™¼é€šçŸ¥ï¼
                    const titlePrefix = evt.remind === 'on_time' ? 'ç¾åœ¨ï¼š' : `${evt.remind >= 60 ? evt.remind/60+'å°æ™‚' : evt.remind+'åˆ†é˜'}å¾Œï¼š`;
                    const bodyText = `${evt.title} ${evt.location ? '@ ' + evt.location : ''}`;
                    
                    try {
                        // æ’­æ”¾ä¸€é»è²éŸ³ (å¦‚æœç€è¦½å™¨å…è¨±)
                        // window.navigator.vibrate([200, 100, 200]); 
                        
                        new Notification(titlePrefix + " " + evt.title, {
                            body: evt.startDate + (evt.allDay ? '' : ' ' + (evt.endTime || '')),
                            icon: 'icon.png',
                            tag: `event-${evt.id}` // é¿å…é‡è¤‡
                        });
                    } catch (e) {
                        console.error("Notification trigger failed", e);
                    }
                }
            });
        };

function initApp(db) {
            if (!db) { console.error("Firebase not initialized"); return; }
            
            // é€£ç·šç‹€æ…‹ç‡ˆè™Ÿ
            const conn = document.getElementById('connection-status'); 
            if (conn) { conn.className = "w-2 h-2 rounded-full bg-ttgreen shadow-[0_0_8px_#2cc998]"; }
            
            // === ğŸš€ æ–°å¢ï¼šæ¨æ’­é€šçŸ¥è¨»å†Šé‚è¼¯ ===
            if (window.Capacitor && Capacitor.Plugins.PushNotifications) {
                const { PushNotifications } = Capacitor.Plugins;

                // 1. è«‹æ±‚æ¬Šé™
                PushNotifications.requestPermissions().then(result => {
                    if (result.receive === 'granted') {
                        PushNotifications.register();
                    }
                });

                // 2. è¨»å†ŠæˆåŠŸï¼Œæ‹¿åˆ° Token (é€™æ˜¯æ‰‹æ©Ÿçš„åœ°å€)
                PushNotifications.addListener('registration', (token) => {
                    console.log('Push Token:', token.value);
                    
                    // æŠŠ Token å­˜åˆ° Firestore çš„ user_tokens é›†åˆ
                    // æˆ‘å€‘ç”¨ currentUserRole (haohao/maomao) ç•¶ä½œæ–‡ä»¶ ID
                    if (currentUserRole) {
                        db.collection('user_tokens').doc(currentUserRole).set({
                            token: token.value,
                            platform: 'ios',
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                    }
                });

                // 3. è¨»å†Šå¤±æ•—
                PushNotifications.addListener('registrationError', (error) => {
                    console.error('Error on registration: ' + JSON.stringify(error));
                });

                // 4. æ”¶åˆ°é€šçŸ¥ (App åœ¨å‰æ™¯æ™‚)
                PushNotifications.addListener('pushNotificationReceived', (notification) => {
                    window.showToast(`ğŸ”” ${notification.title}: ${notification.body}`);
                    // é€™è£¡å¯ä»¥åŠ å…¥éœ‡å‹•
                    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                });

                // 5. é»æ“Šé€šçŸ¥ (App è¢«é»é–‹æ™‚)
                PushNotifications.addListener('pushNotificationActionPerformed', (notification) => {
                    // å¦‚æœæ˜¯èŠå¤©é€šçŸ¥ï¼Œåˆ‡æ›åˆ°èŠå¤©é é¢
                    window.switchTab('chat');
                });
            }

            // === éµç›¤è¡Œç‚ºç›£è½ ===
            if (window.Capacitor && Capacitor.Plugins.Keyboard) {
                const { Keyboard } = Capacitor.Plugins;

                // 1. éš±è—éµç›¤è¼”åŠ©åˆ— (ç¶­æŒåŸæœ¬çš„)
                try { Keyboard.setAccessoryBarVisible({ isVisible: false }); } catch(e){}

                // 2. éµç›¤ã€Œå³å°‡ã€å½ˆå‡º (åŒæ­¥åŸ·è¡Œ)
                Keyboard.addListener('keyboardWillShow', info => {
                    document.body.classList.add('keyboard-open');
                    window.scrollToBottom('auto'); 
                });

                // 2. éµç›¤ã€Œå³å°‡ã€æ”¶èµ·
                Keyboard.addListener('keyboardWillHide', () => {
                    document.body.classList.remove('keyboard-open');
                });
            }

            // === æ–°å¢ï¼šé»æ“Šç©ºç™½è™•æ”¶èµ·éµç›¤ (LINE é«”é©—) ===
            window.dismissKeyboard = async function() {
                // å¦‚æœæ˜¯åœ¨é›»è…¦ç€è¦½å™¨æ¸¬è©¦ï¼Œä¸éœ€è¦é€™è¡Œ
                if (window.Capacitor) {
                    await Capacitor.Plugins.Keyboard.hide();
                }
            };

            // 1. è¡Œç¨‹ (Events) ç›£è½
            bindSnapshot(db.collection('events').orderBy('timestamp', 'asc'), (snapshot) => {
              const events = []; snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
              allEventsCache = events;
              safeRun(() => window.renderDashboardNextUp(window.getCalendarItems()), 'dashboard-events');
              safeRun(() => window.renderCalendarListView(), 'calendar-list');
              
              if (currentViewMode === 'month') { 
                  safeRun(() => window.renderBigCalendar(), 'big-calendar');
                  if (currentSelectedDate && currentSelectedDate.y === bigCalDate.getFullYear() && currentSelectedDate.m === bigCalDate.getMonth()) {
                      window.selectBigCalendarDate(currentSelectedDate.y, currentSelectedDate.m, currentSelectedDate.d, null, true);
                  }
              }
            }, 'events');

            // 2. å¾…è¾¦ (Todos) ç›£è½
            bindSnapshot(db.collection('todos').orderBy('createdAt', 'desc'), (snapshot) => {
              const todos = []; snapshot.forEach(doc => todos.push({ id: doc.id, ...doc.data() }));
              allTodosCache = todos;
              safeRun(() => window.renderTodos(todos), 'todos');
              safeRun(() => window.renderDashboardNextUp(window.getCalendarItems()), 'dashboard-todos');
              safeRun(() => window.renderCalendarListView(), 'calendar-list-from-todos');
              
              if (currentViewMode === 'month') { 
                  safeRun(() => window.renderBigCalendar(), 'big-calendar-from-todos');
                  if (currentSelectedDate && currentSelectedDate.y === bigCalDate.getFullYear() && currentSelectedDate.m === bigCalDate.getMonth()) {
                      window.selectBigCalendarDate(currentSelectedDate.y, currentSelectedDate.m, currentSelectedDate.d, null, true);
                  }
              }
            }, 'todos');
            
            // 3. èŠå¤©å®¤ (Chat) ç›£è½ (åŒ…å«é€šçŸ¥èˆ‡å°ç´…é»)
            let isFirstChatLoad = true; 
            window.unreadMsgIds = []; // ç”¨ä¾†æš«å­˜æœªè®€è¨Šæ¯çš„ ID

            bindSnapshot(db.collection('messages').orderBy('timestamp', 'desc').limit(50), (snapshot) => {
                const msgs = [];
                const now = new Date();
                const expirationMs = 24 * 60 * 60 * 1000;
                
                // é‡ç½®æœªè®€è¨ˆæ•¸
                let unreadCount = 0;
                window.unreadMsgIds = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const msgTime = new Date(data.timestamp);
                    
                    if ((now - msgTime) > expirationMs) {
                        db.collection('messages').doc(doc.id).delete().catch(e => {});
                    } else {
                        msgs.push({ id: doc.id, ...data });

                        // === ğŸ”´ å°ç´…é»æ ¸å¿ƒé‚è¼¯ ===
                        // å¦‚æœæ˜¯åˆ¥äººçš„è¨Šæ¯ï¼Œä¸”é‚„æ²’å·²è®€
                        if (data.creator && currentUserRole && data.creator !== currentUserRole && !data.read) {
                            
                            // æƒ…æ³ A: æˆ‘ç¾åœ¨å°±åœ¨èŠå¤©å®¤ -> é¦¬ä¸Šæ¨™è¨˜å·²è®€ (ä¸é¡¯ç¤ºç´…é»)
                            if (window.currentTab === 'chat') {
                                db.collection('messages').doc(doc.id).update({ read: true });
                            } 
                            // æƒ…æ³ B: æˆ‘åœ¨çœ‹è¡Œäº‹æ›†æˆ–å¾…è¾¦ -> è¨˜ä¸‹ä¾†ï¼Œé¡¯ç¤ºç´…é»
                            else {
                                unreadCount++;
                                window.unreadMsgIds.push(doc.id);
                            }
                        }
                    }
                });

                // æ›´æ–° UI ä¸Šçš„å°ç´…é»
                const badge = document.getElementById('chat-badge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                // === C. é€šçŸ¥é‚è¼¯ (ç¶­æŒä¸è®Š) ===
                if (!isFirstChatLoad && snapshot.docChanges) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newData = change.doc.data();
                            if (newData.creator !== currentUserRole) {
                                const senderName = newData.creator === 'haohao' ? 'çš“çš“' : 'æ¯›æ¯›';
                                if ('Notification' in window && Notification.permission === "granted") {
                                    try {
                                        new Notification(`ä¾†è‡ª ${senderName} çš„è¨Šæ¯`, {
                                            body: newData.text,
                                            icon: 'icon.png',
                                            tag: 'chat-msg'
                                        });
                                    } catch (e) { console.log(e); }
                                }
                            }
                        }
                    });
                }
                
                isFirstChatLoad = false;
                window.renderChat(msgs.reverse());
            }, 'chat');

            // 4. ç‹€æ…‹ (Status) ç›£è½
            bindSnapshot(db.collection('status').doc('current'), (doc) => { 
                if (doc.exists) safeRun(() => window.renderStatus?.(doc.data()), 'status'); 
            }, 'status');
            setInterval(() => {
                window.checkEventReminders();
            }, 30000);
        }

        document.addEventListener('DOMContentLoaded', () => {
          safeRun(() => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            window.updateRoleUI();
            window.updateSettingsColorUI();
            
            // === åŠ å…¥é€™è¡Œ ===
            window.renderDailyBrief(); 
            // ===============

            if (!currentUserRole) { window.switchTab('settings'); setTimeout(() => window.showToast('æ­¡è¿ï¼è«‹å…ˆé¸æ“‡æ‚¨çš„èº«åˆ† ğŸ‘‹'), 500); } 
            else { document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]); }
            if (db) initApp(db);
            window.initSwipe();
          }, 'bootstrap');
        });

        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
          window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered', reg)).catch(err => console.error('SW failed', err)); });
        }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) { safeRun(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); if (currentViewMode === 'month') { window.renderBigCalendar(); } }, 'resume'); } });
    
        // === å¾…è¾¦åˆ†é¡åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ ===

        // 1. å®šç¾©é è¨­åˆ†é¡
        const defaultCategories = [
            { name: 'ç”Ÿæ´»', color: '#e0f2fe', text: '#0284c7' }, // è—
            { name: 'è³¼ç‰©', color: '#fef3c7', text: '#d97706' }, // é»ƒ
            { name: 'å·¥ä½œ', color: '#f3f4f6', text: '#4b5563' }, // ç°
            { name: 'è²¡å‹™', color: '#dcfce7', text: '#16a34a' }, // ç¶ 
            { name: 'é‡è¦', color: '#fee2e2', text: '#dc2626' }, // ç´…
            { name: 'Debug', color: '#f3e8ff', text: '#7e22ce' }, // ç´«
            { name: 'Party', color: '#fce7f3', text: '#be185d' }  // ç²‰
        ];

        // è®€å–ä½¿ç”¨è€…çš„è‡ªè¨‚åˆ†é¡
        let customCategories = JSON.parse(localStorage.getItem('my_custom_categories') || '[]');

        // æ¸²æŸ“æ¨™ç±¤å‡½å¼
        window.renderCategoryChips = function(selectedVal = '') {
            const container = document.getElementById('todo-category-chips');
            if(!container) return;
            
            container.innerHTML = '';
            
            // åˆä½µé è¨­èˆ‡è‡ªè¨‚åˆ†é¡
            const allCats = [...defaultCategories];
            customCategories.forEach(c => {
                // é¿å…é‡è¤‡
                if(!allCats.find(def => def.name === c)) {
                    allCats.push({ name: c, color: '#f3f4f6', text: '#4b5563' });
                }
            });

            // ç”¢ç”Ÿ HTML
            allCats.forEach(cat => {
                const isActive = cat.name === selectedVal;
                const el = document.createElement('div');
                el.className = `category-chip ${isActive ? 'active' : ''}`;
                el.textContent = cat.name;
                el.onclick = () => window.selectTodoCategory(cat.name);
                container.appendChild(el);
            });
        };

        // é»é¸æ¨™ç±¤
        window.selectTodoCategory = function(name) {
            const current = document.getElementById('todo-input-category').value;
            // å¦‚æœé»é¸å·²é¸å–çš„ï¼Œå‰‡å–æ¶ˆé¸å–
            if (current === name) {
                document.getElementById('todo-input-category').value = '';
            } else {
                document.getElementById('todo-input-category').value = name;
            }
            window.renderCategoryChips(document.getElementById('todo-input-category').value);
        };

        // åˆ‡æ›è‡ªè¨‚è¼¸å…¥æ¡†
        window.toggleCustomCategoryInput = function() {
            const el = document.getElementById('todo-custom-category-container');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) {
                document.getElementById('todo-input-category-custom').focus();
            }
        };

        // è¦†å¯«ï¼šé–‹å•Ÿæ–°å¢è¦–çª— (åˆå§‹åŒ–åˆ†é¡)
        const originalOpenAddTodoModal = window.openAddTodoModal;
        window.openAddTodoModal = function() {
            originalOpenAddTodoModal(); // åŸ·è¡ŒåŸæœ¬çš„é–‹å•Ÿé‚è¼¯
            
            // é‡ç½®åˆ†é¡ç‹€æ…‹
            document.getElementById('todo-input-category').value = '';
            document.getElementById('todo-input-category-custom').value = '';
            document.getElementById('todo-custom-category-container').classList.add('hidden');
            window.renderCategoryChips();
        };

        // è¦†å¯«ï¼šé–‹å•Ÿç·¨è¼¯è¦–çª— (è¼‰å…¥èˆŠåˆ†é¡)
        const originalOpenEditTodoModal = window.openEditTodoModal;
        window.openEditTodoModal = function(id) {
            originalOpenEditTodoModal(id);
            
            const todo = allTodosCache.find(t => t.id === id);
            if(todo) {
                const cat = todo.category || '';
                document.getElementById('todo-input-category').value = cat;
                window.renderCategoryChips(cat);
            }
        };
    
        // === ä¿®æ”¹ç‰ˆï¼šæ”¯æ´è²¼åœ–é¡¯ç¤º ===
        window.renderChat = function(messages) {
            const container = document.getElementById('chat-container');
            if(!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs opacity-60"><i data-lucide="message-square" class="w-8 h-8 mb-2"></i><p>é‚„æ²’æœ‰è¨Šæ¯ï¼Œå¿«å‚³é€ç¬¬ä¸€å‰‡ï¼</p></div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            let html = '';
            
            messages.forEach(msg => {
                const isMe = msg.creator === currentUserRole;
                const bubbleColor = roleColors[msg.creator] || '#9ca3af';
                
                // === åˆ¤æ–·å…§å®¹æ˜¯æ–‡å­—é‚„æ˜¯è²¼åœ– ===
                let contentHtml = '';
                // å¦‚æœæ˜¯è²¼åœ–é¡å‹
                if (msg.type === 'sticker') {
                    // è²¼åœ–èƒŒæ™¯è¨­ç‚ºé€æ˜ï¼Œä¸ä½¿ç”¨æ°£æ³¡é¡è‰²
                    contentHtml = `<img src="${msg.text}" class="chat-sticker" onclick="window.confirmDeleteMsg('${msg.id}')">`;
                } else {
                    // ä¸€èˆ¬æ–‡å­— (ç¶­æŒåŸæœ¬æ¨£å¼)
                    const bubbleStyle = `background-color: ${bubbleColor}; color: white;`;
                    contentHtml = `<div class="chat-bubble shadow-md" style="${bubbleStyle}" onclick="window.confirmDeleteMsg('${msg.id}')">
                                        ${msg.text}
                                   </div>`;
                }
                // ==========================

                const avatarChar = msg.creator === 'haohao' ? 'çš“' : 'æ¯›';
                const displayName = msg.creator === 'haohao' ? 'çš“çš“' : 'æ¯›æ¯›';
                
                const date = new Date(msg.timestamp);
                const timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                const readHtml = (isMe && msg.read) ? `<span class="chat-read">å·²è®€</span>` : '';

                if (isMe) {
                    // === å³å´ (è‡ªå·±) ===
                    html += `
                    <div class="chat-row right">
                        <div class="chat-info-col">
                            ${readHtml}
                            <span class="chat-time">${timeStr}</span>
                        </div>
                        ${contentHtml}
                    </div>`;
                } else {
                    // === å·¦å´ (å°æ–¹) ===
                    html += `
                    <div class="chat-row left">
                        <div class="chat-avatar self-start" style="background-color: ${bubbleColor}">${avatarChar}</div>
                        
                        <div class="flex flex-col items-start ml-2 max-w-[88%]">
                            <span class="text-[10px] text-gray-400 mb-0.5 ml-0.5 font-medium">${displayName}</span>
                            
                            <div class="flex items-end">
                                ${contentHtml}
                                <div class="chat-info-col">
                                    <span class="chat-time">${timeStr}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
            });

            container.innerHTML = html;
            window.scrollToBottom();
        };

        // === å„ªåŒ–ç‰ˆï¼šæ²å‹•åˆ°åº•éƒ¨ (ä¿®æ­£éµç›¤å»¶é²å•é¡Œ) ===
        window.scrollToBottom = function(behavior = 'smooth') {
            const container = document.getElementById('chat-container');
            if(container) {
                // å¦‚æœæ˜¯ç¬é–“è·³è½‰ (auto)ï¼Œä¸è¦å»¶é²ï¼Œç›´æ¥åŸ·è¡Œï¼
                if (behavior === 'auto') {
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'auto'
                    });
                } else {
                    // å¦‚æœæ˜¯å¹³æ»‘æ²å‹•ï¼Œä¿ç•™ä¸€é»å»¶é²ç¢ºä¿æ¸²æŸ“å®Œæˆ
                    setTimeout(() => {
                        container.scrollTo({
                            top: container.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 50);
                }
            }
        };

        window.confirmDeleteMsg = function(msgId) {
            deleteTarget = 'message';
            noteToDelete = msgId; 
            
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            const btn = document.getElementById('confirm-delete-btn'); // æŠ“å–æŒ‰éˆ•

            if(title) title.textContent = 'æ”¶å›è¨Šæ¯ï¼Ÿ';
            if(desc) desc.textContent = 'ç¢ºå®šè¦æ”¶å›é€™å‰‡è¨Šæ¯å—ï¼Ÿ'; // æ”¹æˆã€Œæ”¶å›ã€
            if(btn) btn.textContent = 'æ”¶å›'; // æŒ‰éˆ•æ”¹æˆã€Œæ”¶å›ã€
            
            window.confirmDelete();
        };

        // === ä¿®æ­£å¾Œçš„å®Œæ•´åˆªé™¤åŸ·è¡Œå‡½å¼ ===
        window.executeDelete = function() { 
            // 1. åˆªé™¤è¡Œç¨‹
            if (deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete()
                    .then(() => { 
                        window.closeConfirmModal(); 
                        window.closeAddModal(); 
                        window.showToast('è¡Œç¨‹å·²åˆªé™¤'); 
                    })
                    .catch(e => { 
                        console.error(e); 
                        window.showToast('åˆªé™¤å¤±æ•—'); 
                    }); 
            } 
            // 2. åˆªé™¤å¾…è¾¦
            else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete()
                    .then(() => { 
                        window.closeConfirmModal(); 
                        window.closeAddTodoModal(); 
                        window.showToast('å¾…è¾¦å·²åˆªé™¤'); 
                    })
                    .catch(e => { 
                        console.error(e); 
                        window.showToast('åˆªé™¤å¤±æ•—'); 
                    }); 
            } 
            // 3. æ”¶å›è¨Šæ¯ (èŠå¤©å®¤)
            else if (deleteTarget === 'message' && noteToDelete) { 
                db.collection('messages').doc(noteToDelete).delete()
                    .then(() => { 
                        window.showToast('è¨Šæ¯å·²æ”¶å›'); 
                        window.closeConfirmModal(); 
                    })
                    .catch(() => { 
                        window.showToast('åˆªé™¤å¤±æ•—'); 
                    });
            }
            // 4. åˆªé™¤å¿ƒæƒ… (èˆŠç‰ˆåŠŸèƒ½ï¼Œä¿ç•™ä»¥é˜²è¬ä¸€)
            else if (deleteTarget === 'note' && noteToDelete) { 
                window.deleteNote(noteToDelete); 
                window.closeConfirmModal();
            }
        };

        // === ä¿®æ”¹ï¼šå–å¾—åˆ†é¡é †åº (å„ªå…ˆè®€å–ä½¿ç”¨è€…è¨­å®š) ===
        window.getCategoryOrder = function() {
            // 1. é è¨­é †åº
            const defaultOrder = ['é‡è¦', 'Debug', 'å·¥ä½œ', 'ç”Ÿæ´»', 'è³¼ç‰©', 'è«‹å‡', 'Party', 'è²¡å‹™', 'æœªåˆ†é¡'];
            
            // 2. è®€å–å„²å­˜çš„é †åº
            let savedOrder = JSON.parse(localStorage.getItem('todo_category_order') || '[]');
            
            // 3. æ”¶é›†ç›®å‰ç³»çµ±ä¸­æ‰€æœ‰å·²çŸ¥çš„åˆ†é¡ (é è¨­ + è‡ªè¨‚ + ç¾æœ‰å¾…è¾¦ä¸­å‡ºç¾çš„)
            const allCats = new Set(defaultCategories.map(c => c.name));
            if(window.customCategories) window.customCategories.forEach(c => allCats.add(c));
            if(window.allTodosCache) window.allTodosCache.forEach(t => { if(t.category) allCats.add(t.category); });
            allCats.add('æœªåˆ†é¡'); // ç¢ºä¿æœ‰æœªåˆ†é¡

            // 4. åˆä½µé‚è¼¯ï¼š
            //    a. å…ˆæ”¾ savedOrder è£¡æœ‰çš„
            //    b. å†æ”¾ savedOrder è£¡æ²’æœ‰ï¼Œä½†åœ¨ defaultOrder è£¡æœ‰çš„ (æ’åœ¨å¾Œé¢)
            //    c. æœ€å¾Œæ”¾å…¨æ–°çš„ (è‡ªè¨‚çš„)
            
            const finalOrder = [];
            
            // a. æ—¢æœ‰è¨­å®š
            savedOrder.forEach(cat => {
                if (allCats.has(cat)) {
                    finalOrder.push(cat);
                    allCats.delete(cat);
                }
            });
            
            // b. è£œä¸Šé è¨­ (å¦‚æœé‚„æ²’è¢«åŠ é€²å»)
            defaultOrder.forEach(cat => {
                if (allCats.has(cat)) {
                    finalOrder.push(cat);
                    allCats.delete(cat);
                }
            });
            
            // c. è£œä¸Šå‰©ä¸‹çš„ (æ–°è‡ªè¨‚çš„)
            allCats.forEach(cat => finalOrder.push(cat));
            
            return finalOrder;
        };

        // === å„ªåŒ–ç‰ˆï¼šè¨­å®šé é¢åˆ†é¡æ¸²æŸ“ (æ”¯æ´æ‹–æ›³æ’åº) ===
        window.renderCategorySettings = function() {
            const container = document.getElementById('settings-category-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            // 1. å–å¾—ç›®å‰çš„æ’åºé †åº
            const sortedCats = window.getCategoryOrder();

            // 2. ç”¢ç”Ÿ UI (åŠ å…¥ data-cat å±¬æ€§ä»¥ä¾¿è­˜åˆ¥)
            sortedCats.forEach((cat) => {
                const isVisible = window.todoCategoryVisibility[cat] !== false;
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºé è¨­åˆ†é¡
                const defCat = defaultCategories.find(c => c.name === cat);
                const isDefault = !!defCat;
                const color = defCat ? defCat.color : '#f3f4f6'; 
                
                // ç”¢ç”Ÿ ç·¨è¼¯/åˆªé™¤ æŒ‰éˆ• (åªæœ‰è‡ªè¨‚åˆ†é¡æ‰é¡¯ç¤º)
                let actionBtns = '';
                if (!isDefault) {
                    actionBtns = `
                    <div class="flex items-center border-l border-gray-200 pl-2 ml-2 gap-1">
                        <button onclick="window.renameCategory('${cat}')" class="cat-action-btn" title="é‡æ–°å‘½å">
                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="window.deleteCategory('${cat}')" class="cat-action-btn delete" title="åˆªé™¤åˆ†é¡">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>`;
                }

                // ğŸŒŸ ä¿®æ”¹é‡é»ï¼šç§»é™¤ä¸Šä¸‹ç®­é ­ï¼Œæ”¹ç‚ºæ‹–æ›³æŠŠæ‰‹ (.sort-handle)
                const html = `
                <div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0 group category-sort-item" data-cat="${cat}">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        
                        <div class="sort-handle cursor-grab active:cursor-grabbing p-1.5 text-gray-300 hover:text-gray-500 hover:bg-gray-100 rounded touch-none">
                            <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                        </div>
                        
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${color}"></div>
                            <span class="text-sm text-gray-700 font-medium truncate">${cat}</span>
                            ${!isDefault ? '<span class="text-[9px] bg-gray-100 text-gray-400 px-1 rounded">è‡ªè¨‚</span>' : ''}
                        </div>

                        ${actionBtns}
                    </div>

                    <label class="relative inline-flex items-center cursor-pointer ml-3 flex-shrink-0">
                        <input type="checkbox" class="sr-only toggle-checkbox" onchange="window.toggleCategoryVisibility('${cat}')" ${isVisible ? 'checked' : ''}>
                        <div class="w-9 h-5 bg-gray-200 rounded-full toggle-bg transition-colors duration-200 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all input:checked:after:translate-x-full peer-checked:after:translate-x-full"></div>
                    </label>
                </div>`;
                container.innerHTML += html;
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // === ğŸŒŸ å•Ÿç”¨ SortableJS (é‡å°åˆ†é¡åˆ—è¡¨) ===
            // å…ˆéŠ·æ¯€èˆŠçš„å¯¦ä¾‹ (é¿å…é‡è¤‡ç¶å®š)
            if (window.categorySortable) {
                window.categorySortable.destroy();
                window.categorySortable = null;
            }

            window.categorySortable = new Sortable(container, {
                handle: '.sort-handle', // æŒ‡å®šåªæœ‰æŒ‰ä½æŠŠæ‰‹æ‰èƒ½æ‹–æ›³
                animation: 150,
                ghostClass: 'bg-gray-50', // æ‹–æ›³æ™‚ç•™ä¸‹çš„ç©ºä½æ¨£å¼
                onEnd: function () {
                    // 1. å¾ DOM è®€å–æ–°çš„é †åº
                    const newOrder = Array.from(container.querySelectorAll('.category-sort-item'))
                                          .map(el => el.getAttribute('data-cat'));
                    
                    // 2. å­˜å…¥ LocalStorage
                    localStorage.setItem('todo_category_order', JSON.stringify(newOrder));
                    
                    // 3. ç«‹å³åˆ·æ–°å¤–éƒ¨çš„å¾…è¾¦æ¸…å–® (è®“è®Šæ›´å³æ™‚ç”Ÿæ•ˆ)
                    if (typeof window.renderTodos === 'function' && window.allTodosCache) {
                        window.renderTodos(window.allTodosCache);
                    }
                    
                    // 4. çµ¦å€‹éœ‡å‹•å›é¥‹
                    triggerHaptic('LIGHT');
                }
            });
        };

        // === æ–°å¢ï¼šé‡æ–°å‘½åè‡ªè¨‚åˆ†é¡ ===
        window.renameCategory = async function(oldName) {
            const newName = prompt(`è«‹è¼¸å…¥ã€Œ${oldName}ã€çš„æ–°åç¨±ï¼š`, oldName);
            
            // æª¢æŸ¥æœ‰æ•ˆæ€§
            if (!newName || newName.trim() === "" || newName === oldName) return;
            const cleanName = newName.trim();

            // æª¢æŸ¥æ˜¯å¦é‡è¤‡ (è·Ÿé è¨­æˆ–ç¾æœ‰è‡ªè¨‚é‡è¤‡)
            if (defaultCategories.find(c => c.name === cleanName) || window.customCategories.includes(cleanName)) {
                alert('é€™å€‹åˆ†é¡åç¨±å·²ç¶“å­˜åœ¨å›‰ï¼');
                return;
            }

            try {
                window.showToast('æ­£åœ¨æ›´æ–°åˆ†é¡åç¨±...');

                // 1. æ›´æ–°æœ¬åœ°è¨­å®š (customCategories)
                const idx = window.customCategories.indexOf(oldName);
                if (idx !== -1) {
                    window.customCategories[idx] = cleanName;
                    localStorage.setItem('my_custom_categories', JSON.stringify(window.customCategories));
                }

                // 2. æ›´æ–°æœ¬åœ°è¨­å®š (æ’åº order)
                let order = window.getCategoryOrder();
                const orderIdx = order.indexOf(oldName);
                if (orderIdx !== -1) {
                    order[orderIdx] = cleanName;
                    localStorage.setItem('todo_category_order', JSON.stringify(order));
                }

                // 3. æ›´æ–°æœ¬åœ°è¨­å®š (é¡¯ç¤º visibility)
                if (window.todoCategoryVisibility[oldName] !== undefined) {
                    window.todoCategoryVisibility[cleanName] = window.todoCategoryVisibility[oldName];
                    delete window.todoCategoryVisibility[oldName];
                    localStorage.setItem('todo_category_visibility', JSON.stringify(window.todoCategoryVisibility));
                }

                // 4. é‡é ­æˆ²ï¼šæ›´æ–° Firestore è³‡æ–™åº«ä¸­çš„å¾…è¾¦äº‹é …
                // æ‰¾å‡ºæ‰€æœ‰åˆ†é¡æ˜¯ oldName çš„å¾…è¾¦ï¼Œæ‰¹æ¬¡æ›´æ–°ç‚º newName
                const batch = db.batch();
                const snapshot = await db.collection('todos').where('category', '==', oldName).get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { category: cleanName });
                    });
                    await batch.commit();
                }

                // 5. é‡æ–°æ¸²æŸ“ç•«é¢
                window.renderCategorySettings();
                window.showToast(`åˆ†é¡å·²æ›´åç‚ºï¼š${cleanName}`);

            } catch (err) {
                console.error("Rename failed:", err);
                window.showToast('æ›´åå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        };

        // === æ–°å¢ï¼šåˆªé™¤è‡ªè¨‚åˆ†é¡ ===
        window.deleteCategory = async function(catName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${catName}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šå±¬æ–¼æ­¤åˆ†é¡çš„å¾…è¾¦äº‹é …ä¸æœƒè¢«åˆªé™¤ï¼Œä½†æœƒè®Šæˆã€Œæœªåˆ†é¡ã€ã€‚`)) {
                return;
            }

            try {
                // 1. æ›´æ–°æœ¬åœ°è¨­å®š (ç§»é™¤ customCategories)
                window.customCategories = window.customCategories.filter(c => c !== catName);
                localStorage.setItem('my_custom_categories', JSON.stringify(window.customCategories));

                // 2. æ›´æ–°æœ¬åœ°è¨­å®š (ç§»é™¤ order)
                let order = JSON.parse(localStorage.getItem('todo_category_order') || '[]');
                order = order.filter(c => c !== catName);
                localStorage.setItem('todo_category_order', JSON.stringify(order));

                // 3. æ›´æ–°æœ¬åœ°è¨­å®š (ç§»é™¤ visibility)
                delete window.todoCategoryVisibility[catName];
                localStorage.setItem('todo_category_visibility', JSON.stringify(window.todoCategoryVisibility));

                // 4. æ›´æ–° Firestoreï¼šå°‡è©²åˆ†é¡çš„å¾…è¾¦äº‹é …æ”¹ç‚º "" (æœªåˆ†é¡)
                // é€™æ¨£å®ƒå€‘æ‰ä¸æœƒæ¶ˆå¤±ï¼Œè€Œæ˜¯å›åˆ°æœªåˆ†é¡å€å¡Š
                window.showToast('æ­£åœ¨åˆªé™¤åˆ†é¡...');
                
                const batch = db.batch();
                const snapshot = await db.collection('todos').where('category', '==', catName).get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { category: '' }); // æ¸…ç©ºåˆ†é¡
                    });
                    await batch.commit();
                }

                // 5. é‡æ–°æ¸²æŸ“
                window.renderCategorySettings();
                window.showToast('åˆ†é¡å·²åˆªé™¤');

            } catch (err) {
                console.error("Delete failed:", err);
                window.showToast('åˆªé™¤å¤±æ•—');
            }
        };

        // === æ–°å¢ï¼šç§»å‹•åˆ†é¡é †åº ===
        window.moveCategory = function(cat, direction) {
            const currentOrder = window.getCategoryOrder();
            const index = currentOrder.indexOf(cat);
            
            if (index === -1) return;
            
            const newIndex = index + direction;
            
            // é‚Šç•Œæª¢æŸ¥
            if (newIndex < 0 || newIndex >= currentOrder.length) return;
            
            // äº¤æ›ä½ç½®
            const temp = currentOrder[newIndex];
            currentOrder[newIndex] = currentOrder[index];
            currentOrder[index] = temp;
            
            // å­˜æª”
            localStorage.setItem('todo_category_order', JSON.stringify(currentOrder));
            
            // é‡æ–°æ¸²æŸ“è¨­å®šé é¢ (è®“æŒ‰éˆ•ç‹€æ…‹æ›´æ–°)
            window.renderCategorySettings();
            
            // é‡æ–°æ¸²æŸ“å¤–éƒ¨å¾…è¾¦æ¸…å–® (å³æ™‚ç”Ÿæ•ˆ)
            if (typeof window.renderTodos === 'function' && window.allTodosCache) {
                window.renderTodos(window.allTodosCache);
            }
        };

        // === æ–°å¢ï¼šåˆ‡æ›åˆ†é¡é¡¯ç¤ºç‹€æ…‹ ===
        window.toggleCategoryVisibility = function(cat) {
            const current = window.todoCategoryVisibility[cat] !== false;
            window.todoCategoryVisibility[cat] = !current; // åè½‰ç‹€æ…‹
            
            // å­˜å…¥ LocalStorage
            localStorage.setItem('todo_category_visibility', JSON.stringify(window.todoCategoryVisibility));
            
            // ç«‹å³åˆ·æ–°æ‘˜è¦é é¢ (å¦‚æœæœ‰è³‡æ–™çš„è©±)
            if (typeof window.renderTodos === 'function' && allTodosCache.length > 0) {
                window.renderTodos(allTodosCache);
            }
        };

        // === æ¯æ—¥è³‡è¨Šå¡ç‰‡åŠŸèƒ½ (å«ç´€å¿µæ—¥ç¥è³€) ===
        window.renderDailyBrief = function() {
            const now = new Date();
            const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            
            // 1. æ›´æ–°è¥¿å…ƒæ—¥æœŸ
            document.getElementById('brief-day-num').textContent = now.getDate();
            document.getElementById('brief-day-word').textContent = weekDays[now.getDay()];
            document.getElementById('brief-month-year').textContent = `${now.getMonth() + 1}æœˆ / ${now.getFullYear()}`;

            // 2. è¾²æ›†èˆ‡ç¯€æ—¥é‚è¼¯
            let lunarText = '';
            let specialMsg = ''; // å„²å­˜ç¥è³€èª
            
            try {
                // å–å¾—ä»Šå¤©è¾²æ›†
                const parts = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', { 
                    day: 'numeric', month: 'long' 
                }).formatToParts(now);
                
                const lunarMonth = parts.find(p => p.type === 'month')?.value; // ex: æ­£æœˆ, åäºŒæœˆ
                let lunarDay = parts.find(p => p.type === 'day')?.value;       // ex: åˆä¸€, 15

                // ä¿®æ­£ç´”æ•¸å­—çš„è¾²æ›†æ—¥æœŸ
                const dayMap = {
                    '1': 'åˆä¸€', '2': 'åˆäºŒ', '3': 'åˆä¸‰', '4': 'åˆå››', '5': 'åˆäº”',
                    '6': 'åˆå…­', '7': 'åˆä¸ƒ', '8': 'åˆå…«', '9': 'åˆä¹', '10': 'åˆå',
                    '11': 'åä¸€', '12': 'åäºŒ', '13': 'åä¸‰', '14': 'åå››', '15': 'åäº”',
                    '16': 'åå…­', '17': 'åä¸ƒ', '18': 'åå…«', '19': 'åä¹', '20': 'äºŒå',
                    '21': 'å»¿ä¸€', '22': 'å»¿äºŒ', '23': 'å»¿ä¸‰', '24': 'å»¿å››', '25': 'å»¿äº”',
                    '26': 'å»¿å…­', '27': 'å»¿ä¸ƒ', '28': 'å»¿å…«', '29': 'å»¿ä¹', '30': 'ä¸‰å'
                };
                const dayNum = parseInt(lunarDay.replace(/[^\d]/g, ''));
                if (!isNaN(dayNum) && dayMap[dayNum]) { lunarDay = dayMap[dayNum]; }
                
                lunarText = `è¾²æ›† ${lunarMonth}${lunarDay}`;

                // === âœ¨ ç´€å¿µæ—¥åˆ¤æ–·é‚è¼¯ âœ¨ ===
                const m = now.getMonth() + 1; // è¥¿å…ƒæœˆ
                const d = now.getDate();      // è¥¿å…ƒæ—¥

                // 1. å›ºå®šåœ‹æ›†ç¯€æ—¥
                if (m === 3 && d === 17) specialMsg = "ğŸ‚ æ¯›æ¯›ç”Ÿæ—¥å¿«æ¨‚ï¼";
                else if (m === 8 && d === 1) specialMsg = "ğŸ‚ çš“çš“ç”Ÿæ—¥å¿«æ¨‚ï¼";
                else if (m === 6 && d === 20) specialMsg = "â¤ï¸ äº¤å¾€ç´€å¿µæ—¥å¿«æ¨‚ï¼";
                else if (m === 1 && d === 1) specialMsg = "ğŸ‰ æ–°å¹´å¿«æ¨‚ï¼";
                else if (m === 12 && d === 25) specialMsg = "ğŸ„ è–èª•å¿«æ¨‚ï¼";

                // 2. è¾²æ›†ç¯€æ—¥ (åˆä¸€)
                if (lunarMonth === 'æ­£æœˆ' && lunarDay === 'åˆä¸€') {
                    specialMsg = "ğŸ§§ è¾²æ›†æ–°å¹´å¿«æ¨‚ï¼";
                }

                // 3. è¾²æ›†é™¤å¤• (åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœæ˜å¤©æ˜¯åˆä¸€ï¼Œä»Šå¤©å°±æ˜¯é™¤å¤•)
                // é€™æ¨£ä¸ç®¡æ˜¯ 29 æ—¥é‚„æ˜¯ 30 æ—¥é™¤å¤•éƒ½æŠ“å¾—åˆ°
                const tmr = new Date(now);
                tmr.setDate(tmr.getDate() + 1);
                const tmrParts = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', { day: 'numeric', month: 'long' }).formatToParts(tmr);
                const tmrMonth = tmrParts.find(p => p.type === 'month')?.value;
                let tmrDay = tmrParts.find(p => p.type === 'day')?.value;
                // ç°¡å–®æ­£è¦åŒ–
                if (tmrDay === '1') tmrDay = 'åˆä¸€';

                if (tmrMonth === 'æ­£æœˆ' && tmrDay === 'åˆä¸€') {
                    specialMsg = "ğŸ§¨ é™¤èˆŠä½ˆæ–°ï¼é™¤å¤•å¿«æ¨‚";
                }
                
                // ==========================

            } catch (e) {
                console.error(e);
                lunarText = '';
            }

            document.getElementById('brief-lunar').textContent = lunarText;

            // === æ›´æ–° UIï¼šé¡¯ç¤ºæˆ–éš±è—ç¥ç¦èª ===
            const specialEl = document.getElementById('brief-special');
            if (specialMsg) {
                specialEl.textContent = specialMsg;
                specialEl.classList.remove('hidden');
            } else {
                specialEl.classList.add('hidden');
            }

            // === 3. å¤©æ°£é‚è¼¯ (ç¶­æŒä¸è®Š) ===
            const fetchWeather = (lat, lon) => {
                const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const current = data.current;
                        const daily = data.daily;
                        
                        document.getElementById('brief-temp-current').textContent = `${Math.round(current.temperature_2m)}Â°`;
                        document.getElementById('brief-temp-range').textContent = `H:${Math.round(daily.temperature_2m_max[0])}Â° L:${Math.round(daily.temperature_2m_min[0])}Â°`;
                        
                        const code = current.weather_code;
                        const isDay = current.is_day;
                        let iconName = 'cloud';
                        let desc = 'å¤šé›²';
                        let iconColor = 'text-gray-400';

                        if (code === 0) { 
                            iconName = isDay ? 'sun' : 'moon'; 
                            desc = 'æ™´æœ—'; 
                            iconColor = isDay ? 'text-orange-400' : 'text-indigo-400';
                        } else if (code >= 1 && code <= 3) {
                            iconName = isDay ? 'cloud-sun' : 'cloud-moon'; 
                            desc = 'å¤šé›²'; iconColor = 'text-gray-400';
                        } else if (code >= 45 && code <= 48) {
                            iconName = 'cloud-fog'; desc = 'æœ‰éœ§';
                        } else if (code >= 51 && code <= 67) {
                            iconName = 'cloud-drizzle'; desc = 'ç´°é›¨'; iconColor = 'text-blue-400';
                        } else if (code >= 80 && code <= 99) {
                            iconName = 'cloud-rain'; desc = 'é™£é›¨'; iconColor = 'text-blue-500';
                        } else if (code >= 71) {
                            iconName = 'snowflake'; desc = 'ä¸‹é›ª';
                        }

                        const iconEl = document.getElementById('brief-weather-icon');
                        iconEl.setAttribute('data-lucide', iconName);
                        iconEl.className = `w-6 h-6 ${iconColor}`; 
                        document.getElementById('brief-weather-desc').textContent = desc;

                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    })
                    .catch(err => {
                        console.error("Weather fetch failed", err);
                        document.getElementById('brief-weather-desc').textContent = "è¼‰å…¥å¤±æ•—";
                    });
            };

            // === 4. é–‹å§‹å®šä½ (ç¶­æŒä¸è®Š) ===
            const defaultLat = 25.00;
            const defaultLon = 121.48;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => { fetchWeather(position.coords.latitude, position.coords.longitude); },
                    (error) => { fetchWeather(defaultLat, defaultLon); },
                    { timeout: 5000 }
                );
            } else {
                fetchWeather(defaultLat, defaultLon);
            }
        };

        // === è¾²æ›†èˆ‡å‡æ—¥è¼”åŠ©å‡½å¼ (2025-2026 å®Œæ•´ç‰ˆ) ===
        window.getLunarAndHoliday = function(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;

            // å®šç¾©å‡æ—¥è³‡æ–™åº« (åŒ…å« 2025 èˆ‡ 2026)
            const holidays = {
                // ====== 2026 å¹´ (æ°‘åœ‹ 115 å¹´) ======
                // 1. å…ƒæ—¦ (1/1)
                '2026-01-01': 'å…ƒæ—¦',

                // 2. è¾²æ›†æ˜¥ç¯€ (9å¤©é€£å‡: 2/14-2/22)
                '2026-02-14': 'æ˜¥ç¯€é€£å‡',
                '2026-02-15': 'å°å¹´å¤œ', // å½ˆæ€§æ”¾å‡/é€£å‡
                '2026-02-16': 'é™¤å¤•',   // 2/16 ç‚ºé™¤å¤•
                '2026-02-17': 'æ˜¥ç¯€',   // åˆä¸€
                '2026-02-18': 'åˆäºŒ',
                '2026-02-19': 'åˆä¸‰',
                '2026-02-20': 'åˆå››',
                '2026-02-21': 'åˆäº”',
                '2026-02-22': 'æ˜¥ç¯€é€£å‡',

                // 3. å’Œå¹³ç´€å¿µæ—¥ (3å¤©é€£å‡: 2/27-3/1)
                '2026-02-27': 'å’Œå¹³ç´€å¿µ', // 2/28é©é€¢é€±å…­ï¼Œæ–¼å‰ä¸€æ—¥è£œå‡
                '2026-02-28': 'å’Œå¹³ç´€å¿µ',

                // 4. å…’ç«¥ç¯€èˆ‡æ¸…æ˜ç¯€ (4å¤©é€£å‡: 4/3-4/6)
                '2026-04-03': 'å…’ç«¥ç¯€è£œå‡', // 4/4é€±å…­ï¼Œæ–¼å‰ä¸€æ—¥è£œå‡
                '2026-04-04': 'å…’ç«¥ç¯€',
                '2026-04-05': 'æ¸…æ˜ç¯€',
                '2026-04-06': 'æ¸…æ˜è£œå‡', // 4/5é€±æ—¥ï¼Œæ–¼æ¬¡ä¸€æ—¥è£œå‡

                // 5. å‹å‹•ç¯€ (3å¤©é€£å‡: 5/1-5/3)
                '2026-05-01': 'å‹å‹•ç¯€',

                // 6. ç«¯åˆç¯€ (3å¤©é€£å‡: 6/19-6/21)
                '2026-06-19': 'ç«¯åˆç¯€',

                // 7. ä¸­ç§‹ç¯€ & æ•™å¸«ç¯€ (4å¤©é€£å‡: 9/25-9/28)
                // 2026ä¸­ç§‹æ˜¯9/25(äº”)ï¼Œå‰›å¥½é€£è‘—9/28(ä¸€)å½¢æˆé€£å‡
                '2026-09-25': 'ä¸­ç§‹ç¯€',
                '2026-09-28': 'æ•™å¸«ç¯€', // ç´…å­—ï¼

                // 8. åœ‹æ…¶æ—¥ (3å¤©é€£å‡: 10/9-10/11)
                '2026-10-09': 'åœ‹æ…¶è£œå‡', // 10/10é€±å…­ï¼Œæ–¼å‰ä¸€æ—¥è£œå‡
                '2026-10-10': 'åœ‹æ…¶æ—¥',

                // 9. å…‰å¾©ç¯€ (3å¤©é€£å‡: 10/24-10/26) [å‚™è¨»: 2026ç‰¹æ®Šç´…å­—]
                // 10/25æ˜¯é€±æ—¥ï¼Œæ–¼10/26è£œå‡
                '2026-10-25': 'å…‰å¾©ç¯€',
                '2026-10-26': 'å…‰å¾©ç¯€è£œå‡',

                // 10. è¡Œæ†²ç´€å¿µæ—¥/è–èª•ç¯€ (3å¤©é€£å‡: 12/25-12/27) [å‚™è¨»: 2026ç‰¹æ®Šç´…å­—]
                '2026-12-25': 'è–èª•ç¯€', // å…¼è¡Œæ†²ç´€å¿µæ—¥æ”¾å‡

                // ====== 2025 å¹´ (ä¿ç•™ä½œç‚ºåƒè€ƒ) ======
                '2025-01-01': 'å…ƒæ—¦',
                '2025-01-25': 'æ˜¥ç¯€é€£å‡', '2025-01-26': 'æ˜¥ç¯€é€£å‡', '2025-01-27': 'å°å¹´å¤œ',
                '2025-01-28': 'é™¤å¤•', '2025-01-29': 'æ˜¥ç¯€', '2025-01-30': 'åˆäºŒ',
                '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››', '2025-02-02': 'åˆäº”',
                '2025-02-28': 'å’Œå¹³ç´€å¿µ',
                '2025-04-03': 'æ¸…æ˜é€£å‡', '2025-04-04': 'å…’ç«¥ç¯€', '2025-04-05': 'æ¸…æ˜ç¯€',
                '2025-05-01': 'å‹å‹•ç¯€', '2025-05-30': 'ç«¯åˆç¯€',
                '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥',
                '2025-12-25': 'è–èª•ç¯€'
            };

            let holiday = holidays[dateStr] || '';
            
            // è¾²æ›†è½‰æ› (ç¶­æŒè‡ªå‹•è¨ˆç®—)
            let lunar = '';
            try {
                const parts = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', { 
                    day: 'numeric', month: 'long' 
                }).formatToParts(date);
                
                const lunarMonth = parts.find(p => p.type === 'month')?.value; 
                let lunarDay = parts.find(p => p.type === 'day')?.value;       

                const dayMap = {
                    '1': 'åˆä¸€', '2': 'åˆäºŒ', '3': 'åˆä¸‰', '4': 'åˆå››', '5': 'åˆäº”',
                    '6': 'åˆå…­', '7': 'åˆä¸ƒ', '8': 'åˆå…«', '9': 'åˆä¹', '10': 'åˆå',
                    '11': 'åä¸€', '12': 'åäºŒ', '13': 'åä¸‰', '14': 'åå››', '15': 'åäº”',
                    '16': 'åå…­', '17': 'åä¸ƒ', '18': 'åå…«', '19': 'åä¹', '20': 'äºŒå',
                    '21': 'å»¿ä¸€', '22': 'å»¿äºŒ', '23': 'å»¿ä¸‰', '24': 'å»¿å››', '25': 'å»¿äº”',
                    '26': 'å»¿å…­', '27': 'å»¿ä¸ƒ', '28': 'å»¿å…«', '29': 'å»¿ä¹', '30': 'ä¸‰å'
                };

                const dayNum = parseInt(lunarDay.replace(/[^\d]/g, ''));
                if (!isNaN(dayNum) && dayMap[dayNum]) {
                    lunarDay = dayMap[dayNum];
                }

                if (lunarDay === 'åˆä¸€') {
                    lunar = lunarMonth;
                } else {
                    lunar = lunarDay;
                }
            } catch(e) { console.error(e); }

            return { lunar, holiday };
        };

        // === æ–°å¢ï¼šæé†’é¸æ“‡å™¨é‚è¼¯ ===
        
        // 1. å®šç¾©é¸é …å°ç…§è¡¨ (æ–¹ä¾¿åæŸ¥æ–‡å­—)
        const reminderOptionsMap = {
            '0': 'ä¸é€šçŸ¥',
            'on_time': 'æº–æ™‚',
            '5': '5 åˆ†é˜å‰',
            '10': '10 åˆ†é˜å‰',
            '30': '30 åˆ†é˜å‰',
            '60': '1 å°æ™‚å‰',
            '120': '2 å°æ™‚å‰',
            '1440': '1 å¤©å‰'
        };

        // 2. å–å¾—é¡¯ç¤ºæ–‡å­—çš„è¼”åŠ©å‡½å¼
        window.getRemindLabel = function(val) {
            return reminderOptionsMap[val] || 'ä¸é€šçŸ¥';
        };

        // 3. é–‹å•Ÿé¸æ“‡è¦–çª—
        window.openReminderPicker = function() {
            const m = document.getElementById('reminder-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        // 4. é—œé–‰é¸æ“‡è¦–çª—
        window.closeReminderPicker = function() {
            const m = document.getElementById('reminder-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        // 5. ä½¿ç”¨è€…é¸æ“‡äº†æŸå€‹é¸é …
        window.selectReminder = function(val, label) {
            // æ›´æ–°éš±è—çš„ input å€¼ (å­˜é€²è³‡æ–™åº«ç”¨)
            document.getElementById('input-remind').value = val;
            
            // æ›´æ–°ä»‹é¢ä¸Šé¡¯ç¤ºçš„æ–‡å­— (çµ¦äººçœ‹)
            const displayEl = document.getElementById('display-remind');
            displayEl.textContent = label;
            displayEl.classList.remove('dt-text-placeholder');
            displayEl.classList.add('dt-text-value');
            
            // é—œé–‰è¦–çª—
            window.closeReminderPicker();
        };

        // === å„ªåŒ–ç‰ˆï¼šæ»‘å‹•åˆªé™¤åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ (è§£æ±ºæ²å‹•èˆ‡æ’åºè¡çª) ===
window.initSwipeListeners = function(container) {
    let startX = 0;
    let startY = 0;
    let currentItem = null;
    let currentTranslate = 0;
    
    // å–å¾—æ‰€æœ‰å¯æ»‘å‹•çš„é …ç›®
    const items = container.querySelectorAll('.swipe-item');

    items.forEach(item => {
        const content = item.querySelector('.swipe-content');
        if (!content) return;

        // 1. æ‰‹æŒ‡æŒ‰ä¸‹
        content.addEventListener('touchstart', (e) => {
            // å¦‚æœæœ‰å…¶ä»–å·²æ‰“é–‹çš„é …ç›®ï¼Œå…ˆæŠŠå®ƒé—œèµ·ä¾†
            document.querySelectorAll('.swipe-content').forEach(el => {
                if (el !== content) el.style.transform = 'translateX(0px)';
            });

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            currentItem = content;
            
            // ç§»é™¤å‹•ç•«æ•ˆæœï¼Œè®“æ‹–æ›³æ›´è·Ÿæ‰‹
            content.style.transition = 'none';
        }, { passive: true });

        // 2. æ‰‹æŒ‡ç§»å‹•
        content.addEventListener('touchmove', (e) => {
            if (!currentItem) return;

            // ğŸ›‘ é—œéµä¿®æ­£ï¼šå¦‚æœé€™å€‹é …ç›®æ­£åœ¨è¢«æ‹–æ›³æ’åº (SortableJS)ï¼Œå°±ç¦æ­¢æ»‘å‹•åˆªé™¤
            if (item.classList.contains('sortable-drag') || item.classList.contains('sortable-chosen')) {
                return;
            }

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = currentX - startX;
            const diffY = currentY - startY;

            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ˜é¡¯çš„ã€æ°´å¹³æ»‘å‹•
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 5) {
                
                // ç¦æ­¢ç€è¦½å™¨é è¨­æ²å‹•
                if (e.cancelable) e.preventDefault();
                
                // åªå…è¨±å‘å·¦æ»‘ (diffX < 0)
                if (diffX < 0) {
                    currentTranslate = Math.max(diffX, -80); 
                    content.style.transform = `translateX(${currentTranslate}px)`;
                }
            }
        }, { passive: false });

        // 3. æ‰‹æŒ‡æ”¾é–‹
        content.addEventListener('touchend', (e) => {
            if (!currentItem) return;

            // æ¢å¾©å‹•ç•«æ•ˆæœ
            content.style.transition = 'transform 0.2s ease-out';

            // åˆ¤æ–·æ˜¯å¦æ»‘å‹•è¶…éä¸€åŠ (-40px)
            if (currentTranslate < -40) {
                content.style.transform = 'translateX(-80px)';
            } else {
                content.style.transform = 'translateX(0px)';
            }

            // é‡ç½®
            currentItem = null;
            currentTranslate = 0;
        });
    });
};

// === æ–°å¢ï¼šè¡Œç¨‹å¿«é€Ÿåˆªé™¤å‡½å¼ ===
window.quickDeleteEvent = function(id) {
    // è¨­å®š IDï¼Œç‚ºäº†è®“ executeDelete çŸ¥é“è¦åˆªèª°
    editingEventId = id;
    // è¨­å®šå…¨åŸŸåˆªé™¤ç›®æ¨™
    deleteTarget = 'event'; 

    // å‘¼å«ç¢ºèªè¦–çª—
    const m = document.getElementById('confirm-modal');
    const title = m.querySelector('h3');
    const desc = m.querySelector('p');
    if(title) title.textContent = 'åˆªé™¤è¡Œç¨‹ï¼Ÿ';
    if(desc) desc.textContent = 'ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ';
    
    // é¡¯ç¤ºç¢ºèªè¦–çª—
    window.confirmDelete();
    
    // é—œé–‰æ»‘å‹•ç‹€æ…‹ (æŠŠé‚£ä¸€è¡Œå½ˆå›å»)
    const item = document.querySelector(`.swipe-item[data-swipe-id="${id}"] .swipe-content`);
    if (item) item.style.transform = 'translateX(0px)';
};

    // === æ–°å¢ï¼šæ›´æ–°å¾…è¾¦äº‹é …é †åº ===
        window.updateTodoOrder = function(category, listElement) {
            // 1. å–å¾—ç›®å‰ DOM ä¸Šé¢çš„æ’åˆ—é †åº (ID åˆ—è¡¨)
            const newOrderIds = Array.from(listElement.querySelectorAll('.swipe-item'))
                                     .map(el => el.getAttribute('data-id'))
                                     .filter(id => id); // éæ¿¾æ‰ null

            if (newOrderIds.length === 0) return;

            // 2. æ‰¹æ¬¡æ›´æ–° Firebase
            const batch = db.batch();
            
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªæ›´æ–°é€™å€‹åˆ†é¡åº•ä¸‹çš„ items
            // ä½¿ç”¨ç›®å‰çš„ timestamp åŠ ä¸Š index ä½œç‚ºæ’åºä¾æ“šï¼Œç¢ºä¿é †åºæ­£ç¢º
            newOrderIds.forEach((id, index) => {
                const ref = db.collection('todos').doc(id);
                // order æ¬„ä½ï¼šæ•¸å­—è¶Šå°æ’è¶Šå‰é¢
                batch.update(ref, { order: index });
            });

            batch.commit()
                .then(() => console.log(`Category [${category}] order updated`))
                .catch(err => console.error("Order update failed", err));
        };

        window.manualSetupPush = async function() {
    // 1. æª¢æŸ¥å¤–æ›æ˜¯å¦å®‰è£
    const { FirebaseMessaging } = Capacitor.Plugins;
    if (!FirebaseMessaging) {
        alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° FirebaseMessaging å¤–æ›ï¼Œè«‹ç¢ºèªæœ‰é»æ“Š npx cap syncï¼");
        return;
    }

    try {
        // 2. è«‹æ±‚æ¬Šé™
        alert("1. è«‹æ±‚æ¬Šé™ä¸­...");
        const result = await FirebaseMessaging.requestPermissions();
        
        if (result.receive === 'granted') {
            alert("2. æ¬Šé™é€šéï¼æ­£åœ¨å‘ Firebase æ‹¿ Token...");
            
            // 3. é—œéµå·®ç•°ï¼šé€™è£¡æ‹¿åˆ°çš„æœƒæ˜¯ "FCM Token" (Google çœ‹å¾—æ‡‚çš„)
            const tokenResult = await FirebaseMessaging.getToken();
            const fcmToken = tokenResult.token;
            
            alert("ğŸ‰ æˆåŠŸæ‹¿åˆ° FCM Token: " + fcmToken.substring(0, 5) + "...");

            // 4. å­˜å…¥è³‡æ–™åº«
            if (db && currentUserRole) {
                db.collection('user_tokens').doc(currentUserRole).set({
                    token: fcmToken,  // å­˜é€²å»çš„æ˜¯æ­£ç¢ºçš„ FCM Token
                    platform: 'ios',
                    updatedAt: new Date().toISOString()
                }, { merge: true })
                .then(() => {
                    alert("âœ… Token å·²æ›´æ–°ï¼ç¾åœ¨å¯ä»¥æ¸¬è©¦æ¨æ’­äº†ï¼");
                })
                .catch((err) => {
                    alert("âŒ è³‡æ–™åº«å¯«å…¥å¤±æ•—: " + err.message);
                });
            }
        } else {
            alert("âŒ æ¬Šé™è¢«æ‹’çµ•");
        }
    } catch (e) {
        alert("ç™¼ç”ŸéŒ¯èª¤: " + e.message);
    }
};

    </script>

    <div id="category-settings-modal" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCategorySettingsModal()"></div>
        <div class="relative bg-white w-[320px] h-[500px] rounded-2xl shadow-xl overflow-hidden transform scale-100 transition-transform flex flex-col">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 flex-none">
                <button onclick="window.closeCategorySettingsModal()" class="flex items-center text-gray-500 hover:text-gray-800 transition">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    <span class="text-sm font-bold ml-1">è¿”å›</span>
                </button>
                <h3 class="text-base font-bold text-gray-800">åˆ†é¡ç®¡ç†</h3>
                <div class="w-10"></div> </div>
            
            <div class="flex-1 overflow-y-auto p-2 bg-white">
                <p class="text-xs text-gray-400 text-center py-2 mb-2">é•·æŒ‰ <i data-lucide="grip-vertical" class="w-3 h-3 inline"></i> å¯æ‹–æ›³æ’åºï¼Œé–‹é—œå¯åˆ‡æ›é¦–é é¡¯ç¤ºã€‚</p>
                
                <div id="settings-category-list" class="space-y-1 pb-10">
                    </div>
            </div>

            <div class="p-3 border-t border-gray-100 bg-gray-50 text-center flex-none">
                <button onclick="window.closeCategorySettingsModal()" class="w-full py-2 bg-theme text-white rounded-xl text-sm font-bold shadow-sm active:scale-95 transition">
                    å®Œæˆ
                </button>
            </div>
        </div>
    </div>

    <div id="batch-action-bar">
    <div class="text-sm font-bold text-gray-500">å·²é¸æ“‡ <span id="batch-count">0</span> é …</div>
    <button onclick="window.executeBatchDelete()" id="btn-batch-delete" class="px-6 py-2 bg-red-50 text-red-500 font-bold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition hover:bg-red-100">
        åˆªé™¤
    </button>
</div>

</body>
</html>
