/* =========================================
   ä¾¿åˆ©è²¼ (Status Note) åŠŸèƒ½é‚è¼¯
   ========================================= */

// 1. ç™¼é€ä¾¿åˆ©è²¼
window.sendNote = function() {
    const input = document.getElementById('note-input');
    const text = input.value.trim();

    if (!text) return;

    // å¯«å…¥è³‡æ–™åº« (collection: 'notes', docId: role)
    // é€™æ¨£åŒä¸€å€‹äººæ°¸é åªæœ‰ä¸€å‰‡æœ€æ–°çš„ note
    db.collection('notes').doc(currentUserRole).set({
        text: text,
        timestamp: new Date().toISOString(),
        creator: currentUserRole
    }).then(() => {
        window.showToast('å¿ƒæƒ…å·²ç™¼é€ ğŸ’¬');
        input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        input.blur(); // æ”¶èµ·éµç›¤
    }).catch(err => {
        console.error(err);
        window.showToast('ç™¼é€å¤±æ•—');
    });
};

// 2. èšç„¦è¼¸å…¥æ¡† (é»æ“Šé ­åƒæ™‚è§¸ç™¼)
window.setNoteInputFocus = function() {
    const input = document.getElementById('note-input');
    input.focus();
};

// 3. æ¸²æŸ“ä¾¿åˆ©è²¼ (æ ¸å¿ƒé‚è¼¯ï¼šæª¢æŸ¥ 24å°æ™‚)
window.renderNoteBubble = function(role, data) {
    const bubbleId = `note-bubble-${role}`;
    const textId = `note-text-${role}`;
    const dotId = `status-dot-${role}`;
    
    const bubbleEl = document.getElementById(bubbleId);
    const textEl = document.getElementById(textId);
    const dotEl = document.getElementById(dotId);

    if (!bubbleEl || !textEl) return;

    if (!data || !data.text || !data.timestamp) {
        // æ²’æœ‰è³‡æ–™ -> éš±è—
        hideBubble(bubbleEl, dotEl);
        return;
    }

    // è¨ˆç®—æ™‚é–“å·®
    const now = new Date();
    const noteTime = new Date(data.timestamp);
    const diffHours = (now - noteTime) / (1000 * 60 * 60);

    // å¦‚æœå°æ–¼ 24 å°æ™‚ -> é¡¯ç¤º
    if (diffHours < 24) {
        textEl.textContent = data.text;
        
        // é¡¯ç¤ºæ°£æ³¡èˆ‡ç¶ é»
        bubbleEl.classList.remove('hidden');
        dotEl.classList.remove('hidden');
        
        // åŠ å…¥å°å‹•ç•« (å»¶é²ä¸€é»é»è®“ transition ç”Ÿæ•ˆ)
        requestAnimationFrame(() => {
            bubbleEl.classList.remove('opacity-0', 'translate-y-2');
        });
    } else {
        // è¶…é 24 å°æ™‚ -> éš±è—
        hideBubble(bubbleEl, dotEl);
    }
};

function hideBubble(bubbleEl, dotEl) {
    bubbleEl.classList.add('opacity-0', 'translate-y-2');
    if(dotEl) dotEl.classList.add('hidden');
    // ç­‰å‹•ç•«è·‘å®Œå† hidden
    setTimeout(() => {
        bubbleEl.classList.add('hidden');
    }, 300);
}

// 4. æ›´æ–°é ­åƒé¡è‰² (é…åˆè¨­å®šé é¢çš„é¡è‰²)
window.syncNoteAvatarColors = function() {
    const h = document.getElementById('avatar-note-haohao');
    const m = document.getElementById('avatar-note-maomao');
    if(h) h.style.backgroundColor = roleColors.haohao;
    if(m) m.style.backgroundColor = roleColors.maomao;
};
