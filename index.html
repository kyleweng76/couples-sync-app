<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>我們的小時光</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ttgreen: '#2cc998', 
                        ttred: '#e95d5d',   
                        ttgray: '#f5f5f5',  
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; /* 建議改成這個更淺的灰色，原本的 #e5e5e5 有點太深 */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            /* ... */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #main-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        /* 1. 修正頁面頂部距離，避免被標題列擋住 (裁切問題) */
        .page-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding-top: 85px; /* 原本 70px -> 改為 85px */
            padding-bottom: 90px;
            background-color: #f9fafb;
            display: none; 
        }

        /* 2. 加高聊天室高度，讓對話能看更多 */
        #chat-container {
            scroll-behavior: smooth; 
            background-color: #9bbbd4; 
            height: 320px; /* 原本 220px -> 改為 320px */
        }
        
        /* 3. 聊天氣泡樣式優化 (支援顯示名字) */
        .chat-row { display: flex; width: 100%; margin-bottom: 6px; }
        
        /* 左側 (對方) */
        .chat-row.left { justify-content: flex-start; align-items: flex-start; }
        .chat-row.left .chat-bubble {
            background-color: #ffffff;
            color: #1f2937;
            border-radius: 4px 16px 16px 16px; /* 圓角微調 */
            /* 移除 margin-left，由外層容器控制間距 */
        }
        
        /* 右側 (自己) */
        .chat-row.right { justify-content: flex-end; align-items: flex-end; }
        .chat-row.right .chat-bubble {
            background-color: #9de69f;
            color: #0f172a;
            border-radius: 16px 4px 16px 16px;
        }

        .chat-bubble {
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            word-break: break-all;
        }
        
        /* 頭像樣式 */
        .chat-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: white; font-weight: bold;
            flex-shrink: 0;
            margin-top: 2px; /* 稍微對齊 */
        }
        
        /* 時間標籤 */
        .chat-time {
            font-size: 9px;
            color: rgba(255,255,255,0.9); /* 增強對比 */
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .page-content.active { display: block; }
        
        /* 讓行事曆跟待辦頁面都使用 Flex 佈局，解決標題穿透問題 */
        #page-calendar.active, #page-todo.active {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden; /* 隱藏整頁捲軸，改用內部捲軸 */
            padding-top: 70px; /* 避開最上面的 App Header */
            padding-bottom: 90px; /* 避開底部的導航列 */
        }
        
        .nav-item.active { color: #2cc998; } 
        .nav-item.active svg { stroke-width: 2.5px; }

        .tt-input-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tt-input-row:active { background-color: #f9fafb; }
        .tt-icon { color: #9ca3af; margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; }
        
        .modal { transition: opacity 0.2s ease, transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.visible { opacity: 1; pointer-events: auto; transform: scale(1); }

        .custom-checkbox { appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor; width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #2cc998; border-color: #2cc998; }
        .custom-checkbox:checked::before { transform: scale(1); }
        
        .cat-chip { padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; border: 1px solid #e5e7eb; background: white; color: #6b7280; white-space: nowrap; transition: all 0.2s; }
        .cat-chip.active { background: #2cc998; color: white; border-color: #2cc998; box-shadow: 0 2px 5px rgba(44, 201, 152, 0.2); }

        .todo-item { transition: all 0.3s ease; }
        .todo-item.done span { text-decoration: line-through; color: #9ca3af; }

        .dt-btn { background-color: #f9fafb; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; color: #374151; text-align: center; transition: all 0.2s; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .dt-btn:active, .dt-btn:focus { background-color: #fff; border: 1px solid #2cc998; outline: none; }
        .dt-wrapper-date { flex: 2; position: relative; }
        .dt-wrapper-time { flex: 1; position: relative; }

        /* Unified Input Row Styles */
        .dt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dt-row:active { background-color: #f9fafb; }
        
        .dt-label {
            font-size: 15px; 
            font-weight: 500;
            color: #1f2937; 
            min-width: 60px;
        }
        
        .dt-value {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }
        
        .dt-input {
            width: 100%;
            text-align: right;
            font-size: 15px; 
            color: #1f2937;
            outline: none;
            border: none;
            background: transparent;
            padding: 0;
            font-weight: 400;
        }
        .dt-input::placeholder { color: #9ca3af; }
        
        .dt-text-placeholder { color: #9ca3af; font-size: 15px; }
        .dt-text-value { color: #1f2937; font-size: 15px; font-weight: 500; }

        /* Fixed Time Dropdown Modal Style */
        .time-picker-modal-content {
            background: white;
            border-radius: 16px;
            max-height: 300px;
            overflow-y: auto;
            width: 280px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        .time-option { 
            padding: 10px 16px; 
            font-size: 16px; 
            color: #374151; 
            cursor: pointer; 
            text-align: center;
        }
        .time-option:hover { background-color: #f3f4f6; }
        .time-option.selected { color: #2cc998; font-weight: bold; background-color: #ecfdf5; }

        .status-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #6b7280; transition: all 0.2s; }
        .status-btn.active { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; font-weight: bold; }
        .status-btn.active[data-status="confirmed"] { background: #ecfdf5; border-color: #2cc998; color: #2cc998; }
        .status-btn.active[data-status="tbc"] { background: #fffbeb; border-color: #f59e0b; color: #f59e0b; }
        .status-btn.active[data-status="tbd"] { background: #fef2f2; border-color: #ef4444; color: #ef4444; border-style: dashed; }

        .status-tag { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: 1px; line-height: 1.4; flex-shrink: 0; }
        .status-tag.tbc { border: 1px solid #f59e0b; color: #f59e0b; background: #fffbeb; }
        .status-tag.tbd { border: 1px dashed #ef4444; color: #ef4444; background: #fef2f2; }
        
        .recur-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            background: white;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .recur-btn.active {
            background-color: #ecfdf5;
            border-color: #2cc998;
            color: #2cc998;
            font-weight: bold;
        }
        .day-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .day-circle.active {
            background-color: #2cc998;
            border-color: #2cc998;
            color: white;
            font-weight: bold;
        }
        
        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { font-size: 12px; color: #9ca3af; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 50%; cursor: pointer; color: #374151; }
        .cal-day:hover { background-color: #f3f4f6; }
        .cal-day.empty { cursor: default; background: none; }
        .cal-day.selected { background-color: #2cc998; color: white; font-weight: bold; }
        .cal-day.today { color: #2cc998; font-weight: bold; }
        .cal-day:nth-child(7n), .cal-day-header:nth-child(7) { color: #f87171; } 
        .cal-day:nth-child(7n+1), .cal-day-header:nth-child(1) { color: #f87171; } 

        /* === TimeTree 風格月曆樣式 (固定網格版) === */
        .big-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #f0f0f0; /* 頂部邊界 */
        }
        
        .big-cal-cell {
            /* 關鍵：固定高度，讓每個格子一樣大 */
            height: 110px; 
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0; /* 垂直分隔線 */
            padding: 2px 0 0 0; /* 減少內距，爭取空間 */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* 超出範圍隱藏，避免撐開 */
        }

        /* 移除最右邊的線，讓畫面更乾淨 */
        .big-cal-cell:nth-child(7n) {
            border-right: none;
        }

        .big-cal-day-num {
            font-size: 10px; /* 縮小日期數字 */
            color: #374151;
            font-weight: 500;
            text-align: center;
            margin-bottom: 2px;
            height: 20px;
            line-height: 20px;
        }
        
        .big-cal-cell.today .big-cal-day-num {
            background-color: #2cc998;
            color: white;
            border-radius: 50%;
            width: 20px;
            margin: 0 auto 2px auto; /* 居中 */
        }
        
        /* 讓內容區塊變成絕對佈局的容器 */
        .big-cal-content-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1px; /* 行程之間的微小間距 */
        }

        /* 行程條樣式：更扁、文字更小 */
        .event-bar { 
            height: 18px; /* 固定高度 */
            line-height: 18px;
            font-size: 10px; 
            padding: 0 4px; 
            color: white; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            text-align: left; 
            position: relative;
            box-sizing: border-box;
            z-index: 10;
        }

        /* 休假樣式優化 */
        .event-bar.leave {
            background-color: white !important;
            border: 1px solid currentColor;
            font-weight: 800; /* 字加粗 */
            line-height: 16px; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05); /* 加一點點立體感 */
        }

        /* "+N" 的提示改為放在格子底部中央 */
        .more-events { 
            font-size: 9px; 
            color: #9ca3af; 
            text-align: center;
            margin-top: 1px;
        }

        .avatar-sm { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #toast-container { transition: opacity 0.3s ease; }
        #toast-container.visible { opacity: 1; }
        
        /* iOS-like Calendar Picker */
        #calendar-picker-modal .calendar-grid { gap: 6px; min-height: auto; }
        #calendar-picker-modal #calendar-days { min-height: unset; }
        #calendar-picker-modal .cal-day { width: 36px; height: 36px; aspect-ratio: unset; border-radius: 9999px; font-size: 14px; font-weight: 500; transition: background-color 0.15s ease, color 0.15s ease; }
        #calendar-picker-modal .cal-day:hover { background-color: #f2f2f7; }
        #calendar-picker-modal .cal-day.today { color: #2cc998; font-weight: 600; }
        #calendar-picker-modal .cal-day.selected { background-color: #2cc998; color: white; font-weight: 600; }
        #calendar-picker-modal .cal-day.empty { pointer-events: none; background: transparent; }
        #calendar-picker-modal .cal-day-header { font-size: 11px; font-weight: 500; color: #8e8e93; }
        #calendar-picker-modal .relative { padding-bottom: 12px; }
        
        /* iOS Bottom Nav */
        nav .nav-item { padding-bottom: 6px; transition: transform 0.12s ease-out, background-color 0.12s ease-out; border-radius: 12px; -webkit-tap-highlight-color: transparent; position: relative; }
        nav .nav-item i { transition: transform 0.12s ease-out; will-change: transform; }
        nav .nav-item:active i { transform: scale(0.85); }
        nav .nav-item.active i { transform: scale(1.1); }
        nav .nav-item span { transform: none !important; }
        nav .nav-item.active::after { content: ""; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; border-radius: 999px; background-color: var(--active-tab-color, #2cc998); }
    
        /* === 分類標籤樣式 === */
        .category-chip {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .category-chip.active {
            background-color: #ecfdf5;
            color: #2cc998;
            border-color: #2cc998;
            font-weight: bold;
        }

        /* === 聊天室樣式 === */
        #chat-container {
            scroll-behavior: smooth; 
            /* 讓背景有點像聊天軟體 */
            background-color: #9bbbd4; /* LINE 的經典藍底，或者你可以改回 #f0f2f5 灰底 */
        }
        
        .chat-row { display: flex; width: 100%; margin-bottom: 4px; }
        
        /* 對方訊息 (左側) */
        .chat-row.left { justify-content: flex-start; align-items: flex-start; }
        .chat-row.left .chat-bubble {
            background-color: #ffffff;
            color: #1f2937;
            border-radius: 0 16px 16px 16px; /* 左上角尖尖的 */
            margin-left: 6px;
        }
        
        /* 自己訊息 (右側) */
        .chat-row.right { justify-content: flex-end; align-items: flex-end; }
        .chat-row.right .chat-bubble {
            background-color: #9de69f; /* LINE 的綠色氣泡 */
            color: #0f172a;
            border-radius: 16px 0 16px 16px; /* 右上角尖尖的 */
            margin-right: 2px;
        }

        .chat-bubble {
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 75%;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            word-break: break-all;
        }
        
        .chat-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: white; font-weight: bold;
            flex-shrink: 0;
        }
        
        .chat-time {
            font-size: 9px;
            color: #fff; /* 在深色背景上用白色，若是淺色背景用 gray-400 */
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            margin: 0 4px;
            align-self: flex-end;
            margin-bottom: 2px;
            min-width: 25px;
        }
        .chat-row.right .chat-time { text-align: right; }

    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden bg-white">

    <!-- Header -->
    <header class="bg-white border-b border-gray-100 p-4 fixed top-0 w-full z-40 safe-top flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <img src="icon.png" alt="Logo" class="w-9 h-9 rounded-xl shadow-sm">
            <h1 class="text-lg font-bold text-gray-800 tracking-wide">
                小時光 <span class="text-xs text-gray-400 font-normal ml-0.5">for us</span>
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="header-role-badge" class="px-2.5 py-1 rounded-full text-xs text-white font-bold shadow-sm transition-colors duration-300 flex items-center gap-1.5 opacity-0 cursor-pointer hover:opacity-90 active:scale-95 transition-transform" onclick="window.openSettingsModal()">
                <span id="header-role-name">載入中</span>
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>
            <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-red-400 ring-2 ring-white shadow-sm"></div>
        </div>
    </header>

    <!-- Main Content -->
 <main id="main-container">

        <div id="page-dashboard" class="page-content active">
            
            <div class="w-full px-4 mb-4">
                <div id="chat-container" class="bg-[#f0f2f5] border border-gray-200 rounded-xl h-[320px] overflow-y-auto p-3 flex flex-col gap-3 shadow-inner no-scrollbar">
                    <div class="text-center text-xs text-gray-400 mt-4">載入對話中...</div>
                </div>

                <div class="relative z-30 h-10 w-full mt-2">
                    <div class="flex flex-nowrap items-center bg-white rounded-full px-2 py-1 shadow-sm border border-gray-200 focus-within:ring-2 focus-within:ring-ttgreen focus-within:ring-opacity-50 transition-all h-full overflow-hidden">
                        <div class="w-8 h-8 flex items-center justify-center text-gray-300 flex-shrink-0 cursor-pointer" onclick="window.scrollToBottom()">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="note-input" placeholder="傳送訊息..." class="flex-1 min-w-0 bg-transparent border-none text-sm text-gray-700 placeholder-gray-400 focus:ring-0 px-2 outline-none text-left h-full">
                        <button id="note-send-btn" onclick="window.sendNote()" class="w-8 h-8 flex items-center justify-center rounded-full bg-ttgreen text-white shadow-sm active:scale-90 transition ml-1 flex-shrink-0 hover:bg-green-500">
                            <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="px-4 flex gap-3 mb-6">
                <button onclick="window.openAddModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="calendar-plus" class="w-5 h-5 text-ttgreen"></i>
                    <span class="text-sm font-bold">新增行程</span>
                </button>
                <button onclick="window.openAddTodoModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="check-square" class="w-5 h-5 text-blue-400"></i>
                    <span class="text-sm font-bold">新增待辦</span>
                </button>
            </div>

            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4">
                <div class="bg-ttgreen px-4 py-2 flex justify-between items-center">
                <span class="text-white text-xs font-bold tracking-wider">NEXT 3 DAYS</span>
                <button onclick="window.switchTab('calendar')" class="text-white text-xs font-bold hover:bg-white/20 px-2 py-1 rounded transition">查看全部</button>
            </div>
                <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
                    <div class="text-center py-8 text-gray-400 text-sm">載入中...</div>
                </div>
            </div>

            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-ttgreen"></i> 待辦清單
                    </h3>
                    <button onclick="window.switchTab('todo')" class="text-xs text-ttgreen font-medium">查看全部</button>
                </div>
                <div id="dashboard-todo-list" class="space-y-2">
                    <p class="text-xs text-gray-400 text-center py-2">載入中...</p>
                </div>
            </div>
            
        </div> 

        <!-- Page 2: Calendar -->
        <div id="page-calendar" class="page-content">
            <div class="flex-none bg-white z-10 border-b border-gray-200 px-4 flex items-center justify-center h-[60px] relative">
                 <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="window.switchCalendarView('list')" id="btn-view-list" class="w-16 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all">列表</button>
                    <button onclick="window.switchCalendarView('month')" id="btn-view-month" class="w-16 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">月曆</button>
                </div>
                
                <button onclick="window.openAddModal()" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-ttgreen text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-sm active:scale-95 transition hover:bg-green-500">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 relative w-full" id="calendar-view-month">
                <div id="calendar-view-list" class="absolute inset-0 overflow-y-auto">
                    <div id="event-list" class="divide-y divide-gray-100 bg-white">
                        <div class="text-center py-10 text-gray-400 text-sm">載入中...</div>
                    </div>
                </div>
                <div id="calendar-view-month-container" class="absolute inset-0 flex flex-col bg-gray-50 hidden">
                    
                    <div class="flex-none bg-white z-20 shadow-sm relative">
                        <div class="flex justify-between items-center p-3 border-b border-gray-100">
                            <h2 id="big-cal-title" class="text-lg font-bold text-gray-800 pl-2">...</h2>
                            <div class="flex gap-2">
                                <button onclick="window.changeBigCalMonth(-1)" class="p-1.5 rounded-full hover:bg-gray-100 active:bg-gray-200 transition">
                                    <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
                                </button>
                                <button onclick="window.changeBigCalMonth(1)" class="p-1.5 rounded-full hover:bg-gray-100 active:bg-gray-200 transition">
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-7 text-center py-2 bg-white">
                            <div class="big-cal-header text-xs font-bold text-red-400">日</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">一</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">二</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">三</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">四</div>
                            <div class="big-cal-header text-xs font-bold text-gray-500">五</div>
                            <div class="big-cal-header text-xs font-bold text-red-400">六</div>
                        </div>
                    </div>

                    <div id="calendar-scroll-area" class="flex-1 overflow-y-auto relative bg-white w-full">
                        <div id="big-cal-grid" class="big-cal-grid border-t border-gray-100 pb-4"></div>
                        
                        <div class="bg-gray-50 border-t border-gray-200 min-h-[300px] pb-24">
                            <div class="sticky top-0 z-10 px-4 py-2 bg-gray-50/95 backdrop-blur border-b border-gray-200 flex justify-between items-center shadow-sm">
                                <span id="selected-date-label" class="text-sm font-bold text-gray-600">選擇日期查看</span>
                            </div>
            <div id="month-event-list" class="divide-y divide-gray-100 bg-white">
                                </div>
                        </div>
                    </div>
                </div> </div>     </div>         <div id="page-todo" class="page-content">
            
            <div class="flex-none bg-white z-20 border-b border-gray-200 px-4 flex items-center h-[60px] relative shadow-[0_1px_2px_rgba(0,0,0,0.05)]">
                <h2 class="text-xl font-bold text-gray-800">待辦清單</h2>
                
                <button onclick="window.openAddTodoModal()" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-ttgreen text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-sm active:scale-95 transition hover:bg-green-500">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="todo-scroll-area" class="flex-1 overflow-y-auto bg-white w-full relative">
                <div id="todo-category-container" class="p-4 space-y-4 pb-24">
                    <div class="text-center py-10 text-gray-400 text-sm">載入中...</div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modals (All preserved) -->
    
    <!-- Global Color Picker Modal -->
    <div id="global-color-picker" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.toggleGlobalColorPicker(false)"></div>
        <div class="relative bg-white w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">選擇顏色</h3>
            <div id="global-color-grid" class="grid grid-cols-1 gap-1 max-h-[300px] overflow-y-auto"></div>
            <button onclick="window.toggleGlobalColorPicker(false)" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">取消</button>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeSettingsModal()"></div>
        <div class="relative bg-white w-[320px] rounded-2xl shadow-xl overflow-hidden transform scale-100 transition-transform">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">設定</h3>
                <button onclick="window.closeSettingsModal()" class="p-1 rounded-full hover:bg-gray-200 text-gray-400 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-5 space-y-6">
                <div id="role-selection-section" class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">我是誰？ (切換身分)</p>
                    <div class="flex gap-3">
                        <button id="role-haohao" onclick="window.setRole('haohao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">皓皓</button>
                        <button id="role-maomao" onclick="window.setRole('maomao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">毛毛</button>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">代表色設定</p>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('haohao')">
                            <span class="text-sm font-medium text-gray-700">皓皓</span>
                            <div id="setting-color-haohao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('maomao')">
                            <span class="text-sm font-medium text-gray-700">毛毛</span>
                            <div id="setting-color-maomao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('joint')">
                            <span class="text-sm font-medium text-gray-700">共同行程</span>
                            <div id="setting-color-joint" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">首頁摘要顯示設定</p>
                    <p class="text-[10px] text-gray-400 -mt-2 mb-1">關閉的分類將不會出現在首頁，但仍可在待辦清單查看。</p>
                    <div id="settings-category-list" class="bg-gray-50 p-3 rounded-xl border border-gray-100 max-h-[150px] overflow-y-auto space-y-1">
                        <div class="text-center text-xs text-gray-400 py-2">載入中...</div>
                    </div>
                </div>

            </div>
            <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                <span class="text-[10px] text-gray-400">Firebase Connected · v105.0</span>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeConfirmModal()"></div>
        <div class="relative bg-white w-[280px] rounded-xl shadow-xl p-5 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-2">確定刪除？</h3>
            <p class="text-sm text-gray-500 mb-4">此動作無法復原，您確定要刪除這個項目嗎？</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">取消</button>
                <button id="confirm-delete-btn" onclick="window.executeDelete()" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200">刪除</button>            
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[90] pointer-events-none transition-opacity duration-300 opacity-0">
        <div id="toast-message" class="bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur-sm">
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
      <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddModal()"></div>

      <div class="relative bg-white w-full h-full md:h-auto md:w-[380px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
        
        <!-- NEW HEADER: Standard App Style -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
            <button onclick="window.closeAddModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition cursor-pointer">取消</button>
            <span class="text-sm font-bold text-gray-800">行程詳情</span>
            <button onclick="window.saveEvent()" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">保存</button>
        </div>

        <!-- Title -->
        <div class="px-6 pt-4 pb-2">
          <label class="text-xs font-bold text-gray-400 mb-1 block">標題</label>
          <input
            type="text"
            id="input-title"
            placeholder="輸入行程標題"
            class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent"
          />
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">

          <!-- Date / Time / Location Group -->
          <!-- 採用白底、內部有分隔線的列表風格 -->
          <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
             
             <!-- Date -->
             <div class="dt-row" onclick="window.openCalendar('start')">
               <div class="dt-label">開始日期</div>
               <div class="dt-value group">
                 <span id="display-date-start" class="dt-text-placeholder transition-colors">請選擇</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-start">
             </div>

             <!-- Time (Start) -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('start')">
              <div class="dt-label">開始時間</div>
              <div class="dt-value group">
                <span id="display-time-start" class="dt-text-placeholder transition-colors">請選擇</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-start" value="">
            </div>
            
            <!-- Time (End) - New! -->
            <div class="dt-row border-t border-gray-50" onclick="window.openCalendar('end')">
               <div class="dt-label">結束日期</div>
               <div class="dt-value group">
                 <span id="display-date-end" class="dt-text-placeholder transition-colors">請選擇</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-end">
             </div>

            <!-- End Time -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('end')">
              <div class="dt-label">結束時間</div>
              <div class="dt-value group">
                <span id="display-time-end" class="dt-text-placeholder transition-colors">請選擇</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-end" value="">
            </div>

            <!-- Location -->
            <div class="dt-row border-t border-gray-50">
              <div class="dt-label">地點</div>
              <div class="dt-value">
                <input id="input-location" type="text" placeholder="輸入地點" class="dt-input" />
              </div>
            </div>
          </div>

          <!-- Partner -->
          <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
            <span class="text-sm text-gray-700">與對方一起</span>
            <input
              type="checkbox"
              id="check-partner"
              class="custom-checkbox"
              onchange="window.togglePartner()"
            />
          </div>

          <!-- Recurrence (New!) -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
             <div class="flex justify-between items-center mb-3">
                 <span class="text-sm text-gray-700 font-bold">重複設定</span>
                 <input type="checkbox" id="check-recur-event" class="custom-checkbox" onchange="window.toggleRecurOptions('event')">
             </div>
             <div id="recur-options-event" class="hidden space-y-3 pt-2 border-t border-gray-100">
                 <!-- Frequency -->
                 <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                     <button type="button" class="recur-btn active flex-shrink-0" data-val="daily" onclick="window.selectRecurFreq('event', 'daily')">每天</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="weekly" onclick="window.selectRecurFreq('event', 'weekly')">每週</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="biweekly" onclick="window.selectRecurFreq('event', 'biweekly')">每兩週</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="monthly" onclick="window.selectRecurFreq('event', 'monthly')">每月</button>
                     <button type="button" class="recur-btn flex-shrink-0" data-val="yearly" onclick="window.selectRecurFreq('event', 'yearly')">每年</button>
                 </div>
                 
                 <!-- Weekly Days Selector -->
                 <div id="recur-days-row-event" class="flex justify-between hidden">
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="0">日</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="1">一</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="2">二</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="3">三</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="4">四</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="5">五</button>
                     <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="6">六</button>
                 </div>

                 <!-- End Date (Fixed: Custom Picker) -->
                 <div class="dt-row p-0 border-none" onclick="window.openCalendar('recur-event')">
                     <div class="dt-label text-xs text-gray-400">結束重複</div>
                     <div class="dt-value">
                         <span id="display-date-recur-event" class="text-sm text-gray-600 bg-gray-50 rounded px-2 py-1">設定日期</span>
                         <input type="hidden" id="input-date-recur-event">
                     </div>
                 </div>
                 <p class="text-[10px] text-gray-400 text-center">將自動產生至結束日期的行程</p>
             </div>
          </div>

          <!-- Status -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <label class="text-xs font-bold text-gray-400 mb-2 block">狀態</label>
            <div class="flex gap-2">
              <button
                type="button"
                class="status-btn active"
                data-status="confirmed"
                onclick="window.setStatus('confirmed')"
              >已確認</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbc"
                onclick="window.setStatus('tbc')"
              >TBC</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbd"
                onclick="window.setStatus('tbd')"
              >TBD</button>
            </div>
            <input type="hidden" id="input-status" value="confirmed">
          </div>

          <!-- Note -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
            <label class="text-xs font-bold text-gray-400 mb-1 block">備註</label>
            <textarea
              id="input-note"
              rows="3"
              placeholder="簡單備註一下就好"
              class="w-full text-sm bg-transparent focus:outline-none resize-none"
            ></textarea>
          </div>

        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-100 flex justify-center pb-20 md:pb-4">
          <!-- 刪除按鈕 (只在編輯時顯示，全寬紅色按鈕) -->
          <button
            id="btn-delete-event"
            onclick="window.deleteCurrentEvent()"
            class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
          >
            刪除此行程
          </button>
        </div>

      </div>
    </div>

    
    <!-- Add Todo Modal -->
    <div id="add-todo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddTodoModal()"></div>
        <div class="relative bg-white w-full h-full md:h-auto md:w-[350px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
            
            <!-- HEADER: Standard App Style (Unified with Add Event) -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
                <button onclick="window.closeAddTodoModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition cursor-pointer">取消</button>
                <span id="todo-modal-title" class="text-sm font-bold text-gray-800">新增待辦事項</span>
                <button onclick="window.saveTodoItem()" id="todo-modal-btn" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">新增</button>
            </div>

            <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                <!-- Content Input (Unified Style) -->
                <div class="px-2 pt-2 pb-2">
                    <label class="text-xs font-bold text-gray-400 mb-1 block">內容</label>
                    <input type="text" id="todo-input-title" placeholder="輸入待辦事項..." class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent">
                </div>
                <div class="px-2 pt-2 pb-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-400 block">分類標籤</label>
                        <button onclick="window.toggleCustomCategoryInput()" class="text-[10px] text-ttgreen font-bold bg-green-50 px-2 py-0.5 rounded">自訂</button>
                    </div>
                    
                    <div id="todo-category-chips" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        </div>
                    
                    <div id="todo-custom-category-container" class="hidden mt-2 flex gap-2">
                        <input type="text" id="todo-input-category-custom" placeholder="輸入新分類名稱" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-ttgreen">
                    </div>
                    
                    <input type="hidden" id="todo-input-category" value="">
                </div>
                <!-- Date/Time Group (Unified List Style) -->
                <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
                    <!-- Date -->
                    <div class="dt-row" onclick="window.openCalendar('todo')">
                        <div class="dt-label">開始日期</div>
                        <div class="dt-value group">
                            <span id="display-date-todo" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo">
                    </div>
                    
                    <!-- Time (Start) -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo')">
                        <div class="dt-label">開始時間</div>
                        <div class="dt-value group">
                            <span id="display-time-todo" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo">
                    </div>
                    
                    <!-- End Date (New!) -->
                    <div class="dt-row border-t border-gray-50" onclick="window.openCalendar('todo-end')">
                        <div class="dt-label">結束日期</div>
                        <div class="dt-value group">
                            <span id="display-date-todo-end" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo-end">
                    </div>

                    <!-- Time (End) - New! -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo-end')">
                        <div class="dt-label">結束時間</div>
                        <div class="dt-value group">
                            <span id="display-time-todo-end" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo-end">
                    </div>
                </div>

                <!-- Options -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-700">共同待辦 (兩人可見)</span>
                    <input type="checkbox" id="todo-check-joint" class="custom-checkbox">
                </div>

                <!-- Recurrence (New! for Todo) -->
                <div class="bg-white border border-gray-200 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-700 font-bold">重複設定</span>
                        <input type="checkbox" id="check-recur-todo" class="custom-checkbox" onchange="window.toggleRecurOptions('todo')">
                    </div>
                    <div id="recur-options-todo" class="hidden space-y-3 pt-2 border-t border-gray-100">
                        <!-- Frequency -->
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            <button type="button" class="recur-btn active flex-shrink-0" data-val="daily" onclick="window.selectRecurFreq('todo', 'daily')">每天</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="weekly" onclick="window.selectRecurFreq('todo', 'weekly')">每週</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="biweekly" onclick="window.selectRecurFreq('todo', 'biweekly')">每兩週</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="monthly" onclick="window.selectRecurFreq('todo', 'monthly')">每月</button>
                            <button type="button" class="recur-btn flex-shrink-0" data-val="yearly" onclick="window.selectRecurFreq('todo', 'yearly')">每年</button>
                        </div>
                        
                        <!-- Weekly Days Selector -->
                        <div id="recur-days-row-todo" class="flex justify-between hidden">
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="0">日</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="1">一</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="2">二</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="3">三</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="4">四</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="5">五</button>
                            <button type="button" class="day-circle" onclick="window.toggleRecurDay(this)" data-d="6">六</button>
                        </div>

                        <!-- End Date (Fixed: Custom Picker) -->
                        <div class="dt-row p-0 border-none" onclick="window.openCalendar('recur-todo')">
                            <div class="dt-label text-xs text-gray-400">結束重複</div>
                            <div class="dt-value">
                                <span id="display-date-recur-todo" class="text-sm text-gray-600 bg-gray-50 rounded px-2 py-1">設定日期</span>
                                <input type="hidden" id="input-date-recur-todo">
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 text-center">將自動產生至結束日期的待辦</p>
                    </div>
                </div>
            </div>

            <!-- Footer (Delete Button - Unified Style) -->
            <div class="p-4 border-t border-gray-100 flex justify-center pb-20 md:pb-4">
                 <button
                    id="btn-delete-todo"
                    onclick="window.deleteCurrentTodo()"
                    class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
                  >
                    刪除此待辦
                  </button>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div id="time-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
         <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeTimePicker()"></div>
         <div id="time-list-container" class="relative time-picker-modal-content flex flex-col">
             <!-- Time slots will be populated here -->
         </div>
    </div>

    <!-- Dropdowns & Pickers -->
    <div id="calendar-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCalendar()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl w-[320px] p-4 overflow-hidden max-h-[420px]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cal-month-title" class="text-lg font-bold text-gray-800 tracking-wide cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition">...</h3>
                <div class="flex gap-1"><button onclick="window.changeCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><button onclick="window.changeCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-red-400">日</div><div class="cal-day-header">一</div><div class="cal-day-header">二</div><div class="cal-day-header">三</div><div class="cal-day-header">四</div><div class="cal-day-header">五</div><div class="cal-day-header text-red-400">六</div>
            </div>

            <div id="calendar-days" class="calendar-grid"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-sm font-medium">
                <button onclick="window.selectToday()" class="text-ttgreen hover:bg-green-50 px-3 py-1.5 rounded-lg transition">今天</button>
                <div class="flex gap-2">
                    <button onclick="window.clearDate()" class="text-red-400 hover:bg-red-50 px-3 py-1.5 rounded-lg transition">清除</button>
                    <button onclick="window.closeCalendar()" class="text-gray-400 hover:bg-gray-50 px-3 py-1.5 rounded-lg transition">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav (3 Items only) -->
            <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 px-4 pt-2 pb-6 flex justify-around items-center z-50 pb-safe transition-all duration-300">
            
            <button onclick="window.switchTab('dashboard')" class="nav-btn active group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="dashboard">
                <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:bg-ttgreen group-[.active]:text-white text-gray-400">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:text-ttgreen group-[.active]:font-bold text-gray-400">摘要</span>
            </button>

            <button onclick="window.switchTab('calendar')" class="nav-btn group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="calendar">
                <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:bg-ttgreen group-[.active]:text-white text-gray-400">
                    <i data-lucide="calendar" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:text-ttgreen group-[.active]:font-bold text-gray-400">行事曆</span>
            </button>

            <button onclick="window.switchTab('todo')" class="nav-btn group flex flex-col items-center justify-center w-16 h-full transition-all" data-tab="todo">
                 <div class="nav-icon-pill p-1.5 rounded-full transition-all duration-300 group-[.active]:bg-ttgreen group-[.active]:text-white text-gray-400">
                    <i data-lucide="check-square" class="w-6 h-6 transition-transform duration-300 group-active:scale-95"></i>
                </div>
                <span class="text-[10px] font-medium mt-1 transition-all duration-300 group-[.active]:text-ttgreen group-[.active]:font-bold text-gray-400">待辦</span>
            </button>

            </nav>

    <script>

        // === 新增：待辦分類顯示設定 (預設全部顯示，false 代表隱藏) ===
        window.todoCategoryVisibility = JSON.parse(localStorage.getItem('todo_category_visibility') || '{}');

       /* ===== STABLE PATCH: SafeRun Helper ===== */
        window.safeRun = function (fn, label = 'unknown') {
        try {
            return fn();
        } catch (err) {
            console.error(`[SafeRun:${label}]`, err);
            if (window.showToast) {
            window.showToast('發生錯誤，但 App 仍可使用');
            }
            return null;
        }
        };
        // --- 1. VARIABLES ---
        /* ===== STABLE PATCH: Firestore Listener Guard ===== */
        const snapshotRegistry = {};

        function bindSnapshot(ref, cb, label = 'snapshot') {
        if (snapshotRegistry[label]) return; // 已綁過

        const unsub = ref.onSnapshot(
            snap => window.safeRun(() => cb(snap), label),
            err => console.error(`[Firestore:${label}]`, err)
        );

        snapshotRegistry[label] = unsub;
        }


        const firebaseConfig = { apiKey: "AIzaSyDLrPr4X6r3e2V_vqFaCICgKVwLmiykxpc", authDomain: "kyle-mao.firebaseapp.com", projectId: "kyle-mao", storageBucket: "kyle-mao.firebasestorage.app", messagingSenderId: "290564848532", appId: "1:290564848532:web:006c4e9df4b1330895ad81" };
        let db; try { if(typeof firebase!=='undefined'){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}

        // 修改：移除預設值，若沒存過就是 null
        let currentUserRole = localStorage.getItem('user_role'); 
        let currentSelectedColor = '#2cc998'; 
        let currentCategory = 'default';
        let editingEventId = null;
        let editingTodoId = null;
        let allEventsCache = [];
        let isSavingEvent = false;
        let __lastSaveAt = 0;
        let allTodosCache = [];
        // 修改：優先從 localStorage 讀取顏色，若沒有才使用預設值
        let roleColors = { 
            haohao: localStorage.getItem('color_haohao') || '#2cc998', 
            maomao: localStorage.getItem('color_maomao') || '#e6688d', 
            joint: localStorage.getItem('color_joint') || '#f7b546' 
        };
        let colorPickerTarget = null;
        let calTargetInput = 'start'; 
        let calCurrentDate = new Date(); 
        let bigCalDate = new Date();
        let currentViewMode = 'list';
        let timePickerTarget = ''; // FIX: variable for time picker
        let deleteTarget = 'event'; // 'event' or 'todo'
        let noteToDelete = null;
        
        // Recurrence Variables
        let currentRecurFreq = { event: 'daily', todo: 'daily' };

        const timeTreeColors = [ { name: "Emerald Green", hex: "#2cc998" }, { name: "Modern Cyan", hex: "#5cc2d1" }, { name: "Deep Sky Blue", hex: "#5ba3eb" }, { name: "Pastel Brown", hex: "#a68b75" }, { name: "Midnight Black", hex: "#333333" }, { name: "Apple Red", hex: "#e35651" }, { name: "French Rose", hex: "#e6688d" }, { name: "Coral Pink", hex: "#f29074" }, { name: "Bright Orange", hex: "#f7b546" }, { name: "Soft Violet", hex: "#9f82d1" } ];
        const moodMap = { 'charging': { icon: '⚡️', bg: 'bg-yellow-100', border: 'border-yellow-300' }, 'sleepy': { icon: '💤', bg: 'bg-blue-100', border: 'border-blue-300' }, 'love': { icon: '❤️', bg: 'bg-rose-100', border: 'border-rose-300' }, 'busy': { icon: '🔥', bg: 'bg-orange-100', border: 'border-orange-300' }, 'normal': { icon: '😶', bg: 'bg-gray-50', border: 'border-gray-100' } };

        // --- 2. GLOBAL FUNCTION DEFINITIONS (Assigned to window immediately) ---

        function isLeaveEvent(title) {
            if (!title) return false;
            return title.includes('休假') || title.includes('請假');
        }
        
        function hideBubble(bubbleEl, dotEl, timeEl, role) {
            bubbleEl.classList.add('opacity-0');
            if (role === 'haohao') bubbleEl.classList.add('-translate-x-2'); else bubbleEl.classList.add('translate-x-2');
            if(dotEl) dotEl.classList.add('hidden');
            if(timeEl) timeEl.classList.add('opacity-0', 'hidden'); 
            setTimeout(() => { bubbleEl.classList.add('hidden'); }, 300);
        }

        window.renderNoteBubble = function(role, data) {
            const bubbleId = `note-bubble-${role}`; const textId = `note-text-${role}`; const dotId = `status-dot-${role}`; const timeId = `note-time-${role}`; 
            const bubbleEl = document.getElementById(bubbleId); const textEl = document.getElementById(textId); const dotEl = document.getElementById(dotId); const timeEl = document.getElementById(timeId);
            if (!bubbleEl || !textEl) return;
            if (!data || !data.text || !data.timestamp) { hideBubble(bubbleEl, dotEl, timeEl, role); return; }
            const now = new Date(); const noteTime = new Date(data.timestamp); const diffHours = (now - noteTime) / (1000 * 60 * 60);
            if (diffHours < 24) {
                textEl.textContent = data.text;
                if(timeEl) { timeEl.textContent = window.getRelativeTimeStr(data.timestamp); timeEl.classList.remove('hidden'); timeEl.classList.remove('opacity-0'); }
                bubbleEl.classList.remove('hidden'); if(dotEl) dotEl.classList.remove('hidden');
                requestAnimationFrame(() => { bubbleEl.classList.remove('opacity-0'); if (role === 'haohao') { bubbleEl.classList.remove('-translate-x-2'); } else { bubbleEl.classList.remove('translate-x-2'); } });
            } else { hideBubble(bubbleEl, dotEl, timeEl, role); }
        };
        
        window.getRelativeTimeStr = function(timestamp) {
            const now = new Date(); const date = new Date(timestamp); const diffMs = now - date; const diffMins = Math.floor(diffMs / (1000 * 60)); const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffMins < 1) return '剛剛'; if (diffMins < 60) return `${diffMins}分鐘前`; if (diffHours < 24) return `${diffHours}小時前`; return '1天前';
        };

        window.toggleRecurOptions = function(type) {
            const check = document.getElementById(`check-recur-${type}`);
            const options = document.getElementById(`recur-options-${type}`);
            if(check.checked) {
                options.classList.remove('hidden');
                // Set default end date to 3 months from now
                const end = new Date();
                end.setMonth(end.getMonth() + 3);
                const dateStr = end.toISOString().split('T')[0];
                document.getElementById(`input-date-recur-${type}`).value = dateStr;
                window.updateDateDisplay(`recur-${type}`, dateStr);
            } else {
                options.classList.add('hidden');
            }
        };

        window.selectRecurFreq = function(type, freq) {
            currentRecurFreq[type] = freq;
            const container = document.getElementById(`recur-options-${type}`);
            const buttons = container.querySelectorAll('.recur-btn');
            buttons.forEach(b => {
                if(b.dataset.val === freq) b.classList.add('active');
                else b.classList.remove('active');
            });
            
            // Show/Hide Days Selector for Weekly/Biweekly
            const daysRow = document.getElementById(`recur-days-row-${type}`);
            if(freq === 'weekly' || freq === 'biweekly') {
                daysRow.classList.remove('hidden');
            } else {
                daysRow.classList.add('hidden');
            }
        };

        window.toggleRecurDay = function(el) {
            el.classList.toggle('active');
        };

        // Utility: Generate recurring dates
        window.generateRecurringDates = function(startDateStr, endDateStr, freq, selectedDays) {
            const dates = [];
            let current = new Date(startDateStr);
            const end = new Date(endDateStr);
            const startDay = current.getDate();
            const startMonth = current.getMonth();
            
            // Safety: max 100 events to prevent browser hang
            let limit = 100; 
            
            // Bi-weekly logic: Calculate week difference from start
            const getWeekDiff = (d1, d2) => {
                const oneJan = new Date(d1.getFullYear(), 0, 1);
                // Simple approximation is enough for parity check if consistent
                return Math.floor((d2 - d1) / (7 * 24 * 60 * 60 * 1000));
            };

            while(current <= end && limit > 0) {
                let addIt = false;
                
                if (freq === 'daily') {
                    addIt = true;
                } else if (freq === 'weekly') {
                    // Check if current day is in selectedDays
                    if (selectedDays.includes(current.getDay())) addIt = true;
                } else if (freq === 'biweekly') {
                    // Check week parity relative to start
                    const weekDiff = getWeekDiff(new Date(startDateStr), current);
                    if (weekDiff % 2 === 0 && selectedDays.includes(current.getDay())) {
                        addIt = true;
                    }
                } else if (freq === 'monthly') {
                    if (current.getDate() === startDay) addIt = true;
                } else if (freq === 'yearly') {
                    if (current.getMonth() === startMonth && current.getDate() === startDay) addIt = true;
                }

                if (addIt) {
                    dates.push(new Date(current));
                    limit--;
                }

                // Increment
                if(freq === 'monthly') {
                    current.setMonth(current.getMonth() + 1);
                } else if (freq === 'yearly') {
                    current.setFullYear(current.getFullYear() + 1);
                } else {
                    // Daily, Weekly, Biweekly -> Increment by day to catch multiple days/week
                    current.setDate(current.getDate() + 1);
                }
            }
            return dates;
        };

        // --- IMPORTANT: Modal Closing Functions Defined Globally Here ---
        
        window.closeAddModal = function() {
          window.__savingEvent = false;
          const m = document.getElementById('add-modal');
          if(m) {
              m.classList.remove('visible');
              setTimeout(() => m.classList.add('hidden'), 200);
          }
        };

        window.closeAddTodoModal = function() { 
            const m = document.getElementById('add-todo-modal'); 
            if(m) {
                m.classList.remove('visible'); 
                setTimeout(()=>m.classList.add('hidden'),200); 
            }
        };

        // --- Core Action Functions Moved Up ---
        
        window.openAddModal = function () {
          if (!window.checkRoleEnforcement()) return;
          editingEventId = null;
          document.getElementById('input-title').value = '';
          document.getElementById('input-note').value = '';
          document.getElementById('input-date-start').value = '';
          const dD = document.getElementById('display-date-start'); dD.textContent = '請選擇'; dD.classList.add('dt-text-placeholder'); dD.classList.remove('dt-text-value');
          const t = document.getElementById('input-time-start'); if (t) t.value = '';
          const td = document.getElementById('display-time-start'); if (td) { td.textContent = '請選擇'; td.classList.add('dt-text-placeholder'); td.classList.remove('dt-text-value'); }
          const de = document.getElementById('input-date-end'); if (de) de.value = '';
          const dde = document.getElementById('display-date-end'); if (dde) { dde.textContent = '請選擇'; dde.classList.add('dt-text-placeholder'); dde.classList.remove('dt-text-value'); }
          const te = document.getElementById('input-time-end'); if (te) te.value = '';
          const tde = document.getElementById('display-time-end'); if (tde) { tde.textContent = '請選擇'; tde.classList.add('dt-text-placeholder'); tde.classList.remove('dt-text-value'); }
          const loc = document.getElementById('input-location'); if (loc) loc.value = '';
          const partner = document.getElementById('check-partner'); partner.checked = false;
          
          document.getElementById('check-recur-event').checked = false; window.toggleRecurOptions('event');
          window.selectRecurFreq('event', 'daily'); document.querySelectorAll('.day-circle').forEach(b => b.classList.remove('active'));
          window.setStatus('confirmed');
          currentSelectedColor = roleColors[currentUserRole]; colorPickerTarget = 'event';
          const delBtn = document.getElementById('btn-delete-event'); if(delBtn) delBtn.classList.add('hidden');
          const m = document.getElementById('add-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10);
          
          window.updateParticipantsPreview();
        };

        window.openEditModal = function (id) {
          const evt = allEventsCache.find(e => e.id === id);
          if (!evt) { window.showToast('找不到行程'); return; }
          editingEventId = id;
          document.getElementById('input-title').value = evt.title || '';
          if (evt.startDate) { document.getElementById('input-date-start').value = evt.startDate; window.updateDateDisplay('start', evt.startDate); } 
          else if (evt.timestamp) { const d = new Date(evt.timestamp); const ds = d.toISOString().split('T')[0]; document.getElementById('input-date-start').value = ds; window.updateDateDisplay('start', ds); }
          const timeInput = document.getElementById('input-time-start');
          if (evt.allDay) { timeInput.value = ''; window.updateTimeDisplay('start', ''); window.updateTimeDisplay('end', ''); } 
          else if (evt.timestamp) { const d = new Date(evt.timestamp); const hours = d.getHours().toString().padStart(2, '0'); const minutes = d.getMinutes().toString().padStart(2, '0'); const timeStr = `${hours}:${minutes}`; timeInput.value = timeStr; window.updateTimeDisplay('start', timeStr); }
          if (evt.endDate) { document.getElementById('input-date-end').value = evt.endDate; window.updateDateDisplay('end', evt.endDate); } 
          else { const sD = document.getElementById('input-date-start').value; document.getElementById('input-date-end').value = sD; window.updateDateDisplay('end', sD); }
          if (evt.endTime) { document.getElementById('input-time-end').value = evt.endTime; window.updateTimeDisplay('end', evt.endTime); } 
          else { document.getElementById('input-time-end').value = ''; window.updateTimeDisplay('end', ''); }
          document.getElementById('input-location').value = evt.location || '';
          const partner = document.getElementById('check-partner'); partner.checked = !!evt.isJoint;
          window.setStatus(evt.status || 'confirmed');
          document.getElementById('input-note').value = evt.note || '';
          document.getElementById('check-recur-event').checked = false; window.toggleRecurOptions('event');
          currentSelectedColor = evt.color || roleColors[evt.creator] || roleColors[currentUserRole]; colorPickerTarget = 'event';
          const delBtn = document.getElementById('btn-delete-event'); if(delBtn) delBtn.classList.remove('hidden');
          const m = document.getElementById('add-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10);
          
          window.updateParticipantsPreview();
        };

        window.openAddTodoModal = function() { 
            // === 加入這行 ===
            if (!window.checkRoleEnforcement()) return;
            // ===============
            editingTodoId = null; document.getElementById('todo-modal-title').textContent = '新增待辦事項'; document.getElementById('todo-modal-btn').textContent = '新增'; document.getElementById('todo-input-title').value = ''; document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; 
            const dd = document.getElementById('display-date-todo'); dd.textContent = '請選擇'; dd.classList.add('dt-text-placeholder'); dd.classList.remove('dt-text-value');
            const dt = document.getElementById('display-time-todo'); dt.textContent = '請選擇'; dt.classList.add('dt-text-placeholder'); dt.classList.remove('dt-text-value');
            
            // Reset End Date
            document.getElementById('input-date-todo-end').value = '';
            const dde = document.getElementById('display-date-todo-end');
            dde.textContent = '請選擇'; dde.classList.add('dt-text-placeholder'); dde.classList.remove('dt-text-value');

            // Reset End Time
            document.getElementById('input-time-todo-end').value = '';
            const dte = document.getElementById('display-time-todo-end');
            dte.textContent = '請選擇'; dte.classList.add('dt-text-placeholder'); dte.classList.remove('dt-text-value');

            // FIX: 移除了對不存在元素 'todo-check-calendar' 的引用
            document.getElementById('todo-check-joint').checked = false; 
            
            // Reset recurrence
            document.getElementById('check-recur-todo').checked = false;
            window.toggleRecurOptions('todo');
            window.selectRecurFreq('todo', 'daily');
            document.querySelectorAll('.day-circle').forEach(b => b.classList.remove('active'));
            
            const btn=document.getElementById('btn-delete-todo'); if(btn) btn.classList.add('hidden'); const m = document.getElementById('add-todo-modal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); 
        };

        window.openEditTodoModal = function(id) { 
            editingTodoId = id; 
            const todo = allTodosCache.find(t => t.id === id); 
            if(!todo) return; 
            document.getElementById('todo-modal-title').textContent = '編輯待辦事項'; 
            document.getElementById('todo-modal-btn').textContent = '儲存'; 
            document.getElementById('todo-input-title').value = todo.title; 
            if(todo.dueDate) { 
                document.getElementById('input-date-todo').value = todo.dueDate; 
                window.updateDateDisplay('todo', todo.dueDate); 
            } else { 
                document.getElementById('input-date-todo').value = ''; 
                window.updateDateDisplay('todo', ''); 
            } 
            if(todo.dueTime) { 
                document.getElementById('input-time-todo').value = todo.dueTime; 
                window.updateTimeDisplay('todo', todo.dueTime); 
            } else { 
                document.getElementById('input-time-todo').value = ''; 
                window.updateTimeDisplay('todo', ''); 
            }

            // End Date
            if (todo.dueDateEnd) {
                document.getElementById('input-date-todo-end').value = todo.dueDateEnd;
                window.updateDateDisplay('todo-end', todo.dueDateEnd);
            } else {
                // Default to start date if existing
                const sD = document.getElementById('input-date-todo').value;
                document.getElementById('input-date-todo-end').value = sD;
                window.updateDateDisplay('todo-end', sD);
            }

            // End Time
            if (todo.dueTimeEnd) {
                document.getElementById('input-time-todo-end').value = todo.dueTimeEnd;
                window.updateTimeDisplay('todo-end', todo.dueTimeEnd);
            } else {
                document.getElementById('input-time-todo-end').value = '';
                window.updateTimeDisplay('todo-end', '');
            }

            document.getElementById('todo-check-joint').checked = todo.isJoint; 
            
            // Edit mode: Hide recurrence options
            document.getElementById('check-recur-todo').checked = false;
            window.toggleRecurOptions('todo');
            
            const btn=document.getElementById('btn-delete-todo'); 
            if(btn) btn.classList.remove('hidden'); 
            const m = document.getElementById('add-todo-modal'); 
            m.classList.remove('hidden'); 
            setTimeout(()=>m.classList.add('visible'),10); 
        };

        window.saveEvent = function () {
          if (!db) { window.showToast('資料庫尚未連線'); return; }
          if (window.__savingEvent) return;
          window.__savingEvent = true;

          const saveBtn = document.querySelector('#add-modal button[onclick="window.saveEvent()"]');
          if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = '儲存中…'; saveBtn.classList.add('opacity-60'); }

          try {
            const title = document.getElementById('input-title').value.trim();
            if (!title) { window.showToast('請填寫標題'); throw new Error('Missing title'); }

            const startDate = document.getElementById('input-date-start').value;
            if (!startDate) { window.showToast('請選擇日期'); throw new Error('Missing date'); }

            let endDate = document.getElementById('input-date-end').value;
            if (!endDate) endDate = startDate;

            const time = document.getElementById('input-time-start').value || '00:00'; 
            const timestamp = new Date(`${startDate}T${time}:00`).toISOString();
            const isAllDay = !document.getElementById('input-time-start').value;
            const endTime = document.getElementById('input-time-end').value || '';

            const baseData = {
              title, allDay: isAllDay, isJoint: document.getElementById('check-partner').checked || false,
              status: document.getElementById('input-status').value || 'confirmed',
              note: document.getElementById('input-note').value || '',
              creator: currentUserRole, color: currentSelectedColor,
              location: document.getElementById('input-location').value || '',
              endDate: endDate, endTime: endTime, createdAt: new Date().toISOString()
            };

            const isRecur = document.getElementById('check-recur-event').checked;
            
            if (editingEventId && !isRecur) {
                db.collection('events').doc(editingEventId).update({ ...baseData, startDate, timestamp })
                .then(() => { window.showToast('行程已儲存'); window.closeAddModal(); })
                .catch(err => { console.error(err); window.showToast('儲存失敗'); })
                .finally(() => { window.__savingEvent = false; if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = '保存'; saveBtn.classList.remove('opacity-60'); } });
            } else {
                let batchEvents = [];
                if (isRecur) {
                    const recurEndDateStr = document.getElementById('input-date-recur-event').value;
                    if (!recurEndDateStr) { window.showToast('請選擇重複結束日期'); throw new Error('Missing end date'); }
                    const dayBtns = document.querySelectorAll('#recur-days-row-event .day-circle.active');
                    const selectedDays = Array.from(dayBtns).map(b => parseInt(b.dataset.d));
                    const dateList = window.generateRecurringDates(startDate, recurEndDateStr, currentRecurFreq.event, selectedDays);
                    if (dateList.length === 0) { window.showToast('區間內沒有符合的日期'); throw new Error('No dates generated'); }
                    const groupId = crypto.randomUUID(); 
                    const startObj = new Date(startDate);
                    const endObj = new Date(endDate);
                    const durationMs = endObj - startObj;
                    const durationDays = Math.round(durationMs / (1000 * 60 * 60 * 24));

                    batchEvents = dateList.map(d => {
                        const dStr = d.toISOString().split('T')[0];
                        const ts = new Date(`${dStr}T${time}:00`).toISOString();
                        const newEndObj = new Date(d);
                        newEndObj.setDate(newEndObj.getDate() + durationDays);
                        const newEndDateStr = newEndObj.toISOString().split('T')[0];
                        return { ...baseData, startDate: dStr, endDate: newEndDateStr, timestamp: ts, groupId: groupId };
                    });
                } else {
                    batchEvents.push({ ...baseData, startDate, timestamp });
                }
                Promise.all(batchEvents.map(evt => db.collection('events').add(evt)))
                .then(() => { const msg = isRecur ? `已建立 ${batchEvents.length} 個重複行程` : '行程已儲存'; window.showToast(msg); window.closeAddModal(); })
                .catch(err => { console.error(err); window.showToast('儲存失敗'); })
                .finally(() => { window.__savingEvent = false; if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = '保存'; saveBtn.classList.remove('opacity-60'); } });
            }
          } catch (err) {
            window.__savingEvent = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = '保存'; saveBtn.classList.remove('opacity-60'); }
          }
        };

        window.saveTodoItem = function() {
            if (window.isSavingTodo) return;
            const title = document.getElementById('todo-input-title').value.trim();
            if (!title) { window.showToast('請輸入內容'); return; }
            
            // === 修改重點：取得分類 ===
            let category = document.getElementById('todo-input-category').value;
            const customCat = document.getElementById('todo-input-category-custom').value.trim();
            
            // 如果有輸入自訂分類，優先使用，並存入 localStorage
            if (customCat) {
                category = customCat;
                if (!customCategories.includes(customCat)) {
                    customCategories.push(customCat);
                    localStorage.setItem('my_custom_categories', JSON.stringify(customCategories));
                }
            }
            // ========================

            window.isSavingTodo = true;
            const btn = document.getElementById('todo-modal-btn');
            const originalText = btn ? btn.textContent : '儲存';
            if (btn) { btn.textContent = '儲存中...'; btn.style.opacity = '0.5'; }

            const date = document.getElementById('input-date-todo').value || null;
            const time = document.getElementById('input-time-todo').value || null;
            const isJoint = document.getElementById('todo-check-joint').checked;
            const isRecur = document.getElementById('check-recur-todo').checked;
            let dateEnd = document.getElementById('input-date-todo-end').value || null;
            if (date && !dateEnd) dateEnd = date;
            const timeEnd = document.getElementById('input-time-todo-end').value || null;
            const addToCalendar = !!date; 

            // === 修改重點：加入 category 欄位 ===
            const baseData = {
                title, done: false, creator: currentUserRole, isJoint: isJoint, addToCalendar: addToCalendar,
                category: category, // <--- 存入資料庫
                dueDate: date, dueTime: (date && time) ? time : null,
                dueDateEnd: dateEnd, dueTimeEnd: (date && timeEnd) ? timeEnd : null, 
                timestamp: null, createdAt: new Date().toISOString() 
            };
            
            if (date) {
                const tStr = time || "00:00";
                try { baseData.timestamp = new Date(`${date}T${tStr}`).toISOString(); } catch(e){}
            }

            const finish = (msg) => {
                if (typeof window.closeAddTodoModal === 'function') window.closeAddTodoModal();
                window.showToast(msg); window.isSavingTodo = false;
                if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; }
            };
            const onError = (err) => {
                console.error("Save Error:", err); window.showToast('儲存失敗'); window.isSavingTodo = false;
                if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; }
            };

            if (editingTodoId && !isRecur) {
                db.collection('todos').doc(editingTodoId).update(baseData).then(() => finish('待辦事項已更新')).catch(onError);
            } else if (!isRecur) {
                db.collection('todos').add(baseData).then(() => finish('待辦事項已新增')).catch(onError);
            } else {
                if (!date) { window.showToast('重複待辦需要設定開始日期'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const endDateStr = document.getElementById('input-date-recur-todo').value;
                if (!endDateStr) { window.showToast('請選擇重複結束日期'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const dayBtns = document.querySelectorAll('#recur-days-row-todo .day-circle.active');
                const selectedDays = Array.from(dayBtns).map(b => parseInt(b.dataset.d));
                const dateList = window.generateRecurringDates(date, endDateStr, currentRecurFreq.todo, selectedDays);
                if (dateList.length === 0) { window.showToast('區間內沒有符合的日期'); window.isSavingTodo = false; if (btn) { btn.textContent = originalText; btn.style.opacity = '1'; } return; }
                const groupId = crypto.randomUUID();
                const startObj = new Date(date);
                const endObj = new Date(dateEnd);
                const durationMs = endObj - startObj;
                const durationDays = Math.round(durationMs / (1000 * 60 * 60 * 24));
                const batchEvents = dateList.map(d => {
                    const dStr = d.toISOString().split('T')[0];
                    let ts = null;
                    if(time) ts = new Date(`${dStr}T${time}`).toISOString(); else ts = new Date(`${dStr}T00:00`).toISOString();
                    const newEndObj = new Date(d);
                    newEndObj.setDate(newEndObj.getDate() + durationDays);
                    const newEndDateStr = newEndObj.toISOString().split('T')[0];
                    return { ...baseData, dueDate: dStr, dueDateEnd: newEndDateStr, timestamp: ts, groupId: groupId };
                });
                Promise.all(batchEvents.map(evt => db.collection('todos').add(evt))).then(() => finish(`已建立 ${batchEvents.length} 個重複待辦`)).catch(onError);
            }
        };

        window.confirmDeleteNote = function(role) {
            if (!window.checkRoleEnforcement()) return;
            deleteTarget = 'note';
            noteToDelete = role;
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = '刪除心情？';
            if(desc) desc.textContent = '確定要刪除這則留言嗎？';
            window.confirmDelete();
        };

        // === 補上：從列表直接刪除待辦 ===
        window.deleteTodo = function(id) {
            // 設定要刪除的 ID (讓 executeDelete 知道要刪誰)
            editingTodoId = id;
            deleteTarget = 'todo';

            // 設定確認視窗的文字
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = '刪除待辦？';
            if(desc) desc.textContent = '確定要刪除這個待辦事項嗎？';

            // 打開確認視窗
            window.confirmDelete();
        };

        window.deleteNote = function(role) {
            if (!window.checkRoleEnforcement()) return;
            const bubbleEl = document.getElementById(`note-bubble-${role}`); if(bubbleEl) bubbleEl.classList.add('hidden');
            const dotEl = document.getElementById(`status-dot-${role}`); if(dotEl) dotEl.classList.add('hidden');
            const timeEl = document.getElementById(`note-time-${role}`); if(timeEl) timeEl.classList.add('hidden');
            db.collection('notes').doc(role).delete().then(() => { window.showToast('心情已刪除 💨'); }).catch(err => { console.error(err); window.showToast('刪除失敗'); });
        };
        
        // === 優化版：發送心情留言 ===
        window.sendNote = function() {
            if (!window.checkRoleEnforcement()) return;
            
            const input = document.getElementById('note-input');
            const btn = document.getElementById('note-send-btn');
            const text = input.value.trim();
            
            if (!text) {
                window.showToast('請輸入內容 💬');
                input.focus();
                return;
            }

            // 鎖定 UI
            input.disabled = true;
            btn.classList.add('opacity-50');

            const data = {
                text: text,
                timestamp: new Date().toISOString(),
                creator: currentUserRole
            };

            // 改用 .add() 新增到 messages 集合
            db.collection('messages').add(data)
                .then(() => {
                    input.value = '';
                    window.showToast('已傳送');
                    window.scrollToBottom();
                })
                .catch((error) => {
                    console.error("Error: ", error);
                    window.showToast('傳送失敗');
                })
                .finally(() => {
                    input.disabled = false;
                    btn.classList.remove('opacity-50');
                    input.focus();
                });
        };

        // === 補上：點擊頭像聚焦輸入框 ===
        window.setNoteInputFocus = function() {
            if (!window.checkRoleEnforcement()) return;
            const el = document.getElementById('note-input');
            if (el) {
                el.focus();
                // 稍微震動一下手機 (如果有支援)
                if (navigator.vibrate) navigator.vibrate(5);
            }
        };

        window.syncNoteAvatarColors = function() { 
            const h = document.getElementById('avatar-note-haohao'); 
            const m = document.getElementById('avatar-note-maomao'); 
            if(h) h.style.backgroundColor = roleColors.haohao; 
            if(m) m.style.backgroundColor = roleColors.maomao; 
        };

        window.openCalendar = function(type) {
            calTargetInput = type;
            const val = document.getElementById(`input-date-${type}`).value;
            if (val) calCurrentDate = new Date(val);
            else calCurrentDate = new Date();
            window.renderCalendarPicker();
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeCalendar = function() {
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.changeCalMonth = function(delta) {
            calCurrentDate.setMonth(calCurrentDate.getMonth() + delta);
            window.renderCalendarPicker();
        };

        window.renderCalendarPicker = function() {
            const y = calCurrentDate.getFullYear();
            const m = calCurrentDate.getMonth();
            document.getElementById('cal-month-title').textContent = `${y}年${m + 1}月`;
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;
            const todayStr = new Date().toDateString();
            const inputVal = document.getElementById(`input-date-${calTargetInput}`).value;
            const selectedDateStr = inputVal ? new Date(inputVal).toDateString() : '';
            for (let d = 1; d <= daysInMonth; d++) {
                const thisDate = new Date(y, m, d);
                const thisDateStr = thisDate.toDateString();
                let classes = "cal-day";
                if (thisDateStr === todayStr) classes += " today";
                if (thisDateStr === selectedDateStr) classes += " selected";
                const el = document.createElement('div');
                el.className = classes;
                el.textContent = d;
                el.onclick = () => window.selectDate(y, m, d);
                grid.appendChild(el);
            }
        };

        window.selectDate = function(y, m, d) {
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            document.getElementById(`input-date-${calTargetInput}`).value = dateStr;
            window.updateDateDisplay(calTargetInput, dateStr);
            if (calTargetInput === 'start') {
                const endInput = document.getElementById('input-date-end');
                if (endInput && !endInput.value) { endInput.value = dateStr; window.updateDateDisplay('end', dateStr); }
                if(window.autoUpdateEnd) window.autoUpdateEnd(); 
            } else if (calTargetInput === 'todo') {
                 const endInput = document.getElementById('input-date-todo-end');
                 if (endInput && !endInput.value) { endInput.value = dateStr; window.updateDateDisplay('todo-end', dateStr); }
            }
            window.closeCalendar();
        };

        window.selectToday = function() {
            const now = new Date();
            window.selectDate(now.getFullYear(), now.getMonth(), now.getDate());
        };

        window.openTimePicker = function(type) {
            timePickerTarget = type;
            const container = document.getElementById('time-list-container');
            container.innerHTML = '';
            const currentVal = document.getElementById(`input-time-${type}`).value;
            const header = document.createElement('div');
            header.className = "sticky top-0 bg-white border-b border-gray-100 flex justify-between items-center px-4 py-3 z-10 flex-none";
            header.innerHTML = `<button onclick="window.closeTimePicker()" class="text-sm text-gray-500">取消</button><span class="text-sm font-bold text-gray-800">選擇時間</span><button onclick="window.clearTime()" class="text-sm text-red-400">清除</button>`;
            container.appendChild(header);
            const list = document.createElement('div');
            list.className = "overflow-y-auto flex-1 p-2";
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const isSelected = currentVal === timeStr;
                    const item = document.createElement('div');
                    item.className = `time-option rounded-lg ${isSelected ? 'selected' : ''}`;
                    item.textContent = timeStr;
                    item.onclick = () => window.selectTime(timeStr);
                    list.appendChild(item);
                }
            }
            container.appendChild(list);
            const m = document.getElementById('time-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
            if (currentVal) { setTimeout(() => { const selectedEl = list.querySelector('.selected'); if (selectedEl) selectedEl.scrollIntoView({ block: 'center' }); }, 50); }
        };

        window.closeTimePicker = function() {
            const m = document.getElementById('time-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.selectTime = function(timeStr) {
            document.getElementById(`input-time-${timePickerTarget}`).value = timeStr;
            window.updateTimeDisplay(timePickerTarget, timeStr);
            window.closeTimePicker();
            if (timePickerTarget === 'start' || timePickerTarget === 'todo') { if (window.autoUpdateEnd) window.autoUpdateEnd(); }
        };

        window.clearTime = function() {
            document.getElementById(`input-time-${timePickerTarget}`).value = '';
            window.updateTimeDisplay(timePickerTarget, ''); 
            window.closeTimePicker();
        };

        window.checkRoleEnforcement = function() {
            if (!currentUserRole) {
                window.openSettingsModal();
                window.showToast('👋 請先告訴我您是誰？');
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) { roleSection.classList.add('ring-2', 'ring-ttgreen', 'bg-green-50'); setTimeout(() => roleSection.classList.remove('ring-2', 'ring-ttgreen', 'bg-green-50'), 600); }
                return false; 
            }
            return true;
        };
        
        // 修改原本的 openSettingsModal
        window.openSettingsModal = function() {
            const m = document.getElementById('settings-modal');
            
            // === 加入這行：打開設定時，渲染分類開關 ===
            window.renderCategorySettings(); 
            // ======================================
            
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeSettingsModal = function() {
            if (!currentUserRole) {
                window.showToast('請先選擇一個身分 🙏');
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) { roleSection.classList.add('animate-pulse'); setTimeout(() => roleSection.classList.remove('animate-pulse'), 500); }
                return;
            }
            const m = document.getElementById('settings-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };
        
        window.updateDateDisplay = function(type, dateStr) {
            let targetEl = (type === 'recur') ? document.getElementById('display-recur-until') : (type === 'todo' ? document.getElementById('display-date-todo') : document.getElementById(`display-date-${type}`));
            if (!targetEl) {
                 if (type === 'end') targetEl = document.getElementById('display-date-end');
                 else if (type === 'todo-end') targetEl = document.getElementById('display-date-todo-end');
                 else if (type.startsWith('recur-')) targetEl = document.getElementById(`display-date-${type}`);
            }
            if(!targetEl) return;
            if(!dateStr) { 
                if (type === 'recur' || type.startsWith('recur-')) targetEl.textContent = "設定日期"; 
                else { targetEl.textContent = "請選擇"; targetEl.classList.add('dt-text-placeholder'); targetEl.classList.remove('dt-text-value'); }
                return; 
            }
            targetEl.classList.remove('dt-text-placeholder'); targetEl.classList.add('dt-text-value');
            const date = new Date(dateStr); 
            const weekDays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            if (type === 'recur' || type.startsWith('recur-')) targetEl.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} (${weekDays[date.getDay()]})`;
            else targetEl.textContent = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日(${weekDays[date.getDay()]})`;
        };

        window.updateTimeDisplay = function(type, timeStr) { 
            const el = document.getElementById(`display-time-${type}`); 
            if(el) { 
                if(!timeStr) { el.textContent = '請選擇'; el.classList.add('dt-text-placeholder'); el.classList.remove('dt-text-value'); } 
                else { el.textContent = timeStr; el.value = timeStr; el.classList.remove('dt-text-placeholder'); el.classList.add('dt-text-value'); }
            } 
        }; 
        
        window.checkRecurValidity = function() { const eD = document.getElementById('input-date-end')?.value; const rD = document.getElementById('input-recur-until')?.value; if(rD && eD && new Date(rD) < new Date(eD)) { const el = document.getElementById('input-recur-until'); if(el) el.value = eD; window.updateDateDisplay('recur', eD); } };
        
        window.autoUpdateEnd = function() { 
            try {
                let sT, endInputT, endDisplayType;
                if (document.getElementById('input-time-start') && document.getElementById('input-time-start').offsetParent !== null) {
                    sT = document.getElementById('input-time-start').value;
                    endInputT = document.getElementById('input-time-end');
                    endDisplayType = 'end';
                } 
                else if (document.getElementById('input-time-todo') && document.getElementById('input-time-todo').offsetParent !== null) {
                    sT = document.getElementById('input-time-todo').value;
                    endInputT = document.getElementById('input-time-todo-end');
                    endDisplayType = 'todo-end';
                }
                if (!sT || !endInputT) return;
                const [h, m] = sT.split(':').map(Number);
                const endH = (h + 1) % 24;
                const endTStr = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                if (!endInputT.value) { endInputT.value = endTStr; window.updateTimeDisplay(endDisplayType, endTStr); }
            } catch (e) { console.warn("Auto update end failed silently", e); }
        };
        window.checkEndDateValidity = function() { const sD = document.getElementById('input-date-start').value; const sT = document.getElementById('input-time-start').value; const eD = document.getElementById('input-date-end').value; const eT = document.getElementById('input-time-end').value; if(new Date(`${eD}T${eT}`) < new Date(`${sD}T${sT}`)) { window.autoUpdateEnd(); } else { window.checkRecurValidity(); } };
        window.setNowToInputs = function() { const now = new Date(); const dStr = now.toISOString().split('T')[0]; let h = now.getHours(), m = now.getMinutes(); if(m < 30) { m = 30; } else { m = 0; h += 1; } if(h > 23) h = 0; const tStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; const startEl = document.getElementById('input-date-start'); if(startEl) { startEl.value = dStr; document.getElementById('input-time-start').value = tStr; window.updateDateDisplay('start', dStr); window.updateTimeDisplay('start', tStr); const endD = document.getElementById('input-date-end'); if(endD) endD.value = dStr; const endT = document.getElementById('input-time-end'); if(endT) endT.value = tStr; window.updateDateDisplay('end', dStr); window.updateTimeDisplay('end', tStr); } };
        
        window.updateRoleUI = function() {
            const btnHaohao = document.getElementById('role-haohao');
            const btnMaomao = document.getElementById('role-maomao');
            if (btnHaohao) {
                const activeClass = "flex-1 py-3 rounded-xl text-sm font-bold border-2 border-ttgreen bg-green-50 text-ttgreen transition shadow-sm";
                const inactiveClass = "flex-1 py-3 rounded-xl text-sm font-medium border border-gray-200 text-gray-400 bg-white transition";
                if (currentUserRole === 'haohao') { btnHaohao.className = activeClass; btnMaomao.className = inactiveClass; } 
                else if (currentUserRole === 'maomao') { btnHaohao.className = inactiveClass; btnMaomao.className = activeClass; } 
                else { btnHaohao.className = inactiveClass; btnMaomao.className = inactiveClass; }
            }
            const badge = document.getElementById('header-role-badge');
            const badgeName = document.getElementById('header-role-name');
            if (badge && badgeName) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? '皓皓' : '毛毛';
                    const color = roleColors[currentUserRole];
                    badgeName.textContent = name;
                    badge.style.backgroundColor = color;
                    badge.classList.remove('opacity-0');
                } else {
                    badgeName.textContent = '請選擇';
                    badge.style.backgroundColor = '#9ca3af';
                    badge.classList.remove('opacity-0');
                    badge.classList.add('animate-pulse');
                }
            }
            const noteInput = document.getElementById('note-input');
            const noteSendBtn = document.getElementById('note-send-btn');
            if (noteInput) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? '皓皓' : '毛毛';
                    const color = roleColors[currentUserRole];
                    noteInput.placeholder = `${name}，說點什麼...`;
                    noteInput.disabled = false;
                    if(noteInput.parentElement) noteInput.parentElement.style.borderColor = color;
                    if(noteSendBtn) { noteSendBtn.style.backgroundColor = color; noteSendBtn.classList.remove('bg-gray-300', 'cursor-not-allowed'); noteSendBtn.disabled = false; }
                } else {
                    noteInput.placeholder = '請先選擇身分...';
                    noteInput.disabled = true;
                    if(noteInput.parentElement) noteInput.parentElement.style.borderColor = '#e5e7eb';
                    if(noteSendBtn) { noteSendBtn.style.backgroundColor = '#d1d5db'; noteSendBtn.classList.add('cursor-not-allowed'); noteSendBtn.disabled = true; }
                }
            }
            if (currentUserRole) {
                document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]);
                if(badge) badge.classList.remove('animate-pulse');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.updateSettingsColorUI = function() { const h = document.getElementById('setting-color-haohao'); if(h) { h.style.backgroundColor = roleColors.haohao; document.getElementById('setting-color-maomao').style.backgroundColor = roleColors.maomao; document.getElementById('setting-color-joint').style.backgroundColor = roleColors.joint; } };
        window.setStatus = function(s) { document.getElementById('input-status').value = s; document.querySelectorAll('.status-btn').forEach(b=>{ if(b.dataset.status===s) b.classList.add('active'); else b.classList.remove('active'); }); };
        window.showToast = function(msg) { const t = document.getElementById('toast-container'); const m = document.getElementById('toast-message'); m.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); };
        
        window.updateParticipantsPreview = function() { 
            const container = document.getElementById('participants-preview'); 
            if(!container) return; 
            const isP = document.getElementById('check-partner').checked; 
            let html = ''; 
            html += `<div class="avatar-sm z-20" style="background-color:${roleColors[currentUserRole]}">${currentUserRole==='haohao'?'皓':'毛'}</div>`; 
            if(isP) { 
                const p = currentUserRole==='haohao'?'maomao':'haohao'; 
                html += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]}">${p==='haohao'?'皓':'毛'}</div>`; 
            } 
            container.innerHTML = html; 
        };

        window.togglePartner = function() {
          const isChecked = document.getElementById('check-partner').checked;
          window.updateParticipantsPreview();
          colorPickerTarget = 'event';
          if (isChecked) currentSelectedColor = roleColors.joint;
          else currentSelectedColor = roleColors[currentUserRole];
        };

        window.setRole = function(role) { localStorage.setItem('user_role', role); currentUserRole = role; window.updateRoleUI(); document.documentElement.style.setProperty('--active-tab-color', roleColors[role]); };
        window.updateMyStatus = function(status) {
            if (!window.checkRoleEnforcement()) return;
             if(!db) return; const moods = ['normal', 'charging', 'sleepy', 'love', 'busy']; 
             let moodToSet = status;
             if (!moodToSet || !moodMap[moodToSet]) { moodToSet = moods[Math.floor(Math.random() * moods.length)]; }
             const d = {}; d[currentUserRole] = moodToSet; db.collection('status').doc('current').set(d, { merge: true }); 
        };
        window.toggleGlobalColorPicker = function(show) { const el = document.getElementById('global-color-picker'); const grid = document.getElementById('global-color-grid'); if(show) { grid.innerHTML = ''; timeTreeColors.forEach(color => { const row = document.createElement('div'); row.className = "flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition"; row.onclick = () => window.selectGlobalColor(color); row.innerHTML = `<div class="w-5 h-5 rounded-full mr-3 shadow-sm" style="background-color: ${color.hex}"></div><span class="text-sm text-gray-700">${color.name}</span>`; grid.appendChild(row); }); el.classList.remove('hidden'); setTimeout(() => el.classList.add('visible'), 10); } else { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); colorPickerTarget = null; } };

        window.selectGlobalColor = function(c) {
            if (colorPickerTarget === 'event') {
                currentSelectedColor = c.hex;
                document.getElementById('selected-color-name').textContent = c.name;
                document.getElementById('selected-color-dot').style.backgroundColor = c.hex;
            } 
            else if (colorPickerTarget) {
                const newHex = c.hex;
                const targetRole = colorPickerTarget; 
                const oldHex = roleColors[targetRole]; 
                let conflictRole = null;
                for (let key in roleColors) { if (key !== targetRole && roleColors[key] === newHex) { conflictRole = key; break; } }
                roleColors[targetRole] = newHex;
                localStorage.setItem(`color_${targetRole}`, newHex);
                if (conflictRole) {
                    roleColors[conflictRole] = oldHex;
                    localStorage.setItem(`color_${conflictRole}`, oldHex);
                    window.showToast(`顏色重複，已與「${conflictRole==='haohao'?'皓皓':(conflictRole==='maomao'?'毛毛':'共同行程')}」交換顏色！`);
                }
                window.updateSettingsColorUI();
                if (targetRole === currentUserRole || conflictRole === currentUserRole) { if (currentUserRole) { document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]); } }
            }
            window.toggleGlobalColorPicker(false);
        };
        window.openColorConfig = function(target) { colorPickerTarget = target; window.toggleGlobalColorPicker(true); };
        window.syncSelectedColorUI = function() {
            const dot = document.getElementById('selected-color-dot');
            const name = document.getElementById('selected-color-name');
            if (!dot || !name) return;
            const found = timeTreeColors.find(c => c.hex === currentSelectedColor);
            dot.style.backgroundColor = currentSelectedColor;
            name.textContent = found ? found.name : '自訂顏色';
        };

        window.renderEvents = function(ignored) { const items = window.getCalendarItems(); const now = new Date(); const future = items.filter(e => { const date = new Date(e.timestamp); if(e.isTodo && e.done) return false; return !isNaN(date) && date >= now; }); const titleEl = document.getElementById('next-event-title'); if(titleEl && future.length > 0) { const n = future[0], d = new Date(n.timestamp); titleEl.textContent = n.title; const timeStr = n.allDay ? "All Day" : d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('next-event-time').textContent = timeStr; document.getElementById('next-event-date').textContent = d.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); const diff = Math.ceil((d-now)/(1000*60*60*24)); document.getElementById('countdown').textContent = diff<=0?"TODAY":`D - ${diff}`; } else if(titleEl) { titleEl.textContent = "No Upcoming Events"; } const listEl = document.getElementById('event-list'); if(listEl) { if (items.length === 0) listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">無行程</div>`; else window.renderEventListItems(items, listEl); } };
        window.getCalendarItems = function() {
            // 事件直接帶入
            const events = allEventsCache.map(e => ({...e, type: 'event'}));
            
            // 待辦事項：這裡原本漏了欄位，現在改用 ...t 展開所有屬性
            const todos = allTodosCache
                .filter(t => t.timestamp) // 只顯示有設定時間的待辦
                .map(t => ({
                    ...t, // <--- 關鍵修正：保留原始待辦的所有欄位 (dueDate, etc.)
                    id: t.id,
                    title: t.title,
                    timestamp: t.timestamp,
                    allDay: !t.dueTime,
                    isTodo: true,
                    done: t.done,
                    type: 'todo',
                    // 如果沒有設定顏色，這欄位留空交給渲染層判斷
                    color: null 
                }));

            // 合併並排序
            return [...events, ...todos].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        };        

        window.renderDashboardNextUp = function(items) {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // <--- 關鍵修改：將比較基準設為今天的起始點
            
            const nextLimit = new Date();
            nextLimit.setDate(now.getDate() + 3); 
            
            const upcoming = items.filter(item => {
                const t = new Date(item.timestamp);
                if (item.isTodo && item.done) return false;
                // 邏輯：時間 >= 今天凌晨 且 <= 未來3天
                return !isNaN(t) && t >= now && t <= nextLimit;
            });

            // (已移除舊的 countdown 邏輯)

            const container = document.getElementById('dashboard-next-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (upcoming.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">未來 3 天沒有行程 😴</div>`;
            } else {
                let html = '';
                upcoming.forEach(item => {
                    const date = new Date(item.timestamp);
                    const startDateStr = item.startDate || item.dueDate;
                    const endDateStr = item.endDate || item.dueDateEnd;
                    const effectiveEndDateStr = endDateStr || startDateStr;

                    // 判斷是否跨日
                    const isCrossDay = startDateStr !== effectiveEndDateStr;

                    // === 1. 建構顯示字串 (Meta HTML) ===
                    let metaHtml = '';

                    if (isCrossDay) {
                        // === 跨日行程 ===
                        const startD = new Date(startDateStr);
                        const endD = new Date(effectiveEndDateStr);
                        
                        if (item.allDay) {
                            const sStr = `${startD.getMonth()+1}/${startD.getDate()}`;
                            const eStr = `${endD.getMonth()+1}/${endD.getDate()}`;
                            metaHtml = `<span class="font-bold text-gray-600">${sStr}</span> <span class="text-gray-300 mx-1">→</span> <span class="font-bold text-gray-600">${eStr}</span> <span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-1">All Day</span>`;
                        } else {
                            const sTime = date.toLocaleTimeString('zh-TW', {
                                hour: '2-digit', minute: '2-digit', hour12: false
                            });
                            const eTime = item.endTime || '??:??';
                            const sStr = `${startD.getMonth()+1}/${startD.getDate()} ${sTime}`;
                            const eStr = `${endD.getMonth()+1}/${endD.getDate()} ${eTime}`;
                            metaHtml = `<span class="font-medium text-gray-600 tracking-tight">${sStr}</span> <i data-lucide="arrow-right" class="w-3 h-3 inline-block mx-0.5 align-middle text-gray-300"></i> <span class="font-medium text-gray-600 tracking-tight">${eStr}</span>`;
                        }
                    } else {
                        // === 單日行程 ===
                        const dateDisplay = new Date(startDateStr).toLocaleDateString('zh-TW', {
                            month: 'numeric', day: 'numeric', weekday: 'short'
                        });
                        
                        let timeStr = item.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
                            hour: '2-digit', minute: '2-digit', hour12: false
                        });
                        
                        const endTime = item.endTime || item.dueTimeEnd;
                        if (endTime && !item.allDay) {
                            timeStr += ` - ${endTime}`;
                        }
                        
                        metaHtml = `${dateDisplay} <span class="text-gray-300 mx-1">|</span> ${timeStr}`;
                    }

                    if (item.location) {
                        metaHtml += ` <span class="text-gray-300 mx-1">|</span> ${item.location}`;
                    }

                    let color;
                    if (item.isJoint) {
                        color = roleColors.joint;
                    } else {
                        color = (item.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                    }

                    let displayIcon = '';
                    let isVac = false;
                    if (typeof window.isLeaveEvent === 'function' && window.isLeaveEvent(item.title)) {
                        isVac = true;
                        displayIcon = ''; 
                    }

                    let tagHtml = '';
                    if (item.isTodo) tagHtml = `<span class="ml-2 text-[10px] border border-gray-200 text-gray-400 px-1 rounded flex-shrink-0">待辦</span>`;
                    else if (isVac) tagHtml = `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-500 border border-blue-100 flex-shrink-0">🏖 休假</span>`;
                    else if (item.status === 'tbc') tagHtml = `<span class="ml-2 status-tag tbc">TBC</span>`;
                    else if (item.status === 'tbd') tagHtml = `<span class="ml-2 status-tag tbd">TBD</span>`;

                    let noteDisplay = '';
                    if (item.note && item.note.trim()) {
                        noteDisplay = `<div class="text-xs text-gray-400 mt-1 flex items-start gap-1"><i data-lucide="sticky-note" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><span class="truncate">${item.note}</span></div>`;
                    }

                    let clickAction = item.isTodo ? `window.openEditTodoModal('${item.id}')` : `window.openEditModal('${item.id}')`;
                    const bgClass = isVac ? 'bg-blue-50/30' : 'hover:bg-gray-50';

                    html += `
                    <div class="flex items-center p-3 ${bgClass} cursor-pointer transition border-b border-gray-50 last:border-0" onclick="${clickAction}">
                        <div class="w-1 self-stretch rounded-full mr-3" style="background-color: ${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-gray-800 truncate">${displayIcon}${item.title}</span>
                                ${tagHtml}
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5 flex items-center flex-wrap">
                                ${metaHtml}
                            </div>
                            ${noteDisplay}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({ root: container });
                }
            }
        };
    
        window.renderCalendarListView = function() { const items = window.getCalendarItems(); const listEl = document.getElementById('event-list'); if(!listEl) return; if (items.length === 0) { listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">無行程</div>`; } else { window.renderEventListItems(items, listEl); } };

        // === 優化版：列表渲染 (支援強制展開模式) ===
        window.renderEventListItems = function(items, container, forceExpand = false) {
            const now = new Date(); 
            
            // 2. 定義 HTML 生成器 (先定義好，後面會用)
            const generateItemHtml = (listItems) => {
                let htmlBuffer = '';
                let lastMonthLabel = '';

                listItems.forEach(e => {
                    const date = new Date(e.timestamp);
                    // 月份標題
                    const currentMonthLabel = `${date.getFullYear()}年 ${date.getMonth() + 1}月`;
                    if (currentMonthLabel !== lastMonthLabel) {
                        htmlBuffer += `
                        <div class="sticky top-0 z-30 bg-gray-100/95 backdrop-blur-sm px-4 py-2 text-xs font-bold text-gray-500 border-b border-gray-200 shadow-sm flex items-center justify-between">
                            <span>${currentMonthLabel}</span>
                            ${currentMonthLabel === `${now.getFullYear()}年 ${now.getMonth() + 1}月` ? '<span class="text-[10px] bg-ttgreen text-white px-1.5 py-0.5 rounded-full">本月</span>' : ''}
                        </div>`;
                        lastMonthLabel = currentMonthLabel;
                    }

                    let opacityClass = '';
                    if (e.isTodo && e.done) opacityClass = 'opacity-40 grayscale';
                    else if (!e.isTodo && new Date(e.timestamp) < now) opacityClass = 'opacity-50 grayscale';

                    let timeStr = "";
                    const startDateStr = e.startDate || e.dueDate;
                    const endDateStr = e.endDate || e.dueDateEnd;
                    const effectiveEndDateStr = endDateStr || startDateStr;
                    
                    let dateObjStart = startDateStr ? new Date(startDateStr) : date;
                    if (isNaN(dateObjStart)) dateObjStart = date;
                    
                    let dayNum = dateObjStart.getDate();
                    let dayName = dateObjStart.toLocaleDateString('en-US', { weekday: 'short' });

                    if (startDateStr && effectiveEndDateStr && startDateStr !== effectiveEndDateStr) {
                        const dateObjEnd = new Date(effectiveEndDateStr);
                        const sDateDisplay = `${dateObjStart.getMonth()+1}/${dateObjStart.getDate()}`;
                        const eDateDisplay = `${dateObjEnd.getMonth()+1}/${dateObjEnd.getDate()}`;
                        if (e.allDay) {
                             timeStr = `${sDateDisplay} - ${eDateDisplay} (All Day)`;
                        } else {
                             const sTime = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                             const eTime = (e.endTime || e.dueTimeEnd) || "??:??";
                             timeStr = `${sTime} <span class="text-gray-400">→</span> ${eDateDisplay} ${eTime}`;
                        }
                    } else {
                        timeStr = e.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                        const endTime = e.endTime || e.dueTimeEnd;
                        if (endTime && !e.allDay) timeStr += ` - ${endTime}`;
                    }

                    let displayIcon = '';
                    if (typeof window.isLeaveEvent === 'function' && window.isLeaveEvent(e.title)) displayIcon = '🏖️ ';

                    let displayColor;
                    if (e.isJoint) displayColor = roleColors.joint; 
                    else displayColor = (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);

                    if (e.isTodo) {
                        const statusClass = e.done ? "line-through text-gray-400" : "text-gray-800";
                        const checkIcon = e.done ? '<i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="square" class="w-5 h-5 text-gray-400"></i>';
                        htmlBuffer += `
                        <div id="list-item-${e.id}" class="flex p-4 items-center gap-4 hover:bg-gray-50 transition cursor-pointer border-b border-gray-50 last:border-0 ${opacityClass}">
                            <div class="flex flex-col items-center w-10">
                                <span class="text-xs text-gray-400 font-medium uppercase">${dayName}</span>
                                <span class="text-xl font-bold text-gray-800 leading-none">${dayNum}</span>
                            </div>
                            <div class="w-1 self-stretch rounded-full" style="background-color: ${displayColor}"></div>
                            <div class="flex-1 min-w-0 flex items-center justify-between" onclick="window.openEditTodoModal('${e.id}')">
                                <div>
                                    <div class="flex items-center ${statusClass}">
                                        <span class="font-bold truncate block">${displayIcon}${e.title}</span>
                                        <span class="ml-2 text-[10px] border border-gray-200 px-1 rounded text-gray-400 flex-shrink-0">待辦</span>
                                    </div>
                                    <div class="text-xs text-gray-500">${timeStr}</div>
                                </div>
                            </div>
                            <div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${e.id}', ${!e.done}); event.stopPropagation();">
                                ${checkIcon}
                            </div>
                        </div>`;
                    } else {
                        let ic = '';
                        if (e.category === 'travel') ic = 'plane';
                        else if (e.category === 'appointment') ic = 'scissors';
                        else if (e.category === 'gathering') ic = 'users';
                        else if (e.category === 'vacation') ic = 'palmtree';
                        let ico = ic ? `<i data-lucide="${ic}" class="w-3 h-3 text-gray-400 mr-1"></i>` : '';
                        let st = '';
                        if (e.status === 'tbc') st = `<span class="ml-2 status-tag tbc">TBC</span>`;
                        else if (e.status === 'tbd') st = `<span class="ml-2 status-tag tbd">TBD</span>`;
                        let av = `<div class="avatar-sm z-20" style="background-color:${roleColors[e.creator]||'#2cc998'}">${e.creator==='haohao'?'皓':'毛'}</div>`;
                        if (e.isJoint) {
                            const partner = e.creator === 'haohao' ? 'maomao' : 'haohao';
                            av += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[partner]}">${partner==='haohao'?'皓':'毛'}</div>`;
                        }
                        let noteDisplay = '';
                        if (e.note && e.note.trim()) noteDisplay = `<div class="text-xs text-gray-400 mt-1 flex items-start gap-1"><i data-lucide="sticky-note" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><span class="truncate">${e.note}</span></div>`;

                        htmlBuffer += `
                        <div id="list-item-${e.id}" class="flex p-4 items-start gap-4 hover:bg-gray-50 transition cursor-pointer card-press border-b border-gray-50 last:border-0 ${opacityClass}" onclick="window.openEditModal('${e.id}')">
                            <div class="flex flex-col items-center w-10 pt-1">
                                <span class="text-xs text-gray-400 font-medium uppercase">${dayName}</span>
                                <span class="text-xl font-bold leading-none" style="color:${displayColor}">${dayNum}</span>
                            </div>
                            <div class="w-1 self-stretch rounded-full" style="background-color:${displayColor}"></div>
                            <div class="flex-1 min-w-0 pt-1">
                                <div class="flex items-center">
                                    ${ico}
                                    <h4 class="font-bold text-gray-800 truncate">${displayIcon}${e.title}</h4>
                                    ${st}
                                </div>
                                <div class="text-xs text-gray-500">${timeStr} ${e.location?'· '+e.location:''}</div>
                                ${noteDisplay}
                            </div>
                            <div class="flex items-center self-center -space-x-1 pl-2">${av}</div>
                        </div>`;
                    }
                });
                return htmlBuffer;
            };

            // === 修改重點：如果 forceExpand 為 true，直接渲染全部，不分流 ===
            if (forceExpand) {
                container.innerHTML = generateItemHtml(items);
                if (typeof lucide !== 'undefined') lucide.createIcons({ root: container });
                return;
            }
            // =========================================================

            // 1. 資料分流 (原本的邏輯)
            const pastItems = [];
            const futureItems = [];

            items.forEach(e => {
                const date = new Date(e.timestamp);
                if (isNaN(date)) return;
                let isPast = false;
                if (e.isTodo) { isPast = e.done; } 
                else {
                    const endDateStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                    const endTimeStr = e.endTime || e.dueTimeEnd || "23:59";
                    const endDateTime = new Date(`${endDateStr}T${endTimeStr}`);
                    if(isNaN(endDateTime)) isPast = date < now; else isPast = endDateTime < now;
                }
                if (isPast) pastItems.push(e); else futureItems.push(e);
            });

            // 3. 組合 HTML
            let finalHtml = '';
            if (pastItems.length > 0) {
                finalHtml += `
                <div onclick="window.toggleHistory()" class="cursor-pointer bg-gray-50 border-b border-gray-200 py-3 flex items-center justify-center text-xs text-gray-500 hover:bg-gray-100 transition">
                    <i data-lucide="clock" class="w-3.5 h-3.5 mr-1.5"></i>
                    <span id="history-btn-text">查看之前的 ${pastItems.length} 筆行程</span>
                    <i id="history-chevron" data-lucide="chevron-down" class="w-3.5 h-3.5 ml-1 transition-transform duration-300"></i>
                </div>
                <div id="history-list-container" class="hidden bg-gray-50/50 border-b border-gray-200 shadow-inner">`;
                finalHtml += generateItemHtml(pastItems);
                finalHtml += `</div>`;
            }
            if (futureItems.length > 0) {
                finalHtml += generateItemHtml(futureItems);
            } else {
                finalHtml += `<div class="text-center py-12 text-gray-400 text-sm">接下來沒有安排行程 🎉</div>`;
            }

            container.innerHTML = finalHtml;
            if (typeof lucide !== 'undefined') lucide.createIcons({ root: container });
        };

        // === 新增：切換歷史顯示的函式 ===
        window.toggleHistory = function() {
            const container = document.getElementById('history-list-container');
            const chevron = document.getElementById('history-chevron');
            const btnText = document.getElementById('history-btn-text');
            
            if (!container) return;

            if (container.classList.contains('hidden')) {
                // 展開
                container.classList.remove('hidden');
                chevron.classList.add('rotate-180');
                btnText.textContent = "收起歷史行程";
            } else {
                // 收起
                container.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                // 重新計算數量 (這裡偷懶直接讀取原本的字串可能會跑掉，簡單寫死或是重算)
                // 比較好的做法是保持原樣，或是簡單寫 "查看歷史行程"
                btnText.textContent = "查看歷史行程";
            }
        };
       
        window.toggleAllDay = function() { const isChecked = document.getElementById('check-allday').checked; document.querySelectorAll('.dt-wrapper-time').forEach(d => d.style.display = isChecked ? 'none' : 'block'); };
        window.toggleRecurring = function() { const isChecked = document.getElementById('check-recurring').checked; const opts = document.getElementById('recurring-options'); if(isChecked) { opts.classList.remove('hidden'); if(!document.getElementById('input-recur-until').value) document.getElementById('input-recur-until').value = document.getElementById('input-date-end').value; } else opts.classList.add('hidden'); };
        window.toggleTravelFields = function() { const type = document.getElementById('input-transport-type').value; const isPlane = type === 'plane'; document.getElementById('travel-region-intl').classList.toggle('hidden', !isPlane); document.getElementById('travel-region-tw').classList.toggle('hidden', isPlane); };
        window.toggleBooked = function() { const isChecked = document.getElementById('check-booked').checked; const txt = document.getElementById('appoint-status-text'); txt.textContent = isChecked ? "已預約" : "未完成"; txt.className = isChecked ? "text-xs font-bold text-purple-600" : "text-xs text-gray-500"; };

        window.toggleTodo = function(id,s) { db.collection('todos').doc(id).update({done:s}); };

        // === 補上缺失的刪除觸發函式 ===

        window.deleteCurrentEvent = function() {
            // 確保有正在編輯的 ID
            if (!editingEventId) return;
            
            deleteTarget = 'event';
            
            // 設定確認視窗的文字
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = '刪除行程？';
            if(desc) desc.textContent = '確定要刪除這個行程嗎？無法復原喔！';
            
            // 打開確認視窗
            window.confirmDelete();
        };

        window.deleteCurrentTodo = function() {
            // 確保有正在編輯的 ID
            if (!editingTodoId) return;
            
            deleteTarget = 'todo';
            
            // 設定確認視窗的文字
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = '刪除待辦？';
            if(desc) desc.textContent = '確定要刪除這個待辦事項嗎？';
            
            // 打開確認視窗
            window.confirmDelete();
        };

        // === 全域變數：用來記錄哪些分類是被「收起來」的 ===
        window.collapsedCategories = JSON.parse(localStorage.getItem('collapsed_categories') || '{}');

        window.renderTodos = function(todos) {
            const container = document.getElementById('todo-category-container');
            const dashboardList = document.getElementById('dashboard-todo-list');
            
            if(!container) return;
            container.innerHTML = '';
            
            // 1. 資料分組 (Grouping)
            const groups = {};
            const noCategoryKey = '未分類';
            
            // 預設分類排序 (你可以調整順序)
            const categoryOrder = ['重要', 'Debug', '工作', '生活', '購物', '請假', 'Party', '財務', noCategoryKey];
            
            let pendingCount = 0;

            todos.forEach(t => {
                if(!t.done) pendingCount++;
                
                // 決定分類名稱
                const cat = t.category || noCategoryKey;
                
                if (!groups[cat]) {
                    groups[cat] = [];
                }
                groups[cat].push(t);
            });

            // 2. 決定顯示順序 (已定義的排前面，自訂的排後面)
            const sortedKeys = Object.keys(groups).sort((a, b) => {
                const idxA = categoryOrder.indexOf(a);
                const idxB = categoryOrder.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.localeCompare(b); // 其他自訂分類照筆畫排
            });

            // 3. 渲染每個分類區塊
            if (sortedKeys.length === 0) {
                 container.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">目前沒有待辦事項 🎉</div>`;
            } else {
                sortedKeys.forEach(cat => {
                    const items = groups[cat];
                    const isCollapsed = !!window.collapsedCategories[cat];
                    const count = items.filter(i => !i.done).length; // 只計算未完成的
                    
                    // 區塊 HTML
                    const sectionId = `cat-section-${cat}`;
                    const listId = `cat-list-${cat}`;
                    const chevronClass = isCollapsed ? '' : 'rotate-180';
                    const listClass = isCollapsed ? 'hidden' : 'block';
                    
                    // 標題列
                    let html = `
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="flex items-center justify-between p-3 bg-gray-50/50 cursor-pointer select-none active:bg-gray-100 transition" onclick="window.toggleTodoCategory('${cat}')">
                            <div class="flex items-center gap-2">
                                <i data-lucide="chevron-down" id="chevron-${cat}" class="w-4 h-4 text-gray-400 transition-transform duration-300 ${chevronClass}"></i>
                                <h3 class="font-bold text-gray-700">${cat}</h3>
                                ${count > 0 ? `<span class="bg-ttgreen text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">${count}</span>` : ''}
                            </div>
                        </div>
                        
                        <div id="${listId}" class="${listClass} divide-y divide-gray-100 bg-white">
                    `;
                    
                    // 該分類下的清單項目
                    items.forEach(t => {
                        // 顏色邏輯 (改為顯示在卡片左側邊條)
                        let barColor = roleColors.haohao;
                        if (t.isJoint) barColor = roleColors.joint;
                        else if (t.creator === 'maomao') barColor = roleColors.maomao;
                        
                        const titleClass = t.done ? "text-gray-400 line-through" : "text-gray-800";
                        const checkStyle = t.done ? `background-color: #d1d5db; border-color: #d1d5db;` : `border-color: ${barColor};`;
                        
                        // 時間顯示
                        let calInfo = '';
                        if (t.dueDate) {
                            calInfo = `<span class="text-[10px] ${t.done?'text-gray-300':'text-gray-400'} ml-auto flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</span>`;
                        }

                        html += `
                        <div class="flex items-center p-3 hover:bg-gray-50 transition cursor-pointer group" onclick="window.openEditTodoModal('${t.id}')">
                            <div class="flex-none mr-3" onclick="window.toggleTodo('${t.id}', ${!t.done}); event.stopPropagation();">
                                <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors text-white" style="${checkStyle}">
                                    ${t.done ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <span class="${titleClass} font-medium truncate">${t.title}</span>
                                    ${calInfo}
                                </div>
                                <div class="flex items-center mt-1">
                                    <div class="w-1.5 h-1.5 rounded-full mr-1.5" style="background-color: ${barColor}"></div>
                                    <span class="text-[10px] text-gray-400">
                                        ${t.isJoint ? '共同' : (t.creator === 'haohao' ? '皓皓' : '毛毛')}
                                    </span>
                                </div>
                            </div>

                            <button onclick="window.deleteTodo('${t.id}'); event.stopPropagation();" class="flex-none p-2 text-gray-200 hover:text-red-400 transition ml-1">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>`;
                    });
                    
                    if(items.length === 0) {
                        html += `<div class="p-4 text-center text-xs text-gray-300">此分類無項目</div>`;
                    }

                    html += `
                        </div>
                    </div>`; // 關閉 container
                    
                    container.innerHTML += html;
                });
            }

            // 更新 Dashboard (摘要) - 修改過濾邏輯
            if(dashboardList) {
                if (pendingCount === 0) {
                    dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">沒有未完成的待辦事項 🎉</p>`;
                } else {
                    dashboardList.innerHTML = '';
                    
                    // === 修改重點：加入分類過濾 ===
                    const pendings = todos.filter(t => {
                        // 1. 必須是未完成
                        if (t.done) return false;
                        
                        // 2. 檢查該分類是否被隱藏
                        // 如果沒有分類，視為 "未分類"，預設顯示
                        // 如果有分類，檢查 visibility 設定 (預設 true)
                        const cat = t.category; 
                        if (cat && window.todoCategoryVisibility[cat] === false) {
                            return false; // 如果設定為 false，則隱藏
                        }
                        
                        return true;
                    }).slice(0, 3); // 取過濾後的前 3 筆
                    // ==========================

                    if (pendings.length === 0 && pendingCount > 0) {
                        // 如果有未完成項目，但全部都被隱藏了
                        dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">待辦事項已隱藏 (請至清單查看)</p>`;
                    } else {
                        pendings.forEach(t => {
                            let dotColor = t.isJoint ? roleColors.joint : (t.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                            dashboardList.innerHTML += `
                            <div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-100 mb-1">
                                <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${dotColor}"></div>
                                <span class="truncate text-gray-700 flex-1">${t.title}</span>
                                ${t.category ? `<span class="text-[9px] px-1 rounded bg-gray-200 text-gray-500">${t.category}</span>` : ''}
                            </div>`;
                        });
                        
                        // 計算還有多少個 (這裡顯示的是 "總未完成數" 扣掉 "摘要顯示數")
                        // 或者你可以改成 "還有 X 個被隱藏"
                        const remaining = todos.filter(t => !t.done).length - pendings.length;
                        if (remaining > 0) {
                            dashboardList.innerHTML += `<div class="text-center text-xs text-gray-400 mt-1">還有 ${remaining} 個項目...</div>`;
                        }
                    }
                }
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // === 新增：分類收合切換功能 ===
        window.toggleTodoCategory = function(cat) {
            // 切換狀態
            const isCollapsed = window.collapsedCategories[cat];
            window.collapsedCategories[cat] = !isCollapsed;
            
            // 存入 localStorage 記住使用者的偏好
            localStorage.setItem('collapsed_categories', JSON.stringify(window.collapsedCategories));
            
            // 直接操作 DOM 顯示/隱藏，不重新渲染整個列表 (效能較好)
            const listEl = document.getElementById(`cat-list-${cat}`);
            const chevronEl = document.getElementById(`chevron-${cat}`);
            
            if (listEl && chevronEl) {
                if (!isCollapsed) { // 變為收合
                    listEl.classList.add('hidden');
                    chevronEl.classList.remove('rotate-180');
                } else { // 變為展開
                    listEl.classList.remove('hidden');
                    chevronEl.classList.add('rotate-180');
                }
            }
        };

        window.confirmDelete = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10); };
        window.closeConfirmModal = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('visible'); setTimeout(() => m.classList.add('hidden'), 200); };
        window.executeDelete = function() { 
            if(deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete().then(() => { window.closeConfirmModal(); window.closeAddModal(); window.showToast('行程已刪除'); }).catch(e => { console.error(e); window.showToast('刪除失敗'); }); 
            } else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete().then(() => { window.closeConfirmModal(); window.closeAddTodoModal(); window.showToast('待辦已刪除'); }).catch(e => { console.error(e); window.showToast('刪除失敗'); });
            } else if (deleteTarget === 'note' && noteToDelete) { // <--- 確認這裡是 noteToDelete
                window.deleteNote(noteToDelete); // 呼叫刪除函式
                window.closeConfirmModal();
            }
        };

        window.clearDate = function() {
            if (calTargetInput === 'todo') { document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; if (window.updateDateDisplay) window.updateDateDisplay('todo', ''); if (window.updateTimeDisplay) window.updateTimeDisplay('todo', ''); } 
            else { const el = document.getElementById(`input-date-${calTargetInput}`); if (el) el.value = ''; if (window.updateDateDisplay) window.updateDateDisplay(calTargetInput, ''); }
            window.closeCalendar();
        };

        // === 修改後的 switchTab：簡化邏輯，只切換 .active 類別 ===
        window.switchTab = function(tabId) {
            // 1. 隱藏所有頁面
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
                // 確保切換時捲動到頂部 (UX 優化)
                page.scrollTop = 0;
            });
            
            // 2. 顯示目標頁面
            const targetPage = document.getElementById(`page-${tabId}`);
            if(targetPage) {
                targetPage.classList.add('active');
                // 如果是行事曆，嘗試渲染大月曆
                if(tabId === 'calendar' && typeof window.renderBigCalendar === 'function') {
                    window.renderBigCalendar();
                }
            }
            
            // 3. 更新底部導航按鈕狀態 (關鍵修改)
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                // 只需切換 'active' 類別，樣式由 Tailwind 的 group-[.active] 控制
                if(btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // (可選) 在切換時產生一點點觸覺回饋
            if (navigator.vibrate) navigator.vibrate(5);
        };

        window.switchCalendarView = function(mode) {
            currentViewMode = mode;
            const vList = document.getElementById('calendar-view-list');
            const bList = document.getElementById('btn-view-list');
            const bMonth = document.getElementById('btn-view-month');
            const calendarViewMonthContainer = document.getElementById('calendar-view-month-container');
            
            if(mode === 'list') {
                vList.classList.remove('hidden');
                if(calendarViewMonthContainer) calendarViewMonthContainer.classList.add('hidden');
                bList.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold'); bList.classList.remove('text-gray-500','font-medium');
                bMonth.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold'); bMonth.classList.add('text-gray-500','font-medium');
            } else {
                vList.classList.add('hidden');
                if(calendarViewMonthContainer) calendarViewMonthContainer.classList.remove('hidden');
                bMonth.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold'); bMonth.classList.remove('text-gray-500','font-medium');
                bList.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold'); bList.classList.add('text-gray-500','font-medium');
                window.renderBigCalendar();
            }
        };

        window.changeBigCalMonth = function(delta) {
            bigCalDate.setMonth(bigCalDate.getMonth() + delta);
            window.renderBigCalendar();
        };
        
        window.selectBigCalendarDate = function(y, m, d, targetId = null) {
            // 1. 視覺選取樣式
            document.querySelectorAll('.big-cal-cell.selected').forEach(e => e.classList.remove('selected'));
            if (m === bigCalDate.getMonth()) {
                const el = document.getElementById(`big-cal-day-${d}`);
                if (el) el.classList.add('selected');
            }
            
            // 2. 更新標題
            const label = document.getElementById('selected-date-label');
            if (label) label.textContent = `${y}年${m + 1}月${d}日`;
            
            // 3. 渲染下方清單 (強制展開)
            const listEl = document.getElementById('month-event-list');
            if (listEl) {
                const items = window.getCalendarItems();
                const ds = new Date(y, m, d);
                const de = new Date(y, m, d, 23, 59, 59);
                
                const dayEvents = items.filter(e => {
                    const t = new Date(e.startDate || e.timestamp);
                    const startDay = new Date(t); startDay.setHours(0,0,0,0);
                    if (e.endDate || e.dueDateEnd) {
                        const endT = new Date(e.endDate || e.dueDateEnd); endT.setHours(23,59,59,999);
                        return ds <= endT && de >= startDay;
                    }
                    return t >= ds && t <= de;
                });

                if (dayEvents.length === 0) {
                    listEl.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">這天沒有安排行程 😴</div>`;
                } else {
                    window.renderEventListItems(dayEvents, listEl, true);
                }
            }

            // === 4. 觸發捲動與高亮 (邏輯修正) ===
            setTimeout(() => {
                const scrollArea = document.getElementById('calendar-scroll-area');
                const listHeader = document.getElementById('selected-date-label');
                let didScrollHeader = false;

                // --- 動作 A：優先確保清單標題滑上來 (解決滑不下去的問題) ---
                if (scrollArea && listHeader) {
                    const headerRect = listHeader.getBoundingClientRect();
                    const containerRect = scrollArea.getBoundingClientRect();
                    
                    // 只要標題在視窗下半部 (太低了) 或者被擋住，就捲上來
                    // 即使有點到行程，這個動作也要執行，確保清單進入視野
                    if (headerRect.top > containerRect.bottom - 250) { 
                         listHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                         didScrollHeader = true; // 標記已執行捲動
                    }
                }

                // --- 動作 B：如果有指定行程，進行高亮 (與 動作 A 不衝突) ---
                if (targetId) {
                    const targetEl = document.getElementById(`list-item-${targetId}`);
                    if (targetEl) {
                        // 如果剛剛沒有捲動標題 (代表標題已經在上面了，清單很清楚)，
                        // 這時候我們才執行「聚焦到該行程」，避免畫面亂跳
                        if (!didScrollHeader) {
                             targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // 不管有沒有捲動，都要執行黃色閃爍高亮
                        targetEl.classList.remove('bg-yellow-100', 'transition-colors', 'duration-1000');
                        void targetEl.offsetWidth; // 強制重繪
                        targetEl.classList.add('bg-yellow-100', 'transition-colors', 'duration-1000');
                        setTimeout(() => targetEl.classList.remove('bg-yellow-100'), 1500);
                    }
                }
            }, 150); // 等待渲染完成
        };
        
        window.handleBigCalDbClick = function(y, m, d) {
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            window.openAddModal();
            const dateInput = document.getElementById('input-date-start');
            if (dateInput) { dateInput.value = dateStr; }
            window.updateDateDisplay('start', dateStr);
            if(window.autoUpdateEnd) window.autoUpdateEnd();
        };

        let touchStartX = 0; let touchStartY = 0;
        window.initSwipe = function() {
            // 修改：改為監聽新的捲動區域，這樣手指在格子上滑動時才觸發
            const el = document.getElementById('calendar-scroll-area') || document.getElementById('calendar-view-month');
            
            if(!el) return;
            
            el.addEventListener('touchstart', e => { 
                touchStartX = e.changedTouches[0].screenX; 
                touchStartY = e.changedTouches[0].screenY; 
            }, {passive: true});
            
            el.addEventListener('touchend', e => {
                if (currentViewMode !== 'month') return;
                
                const touchEndX = e.changedTouches[0].screenX; 
                const touchEndY = e.changedTouches[0].screenY;
                
                const diffX = touchStartX - touchEndX; 
                const diffY = touchStartY - touchEndY;
                
                // 邏輯：水平滑動距離 > 垂直滑動距離 (代表使用者想橫滑，不是想捲動)
                // 且滑動距離 > 50px 才觸發
                if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if(diffX > 0) window.changeBigCalMonth(1); // 左滑 -> 下個月
                    else window.changeBigCalMonth(-1);         // 右滑 -> 上個月
                }
            }, {passive: true});
        };

        window.renderBigCalendar = function() {
            const y = bigCalDate.getFullYear();
            const m = bigCalDate.getMonth();
            const title = document.getElementById('big-cal-title');
            if(title) title.textContent = `${y}年${m+1}月`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            
            // 0. 準備資料
            const items = window.getCalendarItems ? window.getCalendarItems() : [];
            const monthStart = new Date(y, m, 1);
            const monthEnd = new Date(y, m, daysInMonth, 23, 59, 59);

            // 1. 篩選出本月相關行程 (包含跨月)
            const visibleEvents = items.filter(e => {
                const s = new Date(e.startDate || e.timestamp);
                const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                const end = new Date(endStr); end.setHours(23,59,59);
                return end >= monthStart && s <= monthEnd;
            });

            // 2. 預先排序 (這是關鍵：決定誰有資格先搶「第1排」)
            // 優先順序：休假 > 跨越天數長 > 開始時間早
            visibleEvents.sort((a, b) => {
                const aIsLeave = window.isLeaveEvent(a.title);
                const bIsLeave = window.isLeaveEvent(b.title);
                if (aIsLeave !== bIsLeave) return aIsLeave ? -1 : 1; // 休假優先
                
                // 計算持續天數
                const getDuration = (evt) => {
                    const s = new Date(evt.startDate || evt.timestamp);
                    const eStr = evt.endDate || evt.dueDateEnd || (evt.startDate || evt.dueDate);
                    const e = new Date(eStr);
                    return (e - s);
                };
                const durA = getDuration(a);
                const durB = getDuration(b);
                if (Math.abs(durA - durB) > 86400000) return durB - durA; // 長行程優先
                
                return new Date(a.timestamp) - new Date(b.timestamp); // 最後比時間
            });

            // 3. 軌道分配演算法 (Tetris Algorithm)
            // 用來記錄每一天、每一軌是否被佔用: slots[dayKey][trackIndex] = true/false
            const slots = {}; 
            // 用來記錄每個活動被分配到第幾軌: eventTrack[eventId] = trackIndex
            const eventTrack = {}; 

            visibleEvents.forEach(e => {
                const s = new Date(e.startDate || e.timestamp); s.setHours(0,0,0,0);
                const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                const end = new Date(endStr); end.setHours(0,0,0,0);

                // 找出這個行程涵蓋的所有日期字串 (key)
                const coveredKeys = [];
                let loopDate = new Date(s);
                while(loopDate <= end) {
                    if (loopDate.getMonth() === m) { // 只處理本月的格子
                        coveredKeys.push(`${loopDate.getDate()}`);
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }

                if (coveredKeys.length === 0) return;

                // 尋找可用的最小軌道 (Track)
                let track = 0;
                while (true) {
                    let isTrackFree = true;
                    // 檢查這個行程涵蓋的每一天，在這個軌道是否都是空的
                    for (const key of coveredKeys) {
                        if (!slots[key]) slots[key] = [];
                        if (slots[key][track]) {
                            isTrackFree = false;
                            break;
                        }
                    }
                    if (isTrackFree) {
                        // 找到空位了！佔用它
                        for (const key of coveredKeys) {
                            slots[key][track] = true;
                        }
                        eventTrack[e.id] = track;
                        break;
                    }
                    track++; // 這一軌有人了，試下一軌
                }
            });

            // 4. 開始渲染 HTML
            let html = '';
            // 填補前面的空白
            for(let i=0; i<firstDay; i++) {
                html += `<div class="big-cal-cell bg-gray-50/30"></div>`;
            }

            for(let d=1; d<=daysInMonth; d++) {
                const current = new Date(y, m, d);
                const nowStr = new Date().toDateString();
                const isToday = current.toDateString() === nowStr;
                const dayKey = `${d}`;

                // 找出當天所有的行程
                const dayEvents = visibleEvents.filter(e => {
                    const s = new Date(e.startDate || e.timestamp); s.setHours(0,0,0,0);
                    const endStr = e.endDate || e.dueDateEnd || (e.startDate || e.dueDate);
                    const end = new Date(endStr); end.setHours(0,0,0,0);
                    return current >= s && current <= end;
                });

                // 找出當天用到的最大軌道數 (為了決定是否顯示 +N)
                // 這裡我們只顯示前 4 軌 (0, 1, 2, 3)
                const MAX_VISIBLE_TRACKS = 4;
                let bars = '';
                
                // 依軌道順序渲染 (0 -> MAX)
                // 這裡很關鍵：即使某些軌道是空的，也要渲染「透明佔位符」
                // 這樣才能把位於 第2軌 的行程「撐」上去
                
                // 計算當天實際顯示到第幾軌
                let maxTrackUsed = -1;
                dayEvents.forEach(e => {
                    if (eventTrack[e.id] > maxTrackUsed) maxTrackUsed = eventTrack[e.id];
                });

                // 限制渲染迴圈
                const renderLimit = Math.min(maxTrackUsed, MAX_VISIBLE_TRACKS - 1);
                
                for (let t = 0; t <= renderLimit; t++) {
                    // 找找看當天、這一軌有沒有行程
                    // ... (前段的 eventTrack 查找邏輯保持不變) ...
                    const evt = dayEvents.find(e => eventTrack[e.id] === t);

                    if (evt) {
                        // === 渲染行程條 ===
                        let bg;
                        if (evt.isJoint) bg = roleColors.joint;
                        else bg = (evt.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                        
                        const s = new Date(evt.startDate || evt.timestamp); s.setHours(0,0,0,0);
                        const endStr = evt.endDate || evt.dueDateEnd || (evt.startDate || evt.dueDate);
                        const end = new Date(endStr); end.setHours(0,0,0,0);
                        
                        const isStart = current.getTime() === s.getTime();
                        const isEnd = current.getTime() === end.getTime();
                        const isSingle = isStart && isEnd;
                        const isVac = window.isLeaveEvent(evt.title);

                        // === 修改重點：決定是否顯示文字 ===
                        // 規則：只有在「開始日」、「單日行程」或「每月1號(d===1)」才顯示標題
                        const showLabel = isStart || isSingle || (d === 1);

                        let styleAttr = `background-color:${bg};`;
                        let content = evt.title;
                        let shapeClass = 'rounded-[3px] mx-[2px] relative z-0'; 

                        if (!isSingle) {
                            if (isStart) {
                                shapeClass = 'rounded-l-[3px] rounded-r-none mr-[-3px] pr-2 relative z-10 ml-[2px]'; 
                                // content 預設就是 title，不用動
                            } else if (isEnd) {
                                shapeClass = 'rounded-l-none rounded-r-[3px] ml-[-3px] pl-2 relative z-10 mr-[2px]';
                                if (!showLabel) content = '&nbsp;'; // 結尾不顯示字 (除非剛好是1號)
                            } else {
                                shapeClass = 'rounded-none mx-[-3px] relative z-10';
                                if (!showLabel) content = '&nbsp;'; // 中間不顯示字 (除非剛好是1號)
                            }
                        }

                        if (isVac) {
                            styleAttr = `color:${bg}; border: 1px solid ${bg}; background-color: white;`; 
                            if (!isSingle && !isStart && !isEnd) styleAttr += ' border-left: none; border-right: none;';
                            if (!isSingle && isStart) styleAttr += ' border-right: none;';
                            if (!isSingle && isEnd) styleAttr += ' border-left: none;';
                            
                            // 休假也套用同樣邏輯：跨月或開始時才顯示文字
                            content = showLabel ? `🏖 ${evt.title}` : '&nbsp;';
                        }

                        bars += `<div class="event-bar ${evt.isTodo&&evt.done?'done':''} ${shapeClass}" style="${styleAttr}" onclick="event.stopPropagation(); window.selectBigCalendarDate(${y},${m},${d}, '${evt.id}')">${content}</div>`;
                    } else {
                        // ... (隱形支架邏輯保持不變) ...
                        bars += `<div class="event-bar invisible"></div>`;
                    }
                }

                // 處理 +N
                let moreHtml = '';
                const hiddenEvents = dayEvents.filter(e => eventTrack[e.id] >= MAX_VISIBLE_TRACKS);
                if(hiddenEvents.length > 0) {
                    moreHtml = `<div class="more-events">${hiddenEvents.length} more</div>`;
                }

                html += `<div class="big-cal-cell ${isToday?'today':''}" id="big-cal-day-${d}" onclick="window.selectBigCalendarDate(${y},${m},${d})" ondblclick="window.handleBigCalDbClick(${y},${m},${d})">
                    <div class="big-cal-day-num">${d}</div>
                    <div class="big-cal-content-wrapper">
                        ${bars}
                        ${moreHtml}
                    </div>
                </div>`;
            }
            
            const grid = document.getElementById('big-cal-grid');
            if(grid) grid.innerHTML = html;
        };

        function initApp(db) {
            if (!db) { console.error("Firebase not initialized"); return; }
            const conn = document.getElementById('connection-status'); if (conn) { conn.className = "w-2 h-2 rounded-full bg-ttgreen shadow-[0_0_8px_#2cc998]"; }
            bindSnapshot(db.collection('events').orderBy('timestamp', 'asc'), (snapshot) => {
              const events = []; snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
              allEventsCache = events;
              safeRun(() => window.renderDashboardNextUp(window.getCalendarItems()), 'dashboard-events');
              safeRun(() => window.renderCalendarListView(), 'calendar-list');
              if (currentViewMode === 'month') safeRun(() => window.renderBigCalendar(), 'big-calendar');
            }, 'events');
            bindSnapshot(db.collection('todos').orderBy('createdAt', 'desc'), (snapshot) => {
              const todos = []; snapshot.forEach(doc => todos.push({ id: doc.id, ...doc.data() }));
              allTodosCache = todos;
              safeRun(() => window.renderTodos(todos), 'todos');
              safeRun(() => window.renderDashboardNextUp(window.getCalendarItems()), 'dashboard-todos');
              safeRun(() => window.renderCalendarListView(), 'calendar-list-from-todos');
              if (currentViewMode === 'month') safeRun(() => window.renderBigCalendar(), 'big-calendar-from-todos');
            }, 'todos');
            
            // ... 在 initApp 函式內 ...

            // === 修改：聊天室監聽 (包含自動刪除過期訊息) ===
            bindSnapshot(db.collection('messages').orderBy('timestamp', 'desc').limit(50), (snapshot) => {
                const msgs = [];
                const now = new Date();
                const expirationMs = 24 * 60 * 60 * 1000; // 設定過期時間：24 小時 (毫秒)
                // 如果想要保留 3 天，改成： 3 * 24 * 60 * 60 * 1000

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const msgTime = new Date(data.timestamp);
                    
                    // 檢查：如果訊息時間距離現在超過設定的時間
                    if ((now - msgTime) > expirationMs) {
                        // 過期了 -> 默默在背景刪除它
                        db.collection('messages').doc(doc.id).delete()
                            .catch(err => console.warn("清除舊訊息失敗", err));
                    } else {
                        // 沒過期 -> 加入顯示列表
                        msgs.push({ id: doc.id, ...data });
                    }
                });

                // 顯示時反轉 (舊 -> 新)
                window.renderChat(msgs.reverse());
            }, 'chat');

            // ... (其他部分保持不變) ...

            bindSnapshot(db.collection('status').doc('current'), (doc) => { if (doc.exists) safeRun(() => window.renderStatus?.(doc.data()), 'status'); }, 'status');
            // ... (在 initApp 函式內) ...
            
            // 改為監聽 'messages' 集合，依照時間排序，只抓最近 30 筆
            bindSnapshot(db.collection('messages').orderBy('timestamp', 'desc').limit(30), (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                // 因為是 desc 抓最新的，顯示時要反轉變成「舊 -> 新」由上往下排
                window.renderChat(msgs.reverse());
            }, 'chat');
            
            // ... (其他監聽保持不變) ...
        }

        document.addEventListener('DOMContentLoaded', () => {
          safeRun(() => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            window.updateRoleUI();
            window.updateSettingsColorUI();
            if (!currentUserRole) { window.switchTab('settings'); setTimeout(() => window.showToast('歡迎！請先選擇您的身分 👋'), 500); } 
            else { document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]); }
            if (db) initApp(db);
            window.initSwipe();
          }, 'bootstrap');
        });

        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
          window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered', reg)).catch(err => console.error('SW failed', err)); });
        }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) { safeRun(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); if (currentViewMode === 'month') { window.renderBigCalendar(); } }, 'resume'); } });
    
        // === 待辦分類功能核心邏輯 ===

        // 1. 定義預設分類
        const defaultCategories = [
            { name: '生活', color: '#e0f2fe', text: '#0284c7' }, // 藍
            { name: '購物', color: '#fef3c7', text: '#d97706' }, // 黃
            { name: '工作', color: '#f3f4f6', text: '#4b5563' }, // 灰
            { name: '財務', color: '#dcfce7', text: '#16a34a' }, // 綠
            { name: '重要', color: '#fee2e2', text: '#dc2626' }, // 紅
            { name: 'Debug', color: '#f3e8ff', text: '#7e22ce' }, // 紫
            { name: 'Party', color: '#fce7f3', text: '#be185d' }  // 粉
        ];

        // 讀取使用者的自訂分類
        let customCategories = JSON.parse(localStorage.getItem('my_custom_categories') || '[]');

        // 渲染標籤函式
        window.renderCategoryChips = function(selectedVal = '') {
            const container = document.getElementById('todo-category-chips');
            if(!container) return;
            
            container.innerHTML = '';
            
            // 合併預設與自訂分類
            const allCats = [...defaultCategories];
            customCategories.forEach(c => {
                // 避免重複
                if(!allCats.find(def => def.name === c)) {
                    allCats.push({ name: c, color: '#f3f4f6', text: '#4b5563' });
                }
            });

            // 產生 HTML
            allCats.forEach(cat => {
                const isActive = cat.name === selectedVal;
                const el = document.createElement('div');
                el.className = `category-chip ${isActive ? 'active' : ''}`;
                el.textContent = cat.name;
                el.onclick = () => window.selectTodoCategory(cat.name);
                container.appendChild(el);
            });
        };

        // 點選標籤
        window.selectTodoCategory = function(name) {
            const current = document.getElementById('todo-input-category').value;
            // 如果點選已選取的，則取消選取
            if (current === name) {
                document.getElementById('todo-input-category').value = '';
            } else {
                document.getElementById('todo-input-category').value = name;
            }
            window.renderCategoryChips(document.getElementById('todo-input-category').value);
        };

        // 切換自訂輸入框
        window.toggleCustomCategoryInput = function() {
            const el = document.getElementById('todo-custom-category-container');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) {
                document.getElementById('todo-input-category-custom').focus();
            }
        };

        // 覆寫：開啟新增視窗 (初始化分類)
        const originalOpenAddTodoModal = window.openAddTodoModal;
        window.openAddTodoModal = function() {
            originalOpenAddTodoModal(); // 執行原本的開啟邏輯
            
            // 重置分類狀態
            document.getElementById('todo-input-category').value = '';
            document.getElementById('todo-input-category-custom').value = '';
            document.getElementById('todo-custom-category-container').classList.add('hidden');
            window.renderCategoryChips();
        };

        // 覆寫：開啟編輯視窗 (載入舊分類)
        const originalOpenEditTodoModal = window.openEditTodoModal;
        window.openEditTodoModal = function(id) {
            originalOpenEditTodoModal(id);
            
            const todo = allTodosCache.find(t => t.id === id);
            if(todo) {
                const cat = todo.category || '';
                document.getElementById('todo-input-category').value = cat;
                window.renderCategoryChips(cat);
            }
        };
    
        window.renderChat = function(messages) {
            const container = document.getElementById('chat-container');
            if(!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs opacity-60"><i data-lucide="message-square" class="w-8 h-8 mb-2"></i><p>還沒有訊息，快傳送第一則！</p></div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            let html = '';
            // 用來記錄上一則訊息是誰傳的，如果連續傳送就不重複顯示頭像 (這是進階優化，這裡先簡單處理)
            
            messages.forEach(msg => {
                const isMe = msg.creator === currentUserRole;
                const roleColor = roleColors[msg.creator] || '#ccc';
                const avatarChar = msg.creator === 'haohao' ? '皓' : '毛';
                const displayName = msg.creator === 'haohao' ? '皓皓' : '毛毛';
                
                // 時間格式化 (例如 20:30)
                const date = new Date(msg.timestamp);
                const timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

                if (isMe) {
                    // === 右側 (自己) ===
                    // 自己不需要顯示名字，只顯示氣泡和時間
                    html += `
                    <div class="chat-row right">
                        <span class="chat-time mb-1">${timeStr}</span>
                        <div class="chat-bubble" onclick="window.confirmDeleteMsg('${msg.id}')">
                            ${msg.text}
                        </div>
                    </div>`;
                } else {
                    // === 左側 (對方) ===
                    // 結構：頭像 + (名字 + 氣泡 + 時間)
                    html += `
                    <div class="chat-row left">
                        <div class="chat-avatar self-start" style="background-color: ${roleColor}">${avatarChar}</div>
                        
                        <div class="flex flex-col items-start ml-2 max-w-[75%]">
                            <span class="text-[10px] text-gray-600 mb-0.5 ml-0.5 font-medium">${displayName}</span>
                            
                            <div class="flex items-end">
                                <div class="chat-bubble" onclick="window.confirmDeleteMsg('${msg.id}')">
                                    ${msg.text}
                                </div>
                                <span class="chat-time ml-1 mb-0">${timeStr}</span>
                            </div>
                        </div>
                    </div>`;
                }
            });

            container.innerHTML = html;
            window.scrollToBottom();
        };

        window.scrollToBottom = function() {
            const container = document.getElementById('chat-container');
            if(container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        };

        window.confirmDeleteMsg = function(msgId) {
            deleteTarget = 'message';
            noteToDelete = msgId; 
            
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            const btn = document.getElementById('confirm-delete-btn'); // 抓取按鈕

            if(title) title.textContent = '收回訊息？';
            if(desc) desc.textContent = '確定要收回這則訊息嗎？'; // 改成「收回」
            if(btn) btn.textContent = '收回'; // 按鈕改成「收回」
            
            window.confirmDelete();
        };

        // === 修正後的完整刪除執行函式 ===
        window.executeDelete = function() { 
            // 1. 刪除行程
            if (deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete()
                    .then(() => { 
                        window.closeConfirmModal(); 
                        window.closeAddModal(); 
                        window.showToast('行程已刪除'); 
                    })
                    .catch(e => { 
                        console.error(e); 
                        window.showToast('刪除失敗'); 
                    }); 
            } 
            // 2. 刪除待辦
            else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete()
                    .then(() => { 
                        window.closeConfirmModal(); 
                        window.closeAddTodoModal(); 
                        window.showToast('待辦已刪除'); 
                    })
                    .catch(e => { 
                        console.error(e); 
                        window.showToast('刪除失敗'); 
                    }); 
            } 
            // 3. 收回訊息 (聊天室)
            else if (deleteTarget === 'message' && noteToDelete) { 
                db.collection('messages').doc(noteToDelete).delete()
                    .then(() => { 
                        window.showToast('訊息已收回'); 
                        window.closeConfirmModal(); 
                    })
                    .catch(() => { 
                        window.showToast('刪除失敗'); 
                    });
            }
            // 4. 刪除心情 (舊版功能，保留以防萬一)
            else if (deleteTarget === 'note' && noteToDelete) { 
                window.deleteNote(noteToDelete); 
                window.closeConfirmModal();
            }
        };

        // === 新增：渲染設定頁面的分類開關 ===
        window.renderCategorySettings = function() {
            const container = document.getElementById('settings-category-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            // 1. 收集所有出現過的分類 (預設 + 自訂 + 現有待辦中用到的)
            const allCats = new Set(defaultCategories.map(c => c.name));
            if(window.customCategories) window.customCategories.forEach(c => allCats.add(c));
            // 也要包含目前待辦事項中已經存在的分類 (避免漏網之魚)
            if(allTodosCache) allTodosCache.forEach(t => { if(t.category) allCats.add(t.category); });
            
            const sortedCats = Array.from(allCats).sort();

            // 2. 產生開關 UI
            sortedCats.forEach(cat => {
                // 預設為 true (顯示)，除非明確被設為 false
                const isVisible = window.todoCategoryVisibility[cat] !== false;
                
                // 顏色裝飾
                const defCat = defaultCategories.find(c => c.name === cat);
                const color = defCat ? defCat.color : '#f3f4f6'; // 預設灰
                
                const html = `
                <div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                        <span class="text-sm text-gray-700">${cat}</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" onchange="window.toggleCategoryVisibility('${cat}')" ${isVisible ? 'checked' : ''}>
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-ttgreen"></div>
                    </label>
                </div>`;
                container.innerHTML += html;
            });
        };

        // === 新增：切換分類顯示狀態 ===
        window.toggleCategoryVisibility = function(cat) {
            const current = window.todoCategoryVisibility[cat] !== false;
            window.todoCategoryVisibility[cat] = !current; // 反轉狀態
            
            // 存入 LocalStorage
            localStorage.setItem('todo_category_visibility', JSON.stringify(window.todoCategoryVisibility));
            
            // 立即刷新摘要頁面 (如果有資料的話)
            if (typeof window.renderTodos === 'function' && allTodosCache.length > 0) {
                window.renderTodos(allTodosCache);
            }
        };

    </script>
</body>
</html>
