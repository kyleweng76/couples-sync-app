<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>我們的小時光</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ttgreen: '#2cc998', 
                        ttred: '#e95d5d',   
                        ttgray: '#f5f5f5',  
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #ffffff; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #main-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        .page-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding-top: 70px; 
            padding-bottom: 90px;
            background-color: #f9fafb;
            display: none; 
        }
        .page-content.active { display: block; }
        
        /* 修改：Padding Top 統一為 70px，避免切換時跳動 */
        #page-calendar.active {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            padding-top: 70px; 
            padding-bottom: 70px;
        }
        
        .nav-item.active { color: #2cc998; } 
        .nav-item.active svg { stroke-width: 2.5px; }

        .tt-input-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tt-input-row:active { background-color: #f9fafb; }
        .tt-icon { color: #9ca3af; margin-right: 12px; width: 20px; height: 20px; flex-shrink: 0; }
        
        .modal { transition: opacity 0.2s ease, transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.visible { opacity: 1; pointer-events: auto; transform: scale(1); }

        .custom-checkbox { appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor; width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #2cc998; border-color: #2cc998; }
        .custom-checkbox:checked::before { transform: scale(1); }
        
        .cat-chip { padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; border: 1px solid #e5e7eb; background: white; color: #6b7280; white-space: nowrap; transition: all 0.2s; }
        .cat-chip.active { background: #2cc998; color: white; border-color: #2cc998; box-shadow: 0 2px 5px rgba(44, 201, 152, 0.2); }

        .todo-item { transition: all 0.3s ease; }
        .todo-item.done span { text-decoration: line-through; color: #9ca3af; }

        .dt-btn { background-color: #f9fafb; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; color: #374151; text-align: center; transition: all 0.2s; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .dt-btn:active, .dt-btn:focus { background-color: #fff; border: 1px solid #2cc998; outline: none; }
        .dt-wrapper-date { flex: 2; position: relative; }
        .dt-wrapper-time { flex: 1; position: relative; }

        /* ===== UPDATED: Unified Input Row Styles ===== */
        .dt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            /* Border logic handled by HTML classes now for better control */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dt-row:active { background-color: #f9fafb; }
        
        .dt-label {
            font-size: 15px; /* Slightly larger */
            font-weight: 500;
            color: #1f2937; /* Darker gray */
            min-width: 60px;
        }
        
        .dt-value {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }
        
        /* Unified Input Style */
        .dt-input {
            width: 100%;
            text-align: right;
            font-size: 15px; 
            color: #1f2937;
            outline: none;
            border: none;
            background: transparent;
            padding: 0;
            font-weight: 400;
        }
        .dt-input::placeholder {
            color: #9ca3af; /* Matches the chevron color */
        }
        
        /* Text placeholder for Date/Time spans */
        .dt-text-placeholder {
            color: #9ca3af;
            font-size: 15px;
        }
        .dt-text-value {
            color: #1f2937; /* Dark */
            font-size: 15px;
            font-weight: 500;
        }

        /* Fixed Time Dropdown Modal Style */
        .time-picker-modal-content {
            background: white;
            border-radius: 16px;
            max-height: 300px;
            overflow-y: auto;
            width: 280px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        .time-option { 
            padding: 10px 16px; 
            font-size: 16px; 
            color: #374151; 
            cursor: pointer; 
            text-align: center;
        }
        .time-option:hover { background-color: #f3f4f6; }
        .time-option.selected { color: #2cc998; font-weight: bold; background-color: #ecfdf5; }

        .status-btn { flex: 1; padding: 8px; text-align: center; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #6b7280; transition: all 0.2s; }
        .status-btn.active { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; font-weight: bold; }
        .status-btn.active[data-status="confirmed"] { background: #ecfdf5; border-color: #2cc998; color: #2cc998; }
        .status-btn.active[data-status="tbc"] { background: #fffbeb; border-color: #f59e0b; color: #f59e0b; }
        .status-btn.active[data-status="tbd"] { background: #fef2f2; border-color: #ef4444; color: #ef4444; border-style: dashed; }

        .status-tag { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: 1px; line-height: 1.4; flex-shrink: 0; }
        .status-tag.tbc { border: 1px solid #f59e0b; color: #f59e0b; background: #fffbeb; }
        .status-tag.tbd { border: 1px dashed #ef4444; color: #ef4444; background: #fef2f2; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Big Calendar View Styles */
        .big-cal-header { font-size: 13px; color: #9ca3af; text-align: center; padding-bottom: 8px; font-weight: 500; }
        .big-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #f3f4f6; border: 1px solid #f3f4f6; }
        .big-cal-cell { 
            background-color: white; 
            min-height: 85px; 
            padding: 2px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative; 
            cursor: pointer; 
            overflow: hidden;
        }
        .big-cal-cell.today { background-color: #f8fafc; }
        .big-cal-cell.selected { background-color: #ecfdf5; box-shadow: inset 0 0 0 2px #2cc998; }
        .big-cal-day-num { 
            font-size: 12px; 
            font-weight: 500; 
            color: #374151; 
            margin-bottom: 2px; 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
        }
        .big-cal-cell.today .big-cal-day-num { background-color: #2cc998; color: white; }
        .event-bar { width: 100%; font-size: 9px; line-height: 1.2; padding: 2px 3px; border-radius: 2px; background-color: #2cc998; color: white; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .event-bar.done { text-decoration: line-through; opacity: 0.6; }
        .more-events { font-size: 9px; color: #9ca3af; margin-top: 1px; }

        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-header { font-size: 12px; color: #9ca3af; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 50%; cursor: pointer; color: #374151; }
        .cal-day:hover { background-color: #f3f4f6; }
        .cal-day.empty { cursor: default; background: none; }
        .cal-day.selected { background-color: #2cc998; color: white; font-weight: bold; }
        .cal-day.today { color: #2cc998; font-weight: bold; }
        .cal-day:nth-child(7n), .cal-day-header:nth-child(7) { color: #f87171; } 
        .cal-day:nth-child(7n+1), .cal-day-header:nth-child(1) { color: #f87171; } 

        .avatar-sm { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #toast-container { transition: opacity 0.3s ease; }
        #toast-container.visible { opacity: 1; }
        /* ===== Calendar Grid Fix (7 columns align) ===== */
        .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        /* ===== FIX: Calendar Picker Height ===== */
        #calendar-picker-modal .calendar-grid {
        min-height: auto;
        }

        #calendar-picker-modal #calendar-days {
        min-height: unset;
        }
        /* ===== iOS-like Calendar Picker ===== */

        /* 整個日期 grid 更緊湊 */
        #calendar-picker-modal .calendar-grid {
        gap: 6px;
        }

        /* 日期格子：圓形、無外框 */
        #calendar-picker-modal .cal-day {
        width: 36px;
        height: 36px;
        aspect-ratio: unset;
        border-radius: 9999px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.15s ease, color 0.15s ease;
        }

        /* Hover（像 iOS 輕觸） */
        #calendar-picker-modal .cal-day:hover {
        background-color: #f2f2f7;
        }

        /* 今天（iOS 常用「字色提示」） */
        #calendar-picker-modal .cal-day.today {
        color: #2cc998;
        font-weight: 600;
        }

        /* 選中日期（iOS 核心） */
        #calendar-picker-modal .cal-day.selected {
        background-color: #2cc998;
        color: white;
        font-weight: 600;
        }

        /* 空白格完全不可點 */
        #calendar-picker-modal .cal-day.empty {
        pointer-events: none;
        background: transparent;
        }

        /* 星期標題更像 iOS */
        #calendar-picker-modal .cal-day-header {
        font-size: 11px;
        font-weight: 500;
        color: #8e8e93;
        }

        /* 整個 modal 高度縮短 */
        #calendar-picker-modal .relative {
        padding-bottom: 12px;
        }
        /* ===== iOS Bottom Nav Touch Fix ===== */
        nav .nav-item {
        padding-bottom: 6px;
        }
        /* ===== iOS-like Bottom Tab Bounce ===== */

        /* Tab 本體 */
        nav .nav-item {
        transition:
            transform 0.12s ease-out,
            background-color 0.12s ease-out;
        border-radius: 12px;
        }

        /* iOS Safari：避免長按出現藍色遮罩 */
        nav .nav-item {
        -webkit-tap-highlight-color: transparent;
        }
        /* ===== iOS-like Bottom Tab (Icon Only Bounce) ===== */

        /* icon 本體 */
        nav .nav-item i {
        transition: transform 0.12s ease-out;
        will-change: transform;
        }

        /* 按下時：只有 icon 縮 */
        nav .nav-item:active i {
        transform: scale(0.85);
        }

        /* 目前頁：icon 微放大 */
        nav .nav-item.active i {
        transform: scale(1.1);
        }

        /* 文字完全不動（保險） */
        nav .nav-item span {
        transform: none !important;
        }

        /* iOS Safari 防藍色高亮 */
        nav .nav-item {
        -webkit-tap-highlight-color: transparent;
        }
        /* ===== iOS-like Active Tab Indicator ===== */

        /* nav-item 變成定位容器 */
        nav .nav-item {
        position: relative;
        }

        /* 使用 CSS 變數控制顏色 */
        nav .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 3px;
        border-radius: 999px;
        background-color: var(--active-tab-color, #2cc998);
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden bg-white">

    <!-- Header (修正版：標題放大，身分標籤移至右側) -->
    <header class="bg-white border-b border-gray-100 p-4 fixed top-0 w-full z-40 safe-top flex justify-between items-center shadow-sm">
        
        <!-- 左側：Logo + 標題 (恢復大字體與間距) -->
        <div class="flex items-center gap-3">
            <img src="icon.png" alt="Logo" class="w-9 h-9 rounded-xl shadow-sm">
            <h1 class="text-lg font-bold text-gray-800 tracking-wide">
                小時光 <span class="text-xs text-gray-400 font-normal ml-0.5">for us</span>
            </h1>
        </div>

        <!-- 右側：身分標籤 + 連線狀態燈 -->
        <div class="flex items-center gap-3">
            
            <!-- 身分顯示膠囊 (移到這裡，放在綠燈左邊) -->
            <!-- 加上 cursor-pointer，點擊可以直接跳轉到設定頁切換身分，很方便 -->
            <!-- 修改：onclick 改為開啟 Modal -->
            <div id="header-role-badge" class="px-2.5 py-1 rounded-full text-xs text-white font-bold shadow-sm transition-colors duration-300 flex items-center gap-1.5 opacity-0 cursor-pointer hover:opacity-90 active:scale-95 transition-transform" onclick="window.openSettingsModal()">
                <span id="header-role-name">載入中</span>
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>

            <!-- 連線狀態 -->
            <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-red-400 ring-2 ring-white shadow-sm"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container">
        <!-- Page 1: Dashboard -->
        <div id="page-dashboard" class="page-content active">
            
            <!-- 1. 頂部間距 -->
            <div class="mt-6"></div>

            <!-- 2. 對話式便利貼區 -->
            <div class="flex flex-col items-center w-full mb-6">
                
                <!-- A. 頭像與對話氣泡列 -->
                <div class="w-full flex justify-between items-start px-5 mb-2 relative z-10">
                    
                    <!-- 左邊：皓皓 -->
                    <div class="flex flex-col items-center gap-1">
                        <div class="relative flex items-center group" onclick="window.setNoteInputFocus()">
                            <div id="avatar-note-haohao" class="w-14 h-14 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xl font-bold ring-4 ring-white shadow-md z-20 cursor-pointer transition-transform active:scale-95" style="background-color: #2cc998;">
                                皓
                                <div id="status-dot-haohao" class="hidden absolute top-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>

                            <div id="note-bubble-haohao" class="hidden absolute left-[64px] top-1/2 transform -translate-y-1/2 opacity-0 -translate-x-2 transition-all duration-300 z-10 w-[110px] flex flex-col items-start">
                                <div class="absolute top-1/2 -translate-y-1/2 -left-1.5 w-3 h-3 bg-white transform rotate-45 border-b border-l border-gray-100 z-20 pointer-events-none"></div>
                                <div class="relative bg-white border border-gray-100 px-2 py-2 rounded-2xl shadow-md text-xs text-gray-600 text-left leading-relaxed break-all whitespace-normal z-10 w-full group-hover:border-green-100 transition-colors cursor-pointer select-none active:scale-95 duration-200" onclick="event.stopPropagation()" ondblclick="window.confirmDeleteNote('haohao')">
                                    <span id="note-text-haohao">...</span>
                                </div>
                            </div>
                        </div>
                        <span id="note-time-haohao" class="text-[10px] text-gray-300 h-4 transition-opacity duration-300 opacity-0"></span>
                    </div>

                    <!-- 右邊：毛毛 -->
                    <div class="flex flex-col items-center gap-1">
                        <div class="relative flex flex-row-reverse items-center group" onclick="window.setNoteInputFocus()">
                            <div id="avatar-note-maomao" class="w-14 h-14 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xl font-bold ring-4 ring-white shadow-md z-20 cursor-pointer transition-transform active:scale-95" style="background-color: #e6688d;">
                                毛
                                <div id="status-dot-maomao" class="hidden absolute top-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>

                            <div id="note-bubble-maomao" class="hidden absolute right-[64px] top-1/2 transform -translate-y-1/2 opacity-0 translate-x-2 transition-all duration-300 z-10 w-[110px] flex flex-col items-end">
                                <div class="absolute top-1/2 -translate-y-1/2 -right-1.5 w-3 h-3 bg-white transform rotate-45 border-t border-r border-gray-100 z-20 pointer-events-none"></div>
                                <div class="relative bg-white border border-gray-100 px-2 py-2 rounded-2xl shadow-md text-xs text-gray-600 text-left leading-relaxed break-all whitespace-normal z-10 w-full group-hover:border-pink-100 transition-colors cursor-pointer select-none active:scale-95 duration-200" onclick="event.stopPropagation()" ondblclick="window.confirmDeleteNote('maomao')">
                                    <span id="note-text-maomao">...</span>
                                </div>
                            </div>
                        </div>
                        <span id="note-time-maomao" class="text-[10px] text-gray-300 h-4 transition-opacity duration-300 opacity-0"></span>
                    </div>
                </div>

                <!-- B. 輸入框 -->
                <div class="relative z-20 h-9 w-[270px]">
                    <!-- Added overflow-hidden to clip the button if it tries to escape, and flex-nowrap -->
                    <div class="flex flex-nowrap items-center bg-white rounded-full px-1 py-0.5 shadow-sm border border-gray-200 focus-within:ring-2 focus-within:ring-opacity-50 transition-all h-full overflow-hidden">
                        <!-- 左側 Icon (恢復) -->
                        <div class="w-8 h-8 flex items-center justify-center text-gray-300 flex-shrink-0">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                        </div>
                        
                        <!-- 輸入框 -->
                        <input type="text" id="note-input" maxlength="14" placeholder="說點什麼吧..." 
                            class="flex-1 min-w-0 bg-transparent border-none text-xs text-gray-600 placeholder-gray-300 focus:ring-0 px-1 outline-none text-left h-full tracking-wide">

                        <!-- 發送按鈕 (移到右側，並加入 ID) -->
                        <button id="note-send-btn" onclick="window.sendNote()" class="w-7 h-7 flex items-center justify-center rounded-full text-white shadow-sm active:scale-90 transition ml-0.5 flex-shrink-0" style="background-color: #d1d5db;">
                            <i data-lucide="send" class="w-3.5 h-3.5 ml-0.5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. 操作按鈕區 -->
            <div class="px-4 flex gap-3 mb-6">
                <button onclick="window.openAddModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="calendar-plus" class="w-5 h-5 text-ttgreen"></i>
                    <span class="text-sm font-bold">新增行程</span>
                </button>
                
                <button onclick="window.openAddTodoModal()" class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-gray-600 flex items-center justify-center gap-2 active:bg-gray-50 transition">
                    <i data-lucide="check-square" class="w-5 h-5 text-blue-400"></i>
                    <span class="text-sm font-bold">新增待辦</span>
                </button>
            </div>

            <!-- 4. Next Up Card -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 mx-4">
                <div class="bg-ttgreen px-4 py-2 flex justify-between items-center">
                    <span class="text-white text-xs font-bold tracking-wider">NEXT 7 DAYS</span>
                    <span id="dashboard-countdown" class="text-white text-xs bg-white/20 px-2 py-0.5 rounded-full">...</span>
                </div>
                <div id="dashboard-next-list" class="divide-y divide-gray-100 min-h-[100px]">
                    <div class="text-center py-8 text-gray-400 text-sm">載入中...</div>
                </div>
            </div>

            <!-- 5. 待辦清單摘要 -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4 mx-4 mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 h-4 text-ttgreen"></i> 待辦清單
                    </h3>
                    <button onclick="window.switchTab('todo')" class="text-xs text-ttgreen font-medium">查看全部</button>
                </div>
                <div id="dashboard-todo-list" class="space-y-2">
                    <p class="text-xs text-gray-400 text-center py-2">載入中...</p>
                </div>
            </div>
            
        </div>

        <!-- Page 2: Calendar -->
        <div id="page-calendar" class="page-content">
            <!-- 修正 Header：高度固定 60px，按鈕絕對定位 -->
            <div class="flex-none bg-white z-10 border-b border-gray-200 px-4 flex items-center justify-center h-[60px] relative">
                 <!-- 中間：視圖切換 (置中 + 固定寬度) -->
                 <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="window.switchCalendarView('list')" id="btn-view-list" class="w-16 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-ttgreen transition-all">列表</button>
                    <button onclick="window.switchCalendarView('month')" id="btn-view-month" class="w-16 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">月曆</button>
                </div>
                
                <!-- 右側：新增按鈕 (絕對定位 + 垂直置中) -->
                <button onclick="window.openAddModal()" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-ttgreen text-white p-2 rounded-lg shadow-sm active:scale-95 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 relative w-full" id="calendar-view-month">
                <div id="calendar-view-list" class="absolute inset-0 overflow-y-auto">
                    <div id="event-list" class="divide-y divide-gray-100 bg-white">
                        <div class="text-center py-10 text-gray-400 text-sm">載入中...</div>
                    </div>
                </div>
                <div id="calendar-view-month-container" class="absolute inset-0 overflow-y-auto hidden">
                    <div class="flex justify-between items-center p-4 bg-white">
                        <h2 id="big-cal-title" class="text-lg font-bold text-gray-800">...</h2>
                        <div class="flex gap-2">
                            <button onclick="window.changeBigCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button onclick="window.changeBigCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="bg-white pb-2">
                        <div class="grid grid-cols-7 text-center mb-1">
                            <div class="big-cal-header text-red-400">日</div><div class="big-cal-header">一</div><div class="big-cal-header">二</div><div class="big-cal-header">三</div><div class="big-cal-header">四</div><div class="big-cal-header">五</div><div class="big-cal-header text-red-400">六</div>
                        </div>
                        <div id="big-cal-grid" class="big-cal-grid border-t border-gray-100"></div>
                    </div>
                    <div class="mt-2 bg-white border-t border-gray-200 min-h-[300px]">
                        <div class="px-4 py-2 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                            <span id="selected-date-label" class="text-sm font-bold text-gray-600">選擇日期查看</span>
                        </div>
                        <div id="month-event-list" class="divide-y divide-gray-100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Todo -->
        <div id="page-todo" class="page-content">
            <!-- 修正 Header：高度固定 60px，按鈕絕對定位 -->
            <div class="sticky top-0 bg-white z-10 border-b border-gray-200 px-4 flex items-center h-[60px] relative">
                <h2 class="text-xl font-bold text-gray-800">待辦清單</h2>
                 
                 <!-- 右側：新增按鈕 (絕對定位 + 垂直置中) -->
                 <button onclick="window.openAddTodoModal()" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-ttgreen text-white p-2 rounded-lg shadow-sm active:scale-95 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="todo-list-container" class="p-4 space-y-6 pb-24">
                <!-- Joint Section -->
                <div>
                     <h3 class="text-sm font-bold text-orange-400 mb-2 flex items-center gap-1">
                        <i data-lucide="users" class="w-4 h-4"></i> 共同待辦
                    </h3>
                    <div id="todo-list-joint" class="space-y-2"></div>
                </div>
                 <!-- Haohao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-ttgreen mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> 皓皓
                    </h3>
                    <div id="todo-list-haohao" class="space-y-2"></div>
                </div>
                 <!-- Maomao Section -->
                 <div>
                     <h3 class="text-sm font-bold text-pink-400 mb-2 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> 毛毛
                    </h3>
                    <div id="todo-list-maomao" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Page 4 REMOVED, replaced by Modal -->
    </main>

    <!-- Global Color Picker Modal -->
    <div id="global-color-picker" class="fixed inset-0 z-[70] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.toggleGlobalColorPicker(false)"></div>
        <div class="relative bg-white w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">選擇顏色</h3>
            <div id="global-color-grid" class="grid grid-cols-1 gap-1 max-h-[300px] overflow-y-auto"></div>
            <button onclick="window.toggleGlobalColorPicker(false)" class="mt-4 w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">取消</button>
        </div>
    </div>
    
    <!-- Settings Modal (New!) -->
    <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeSettingsModal()"></div>
        <div class="relative bg-white w-[320px] rounded-2xl shadow-xl overflow-hidden transform scale-100 transition-transform">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">設定</h3>
                <button onclick="window.closeSettingsModal()" class="p-1 rounded-full hover:bg-gray-200 text-gray-400 transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-5 space-y-6">
                <!-- Role Selection -->
                <div id="role-selection-section" class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">我是誰？ (切換身分)</p>
                    <div class="flex gap-3">
                        <button id="role-haohao" onclick="window.setRole('haohao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">皓皓</button>
                        <button id="role-maomao" onclick="window.setRole('maomao')" class="flex-1 py-3 rounded-xl text-sm font-bold border transition transform active:scale-95">毛毛</button>
                    </div>
                </div>
                
                <!-- Color Settings -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">代表色設定</p>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('haohao')">
                            <span class="text-sm font-medium text-gray-700">皓皓</span>
                            <div id="setting-color-haohao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('maomao')">
                            <span class="text-sm font-medium text-gray-700">毛毛</span>
                            <div id="setting-color-maomao" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 active:scale-98 transition cursor-pointer" onclick="window.openColorConfig('joint')">
                            <span class="text-sm font-medium text-gray-700">共同行程</span>
                            <div id="setting-color-joint" class="w-6 h-6 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                <span class="text-[10px] text-gray-400">Firebase Connected · v105.0</span>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeConfirmModal()"></div>
        <div class="relative bg-white w-[280px] rounded-xl shadow-xl p-5 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-2">確定刪除？</h3>
            <p class="text-sm text-gray-500 mb-4">此動作無法復原，您確定要刪除這個項目嗎？</p>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">取消</button>
                <button onclick="window.executeDelete()" class="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md shadow-red-200">刪除</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[90] pointer-events-none transition-opacity duration-300 opacity-0">
        <div id="toast-message" class="bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur-sm">
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
      <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddModal()"></div>

      <div class="relative bg-white w-full h-full md:h-auto md:w-[380px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
        
        <!-- NEW HEADER: Standard App Style -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
            <button onclick="window.closeAddModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition">取消</button>
            <span class="text-sm font-bold text-gray-800">行程詳情</span>
            <button onclick="window.saveEvent()" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">保存</button>
        </div>

        <!-- Title -->
        <div class="px-6 pt-4 pb-2">
          <label class="text-xs font-bold text-gray-400 mb-1 block">標題</label>
          <input
            type="text"
            id="input-title"
            placeholder="輸入行程標題"
            class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent"
          />
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">

          <!-- Date / Time / Location Group -->
          <!-- 採用白底、內部有分隔線的列表風格 -->
          <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
             
             <!-- Date -->
             <div class="dt-row" onclick="window.openCalendar('start')">
               <div class="dt-label">日期</div>
               <div class="dt-value group">
                 <span id="display-date-start" class="dt-text-placeholder transition-colors">請選擇</span>
                 <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
               </div>
               <input type="hidden" id="input-date-start">
             </div>

             <!-- Time -->
            <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('start')">
              <div class="dt-label">時間</div>
              <div class="dt-value group">
                <span id="display-time-start" class="dt-text-placeholder transition-colors">請選擇</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
              </div>
              <input type="hidden" id="input-time-start" value="">
            </div>

            <!-- Location -->
            <div class="dt-row border-t border-gray-50">
              <div class="dt-label">地點</div>
              <div class="dt-value">
                <input id="input-location" type="text" placeholder="輸入地點" class="dt-input" />
              </div>
            </div>
          </div>

          <!-- Partner -->
          <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
            <span class="text-sm text-gray-700">與對方一起</span>
            <input
              type="checkbox"
              id="check-partner"
              class="custom-checkbox"
              onchange="window.togglePartner()"
            />
          </div>

          <!-- Status -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <label class="text-xs font-bold text-gray-400 mb-2 block">狀態</label>
            <div class="flex gap-2">
              <button
                type="button"
                class="status-btn active"
                data-status="confirmed"
                onclick="window.setStatus('confirmed')"
              >已確認</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbc"
                onclick="window.setStatus('tbc')"
              >TBC</button>
              <button
                type="button"
                class="status-btn"
                data-status="tbd"
                onclick="window.setStatus('tbd')"
              >TBD</button>
            </div>
            <input type="hidden" id="input-status" value="confirmed">
          </div>

          <!-- Note -->
          <div class="bg-white border border-gray-200 rounded-xl p-4">
            <label class="text-xs font-bold text-gray-400 mb-1 block">備註</label>
            <textarea
              id="input-note"
              rows="3"
              placeholder="簡單備註一下就好"
              class="w-full text-sm bg-transparent focus:outline-none resize-none"
            ></textarea>
          </div>

        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-100 flex justify-center pb-safe">
          <!-- 刪除按鈕 (只在編輯時顯示，全寬紅色按鈕) -->
          <button
            id="btn-delete-event"
            onclick="window.deleteCurrentEvent()"
            class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
          >
            刪除此行程
          </button>
        </div>

      </div>
    </div>

    
    <!-- Add Todo Modal -->
    <div id="add-todo-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeAddTodoModal()"></div>
        <div class="relative bg-white w-full h-full md:h-auto md:w-[350px] md:rounded-2xl flex flex-col md:max-h-[85vh]">
            
            <!-- HEADER: Standard App Style (Unified with Add Event) -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
                <button onclick="window.closeAddTodoModal()" class="text-gray-500 text-sm font-medium px-2 py-1 hover:bg-gray-50 rounded-lg transition">取消</button>
                <span id="todo-modal-title" class="text-sm font-bold text-gray-800">新增待辦事項</span>
                <button onclick="window.saveTodoItem()" id="todo-modal-btn" class="text-ttgreen text-sm font-bold px-2 py-1 hover:bg-green-50 rounded-lg transition">新增</button>
            </div>

            <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                <!-- Content Input (Unified Style) -->
                <div class="px-2 pt-2 pb-2">
                    <label class="text-xs font-bold text-gray-400 mb-1 block">內容</label>
                    <input type="text" id="todo-input-title" placeholder="輸入待辦事項..." class="w-full text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 focus:outline-none focus:border-ttgreen bg-transparent">
                </div>
                
                <!-- Date/Time Group (Unified List Style) -->
                <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
                    <!-- Date -->
                    <div class="dt-row" onclick="window.openCalendar('todo')">
                        <div class="dt-label">日期</div>
                        <div class="dt-value group">
                            <span id="display-date-todo" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-date-todo">
                    </div>
                    
                    <!-- Time -->
                    <div class="dt-row border-t border-gray-50 dt-wrapper-time" onclick="window.openTimePicker('todo')">
                        <div class="dt-label">時間</div>
                        <div class="dt-value group">
                            <span id="display-time-todo" class="dt-text-placeholder transition-colors">請選擇</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1 group-active:text-gray-500"></i>
                        </div>
                        <input type="hidden" id="input-time-todo">
                    </div>
                </div>

                <!-- Options -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-700">共同待辦 (兩人可見)</span>
                    <input type="checkbox" id="todo-check-joint" class="custom-checkbox">
                </div>
            </div>

            <!-- Footer (Delete Button - Unified Style) -->
            <div class="p-4 border-t border-gray-100 flex justify-center pb-safe">
                 <button
                    id="btn-delete-todo"
                    onclick="window.deleteCurrentTodo()"
                    class="hidden w-full py-3 text-sm font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition"
                  >
                    刪除此待辦
                  </button>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div id="time-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
         <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeTimePicker()"></div>
         <div id="time-list-container" class="relative time-picker-modal-content flex flex-col">
             <!-- Time slots will be populated here -->
         </div>
    </div>

    <!-- Dropdowns & Pickers -->
    <div id="calendar-picker-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="window.closeCalendar()"></div>
        <div class="relative bg-white rounded-2xl shadow-xl w-[320px] p-4 overflow-hidden max-h-[420px]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cal-month-title" class="text-lg font-bold text-gray-800 tracking-wide cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition">...</h3>
                <div class="flex gap-1"><button onclick="window.changeCalMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><button onclick="window.changeCalMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-500"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-red-400">日</div><div class="cal-day-header">一</div><div class="cal-day-header">二</div><div class="cal-day-header">三</div><div class="cal-day-header">四</div><div class="cal-day-header">五</div><div class="cal-day-header text-red-400">六</div>
            </div>

            <div id="calendar-days" class="calendar-grid"></div>
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-sm font-medium">
                <button onclick="window.selectToday()" class="text-ttgreen hover:bg-green-50 px-3 py-1.5 rounded-lg transition">今天</button>
                <div class="flex gap-2">
                    <button onclick="window.clearDate()" class="text-red-400 hover:bg-red-50 px-3 py-1.5 rounded-lg transition">清除</button>
                    <button onclick="window.closeCalendar()" class="text-gray-400 hover:bg-gray-50 px-3 py-1.5 rounded-lg transition">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav (3 Items only) -->
        <nav class="bg-white border-t border-gray-100 fixed bottom-0 w-full px-6 pt-3 pb-6 pb-safe z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <button class="nav-item active flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('dashboard')"><i data-lucide="layout-grid" class="w-6 h-6"></i><span class="text-[10px] font-medium">摘要</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('calendar')"><i data-lucide="calendar" class="w-6 h-6"></i><span class="text-[10px] font-medium">行事曆</span></button>
            <button class="nav-item flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="window.switchTab('todo')"><i data-lucide="list-checks" class="w-6 h-6"></i><span class="text-[10px] font-medium">清單</span></button>
        </div>
    </nav>

    <script>
       /* ===== STABLE PATCH: SafeRun Helper ===== */
        window.safeRun = function (fn, label = 'unknown') {
        try {
            return fn();
        } catch (err) {
            console.error(`[SafeRun:${label}]`, err);
            if (window.showToast) {
            window.showToast('發生錯誤，但 App 仍可使用');
            }
            return null;
        }
        };
        // --- 1. VARIABLES ---
        /* ===== STABLE PATCH: Firestore Listener Guard ===== */
        const snapshotRegistry = {};

        function bindSnapshot(ref, cb, label = 'snapshot') {
        if (snapshotRegistry[label]) return; // 已綁過

        const unsub = ref.onSnapshot(
            snap => window.safeRun(() => cb(snap), label),
            err => console.error(`[Firestore:${label}]`, err)
        );

        snapshotRegistry[label] = unsub;
        }


        const firebaseConfig = { apiKey: "AIzaSyDLrPr4X6r3e2V_vqFaCICgKVwLmiykxpc", authDomain: "kyle-mao.firebaseapp.com", projectId: "kyle-mao", storageBucket: "kyle-mao.firebasestorage.app", messagingSenderId: "290564848532", appId: "1:290564848532:web:006c4e9df4b1330895ad81" };
        let db; try { if(typeof firebase!=='undefined'){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}

        // 修改：移除預設值，若沒存過就是 null
        let currentUserRole = localStorage.getItem('user_role'); 
        let currentSelectedColor = '#2cc998'; 
        let currentCategory = 'default';
        let editingEventId = null;
        let editingTodoId = null;
        let allEventsCache = [];
        let isSavingEvent = false;
        let __lastSaveAt = 0;
        let allTodosCache = [];
        // 修改：優先從 localStorage 讀取顏色，若沒有才使用預設值
        let roleColors = { 
            haohao: localStorage.getItem('color_haohao') || '#2cc998', 
            maomao: localStorage.getItem('color_maomao') || '#e6688d', 
            joint: localStorage.getItem('color_joint') || '#f7b546' 
        };
        let colorPickerTarget = null;
        let calTargetInput = 'start'; 
        let calCurrentDate = new Date(); 
        let bigCalDate = new Date();
        let currentViewMode = 'list';
        let timePickerTarget = ''; // FIX: variable for time picker
        let deleteTarget = 'event'; // 'event' or 'todo'
        let noteToDelete = null;

        const timeTreeColors = [ { name: "Emerald Green", hex: "#2cc998" }, { name: "Modern Cyan", hex: "#5cc2d1" }, { name: "Deep Sky Blue", hex: "#5ba3eb" }, { name: "Pastel Brown", hex: "#a68b75" }, { name: "Midnight Black", hex: "#333333" }, { name: "Apple Red", hex: "#e35651" }, { name: "French Rose", hex: "#e6688d" }, { name: "Coral Pink", hex: "#f29074" }, { name: "Bright Orange", hex: "#f7b546" }, { name: "Soft Violet", hex: "#9f82d1" } ];
        const moodMap = { 'charging': { icon: '⚡️', bg: 'bg-yellow-100', border: 'border-yellow-300' }, 'sleepy': { icon: '💤', bg: 'bg-blue-100', border: 'border-blue-300' }, 'love': { icon: '❤️', bg: 'bg-rose-100', border: 'border-rose-300' }, 'busy': { icon: '🔥', bg: 'bg-orange-100', border: 'border-orange-300' }, 'normal': { icon: '😶', bg: 'bg-gray-50', border: 'border-gray-100' } };

        // --- 2. GLOBAL FUNCTION DEFINITIONS (Assigned to window immediately) ---

        // ==========================================
        //  MISSING PICKER LOGIC (RE-ADDED)
        // ==========================================

        // --- Calendar Picker ---
        window.openCalendar = function(type) {
            calTargetInput = type; // 'start', 'end', 'todo'
            
            // Get current value
            const val = document.getElementById(`input-date-${type}`).value;
            if (val) {
                calCurrentDate = new Date(val);
            } else {
                calCurrentDate = new Date();
            }
            
            window.renderCalendarPicker();
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeCalendar = function() {
            const m = document.getElementById('calendar-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.changeCalMonth = function(delta) {
            calCurrentDate.setMonth(calCurrentDate.getMonth() + delta);
            window.renderCalendarPicker();
        };

        window.renderCalendarPicker = function() {
            const y = calCurrentDate.getFullYear();
            const m = calCurrentDate.getMonth();
            
            document.getElementById('cal-month-title').textContent = `${y}年${m + 1}月`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';
            
            // Empty slots
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="cal-day empty"></div>`;
            }
            
            const todayStr = new Date().toDateString();
            // Current selected value
            const inputVal = document.getElementById(`input-date-${calTargetInput}`).value;
            const selectedDateStr = inputVal ? new Date(inputVal).toDateString() : '';

            for (let d = 1; d <= daysInMonth; d++) {
                const thisDate = new Date(y, m, d);
                const thisDateStr = thisDate.toDateString();
                
                let classes = "cal-day";
                if (thisDateStr === todayStr) classes += " today";
                if (thisDateStr === selectedDateStr) classes += " selected";
                
                const el = document.createElement('div');
                el.className = classes;
                el.textContent = d;
                el.onclick = () => window.selectDate(y, m, d);
                grid.appendChild(el);
            }
        };

        window.selectDate = function(y, m, d) {
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            
            // Set value
            document.getElementById(`input-date-${calTargetInput}`).value = dateStr;
            
            // Update Display
            window.updateDateDisplay(calTargetInput, dateStr);
            
            // If setting start date, auto-set end date if needed (legacy logic, keep safe)
            if (calTargetInput === 'start') {
                if(window.autoUpdateEnd) window.autoUpdateEnd(); 
            }
            
            // Special: if in todo modal, check calendar option
            
            window.closeCalendar();
        };

        window.selectToday = function() {
            const now = new Date();
            window.selectDate(now.getFullYear(), now.getMonth(), now.getDate());
        };

        // --- Time Picker Logic ---
        window.openTimePicker = function(type) {
            timePickerTarget = type;
            const container = document.getElementById('time-list-container');
            container.innerHTML = '';
            
            const currentVal = document.getElementById(`input-time-${type}`).value;
            
            // Header for clear/cancel (Sticky)
            const header = document.createElement('div');
            header.className = "sticky top-0 bg-white border-b border-gray-100 flex justify-between items-center px-4 py-3 z-10 flex-none";
            header.innerHTML = `
                <button onclick="window.closeTimePicker()" class="text-sm text-gray-500">取消</button>
                <span class="text-sm font-bold text-gray-800">選擇時間</span>
                <button onclick="window.clearTime()" class="text-sm text-red-400">清除</button>
            `;
            container.appendChild(header);

            // Time slots list
            const list = document.createElement('div');
            list.className = "overflow-y-auto flex-1 p-2"; // Allow this part to scroll
            
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const isSelected = currentVal === timeStr;
                    
                    const item = document.createElement('div');
                    item.className = `time-option rounded-lg ${isSelected ? 'selected' : ''}`;
                    item.textContent = timeStr;
                    item.onclick = () => window.selectTime(timeStr);
                    list.appendChild(item);
                }
            }
            container.appendChild(list);

            const m = document.getElementById('time-picker-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
            
            // Scroll to selected
            if (currentVal) {
                setTimeout(() => {
                    const selectedEl = list.querySelector('.selected');
                    if (selectedEl) selectedEl.scrollIntoView({ block: 'center' });
                }, 50);
            }
        };

        window.closeTimePicker = function() {
            const m = document.getElementById('time-picker-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.selectTime = function(timeStr) {
            document.getElementById(`input-time-${timePickerTarget}`).value = timeStr;
            window.updateTimeDisplay(timePickerTarget, timeStr);
            window.closeTimePicker();
        };

        window.clearTime = function() {
            document.getElementById(`input-time-${timePickerTarget}`).value = '';
            window.updateTimeDisplay(timePickerTarget, ''); 
            window.closeTimePicker();
        };

        /* =========================================
           身分強制檢查機制
           ========================================= */
        window.checkRoleEnforcement = function() {
            if (!currentUserRole) {
                // 1. 強制切換到設定頁 (開啟 Modal)
                window.openSettingsModal();
                
                // 2. 跳出提示
                window.showToast('👋 請先告訴我您是誰？');
                
                // 3. 視覺引導：讓選擇區塊閃爍一下
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) {
                    roleSection.classList.add('ring-2', 'ring-ttgreen', 'bg-green-50');
                    setTimeout(() => roleSection.classList.remove('ring-2', 'ring-ttgreen', 'bg-green-50'), 600);
                }
                
                return false; // 阻擋後續操作
            }
            return true; // 通行
        };
        
        window.openSettingsModal = function() {
            const m = document.getElementById('settings-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('visible'), 10);
        };

        window.closeSettingsModal = function() {
            // 如果沒選身分，不准關閉
            if (!currentUserRole) {
                window.showToast('請先選擇一個身分 🙏');
                const roleSection = document.getElementById('role-selection-section');
                if(roleSection) {
                    roleSection.classList.add('animate-pulse');
                    setTimeout(() => roleSection.classList.remove('animate-pulse'), 500);
                }
                return;
            }
            
            const m = document.getElementById('settings-modal');
            m.classList.remove('visible');
            setTimeout(() => m.classList.add('hidden'), 200);
        };
        
        window.updateDateDisplay = function(type, dateStr) {
            const displayEl = (type === 'recur') ? document.getElementById('display-recur-until') : (type === 'todo' ? document.getElementById('display-date-todo') : document.getElementById(`display-date-${type}`));
            if(!displayEl) return;
            if(!dateStr) { 
                // Empty state styling
                if (type === 'recur') displayEl.textContent = "設定日期"; 
                else if (type === 'todo') {
                    displayEl.textContent = "請選擇"; 
                    displayEl.classList.add('dt-text-placeholder');
                    displayEl.classList.remove('dt-text-value');
                }
                else {
                    displayEl.textContent = "請選擇"; // Unified placeholder
                    displayEl.classList.add('dt-text-placeholder');
                    displayEl.classList.remove('dt-text-value');
                }
                return; 
            }
            
            // Value state styling
            displayEl.classList.remove('dt-text-placeholder');
            displayEl.classList.add('dt-text-value');

            const date = new Date(dateStr); 
            const weekDays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            if (type === 'recur' || type === 'todo') displayEl.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} (${weekDays[date.getDay()]})`;
            else displayEl.textContent = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日(${weekDays[date.getDay()]})`;
        };

        window.updateTimeDisplay = function(type, timeStr) { 
            const el = document.getElementById(`display-time-${type}`); 
            if(el) { 
                if(!timeStr) {
                    el.textContent = '請選擇';
                    el.classList.add('dt-text-placeholder');
                    el.classList.remove('dt-text-value');
                } else {
                    el.textContent = timeStr;
                    el.value = timeStr; 
                    el.classList.remove('dt-text-placeholder');
                    el.classList.add('dt-text-value');
                }
            } 
        }; 
        
        window.checkRecurValidity = function() { const eD = document.getElementById('input-date-end')?.value; const rD = document.getElementById('input-recur-until')?.value; if(rD && eD && new Date(rD) < new Date(eD)) { const el = document.getElementById('input-recur-until'); if(el) el.value = eD; window.updateDateDisplay('recur', eD); } };
        // FIX: Safer Auto Update
        window.autoUpdateEnd = function() { 
            try {
                const sD = document.getElementById('input-date-start')?.value; 
                const sT = document.getElementById('input-time-start')?.value; 
                if(!sD || !sT) return; 
                
                // Safe Check: If end input doesn't exist, don't crash
                const endInputD = document.getElementById('input-date-end');
                const endInputT = document.getElementById('input-time-end');
                
                if (!endInputD || !endInputT) return;

                const start = new Date(`${sD}T${sT}`); 
                const end = new Date(start.getTime() + 3600000); 
                const eD = end.toISOString().split('T')[0]; 
                const eT = end.toTimeString().substring(0,5); 
                
                endInputD.value = eD; 
                endInputT.value = eT; 
                
                const dispEndT = document.getElementById('display-time-end');
                if(dispEndT) dispEndT.value = eT; 
                
                window.updateDateDisplay('end', eD); 
                if(window.checkRecurValidity) window.checkRecurValidity(); 
            } catch (e) {
                console.warn("Auto update end failed silently", e);
            }
        };
        window.checkEndDateValidity = function() { const sD = document.getElementById('input-date-start').value; const sT = document.getElementById('input-time-start').value; const eD = document.getElementById('input-date-end').value; const eT = document.getElementById('input-time-end').value; if(new Date(`${eD}T${eT}`) < new Date(`${sD}T${sT}`)) { window.autoUpdateEnd(); } else { window.checkRecurValidity(); } };
        window.setNowToInputs = function() { const now = new Date(); const dStr = now.toISOString().split('T')[0]; let h = now.getHours(), m = now.getMinutes(); if(m < 30) { m = 30; } else { m = 0; h += 1; } if(h > 23) h = 0; const tStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; const startEl = document.getElementById('input-date-start'); if(startEl) { startEl.value = dStr; document.getElementById('input-time-start').value = tStr; window.updateDateDisplay('start', dStr); window.updateTimeDisplay('start', tStr); const endD = document.getElementById('input-date-end'); if(endD) endD.value = dStr; const endT = document.getElementById('input-time-end'); if(endT) endT.value = tStr; window.updateDateDisplay('end', dStr); window.updateTimeDisplay('end', tStr); } };
        
        // 修改：身分切換時，全面更新 UI 提示
        window.updateRoleUI = function() {
            // 1. 設定頁按鈕狀態
            const btnHaohao = document.getElementById('role-haohao');
            const btnMaomao = document.getElementById('role-maomao');
            
            if (btnHaohao) {
                const activeClass = "flex-1 py-3 rounded-xl text-sm font-bold border-2 border-ttgreen bg-green-50 text-ttgreen transition shadow-sm";
                const inactiveClass = "flex-1 py-3 rounded-xl text-sm font-medium border border-gray-200 text-gray-400 bg-white transition";
                
                if (currentUserRole === 'haohao') {
                    btnHaohao.className = activeClass;
                    btnMaomao.className = inactiveClass;
                } else if (currentUserRole === 'maomao') {
                    btnHaohao.className = inactiveClass;
                    btnMaomao.className = activeClass;
                } else {
                    // 都沒選：兩個都是未選取狀態
                    btnHaohao.className = inactiveClass;
                    btnMaomao.className = inactiveClass;
                }
                
                const ptText = document.getElementById('partner-toggle-text');
                if (ptText && currentUserRole) ptText.textContent = (currentUserRole === 'haohao' ? '與毛毛一起' : '與皓皓一起');
            }

            // 2. Header 身分膠囊
            const badge = document.getElementById('header-role-badge');
            const badgeName = document.getElementById('header-role-name');
            if (badge && badgeName) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? '皓皓' : '毛毛';
                    const color = roleColors[currentUserRole];
                    badgeName.textContent = name;
                    badge.style.backgroundColor = color;
                    badge.classList.remove('opacity-0');
                } else {
                    // 未選擇狀態
                    badgeName.textContent = '請選擇';
                    badge.style.backgroundColor = '#9ca3af'; // 灰色
                    badge.classList.remove('opacity-0');
                    // 加個小動畫吸引注意
                    badge.classList.add('animate-pulse');
                }
            }

            // 3. 便利貼輸入框提示 & 發送按鈕顏色同步
            const noteInput = document.getElementById('note-input');
            const noteSendBtn = document.getElementById('note-send-btn');
            
            if (noteInput) {
                if (currentUserRole) {
                    const name = currentUserRole === 'haohao' ? '皓皓' : '毛毛';
                    const color = roleColors[currentUserRole];
                    
                    noteInput.placeholder = `${name}，說點什麼...`;
                    noteInput.disabled = false;
                    
                    // 輸入框外框變色 (border color)
                    if(noteInput.parentElement) {
                        noteInput.parentElement.style.borderColor = color;
                    }
                    
                    // 發送按鈕變色
                    if(noteSendBtn) {
                        noteSendBtn.style.backgroundColor = color;
                        noteSendBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                        noteSendBtn.disabled = false;
                    }

                } else {
                    noteInput.placeholder = '請先選擇身分...';
                    noteInput.disabled = true;
                    
                    if(noteInput.parentElement) {
                        noteInput.parentElement.style.borderColor = '#e5e7eb';
                    }
                    
                    if(noteSendBtn) {
                        noteSendBtn.style.backgroundColor = '#d1d5db'; // gray-300
                        noteSendBtn.classList.add('cursor-not-allowed');
                        noteSendBtn.disabled = true;
                    }
                }
            }
            
            // 4. 同步 Active Tab 顏色
            if (currentUserRole) {
                document.documentElement.style.setProperty('--active-tab-color', roleColors[currentUserRole]);
                // 移除 header 閃爍動畫
                if(badge) badge.classList.remove('animate-pulse');
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.updateSettingsColorUI = function() { const h = document.getElementById('setting-color-haohao'); if(h) { h.style.backgroundColor = roleColors.haohao; document.getElementById('setting-color-maomao').style.backgroundColor = roleColors.maomao; document.getElementById('setting-color-joint').style.backgroundColor = roleColors.joint; } };
        window.setStatus = function(s) { document.getElementById('input-status').value = s; document.querySelectorAll('.status-btn').forEach(b=>{ if(b.dataset.status===s) b.classList.add('active'); else b.classList.remove('active'); }); };
        window.showToast = function(msg) { const t = document.getElementById('toast-container'); const m = document.getElementById('toast-message'); m.textContent = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); };
        window.updateParticipantsPreview = function() { const container = document.getElementById('participants-preview'); const isP = document.getElementById('check-partner').checked; let html = ''; html += `<div class="avatar-sm z-20" style="background-color:${roleColors[currentUserRole]}">${currentUserRole==='haohao'?'皓':'毛'}</div>`; if(isP) { const p = currentUserRole==='haohao'?'maomao':'haohao'; html += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[p]}">${p==='haohao'?'皓':'毛'}</div>`; } container.innerHTML = html; };
  window.setRole = function(role) {
  localStorage.setItem('user_role', role);
  currentUserRole = role;
  window.updateRoleUI();

  // ⭐ Active Tab 指示線顏色跟角色同步
  document.documentElement.style.setProperty(
    '--active-tab-color',
    roleColors[role]
  );
};
        window.updateMyStatus = function(status) {
             // === 加入這行 ===
            if (!window.checkRoleEnforcement()) return;
            // ===============
             if(!db) return; const moods = ['normal', 'charging', 'sleepy', 'love', 'busy']; 
             // If status is passed, use it, otherwise random (legacy support if needed, but UI passes 'charging' etc now)
             // Actually UI passes specific status now? The UI calls updateMyStatus('charging')
             // But the original code was random. Let's fix it to use the passed status if available.
             
             let moodToSet = status;
             if (!moodToSet || !moodMap[moodToSet]) {
                 moodToSet = moods[Math.floor(Math.random() * moods.length)];
             }
             
             const d = {}; d[currentUserRole] = moodToSet; db.collection('status').doc('current').set(d, { merge: true }); 
        };
        window.toggleGlobalColorPicker = function(show) { const el = document.getElementById('global-color-picker'); const grid = document.getElementById('global-color-grid'); if(show) { grid.innerHTML = ''; timeTreeColors.forEach(color => { const row = document.createElement('div'); row.className = "flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition"; row.onclick = () => window.selectGlobalColor(color); row.innerHTML = `<div class="w-5 h-5 rounded-full mr-3 shadow-sm" style="background-color: ${color.hex}"></div><span class="text-sm text-gray-700">${color.name}</span>`; grid.appendChild(row); }); el.classList.remove('hidden'); setTimeout(() => el.classList.add('visible'), 10); } else { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); colorPickerTarget = null; } };

        window.selectGlobalColor = function(c) {
            // 1. 如果是在「新增/編輯行程」時選顏色 (維持原樣)
            if (colorPickerTarget === 'event') {
                currentSelectedColor = c.hex;
                document.getElementById('selected-color-name').textContent = c.name;
                document.getElementById('selected-color-dot').style.backgroundColor = c.hex;
            } 
            // 2. 如果是在「設定頁面」選代表色 (修改邏輯)
            else if (colorPickerTarget) {
                const newHex = c.hex;
                const targetRole = colorPickerTarget; // 目前正在修改的角色 (haohao, maomao, joint)
                const oldHex = roleColors[targetRole]; // 該角色原本的顏色 (用來交換用)

                // === 步驟 A: 檢查衝突 ===
                let conflictRole = null;
                for (let key in roleColors) {
                    // 如果不是自己，且顏色跟新選的一樣，就是衝突者
                    if (key !== targetRole && roleColors[key] === newHex) {
                        conflictRole = key;
                        break;
                    }
                }

                // === 步驟 B: 更新目標角色的顏色 ===
                roleColors[targetRole] = newHex;
                localStorage.setItem(`color_${targetRole}`, newHex);

                // === 步驟 C: 處理衝突 (自動交換) ===
                if (conflictRole) {
                    // 把衝突者的顏色換成舊顏色
                    roleColors[conflictRole] = oldHex;
                    localStorage.setItem(`color_${conflictRole}`, oldHex);
                    
                    // 顯示提示訊息
                    const roleNames = { haohao: '皓皓', maomao: '毛毛', joint: '共同行程' };
                    window.showToast(`顏色重複，已與「${roleNames[conflictRole]}」交換顏色！`);
                }

                // === 步驟 D: 更新介面 ===
                // 1. 更新設定頁面的三個圓圈
                window.updateSettingsColorUI();

                // 2. 檢查是否影響到底部導航列 (Active Tab) 的顏色
                // (無論是「直接修改自己」或是「因為交換而改變了自己」都要更新)
                if (targetRole === currentUserRole || conflictRole === currentUserRole) {
                    if (currentUserRole) {
                        document.documentElement.style.setProperty(
                            '--active-tab-color',
                            roleColors[currentUserRole]
                        );
                    }
                }
            }
            
            // 關閉選色視窗
            window.toggleGlobalColorPicker(false);
        };
        window.openColorConfig = function(target) { colorPickerTarget = target; window.toggleGlobalColorPicker(true); };
        window.syncSelectedColorUI = function() {
            const dot = document.getElementById('selected-color-dot');
            const name = document.getElementById('selected-color-name');

  if (!dot || !name) return;

  // 從目前選擇的顏色找對應名稱
  const found = timeTreeColors.find(c => c.hex === currentSelectedColor);

  dot.style.backgroundColor = currentSelectedColor;
  name.textContent = found ? found.name : '自訂顏色';
};

        // --- 3. RENDERERS ---
        window.renderEvents = function(ignored) { const items = window.getCalendarItems(); const now = new Date(); const future = items.filter(e => { const date = new Date(e.timestamp); if(e.isTodo && e.done) return false; return !isNaN(date) && date >= now; }); const titleEl = document.getElementById('next-event-title'); if(titleEl && future.length > 0) { const n = future[0], d = new Date(n.timestamp); titleEl.textContent = n.title; const timeStr = n.allDay ? "All Day" : d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('next-event-time').textContent = timeStr; document.getElementById('next-event-date').textContent = d.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric',weekday:'short'}); const diff = Math.ceil((d-now)/(1000*60*60*24)); document.getElementById('countdown').textContent = diff<=0?"TODAY":`D - ${diff}`; } else if(titleEl) { titleEl.textContent = "No Upcoming Events"; } const listEl = document.getElementById('event-list'); if(listEl) { if (items.length === 0) listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">無行程</div>`; else window.renderEventListItems(items, listEl); } };
        window.getCalendarItems = function() { const events = allEventsCache.map(e => ({...e, type: 'event'})); const todos = allTodosCache.filter(t => t.timestamp).map(t => ({ id: t.id, title: t.title, timestamp: t.timestamp, color: null, allDay: !t.dueTime, isTodo: true, done: t.done, type: 'todo', creator: t.creator, isJoint: t.isJoint })); return [...events, ...todos].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); };
        
        window.renderDashboardNextUp = function(items) {
            const now = new Date();
            const next7Days = new Date();
            next7Days.setDate(now.getDate() + 7);
            
            const upcoming = items.filter(item => {
                const t = new Date(item.timestamp);
                if (item.isTodo && item.done) return false;
                return !isNaN(t) && t >= now && t <= next7Days;
            });

            const countEl = document.getElementById('dashboard-countdown');
            if (upcoming.length > 0) {
                const first = upcoming[0];
                const d = new Date(first.timestamp);
                const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
                countEl.textContent = diff <= 0 ? "TODAY" : `D - ${diff}`;
            } else {
                countEl.textContent = "FREE";
            }

            const container = document.getElementById('dashboard-next-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (upcoming.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">未來 7 天沒有行程 😴</div>`;
            } else {
                let html = '';
                upcoming.forEach(item => {
                    const date = new Date(item.timestamp);
                    const timeStr = item.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    const dateStr = date.toLocaleDateString('zh-TW', {
                        month: 'numeric',
                        day: 'numeric',
                        weekday: 'short'
                    });

                    // === 修改處：強制顏色邏輯 ===
                    // 1. 如果是共同行程 -> 用 joint 顏色
                    // 2. 否則 -> 用建立者的顏色 (皓皓/毛毛)
                    let color;
                    if (item.isJoint) {
                        color = roleColors.joint;
                    } else {
                        color = (item.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                    }
                    // ===========================

                    let tagHtml = item.isTodo ? `<span class="ml-2 text-[10px] border border-gray-200 text-gray-400 px-1 rounded flex-shrink-0">待辦</span>` : '';
                    
                    // 補上 TBC/TBD 標籤
                    if (!item.isTodo) {
                        if (item.status === 'tbc') tagHtml = `<span class="ml-2 status-tag tbc">TBC</span>`;
                        else if (item.status === 'tbd') tagHtml = `<span class="ml-2 status-tag tbd">TBD</span>`;
                    }

                    // === 新增：備註顯示 (如果有) ===
                    let noteDisplay = '';
                    if (item.note && item.note.trim()) {
                        noteDisplay = `<div class="text-xs text-gray-400 mt-1 flex items-start gap-1"><i data-lucide="sticky-note" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><span class="truncate">${item.note}</span></div>`;
                    }

                    let clickAction = item.isTodo ? `window.openEditTodoModal('${item.id}')` : `window.openEditModal('${item.id}')`;
                    
                    html += `
                    <div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer" onclick="${clickAction}">
                        <div class="w-1 self-stretch rounded-full mr-3" style="background-color: ${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-gray-800 truncate">${item.title}</span>
                                ${tagHtml}
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${dateStr} · ${timeStr} ${item.location ? `· ${item.location}` : ''}</div>
                            ${noteDisplay}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({ root: container });
                }
            }
        };
        window.renderCalendarListView = function() { const items = window.getCalendarItems(); const listEl = document.getElementById('event-list'); if(!listEl) return; if (items.length === 0) { listEl.innerHTML = `<div class="text-center py-20 text-gray-300 text-sm">無行程</div>`; } else { window.renderEventListItems(items, listEl); } };
        window.renderEventListItems = function(items, container) {
            let html = '';
            items.forEach(e => {
                const date = new Date(e.timestamp);
                if (isNaN(date)) return;
                const timeStr = e.allDay ? "All Day" : date.toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                // === 修改處：統一計算顏色邏輯 ===
                // 優先判斷是否為共同行程，是則強制使用 joint 顏色
                let displayColor;
                if (e.isJoint) {
                    displayColor = roleColors.joint;
                } else {
                    displayColor = (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                }
                // ============================

                if (e.isTodo) {
                    // === 待辦事項 ===
                    const statusClass = e.done ? "line-through text-gray-400" : "text-gray-800";
                    const checkIcon = e.done ? '<i data-lucide="check-square" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="square" class="w-5 h-5 text-gray-400"></i>';
                    
                    html += `
                    <div class="flex p-4 items-center gap-4 hover:bg-gray-50 transition cursor-pointer">
                        <div class="flex flex-col items-center w-10">
                            <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
                            <span class="text-xl font-bold text-gray-800 leading-none">${date.getDate()}</span>
                        </div>
                        <!-- 使用計算好的顏色 -->
                        <div class="w-1 self-stretch rounded-full" style="background-color: ${displayColor}"></div>
                        <div class="flex-1 min-w-0 flex items-center justify-between" onclick="window.openEditTodoModal('${e.id}')">
                            <div>
                                <div class="flex items-center ${statusClass}">
                                    <span class="font-bold truncate block">${e.title}</span>
                                    <span class="ml-2 text-[10px] border border-gray-200 px-1 rounded text-gray-400 flex-shrink-0">待辦</span>
                                </div>
                                <div class="text-xs text-gray-500">${timeStr}</div>
                            </div>
                        </div>
                        <div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${e.id}', ${!e.done}); event.stopPropagation();">
                            ${checkIcon}
                        </div>
                    </div>`;
                } else {
                    // === 一般行程 ===
                    let ic = '';
                    if (e.category === 'travel') ic = 'plane';
                    else if (e.category === 'appointment') ic = 'scissors';
                    else if (e.category === 'gathering') ic = 'users';
                    else if (e.category === 'vacation') ic = 'palmtree';

                    let ico = ic ? `<i data-lucide="${ic}" class="w-3 h-3 text-gray-400 mr-1"></i>` : '';

                    let st = '';
                    if (e.status === 'tbc') st = `<span class="ml-2 status-tag tbc">TBC</span>`;
                    else if (e.status === 'tbd') st = `<span class="ml-2 status-tag tbd">TBD</span>`;

                    // 小頭像邏輯 (如果是共同行程，顯示兩個頭像)
                    let av = `<div class="avatar-sm z-20" style="background-color:${roleColors[e.creator]||'#2cc998'}">${e.creator==='haohao'?'皓':'毛'}</div>`;
                    if (e.isJoint) {
                        const partner = e.creator === 'haohao' ? 'maomao' : 'haohao';
                        const partnerName = partner === 'haohao' ? '皓' : '毛';
                        av += `<div class="avatar-sm z-10 -ml-2" style="background-color:${roleColors[partner]}">${partnerName}</div>`;
                    }

                    // === 新增：備註顯示 (如果有) ===
                    let noteDisplay = '';
                    if (e.note && e.note.trim()) {
                        noteDisplay = `<div class="text-xs text-gray-400 mt-1 flex items-start gap-1"><i data-lucide="sticky-note" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><span class="truncate">${e.note}</span></div>`;
                    }

                    html += `
                    <div class="flex p-4 items-start gap-4 hover:bg-gray-50 transition cursor-pointer card-press" onclick="window.openEditModal('${e.id}')">
                        <div class="flex flex-col items-center w-10 pt-1">
                            <span class="text-xs text-gray-400 font-medium uppercase">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>
                            <!-- 日期數字顏色也跟著變 -->
                            <span class="text-xl font-bold leading-none" style="color:${displayColor}">${date.getDate()}</span>
                        </div>
                        <!-- 側邊條顏色 -->
                        <div class="w-1 self-stretch rounded-full" style="background-color:${displayColor}"></div>
                        <div class="flex-1 min-w-0 pt-1">
                            <div class="flex items-center">
                                ${ico}
                                <h4 class="font-bold text-gray-800 truncate">${e.title}</h4>
                                ${st}
                            </div>
                            <div class="text-xs text-gray-500">${timeStr} ${e.location?'· '+e.location:''}</div>
                            ${noteDisplay}
                        </div>
                        <div class="flex items-center self-center -space-x-1 pl-2">${av}</div>
                    </div>`;
                }
            });
            container.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons({
                root: container
            });
        };
        window.toggleAllDay = function() { const isChecked = document.getElementById('check-allday').checked; document.querySelectorAll('.dt-wrapper-time').forEach(d => d.style.display = isChecked ? 'none' : 'block'); };
        window.toggleRecurring = function() { const isChecked = document.getElementById('check-recurring').checked; const opts = document.getElementById('recurring-options'); if(isChecked) { opts.classList.remove('hidden'); if(!document.getElementById('input-recur-until').value) document.getElementById('input-recur-until').value = document.getElementById('input-date-end').value; } else opts.classList.add('hidden'); };
        window.toggleTravelFields = function() { const type = document.getElementById('input-transport-type').value; const isPlane = type === 'plane'; document.getElementById('travel-region-intl').classList.toggle('hidden', !isPlane); document.getElementById('travel-region-tw').classList.toggle('hidden', isPlane); };
        window.toggleBooked = function() { const isChecked = document.getElementById('check-booked').checked; const txt = document.getElementById('appoint-status-text'); txt.textContent = isChecked ? "已預約" : "未完成"; txt.className = isChecked ? "text-xs font-bold text-purple-600" : "text-xs text-gray-500"; };
window.togglePartner = function() {
  const isChecked = document.getElementById('check-partner').checked;
  updateParticipantsPreview();

  colorPickerTarget = 'event';

  if (isChecked) {
    currentSelectedColor = roleColors.joint;
  } else {
    currentSelectedColor = roleColors[currentUserRole];
  }

};
window.saveEvent = function () {
  if (!db) {
    window.showToast('資料庫尚未連線');
    return;
  }

  // 防連點
  if (window.__savingEvent) return;
  window.__savingEvent = true;

  const saveBtn = document.querySelector(
    '#add-modal button[onclick="window.saveEvent()"]'
  );
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '儲存中…';
    saveBtn.classList.add('opacity-60');
  }

  try {
    const title = document.getElementById('input-title')?.value?.trim();
    if (!title) {
      window.showToast('請填寫標題');
      throw new Error('Missing title');
    }

    const startDate = document.getElementById('input-date-start')?.value;
    if (!startDate) {
      window.showToast('請選擇日期');
      throw new Error('Missing date');
    }

    const time = document.getElementById('input-time-start')?.value || '00:00'; // Default time if missing
    const timestamp = new Date(`${startDate}T${time}:00`).toISOString();
    const isAllDay = !document.getElementById('input-time-start').value;

    const data = {
      title,
      startDate,
      timestamp,
      allDay: isAllDay, // 寫入全天旗標
      isJoint: document.getElementById('check-partner')?.checked || false,
      status: document.getElementById('input-status')?.value || 'confirmed',
      note: document.getElementById('input-note')?.value || '',
      creator: currentUserRole,
      color: currentSelectedColor,
      location: document.getElementById('input-location')?.value || '',
      createdAt: new Date().toISOString()
    };

    const req = editingEventId
      ? db.collection('events').doc(editingEventId).update(data)
      : db.collection('events').add(data);

    req
      .then(() => {
        window.showToast('行程已儲存');
        window.closeAddModal();
      })
      .catch(err => {
        console.error(err);
        window.showToast('儲存失敗');
      })
      .finally(() => {
        window.__savingEvent = false;
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = '保存';
          saveBtn.classList.remove('opacity-60');
        }
      });

  } catch (err) {
    window.__savingEvent = false;
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = '保存';
      saveBtn.classList.remove('opacity-60');
    }
  }
};
        window.deleteCurrentEvent = function() { if(!editingEventId){ window.showToast("無法識別 ID"); return; } deleteTarget='event'; window.confirmDelete(); };
        window.deleteCurrentTodo = function() { if(!editingTodoId){ window.showToast("無法識別 ID"); return; } deleteTarget='todo'; window.confirmDelete(); };
        window.confirmDelete = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('visible'), 10); };
        window.closeConfirmModal = function() { const m = document.getElementById('confirm-modal'); m.classList.remove('visible'); setTimeout(() => m.classList.add('hidden'), 200); };
        window.executeDelete = function() { 
            if(deleteTarget === 'event' && editingEventId) { 
                db.collection('events').doc(editingEventId).delete().then(() => { window.closeConfirmModal(); window.closeAddModal(); window.showToast('行程已刪除'); }).catch(e => { console.error(e); window.showToast('刪除失敗'); }); 
            } else if (deleteTarget === 'todo' && editingTodoId) {
                db.collection('todos').doc(editingTodoId).delete().then(() => { window.closeConfirmModal(); window.closeAddTodoModal(); window.showToast('待辦已刪除'); }).catch(e => { console.error(e); window.showToast('刪除失敗'); });
            } else if (deleteTarget === 'note' && noteToDelete) {
                window.deleteNote(noteToDelete);
                window.closeConfirmModal();
            }
        };
window.openAddModal = function () {
  // === 加入這行 ===
  if (!window.checkRoleEnforcement()) return;
  // ===============

  editingEventId = null;

  // === 基本欄位（都存在）===
  document.getElementById('input-title').value = '';
  document.getElementById('input-note').value = '';
  document.getElementById('input-date-start').value = '';
  
  // FIX: Reset displays style
  const dD = document.getElementById('display-date-start');
  dD.textContent = '請選擇';
  dD.classList.add('dt-text-placeholder');
  dD.classList.remove('dt-text-value');

  const t = document.getElementById('input-time-start');
  if (t) t.value = '';
  const td = document.getElementById('display-time-start');
  if (td) { 
      td.textContent = '請選擇';
      td.classList.add('dt-text-placeholder');
      td.classList.remove('dt-text-value');
  }

  const loc = document.getElementById('input-location');
  if (loc) loc.value = '';

  // 一起 / 不一起
  const partner = document.getElementById('check-partner');
  partner.checked = false;

  // 狀態預設 confirmed
  window.setStatus('confirmed');

  // 顏色邏輯（保留，但不碰 UI）
  currentSelectedColor = roleColors[currentUserRole];
  colorPickerTarget = 'event';

  // 刪除按鈕：新增模式下隱藏
  const delBtn = document.getElementById('btn-delete-event');
  if(delBtn) delBtn.classList.add('hidden');

  // 🔓 開 modal
  const m = document.getElementById('add-modal');
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};
window.openEditModal = function (id) {
  const evt = allEventsCache.find(e => e.id === id);
  if (!evt) {
    window.showToast('找不到行程');
    return;
  }

  editingEventId = id;

  // === 標題 ===
  document.getElementById('input-title').value = evt.title || '';

  // === 日期 ===
  if (evt.startDate) {
    document.getElementById('input-date-start').value = evt.startDate;
    window.updateDateDisplay('start', evt.startDate);
  } else if (evt.timestamp) {
    const d = new Date(evt.timestamp);
    const ds = d.toISOString().split('T')[0];
    document.getElementById('input-date-start').value = ds;
    window.updateDateDisplay('start', ds);
  }

  // === 時間 (若為 All Day 則清空，否則解析顯示) ===
  const timeInput = document.getElementById('input-time-start');
  
  if (evt.allDay) {
      // 1. 如果是全天行程，清空時間欄位
      timeInput.value = '';
      // 2. 顯示文字設為預設 (通常是 '請選擇'，這代表無時間=全天)
      window.updateTimeDisplay('start', ''); 
  } else if (evt.timestamp) {
      // 3. 一般行程，解析時間並顯示
      const d = new Date(evt.timestamp);
      const hours = d.getHours().toString().padStart(2, '0');
      const minutes = d.getMinutes().toString().padStart(2, '0');
      const timeStr = `${hours}:${minutes}`;
      timeInput.value = timeStr;
      window.updateTimeDisplay('start', timeStr);
  }
  
  // === 地點 ===
  document.getElementById('input-location').value = evt.location || '';
  
  // === 一起 / 不一起 ===
  const partner = document.getElementById('check-partner');
  partner.checked = !!evt.isJoint;

  // === 狀態 ===
  window.setStatus(evt.status || 'confirmed');

  // === 備註 ===
  document.getElementById('input-note').value = evt.note || '';

  // === 顏色邏輯（只保留資料，不碰 UI）===
  currentSelectedColor = evt.color || roleColors[evt.creator] || roleColors[currentUserRole];
  colorPickerTarget = 'event';

  // 刪除按鈕：編輯模式下顯示
  const delBtn = document.getElementById('btn-delete-event');
  if(delBtn) delBtn.classList.remove('hidden');

  // === 開 modal ===
  const m = document.getElementById('add-modal');
  m.classList.remove('hidden');
  setTimeout(() => m.classList.add('visible'), 10);
};
 window.openAddTodoModal = function() { 
    // === 加入這行 ===
    if (!window.checkRoleEnforcement()) return;
    // ===============
    editingTodoId = null; document.getElementById('todo-modal-title').textContent = '新增待辦事項'; document.getElementById('todo-modal-btn').textContent = '新增'; document.getElementById('todo-input-title').value = ''; document.getElementById('input-date-todo').value = ''; document.getElementById('input-time-todo').value = ''; 
    const dd = document.getElementById('display-date-todo'); dd.textContent = '請選擇'; dd.classList.add('dt-text-placeholder'); dd.classList.remove('dt-text-value');
    const dt = document.getElementById('display-time-todo'); dt.textContent = '請選擇'; dt.classList.add('dt-text-placeholder'); dt.classList.remove('dt-text-value');
    
    // FIX: 移除了對不存在元素 'todo-check-calendar' 的引用
    document.getElementById('todo-check-joint').checked = false; 
    
    const btn=document.getElementById('btn-delete-todo'); if(btn) btn.classList.add('hidden'); const m = document.getElementById('add-todo-modal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('visible'),10); 
 };
 window.closeAddModal = function() {
  window.__savingEvent = false; // 🔒 保險重置
  const m=document.getElementById('add-modal');
  m.classList.remove('visible');
  setTimeout(()=>m.classList.add('hidden'),200);
};
        window.openEditTodoModal = function(id) { 
            editingTodoId = id; 
            const todo = allTodosCache.find(t => t.id === id); 
            if(!todo) return; 
            document.getElementById('todo-modal-title').textContent = '編輯待辦事項'; 
            document.getElementById('todo-modal-btn').textContent = '儲存'; 
            document.getElementById('todo-input-title').value = todo.title; 
            if(todo.dueDate) { 
                document.getElementById('input-date-todo').value = todo.dueDate; 
                window.updateDateDisplay('todo', todo.dueDate); 
            } else { 
                document.getElementById('input-date-todo').value = ''; 
                window.updateDateDisplay('todo', ''); 
            } 
            if(todo.dueTime) { 
                document.getElementById('input-time-todo').value = todo.dueTime; 
                window.updateTimeDisplay('todo', todo.dueTime); 
            } else { 
                document.getElementById('input-time-todo').value = ''; 
                window.updateTimeDisplay('todo', ''); 
            } 
            document.getElementById('todo-check-joint').checked = todo.isJoint; 
            
            // FIX: 移除了對不存在元素 'todo-check-calendar' 的引用
            
            const btn=document.getElementById('btn-delete-todo'); 
            if(btn) btn.classList.remove('hidden'); 
            const m = document.getElementById('add-todo-modal'); 
            m.classList.remove('hidden'); 
            setTimeout(()=>m.classList.add('visible'),10); 
        };
        window.closeAddTodoModal = function() { const m = document.getElementById('add-todo-modal'); m.classList.remove('visible'); setTimeout(()=>m.classList.add('hidden'),200); };       
        // 4. 儲存待辦事項 (修復：清除日期後無法存檔的問題)
        window.isSavingTodo = false;

        window.saveTodoItem = function() {
            if (window.isSavingTodo) return;

            const title = document.getElementById('todo-input-title').value;
            if (!title) {
                window.showToast('請輸入內容');
                return;
            }

            // 鎖定按鈕
            window.isSavingTodo = true;
            const btn = document.getElementById('todo-modal-btn');
            const originalText = btn ? btn.textContent : '儲存';
            if (btn) {
                btn.textContent = '儲存中...';
                btn.style.opacity = '0.5';
            }

            const date = document.getElementById('input-date-todo').value;
            const time = document.getElementById('input-time-todo').value;
            const isJoint = document.getElementById('todo-check-joint').checked;
            
            // 若有日期則自動標記需同步
            const addToCalendar = !!date; 

            // === 修改重點 ===
            // 我們必須「明確」設定日期欄位，即使是空的也要設為 null
            // 這樣資料庫才會知道要把舊的日期刪掉
            const todoData = {
                title,
                done: false,
                creator: currentUserRole,
                isJoint: isJoint,
                addToCalendar: addToCalendar,
                // 如果 date 是空的，就設為 null；否則設為 date
                dueDate: date || null,
                // 如果 date 或 time 是空的，就設為 null
                dueTime: (date && time) ? time : null,
                // timestamp 也是一樣
                timestamp: null,
                // 注意：編輯時通常不更新 createdAt，以免順序亂掉，這裡我們維持原樣或可選擇不傳
                createdAt: new Date().toISOString() 
            };

            // 計算 Timestamp (只有在有日期時才計算)
            if (date) {
                const tStr = time || "00:00";
                todoData.timestamp = new Date(`${date}T${tStr}`).toISOString();
            }

            const onSuccess = (msg) => {
                if (typeof window.closeAddTodoModal === 'function') {
                    window.closeAddTodoModal();
                } else {
                    const m = document.getElementById('add-todo-modal');
                    if(m) {
                        m.classList.remove('visible');
                        setTimeout(() => m.classList.add('hidden'), 200);
                    }
                    window.isSavingTodo = false;
                }
                window.showToast(msg);
            };

            const onError = (err) => {
                console.error("Save Error:", err);
                window.showToast('儲存失敗，請檢查網路');
                window.isSavingTodo = false;
                if (btn) {
                    btn.textContent = originalText;
                    btn.style.opacity = '1';
                }
            };

            // 執行寫入
            if (editingTodoId) {
                // 編輯模式：這裡傳送 null 會把資料庫裡的舊日期洗掉
                db.collection('todos').doc(editingTodoId).update(todoData)
                    .then(() => onSuccess('待辦事項已更新'))
                    .catch(onError);
            } else {
                db.collection('todos').add(todoData)
                    .then(() => onSuccess('待辦事項已新增'))
                    .catch(onError);
            }
        };

        window.toggleTodo = function(id,s) { db.collection('todos').doc(id).update({done:s}); };
        window.deleteTodo = function(id) { if(confirm('刪除?')) db.collection('todos').doc(id).delete(); };
        window.renderTodos = function(todos) { const jointList=document.getElementById('todo-list-joint'), haohaoList=document.getElementById('todo-list-haohao'), maomaoList=document.getElementById('todo-list-maomao'), dashboardList=document.getElementById('dashboard-todo-list'); if(!jointList) return; jointList.innerHTML=''; haohaoList.innerHTML=''; maomaoList.innerHTML=''; dashboardList.innerHTML=''; let pendingCount=0; todos.forEach(t => { let colorHex = roleColors.haohao; let container = haohaoList; if (t.isJoint) { colorHex = roleColors.joint; container = jointList; } else if (t.creator === 'maomao') { colorHex = roleColors.maomao; container = maomaoList; } let checkStyle = t.done ? `background-color: #d1d5db; border-color: #d1d5db;` : `border-color: ${colorHex};`; let titleClass = t.done ? "text-gray-400 line-through" : "text-gray-800"; if (t.done) { } else { pendingCount++; } let calInfo = t.dueDate ? `<span class="text-[10px] ${t.done?'text-gray-300':'text-gray-400'} ml-2 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</span>` : ''; const html = `<div class="todo-item flex items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm"><div class="flex-none p-2 cursor-pointer" onclick="window.toggleTodo('${t.id}', ${!t.done}); event.stopPropagation();"><div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors text-white" style="${checkStyle}">${t.done?'<i data-lucide="check" class="w-3 h-3"></i>':''}</div></div><div class="flex-1 px-2 cursor-pointer overflow-hidden" onclick="window.openEditTodoModal('${t.id}')"><span class="${titleClass} font-medium truncate block">${t.title}</span>${calInfo}</div><button onclick="window.deleteTodo('${t.id}'); event.stopPropagation();" class="flex-none p-2 text-gray-300 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button></div>`; container.innerHTML += html; }); if (pendingCount === 0) dashboardList.innerHTML = `<p class="text-xs text-gray-400 text-center py-2">沒有未完成的待辦事項 🎉</p>`; else { const pendings = todos.filter(t => !t.done).slice(0, 3); pendings.forEach(t => { let dotColor = t.isJoint ? roleColors.joint : (t.creator==='haohao' ? roleColors.haohao : roleColors.maomao); dashboardList.innerHTML += `<div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-100"><div class="w-2 h-2 rounded-full" style="background-color: ${dotColor}"></div><span class="truncate text-gray-700">${t.title}</span></div>`; }); if (todos.filter(t => !t.done).length > 3) dashboardList.innerHTML += `<div class="text-center text-xs text-gray-400 mt-1">還有 ${todos.filter(t => !t.done).length - 3} 個項目...</div>`; } if(typeof lucide !== 'undefined') lucide.createIcons(); };
        

        /* =========================================
           便利貼 (Status Note) 功能邏輯
           ========================================= */

        // 1. 發送便利貼
        window.sendNote = function() {
            // === 加入這行 ===
            if (!window.checkRoleEnforcement()) return;
            // ===============
            const input = document.getElementById('note-input');
            const text = input.value.trim();

            if (!text) return;

            // === 關鍵修正：樂觀更新 (Optimistic UI) ===
            // 1. 先清空輸入框，讓使用者感覺「已送出」
            input.value = ''; 
            input.blur(); 

            // 2. 先手動更新畫面 (不用等資料庫回傳)
            const mockData = {
                text: text,
                timestamp: new Date().toISOString(),
                creator: currentUserRole
            };
            window.renderNoteBubble(currentUserRole, mockData);

            // 3. 背景執行資料庫寫入
            db.collection('notes').doc(currentUserRole).set(mockData)
            .then(() => {
                window.showToast('心情已發送 💬');
            }).catch(err => {
                console.error(err);
                window.showToast('發送失敗');
            });
        };

        // 2. 聚焦輸入框 (點擊頭像時觸發)
        window.setNoteInputFocus = function() {
            const input = document.getElementById('note-input');
            input.focus();
        };
        
        // 新增：計算相對時間的輔助函式
        window.getRelativeTimeStr = function(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

            if (diffMins < 1) return '剛剛';
            if (diffMins < 60) return `${diffMins}分鐘前`;
            if (diffHours < 24) return `${diffHours}小時前`;
            return '1天前';
        };

        // 3. 渲染便利貼 (更新：加入時間顯示與 7字寬度控制)
        window.renderNoteBubble = function(role, data) {
            const bubbleId = `note-bubble-${role}`;
            const textId = `note-text-${role}`;
            const dotId = `status-dot-${role}`;
            const timeId = `note-time-${role}`; // 新增時間 ID
            
            const bubbleEl = document.getElementById(bubbleId);
            const textEl = document.getElementById(textId);
            const dotEl = document.getElementById(dotId);
            const timeEl = document.getElementById(timeId);

            if (!bubbleEl || !textEl) return;

            if (!data || !data.text || !data.timestamp) {
                hideBubble(bubbleEl, dotEl, timeEl, role);
                return;
            }

            const now = new Date();
            const noteTime = new Date(data.timestamp);
            const diffHours = (now - noteTime) / (1000 * 60 * 60);

            if (diffHours < 24) {
                textEl.textContent = data.text;
                if(timeEl) {
                    timeEl.textContent = window.getRelativeTimeStr(data.timestamp);
                    // FIX: 確保移除 hidden，否則之前刪除或初始隱藏後會顯示不出來
                    timeEl.classList.remove('hidden');
                    timeEl.classList.remove('opacity-0');
                }
                
                // 顯示
                bubbleEl.classList.remove('hidden');
                if(dotEl) dotEl.classList.remove('hidden');
                
                // 動畫：左右滑入
                requestAnimationFrame(() => {
                    bubbleEl.classList.remove('opacity-0');
                    if (role === 'haohao') {
                        bubbleEl.classList.remove('-translate-x-2'); 
                    } else {
                        bubbleEl.classList.remove('translate-x-2'); 
                    }
                });
            } else {
                hideBubble(bubbleEl, dotEl, timeEl, role);
            }
        };

        // 更新隱藏函式，加入時間標籤的處理
        function hideBubble(bubbleEl, dotEl, timeEl, role) {
            bubbleEl.classList.add('opacity-0');
            if (role === 'haohao') {
                bubbleEl.classList.add('-translate-x-2');
            } else {
                bubbleEl.classList.add('translate-x-2');
            }
            
            if(dotEl) dotEl.classList.add('hidden');
            // 也把時間隱藏
            if(timeEl) timeEl.classList.add('opacity-0', 'hidden'); 
            
            setTimeout(() => {
                bubbleEl.classList.add('hidden');
            }, 300);
        }

        // 4. 更新頭像顏色 (配合設定頁面的顏色)
        window.syncNoteAvatarColors = function() {
            const h = document.getElementById('avatar-note-haohao');
            const m = document.getElementById('avatar-note-maomao');
            if(h) h.style.backgroundColor = roleColors.haohao;
            if(m) m.style.backgroundColor = roleColors.maomao;
        };
        
        window.confirmDeleteNote = function(role) {
            if (!window.checkRoleEnforcement()) return;
            
            deleteTarget = 'note';
            noteToDelete = role;
            
            // Update modal text for context
            const m = document.getElementById('confirm-modal');
            const title = m.querySelector('h3');
            const desc = m.querySelector('p');
            if(title) title.textContent = '刪除心情？';
            if(desc) desc.textContent = '確定要刪除這則留言嗎？';
            
            window.confirmDelete();
        };

        window.deleteNote = function(role) {
            // === 加入這行 ===
            if (!window.checkRoleEnforcement()) return;
            // ===============
            
            // === 關鍵修正：立即隱藏 (消除殘影與等待感) ===
            const bubbleEl = document.getElementById(`note-bubble-${role}`);
            if(bubbleEl) {
                // 直接隱藏，不要等待動畫淡出，避免按鈕紅色狀態殘留
                bubbleEl.classList.add('hidden');
            }
            
            const dotEl = document.getElementById(`status-dot-${role}`);
            if(dotEl) dotEl.classList.add('hidden');
            
            const timeEl = document.getElementById(`note-time-${role}`);
            if(timeEl) timeEl.classList.add('hidden');

            // 背景刪除資料庫
            db.collection('notes').doc(role).delete()
                .then(() => {
                    window.showToast('心情已刪除 💨');
                })
                .catch(err => {
                    console.error(err);
                    window.showToast('刪除失敗');
                });
        };
        
        window.clearDate = function() {
            // 1. 如果是待辦事項 (todo)
            if (calTargetInput === 'todo') {
                // 清空日期與時間的隱藏值
                document.getElementById('input-date-todo').value = '';
                document.getElementById('input-time-todo').value = '';
                
                // 使用現有的 helper 函式來重置顯示文字 (變回「請選擇」)
                if (window.updateDateDisplay) window.updateDateDisplay('todo', '');
                if (window.updateTimeDisplay) window.updateTimeDisplay('todo', '');
            } 
            // 2. 如果是其他 (例如一般行程，雖然通常必填，但也提供清除功能)
            else {
                const el = document.getElementById(`input-date-${calTargetInput}`);
                if (el) el.value = '';
                if (window.updateDateDisplay) window.updateDateDisplay(calTargetInput, '');
                
                // 如果是開始日期被清除，可能需要連動結束日期檢查，但因為是清空，暫不處理自動計算
            }

            // 3. 關閉視窗
            window.closeCalendar();
        };

        // ===== MISSING NAVIGATION & CALENDAR RENDER FUNCTIONS =====
        window.switchTab = function(tabId) {
            // 1. Pages
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('page-' + tabId);
            if(target) target.classList.add('active');
            
            // 2. Nav
            const tabs = ['dashboard', 'calendar', 'todo', 'settings'];
            document.querySelectorAll('.nav-item').forEach((el, idx) => {
                if(tabs[idx] === tabId) el.classList.add('active');
                else el.classList.remove('active');
            });

            // 3. Special Logic
            if(tabId === 'calendar' && currentViewMode === 'month') {
                window.renderBigCalendar();
            }
        };

        window.switchCalendarView = function(mode) {
            currentViewMode = mode;
            const vList = document.getElementById('calendar-view-list');
            const vMonth = document.getElementById('calendar-view-month');
            const bList = document.getElementById('btn-view-list');
            const bMonth = document.getElementById('btn-view-month');
            const calendarViewMonthContainer = document.getElementById('calendar-view-month-container');
            
            if(mode === 'list') {
                vList.classList.remove('hidden');
                vMonth.classList.add('hidden');
                calendarViewMonthContainer.classList.add('hidden');
                bList.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold');
                bList.classList.remove('text-gray-500','font-medium');
                bMonth.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold');
                bMonth.classList.add('text-gray-500','font-medium');
            } else {
                vList.classList.add('hidden');
                vMonth.classList.remove('hidden');
                calendarViewMonthContainer.classList.remove('hidden');
                bMonth.classList.add('bg-white','shadow-sm','text-ttgreen','font-bold');
                bMonth.classList.remove('text-gray-500','font-medium');
                bList.classList.remove('bg-white','shadow-sm','text-ttgreen','font-bold');
                bList.classList.add('text-gray-500','font-medium');
                window.renderBigCalendar();
            }
        };

        window.changeBigCalMonth = function(delta) {
            bigCalDate.setMonth(bigCalDate.getMonth() + delta);
            window.renderBigCalendar();
        };
        
        window.selectBigCalendarDate = function(y,m,d) { document.querySelectorAll('.big-cal-cell.selected').forEach(e=>e.classList.remove('selected')); if(m===bigCalDate.getMonth()) { const el=document.getElementById(`big-cal-day-${d}`); if(el) el.classList.add('selected'); } document.getElementById('selected-date-label').textContent = `${y}年${m+1}月${d}日`; const listEl = document.getElementById('month-event-list'); if(!listEl) return; const items = window.getCalendarItems(); const ds=new Date(y, m, d), de=new Date(y, m, d, 23,59,59); const dayEvents = items.filter(e => { const t = new Date(e.timestamp); return t>=ds && t<=de; }); if(dayEvents.length===0) listEl.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">這天沒有安排行程 😴</div>`; else window.renderEventListItems(dayEvents, listEl); };
        
        // === New Function: Handle Double Click ===
        window.handleBigCalDbClick = function(y, m, d) {
            // 1. 建立日期字串
            const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            
            // 2. 開啟新增視窗 (會先重置欄位)
            window.openAddModal();
            
            // 3. 設定日期
            const dateInput = document.getElementById('input-date-start');
            if (dateInput) {
                dateInput.value = dateStr;
            }
            
            // 4. 更新顯示文字
            window.updateDateDisplay('start', dateStr);
            
            // 5. 連動結束時間 (如果有的話)
            if(window.autoUpdateEnd) window.autoUpdateEnd();
        };

        // === New Function: Handle Swipe Logic ===
        let touchStartX = 0;
        let touchStartY = 0;

        window.initSwipe = function() {
            const el = document.getElementById('calendar-view-month');
            if(!el) return;

            el.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: true});

            el.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                // 判斷條件：水平移動 > 垂直移動 且 移動距離 > 50px
                if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if(diffX > 0) {
                        // 左滑 (Next)
                        window.changeBigCalMonth(1);
                    } else {
                        // 右滑 (Prev)
                        window.changeBigCalMonth(-1);
                    }
                }
            }, {passive: true});
        };

        window.renderBigCalendar = function() {
            const y = bigCalDate.getFullYear();
            const m = bigCalDate.getMonth();
            const title = document.getElementById('big-cal-title');
            if(title) title.textContent = `${y}年${m+1}月`;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            
            let html = '';
            for(let i=0; i<firstDay; i++) {
                html += `<div class="big-cal-cell bg-gray-50/50"></div>`;
            }
            
            const nowStr = new Date().toDateString();
            const items = window.getCalendarItems ? window.getCalendarItems() : [];

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(y, m, d);
                const isToday = dateObj.toDateString() === nowStr;
                
                // Filter events for this day
                const dayEvents = items.filter(e => {
                    const t = new Date(e.timestamp);
                    return t.getDate() === d && t.getMonth() === m && t.getFullYear() === y;
                });

                // Bars HTML
                let bars = '';
                dayEvents.slice(0, 3).forEach(e => {
                    // === 修改處：強制顏色邏輯 ===
                    let bg;
                    if (e.isJoint) {
                        bg = roleColors.joint;
                    } else {
                        bg = (e.creator === 'haohao' ? roleColors.haohao : roleColors.maomao);
                    }
                    // =========================

                    bars += `<div class="event-bar ${e.isTodo&&e.done?'done':''}" style="background-color:${bg}">${e.title}</div>`;
                });
                if(dayEvents.length > 3) {
                    bars += `<div class="more-events">+${dayEvents.length-3}</div>`;
                }

                // Add ondblclick handler here
                html += `<div class="big-cal-cell ${isToday?'today':''}" id="big-cal-day-${d}" onclick="window.selectBigCalendarDate(${y},${m},${d})" ondblclick="window.handleBigCalDbClick(${y},${m},${d})">
                    <div class="big-cal-day-num">${d}</div>
                    <div class="w-full px-1 space-y-px">${bars}</div>
                </div>`;
            }
            
            const grid = document.getElementById('big-cal-grid');
            if(grid) grid.innerHTML = html;
        };

function initApp(db) {
  if (!db) {
    console.error("Firebase not initialized");
    return;
  }

  // connection indicator
  const conn = document.getElementById('connection-status');
  if (conn) {
    conn.className = "w-2 h-2 rounded-full bg-ttgreen shadow-[0_0_8px_#2cc998]";
  }

  /* ===== STABLE PATCH: Events Snapshot ===== */
  bindSnapshot(
    db.collection('events').orderBy('timestamp', 'asc'),
    (snapshot) => {
      const events = [];
      snapshot.forEach(doc =>
        events.push({ id: doc.id, ...doc.data() })
      );
      allEventsCache = events;

      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-events'
      );
      safeRun(
        () => window.renderCalendarListView(),
        'calendar-list'
      );

      // Big Calendar 只在月曆模式才渲染
      if (currentViewMode === 'month') {
        safeRun(() => window.renderBigCalendar(), 'big-calendar');
      }
    },
    'events'
  );

  /* ===== STABLE PATCH: Todos Snapshot ===== */
  bindSnapshot(
    db.collection('todos').orderBy('createdAt', 'desc'),
    (snapshot) => {
      const todos = [];
      snapshot.forEach(doc =>
        todos.push({ id: doc.id, ...doc.data() })
      );
      allTodosCache = todos;

      safeRun(() => window.renderTodos(todos), 'todos');
      safeRun(
        () => window.renderDashboardNextUp(window.getCalendarItems()),
        'dashboard-todos'
      );
      
      safeRun(
        () => window.renderCalendarListView(),
        'calendar-list-from-todos'
      );

      // 4. === 新增：如果當前在看月曆，也要更新月曆上的小橫條 ===
      if (currentViewMode === 'month') {
        safeRun(() => window.renderBigCalendar(), 'big-calendar-from-todos');
      }
    },
    'todos'
  );

  /* ===== STABLE PATCH: Status Snapshot ===== */
  bindSnapshot(
    db.collection('status').doc('current'),
    (doc) => {
      if (doc.exists) {
        safeRun(() => window.renderStatus?.(doc.data()), 'status');
      }
    },
    'status'
  );
  
  /* ===== STABLE PATCH: Notes Listener (便利貼) ===== */
  db.collection('notes').onSnapshot(snapshot => {
      snapshot.forEach(doc => {
          // doc.id 會是 'haohao' 或 'maomao'
          window.renderNoteBubble(doc.id, doc.data());
      });
      // 順便同步一下頭像顏色
      window.syncNoteAvatarColors();
  });
}

document.addEventListener('DOMContentLoaded', () => {
  safeRun(() => {
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // 初始化介面
    window.updateRoleUI();
    
    // === 新增這行：啟動時同步設定頁的顏色圈圈 ===
    window.updateSettingsColorUI();
    // ==========================================

    // === 新增：啟動時檢查 ===
    if (!currentUserRole) {
        // 如果沒有身分，直接跳轉到設定頁
        window.switchTab('settings');
        // 顯示提示
        setTimeout(() => window.showToast('歡迎！請先選擇您的身分 👋'), 500);
    } else {
        // 有身分，正常設定顏色
        document.documentElement.style.setProperty(
          '--active-tab-color',
          roleColors[currentUserRole]
        );
    }

    if (db) {
      initApp(db);
    }
    
    // 初始化滑動偵測
    window.initSwipe();
  }, 'bootstrap');
});

if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.error('SW failed', err));
  });
}

/* ===== PWA Resume Guard (iOS) ===== */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    safeRun(() => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      if (currentViewMode === 'month') {
        window.renderBigCalendar();
      }
    }, 'resume');
  }
});

</script>

</body>
</html>
